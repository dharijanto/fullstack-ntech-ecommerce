"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const app_config_1=require("../../../app-config"),base_controller_1=require("../base-controller"),local_shop_service_1=require("../../../services/local-shop-service"),Utils=require("../../../libs/utils"),path=require("path");let log=require("npmlog");const TAG="MainController";class PromotionManagementController extends base_controller_1.default{constructor(e){super(Object.assign(e,{viewPath:path.join(__dirname,"../../views")})),this.PROMOTION_IMAGES_PATH=app_config_1.default.IMAGE_PATH,this.imageService=new e.services.ImageService(e.db.sequelize,e.db.models),this.imageURLFormatter=(e=>`${app_config_1.default.BASE_URL}${app_config_1.default.IMAGE_MOUNT_PATH}${e}`),super.routeGet("/",(e,t,o)=>{t.render("cms/promotion-management")}),super.routeGet("/promotions",(e,t,o)=>{local_shop_service_1.default.getPromotion().then(t.json.bind(t)).catch(o)}),super.routePost("/promotion",(e,t,o)=>{const r=e.query.productId;r?local_shop_service_1.default.createPromotion(r,e.body).then(t.json.bind(t)).catch(o):t.json({status:!1,errMessage:"productId is required"})}),super.routePost("/promotion/edit",(e,t,o)=>{const r=e.query.productId;r?local_shop_service_1.default.updatePromotion(r,e.body.id,e.body).then(t.json.bind(t)).catch(o):t.json({status:!1,errMessage:"productId is required"})}),super.routePost("/promotion/delete",(e,t,o)=>{local_shop_service_1.default.deletePromotion(e.body.id).then(t.json.bind(t)).catch(o)}),this.routePost("/image/get-url",(e,t,o)=>{const r=e.body.filename;t.json({status:!0,data:Utils.getImageURL(r)})}),super.routeGet("/images",(e,t,o)=>{this.imageService.getImages(this.imageURLFormatter).then(e=>{log.verbose(TAG,"/images.GET():"+JSON.stringify(e)),t.json(e)}).catch(o)}),super.routePost("/image",this.imageService.getExpressUploadMiddleware(this.PROMOTION_IMAGES_PATH,this.imageURLFormatter)),super.routePost("/image/delete",(e,t,o)=>{log.verbose(TAG,"image/delete.POST: req.body="+JSON.stringify(e.body)),this.imageService.deleteImage(this.PROMOTION_IMAGES_PATH,e.body.filename).then(e=>{t.json(e)}).catch(o)})}}exports.default=PromotionManagementController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvY21zL3Byb21vdGlvbi1tYW5hZ2VtZW50LWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiYXBwX2NvbmZpZ18xIiwicmVxdWlyZSIsImJhc2VfY29udHJvbGxlcl8xIiwibG9jYWxfc2hvcF9zZXJ2aWNlXzEiLCJVdGlscyIsInBhdGgiLCJsb2ciLCJUQUciLCJQcm9tb3Rpb25NYW5hZ2VtZW50Q29udHJvbGxlciIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJzaXRlRGF0YSIsInN1cGVyIiwiT2JqZWN0IiwiYXNzaWduIiwidmlld1BhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwidGhpcyIsIlBST01PVElPTl9JTUFHRVNfUEFUSCIsIklNQUdFX1BBVEgiLCJpbWFnZVNlcnZpY2UiLCJzZXJ2aWNlcyIsIkltYWdlU2VydmljZSIsImRiIiwic2VxdWVsaXplIiwibW9kZWxzIiwiaW1hZ2VVUkxGb3JtYXR0ZXIiLCJmaWxlbmFtZSIsIkJBU0VfVVJMIiwiSU1BR0VfTU9VTlRfUEFUSCIsInJvdXRlR2V0IiwicmVxIiwicmVzIiwibmV4dCIsInJlbmRlciIsImdldFByb21vdGlvbiIsInRoZW4iLCJqc29uIiwiYmluZCIsImNhdGNoIiwicm91dGVQb3N0IiwicHJvZHVjdElkIiwicXVlcnkiLCJjcmVhdGVQcm9tb3Rpb24iLCJib2R5Iiwic3RhdHVzIiwiZXJyTWVzc2FnZSIsInVwZGF0ZVByb21vdGlvbiIsImlkIiwiZGVsZXRlUHJvbW90aW9uIiwiZGF0YSIsImdldEltYWdlVVJMIiwiZ2V0SW1hZ2VzIiwicmVzcCIsInZlcmJvc2UiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0RXhwcmVzc1VwbG9hZE1pZGRsZXdhcmUiLCJkZWxldGVJbWFnZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFJQSxNQUFBQSxhQUFBQyxRQUFBLHVCQUNBQyxrQkFBQUQsUUFBQSxzQkFFQUUscUJBQUFGLFFBQUEsd0NBRUFHLE1BQUFILFFBQUEsdUJBR01JLEtBQU9KLFFBQVEsUUFFckIsSUFBSUssSUFBTUwsUUFBUSxVQUVsQixNQUFNTSxJQUFNLHVCQUtaQyxzQ0FBMkROLGtCQUFBTyxRQUt6REMsWUFBYUMsR0FDWEMsTUFBTUMsT0FBT0MsT0FBT0gsR0FBWUksU0FBVVYsS0FBS1csS0FBS0MsVUFBVyxrQkFIaERDLEtBQUFDLHNCQUFnQ25CLGFBQUFTLFFBQVVXLFdBS3pERixLQUFLRyxhQUFlLElBQUlWLEVBQVNXLFNBQVNDLGFBQWFaLEVBQVNhLEdBQUdDLFVBQVdkLEVBQVNhLEdBQUdFLFFBQzFGUixLQUFLUyxrQkFBb0JDLENBQUFBLE1BQWU1QixhQUFBUyxRQUFVb0IsV0FBVzdCLGFBQUFTLFFBQVVxQixtQkFBbUJGLEtBRTFGaEIsTUFBTW1CLFNBQVMsSUFBSyxDQUFDQyxFQUFLQyxFQUFLQyxLQUM3QkQsRUFBSUUsT0FBTyw4QkFHYnZCLE1BQU1tQixTQUFTLGNBQWUsQ0FBQ0MsRUFBS0MsRUFBS0MsS0FDdkMvQixxQkFBQU0sUUFBaUIyQixlQUFlQyxLQUFLSixFQUFJSyxLQUFLQyxLQUFLTixJQUFNTyxNQUFNTixLQUdqRXRCLE1BQU02QixVQUFVLGFBQWMsQ0FBQ1QsRUFBS0MsRUFBS0MsS0FDdkMsTUFBTVEsRUFBWVYsRUFBSVcsTUFBTUQsVUFDdkJBLEVBR0h2QyxxQkFBQU0sUUFBaUJtQyxnQkFBZ0JGLEVBQVdWLEVBQUlhLE1BQU1SLEtBQUtKLEVBQUlLLEtBQUtDLEtBQUtOLElBQU1PLE1BQU1OLEdBRnJGRCxFQUFJSyxNQUFPUSxRQUFRLEVBQU9DLFdBQVksNEJBTTFDbkMsTUFBTTZCLFVBQVUsa0JBQW1CLENBQUNULEVBQUtDLEVBQUtDLEtBQzVDLE1BQU1RLEVBQVlWLEVBQUlXLE1BQU1ELFVBRXZCQSxFQUdIdkMscUJBQUFNLFFBQWlCdUMsZ0JBQWdCTixFQUFXVixFQUFJYSxLQUFLSSxHQUFJakIsRUFBSWEsTUFDeERSLEtBQUtKLEVBQUlLLEtBQUtDLEtBQUtOLElBQU1PLE1BQU1OLEdBSHBDRCxFQUFJSyxNQUFPUSxRQUFRLEVBQU9DLFdBQVksNEJBTzFDbkMsTUFBTTZCLFVBQVUsb0JBQXFCLENBQUNULEVBQUtDLEVBQUtDLEtBQzlDL0IscUJBQUFNLFFBQWlCeUMsZ0JBQWdCbEIsRUFBSWEsS0FBS0ksSUFBSVosS0FBS0osRUFBSUssS0FBS0MsS0FBS04sSUFBTU8sTUFBTU4sS0FHL0VoQixLQUFLdUIsVUFBVSxpQkFBa0IsQ0FBQ1QsRUFBS0MsRUFBS0MsS0FDMUMsTUFBTU4sRUFBV0ksRUFBSWEsS0FBS2pCLFNBQzFCSyxFQUFJSyxNQUFPUSxRQUFRLEVBQU1LLEtBQU0vQyxNQUFNZ0QsWUFBWXhCLE9BR25EaEIsTUFBTW1CLFNBQVMsVUFBVyxDQUFDQyxFQUFLQyxFQUFLQyxLQUNuQ2hCLEtBQUtHLGFBQWFnQyxVQUFVbkMsS0FBS1MsbUJBQW1CVSxLQUFLaUIsSUFDdkRoRCxJQUFJaUQsUUFBUWhELElBQUssaUJBQW1CaUQsS0FBS0MsVUFBVUgsSUFDbkRyQixFQUFJSyxLQUFLZ0IsS0FDUmQsTUFBTU4sS0FHWHRCLE1BQU02QixVQUFVLFNBQ2R2QixLQUFLRyxhQUFhcUMsMkJBQTJCeEMsS0FBS0Msc0JBQXVCRCxLQUFLUyxvQkFFaEZmLE1BQU02QixVQUFVLGdCQUFpQixDQUFDVCxFQUFLQyxFQUFLQyxLQUMxQzVCLElBQUlpRCxRQUFRaEQsSUFBSywrQkFBaUNpRCxLQUFLQyxVQUFVekIsRUFBSWEsT0FDckUzQixLQUFLRyxhQUFhc0MsWUFBWXpDLEtBQUtDLHNCQUF1QmEsRUFBSWEsS0FBS2pCLFVBQVVTLEtBQUtpQixJQUNoRnJCLEVBQUlLLEtBQUtnQixLQUNSZCxNQUFNTixNQTlEZjBCLFFBQUFuRCxRQUFBRCIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvY21zL3Byb21vdGlvbi1tYW5hZ2VtZW50LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0ICogYXMgcHVnIGZyb20gJ3B1ZydcblxuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi8uLi8uLi9hcHAtY29uZmlnJ1xuaW1wb3J0IEJhc2VDb250cm9sbGVyIGZyb20gJy4uL2Jhc2UtY29udHJvbGxlcidcbmltcG9ydCBTaG9wU2VydmljZSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9zaG9wLXNlcnZpY2UnXG5pbXBvcnQgTG9jYWxTaG9wU2VydmljZSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9sb2NhbC1zaG9wLXNlcnZpY2UnXG5pbXBvcnQgeyBTaXRlRGF0YSwgSW1hZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2l0ZS1kZWZpbml0aW9ucydcbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJy4uLy4uLy4uL2xpYnMvdXRpbHMnXG5pbXBvcnQgT3JkZXJTZXJ2aWNlIGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2xvY2FsLXNob3Avb3JkZXItc2VydmljZSdcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcblxuY29uc3QgVEFHID0gJ01haW5Db250cm9sbGVyJ1xuXG4vKlxuVE9ETzogT25seSB1c2VyIHdpdGggYWRtaW4gcHJpdmlsZWdlIGNhbiBhY2Nlc3MgdGhpcyBwYWdlIVxuKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFByb21vdGlvbk1hbmFnZW1lbnRDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xuICBwcml2YXRlIGltYWdlU2VydmljZTogSW1hZ2VTZXJ2aWNlXG4gIHByaXZhdGUgcmVhZG9ubHkgaW1hZ2VVUkxGb3JtYXR0ZXJcbiAgcHJpdmF0ZSByZWFkb25seSBQUk9NT1RJT05fSU1BR0VTX1BBVEg6IHN0cmluZyA9IEFwcENvbmZpZy5JTUFHRV9QQVRIXG5cbiAgY29uc3RydWN0b3IgKHNpdGVEYXRhOiBTaXRlRGF0YSkge1xuICAgIHN1cGVyKE9iamVjdC5hc3NpZ24oc2l0ZURhdGEsIHsgdmlld1BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi92aWV3cycpIH0pKVxuXG4gICAgdGhpcy5pbWFnZVNlcnZpY2UgPSBuZXcgc2l0ZURhdGEuc2VydmljZXMuSW1hZ2VTZXJ2aWNlKHNpdGVEYXRhLmRiLnNlcXVlbGl6ZSwgc2l0ZURhdGEuZGIubW9kZWxzKVxuICAgIHRoaXMuaW1hZ2VVUkxGb3JtYXR0ZXIgPSBmaWxlbmFtZSA9PiBgJHtBcHBDb25maWcuQkFTRV9VUkx9JHtBcHBDb25maWcuSU1BR0VfTU9VTlRfUEFUSH0ke2ZpbGVuYW1lfWBcblxuICAgIHN1cGVyLnJvdXRlR2V0KCcvJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICByZXMucmVuZGVyKCdjbXMvcHJvbW90aW9uLW1hbmFnZW1lbnQnKVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZUdldCgnL3Byb21vdGlvbnMnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UHJvbW90aW9uKCkudGhlbihyZXMuanNvbi5iaW5kKHJlcykpLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlUG9zdCgnL3Byb21vdGlvbicsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgcHJvZHVjdElkID0gcmVxLnF1ZXJ5LnByb2R1Y3RJZFxuICAgICAgaWYgKCFwcm9kdWN0SWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAncHJvZHVjdElkIGlzIHJlcXVpcmVkJyB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgTG9jYWxTaG9wU2VydmljZS5jcmVhdGVQcm9tb3Rpb24ocHJvZHVjdElkLCByZXEuYm9keSkudGhlbihyZXMuanNvbi5iaW5kKHJlcykpLmNhdGNoKG5leHQpXG4gICAgICB9XG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlUG9zdCgnL3Byb21vdGlvbi9lZGl0JywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBwcm9kdWN0SWQgPSByZXEucXVlcnkucHJvZHVjdElkXG5cbiAgICAgIGlmICghcHJvZHVjdElkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3Byb2R1Y3RJZCBpcyByZXF1aXJlZCcgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UudXBkYXRlUHJvbW90aW9uKHByb2R1Y3RJZCwgcmVxLmJvZHkuaWQsIHJlcS5ib2R5KVxuICAgICAgICAgICAgLnRoZW4ocmVzLmpzb24uYmluZChyZXMpKS5jYXRjaChuZXh0KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZVBvc3QoJy9wcm9tb3Rpb24vZGVsZXRlJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBMb2NhbFNob3BTZXJ2aWNlLmRlbGV0ZVByb21vdGlvbihyZXEuYm9keS5pZCkudGhlbihyZXMuanNvbi5iaW5kKHJlcykpLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVQb3N0KCcvaW1hZ2UvZ2V0LXVybCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgZmlsZW5hbWUgPSByZXEuYm9keS5maWxlbmFtZVxuICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IHRydWUsIGRhdGE6IFV0aWxzLmdldEltYWdlVVJMKGZpbGVuYW1lKSB9KVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZUdldCgnL2ltYWdlcycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgdGhpcy5pbWFnZVNlcnZpY2UuZ2V0SW1hZ2VzKHRoaXMuaW1hZ2VVUkxGb3JtYXR0ZXIpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGxvZy52ZXJib3NlKFRBRywgJy9pbWFnZXMuR0VUKCk6JyArIEpTT04uc3RyaW5naWZ5KHJlc3ApKVxuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2gobmV4dClcbiAgICB9KVxuXG4gICAgc3VwZXIucm91dGVQb3N0KCcvaW1hZ2UnLFxuICAgICAgdGhpcy5pbWFnZVNlcnZpY2UuZ2V0RXhwcmVzc1VwbG9hZE1pZGRsZXdhcmUodGhpcy5QUk9NT1RJT05fSU1BR0VTX1BBVEgsIHRoaXMuaW1hZ2VVUkxGb3JtYXR0ZXIpKVxuXG4gICAgc3VwZXIucm91dGVQb3N0KCcvaW1hZ2UvZGVsZXRlJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsICdpbWFnZS9kZWxldGUuUE9TVDogcmVxLmJvZHk9JyArIEpTT04uc3RyaW5naWZ5KHJlcS5ib2R5KSlcbiAgICAgIHRoaXMuaW1hZ2VTZXJ2aWNlLmRlbGV0ZUltYWdlKHRoaXMuUFJPTU9USU9OX0lNQUdFU19QQVRILCByZXEuYm9keS5maWxlbmFtZSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgIH0pLmNhdGNoKG5leHQpXG4gICAgfSlcbiAgfVxufVxuIl19
