"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const base_controller_1=require("../base-controller"),order_service_1=require("../../local-shop-services/order-service"),app_config_1=require("../../../app-config"),path=require("path");let log=require("npmlog");const TAG="OrderManagementController";class OrderManagementController extends base_controller_1.default{constructor(e){super(Object.assign(e,{viewPath:path.join(__dirname,"../../views")})),this.addInterceptor((e,r,t)=>{log.verbose(TAG,"req.path="+e.path),log.verbose(TAG,"loggedIn="+e.isAuthenticated()),log.verbose(TAG,"req.on="+JSON.stringify(e.session)),t()}),super.routeGet("/",(e,r,t)=>{r.redirect(`${e.baseUrl}/open-order-management`)}),super.routeGet("/open-order-management",(e,r,t)=>{r.render("cms/open-order-management")}),super.routeGet("/closed-order-management",(e,r,t)=>{r.render("cms/closed-order-management")}),super.routeGet("/open-orders",(e,r,t)=>{order_service_1.default.getOpenOrders().then(r.json.bind(r)).catch(t)}),super.routeGet("/closed-orders",(e,r,t)=>{order_service_1.default.getClosedOrders().then(r.json.bind(r)).catch(t)}),super.routePost("/order",(e,r,t)=>{order_service_1.default.addOrder(e.body).then(r.json.bind(r)).catch(t)}),super.routePost("/order/edit",(e,r,t)=>{order_service_1.default.editOrder(e.body).then(r.json.bind(r)).catch(t)}),super.routePost("/order/cancel",(e,r,t)=>{order_service_1.default.cancelOrder(e.body.id).then(r.json.bind(r)).catch(t)}),super.routePost("/order/close",(e,r,t)=>{const o=e.body.id;order_service_1.default.closeOrder(o).then(e=>e.status?order_service_1.default.printReceipt(`${app_config_1.default.BASE_URL}${this.getRouter().path()}/order/receipt?orderId=${o}&originalCopy=1`,1).then(e=>e.status&&e.data?void r.json({status:!0}):void r.json(e)):void r.json({status:!1,errMessage:e.errMessage}))}),super.routePost("/order/close-po",(e,r,t)=>{const o=e.body.id;order_service_1.default.finishPOOrder(o).then(e=>e.status?order_service_1.default.printReceipt(`${app_config_1.default.BASE_URL}${this.getRouter().path()}/order/receipt?orderId=${o}&originalCopy=1`,1).then(e=>e.status&&e.data?void r.json({status:!0}):void r.json(e)):void r.json({status:!1,errMessage:e.errMessage}))}),super.routePost("/order/print-receipt",(e,r,t)=>{const o=e.body.orderId;order_service_1.default.getReceipt(o).then(e=>e.status?order_service_1.default.printReceipt(`${app_config_1.default.BASE_URL}${this.getRouter().path()}/order/receipt?orderId=${o}`).then(e=>{e.status&&e.data?r.json({status:!0}):r.json(e)}):void r.json({status:!1,errMessage:e.errMessage})).catch(e=>{r.json({status:!1,errMessage:"Error: "+e.message})})}),super.routeGet("/order/receipt",(e,r,t)=>{const o=e.query.orderId,s=e.query.originalCopy;order_service_1.default.getReceipt(o).then(e=>{e.status&&e.data?(console.dir(e.data),r.locals.receipt=e.data,r.locals.originalCopy=s,r.render("cms/receipt")):r.status(500).send("Error: "+e.errMessage)}).catch(t)}),super.routeGet("/order-details",(e,r,t)=>{const o=e.query.orderId;o?order_service_1.default.getOrderDetails(o).then(r.json.bind(r)).catch(t):r.json({status:!1,errMessage:"orderId is required!"})}),super.routePost("/order-detail",(e,r,t)=>{const o=e.query.orderId,s=e.body.variantId,d=parseInt(e.body.quantity,10);order_service_1.default.addOrderDetail(o,s,d).then(r.json.bind(r)).catch(t)}),super.routePost("/order-detail/edit",(e,r,t)=>{r.json({status:!1,errMessage:"Not implemented yet!"})}),super.routePost("/order-detail/delete",(e,r,t)=>{const o=e.body.id;order_service_1.default.deleteOrderDetail(o).then(r.json.bind(r)).catch(t)})}}exports.default=OrderManagementController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvY21zL29yZGVyLW1hbmFnZW1lbnQtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJiYXNlX2NvbnRyb2xsZXJfMSIsInJlcXVpcmUiLCJvcmRlcl9zZXJ2aWNlXzEiLCJhcHBfY29uZmlnXzEiLCJwYXRoIiwibG9nIiwiVEFHIiwiT3JkZXJNYW5hZ2VtZW50Q29udHJvbGxlciIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJzaXRlRGF0YSIsInN1cGVyIiwiT2JqZWN0IiwiYXNzaWduIiwidmlld1BhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwidGhpcyIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsInZlcmJvc2UiLCJpc0F1dGhlbnRpY2F0ZWQiLCJKU09OIiwic3RyaW5naWZ5Iiwic2Vzc2lvbiIsInJvdXRlR2V0IiwicmVkaXJlY3QiLCJiYXNlVXJsIiwicmVuZGVyIiwiZ2V0T3Blbk9yZGVycyIsInRoZW4iLCJqc29uIiwiYmluZCIsImNhdGNoIiwiZ2V0Q2xvc2VkT3JkZXJzIiwicm91dGVQb3N0IiwiYWRkT3JkZXIiLCJib2R5IiwiZWRpdE9yZGVyIiwiY2FuY2VsT3JkZXIiLCJpZCIsIm9yZGVySWQiLCJjbG9zZU9yZGVyIiwicmVzcCIsInN0YXR1cyIsInByaW50UmVjZWlwdCIsIkJBU0VfVVJMIiwiZ2V0Um91dGVyIiwiZGF0YSIsImVyck1lc3NhZ2UiLCJmaW5pc2hQT09yZGVyIiwiZ2V0UmVjZWlwdCIsImVyciIsIm1lc3NhZ2UiLCJxdWVyeSIsIm9yaWdpbmFsQ29weSIsImNvbnNvbGUiLCJkaXIiLCJsb2NhbHMiLCJyZWNlaXB0Iiwic2VuZCIsImdldE9yZGVyRGV0YWlscyIsInZhcmlhbnRJZCIsInF1YW50aXR5IiwicGFyc2VJbnQiLCJhZGRPcmRlckRldGFpbCIsIm9yZGVyRGV0YWlsSWQiLCJkZWxldGVPcmRlckRldGFpbCIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJv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S2QsSUFBTWUsTUFBTWQsR0FFckVELEVBQUlhLE1BQU9hLFFBQVEsRUFBT0ssV0FBWSwyQkFJMUN4QyxNQUFNMEIsVUFBVSxnQkFBaUIsQ0FBQ2xCLEVBQUtDLEVBQUtDLEtBQzFDLE1BQU1zQixFQUFVeEIsRUFBSXFDLE1BQU1iLFFBQ3BCcUIsRUFBWTdDLEVBQUlvQixLQUFLeUIsVUFDckJDLEVBQVdDLFNBQVMvQyxFQUFJb0IsS0FBSzBCLFNBQVUsSUFDN0MvRCxnQkFBQU0sUUFBYTJELGVBQWV4QixFQUFTcUIsRUFBV0MsR0FBVWpDLEtBQUtaLEVBQUlhLEtBQUtDLEtBQUtkLElBQU1lLE1BQU1kLEtBRzNGVixNQUFNMEIsVUFBVSxxQkFBc0IsQ0FBQ2xCLEVBQUtDLEVBQUtDLEtBRS9DRCxFQUFJYSxNQUFPYSxRQUFRLEVBQU9LLFdBQVksMkJBR3hDeEMsTUFBTTBCLFVBQVUsdUJBQXdCLENBQUNsQixFQUFLQyxFQUFLQyxLQUNqRCxNQUFNK0MsRUFBZ0JqRCxFQUFJb0IsS0FBS0csR0FDL0J4QyxnQkFBQU0sUUFBYTZELGtCQUFrQkQsR0FBZXBDLEtBQUtaLEVBQUlhLEtBQUtDLEtBQUtkLElBQU1lLE1BQU1kLE1BbEpuRmlELFFBQUE5RCxRQUFBRCIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvY21zL29yZGVyLW1hbmFnZW1lbnQtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcydcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgKiBhcyBwdWcgZnJvbSAncHVnJ1xuXG5pbXBvcnQgQmFzZUNvbnRyb2xsZXIgZnJvbSAnLi4vYmFzZS1jb250cm9sbGVyJ1xuaW1wb3J0IENhcnRTZXJ2aWNlIGZyb20gJy4uLy4uL2xvY2FsLXNob3Atc2VydmljZXMvY2FydC1zZXJ2aWNlJ1xuaW1wb3J0IHsgU2l0ZURhdGEgfSBmcm9tICcuLi8uLi8uLi9zaXRlLWRlZmluaXRpb25zJ1xuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vLi4vLi4vbGlicy91dGlscydcbmltcG9ydCBPcmRlclNlcnZpY2UgZnJvbSAnLi4vLi4vbG9jYWwtc2hvcC1zZXJ2aWNlcy9vcmRlci1zZXJ2aWNlJ1xuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi8uLi8uLi9hcHAtY29uZmlnJ1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxuXG5jb25zdCBUQUcgPSAnT3JkZXJNYW5hZ2VtZW50Q29udHJvbGxlcidcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT3JkZXJNYW5hZ2VtZW50Q29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKHNpdGVEYXRhOiBTaXRlRGF0YSkge1xuICAgIHN1cGVyKE9iamVjdC5hc3NpZ24oc2l0ZURhdGEsIHsgdmlld1BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi92aWV3cycpIH0pKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3JlcS5wYXRoPScgKyByZXEucGF0aClcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ2xvZ2dlZEluPScgKyByZXEuaXNBdXRoZW50aWNhdGVkKCkpXG4gICAgICBsb2cudmVyYm9zZShUQUcsICdyZXEub249JyArIEpTT04uc3RyaW5naWZ5KHJlcS5zZXNzaW9uKSlcbiAgICAgIG5leHQoKVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZUdldCgnLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgcmVzLnJlZGlyZWN0KGAke3JlcS5iYXNlVXJsfS9vcGVuLW9yZGVyLW1hbmFnZW1lbnRgKVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZUdldCgnL29wZW4tb3JkZXItbWFuYWdlbWVudCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgcmVzLnJlbmRlcignY21zL29wZW4tb3JkZXItbWFuYWdlbWVudCcpXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlR2V0KCcvY2xvc2VkLW9yZGVyLW1hbmFnZW1lbnQnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIHJlcy5yZW5kZXIoJ2Ntcy9jbG9zZWQtb3JkZXItbWFuYWdlbWVudCcpXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlR2V0KCcvb3Blbi1vcmRlcnMnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIE9yZGVyU2VydmljZS5nZXRPcGVuT3JkZXJzKCkudGhlbihyZXMuanNvbi5iaW5kKHJlcykpLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlR2V0KCcvY2xvc2VkLW9yZGVycycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgT3JkZXJTZXJ2aWNlLmdldENsb3NlZE9yZGVycygpLnRoZW4ocmVzLmpzb24uYmluZChyZXMpKS5jYXRjaChuZXh0KVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZVBvc3QoJy9vcmRlcicsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgT3JkZXJTZXJ2aWNlLmFkZE9yZGVyKHJlcS5ib2R5KS50aGVuKHJlcy5qc29uLmJpbmQocmVzKSkuY2F0Y2gobmV4dClcbiAgICB9KVxuXG4gICAgc3VwZXIucm91dGVQb3N0KCcvb3JkZXIvZWRpdCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgT3JkZXJTZXJ2aWNlLmVkaXRPcmRlcihyZXEuYm9keSkudGhlbihyZXMuanNvbi5iaW5kKHJlcykpLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlUG9zdCgnL29yZGVyL2NhbmNlbCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgT3JkZXJTZXJ2aWNlLmNhbmNlbE9yZGVyKHJlcS5ib2R5LmlkKS50aGVuKHJlcy5qc29uLmJpbmQocmVzKSkuY2F0Y2gobmV4dClcbiAgICB9KVxuXG4gICAgc3VwZXIucm91dGVQb3N0KCcvb3JkZXIvY2xvc2UnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IG9yZGVySWQgPSByZXEuYm9keS5pZFxuICAgICAgT3JkZXJTZXJ2aWNlLmNsb3NlT3JkZXIob3JkZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgcmV0dXJuIE9yZGVyU2VydmljZS5wcmludFJlY2VpcHQoYCR7QXBwQ29uZmlnLkJBU0VfVVJMfSR7dGhpcy5nZXRSb3V0ZXIoKS5wYXRoKCl9L29yZGVyL3JlY2VpcHQ/b3JkZXJJZD0ke29yZGVySWR9Jm9yaWdpbmFsQ29weT0xYCwgMSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IHRydWUgfSlcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH0pXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlUG9zdCgnL29yZGVyL2Nsb3NlLXBvJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBvcmRlcklkID0gcmVxLmJvZHkuaWRcbiAgICAgIE9yZGVyU2VydmljZS5maW5pc2hQT09yZGVyKG9yZGVySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgIHJldHVybiBPcmRlclNlcnZpY2UucHJpbnRSZWNlaXB0KGAke0FwcENvbmZpZy5CQVNFX1VSTH0ke3RoaXMuZ2V0Um91dGVyKCkucGF0aCgpfS9vcmRlci9yZWNlaXB0P29yZGVySWQ9JHtvcmRlcklkfSZvcmlnaW5hbENvcHk9MWAsIDEpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiB0cnVlIH0pXG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9KVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZVBvc3QoJy9vcmRlci9wcmludC1yZWNlaXB0JywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBvcmRlcklkID0gcmVxLmJvZHkub3JkZXJJZFxuICAgICAgLy8gVE9ETzogVGhpcyBpcyB2ZXJ5IGluZWZmaWNpZW50IGJlY2F1c2Ugd2UncmUgdGVjaG5pY2FsbHkgY2FsbGluZyBnZXRSZWNlaXB0KCkgdHdpY2U6XG4gICAgICAvLyBIZXJlLCBhbmQgZnJvbSBwcmludC1zZXJ2aWNlLiBCdXQgZm9yIG5vdywgd2UnbGwgbGl2ZSB3aXRoIGl0Li4uXG4gICAgICBPcmRlclNlcnZpY2UuZ2V0UmVjZWlwdChvcmRlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLnByaW50UmVjZWlwdChgJHtBcHBDb25maWcuQkFTRV9VUkx9JHt0aGlzLmdldFJvdXRlcigpLnBhdGgoKX0vb3JkZXIvcmVjZWlwdD9vcmRlcklkPSR7b3JkZXJJZH1gKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgICByZXMuanNvbih7IHN0YXR1czogdHJ1ZSB9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9KVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdFcnJvcjogJyArIGVyci5tZXNzYWdlIH0pXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZUdldCgnL29yZGVyL3JlY2VpcHQnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IG9yZGVySWQgPSByZXEucXVlcnkub3JkZXJJZFxuICAgICAgY29uc3Qgb3JpZ2luYWxDb3B5ID0gcmVxLnF1ZXJ5Lm9yaWdpbmFsQ29weVxuICAgICAgT3JkZXJTZXJ2aWNlLmdldFJlY2VpcHQob3JkZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnNvbGUuZGlyKHJlc3AuZGF0YSlcbiAgICAgICAgICAvLyBSZW5kZXIgdXNpbmcgcHVnXG4gICAgICAgICAgcmVzLmxvY2Fscy5yZWNlaXB0ID0gcmVzcC5kYXRhXG4gICAgICAgICAgcmVzLmxvY2Fscy5vcmlnaW5hbENvcHkgPSBvcmlnaW5hbENvcHlcbiAgICAgICAgICByZXMucmVuZGVyKCdjbXMvcmVjZWlwdCcpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg1MDApLnNlbmQoJ0Vycm9yOiAnICsgcmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICAgIC8vIHJlcy5qc29uKHJlc3ApXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlR2V0KCcvb3JkZXItZGV0YWlscycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3Qgb3JkZXJJZCA9IHJlcS5xdWVyeS5vcmRlcklkXG4gICAgICBpZiAob3JkZXJJZCkge1xuICAgICAgICBPcmRlclNlcnZpY2UuZ2V0T3JkZXJEZXRhaWxzKG9yZGVySWQpLnRoZW4ocmVzLmpzb24uYmluZChyZXMpKS5jYXRjaChuZXh0KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnb3JkZXJJZCBpcyByZXF1aXJlZCEnIH0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIHN1cGVyLnJvdXRlUG9zdCgnL29yZGVyLWRldGFpbCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3Qgb3JkZXJJZCA9IHJlcS5xdWVyeS5vcmRlcklkXG4gICAgICBjb25zdCB2YXJpYW50SWQgPSByZXEuYm9keS52YXJpYW50SWRcbiAgICAgIGNvbnN0IHF1YW50aXR5ID0gcGFyc2VJbnQocmVxLmJvZHkucXVhbnRpdHksIDEwKVxuICAgICAgT3JkZXJTZXJ2aWNlLmFkZE9yZGVyRGV0YWlsKG9yZGVySWQsIHZhcmlhbnRJZCwgcXVhbnRpdHkpLnRoZW4ocmVzLmpzb24uYmluZChyZXMpKS5jYXRjaChuZXh0KVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZVBvc3QoJy9vcmRlci1kZXRhaWwvZWRpdCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgLy8gVE9ETzogSW1wbGVtZW50IHRoaXMuIEFUTSB0aGlzIGlzIGRpc2FibGVkIGZyb20gVUlcbiAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ05vdCBpbXBsZW1lbnRlZCB5ZXQhJyB9KVxuICAgIH0pXG5cbiAgICBzdXBlci5yb3V0ZVBvc3QoJy9vcmRlci1kZXRhaWwvZGVsZXRlJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBvcmRlckRldGFpbElkID0gcmVxLmJvZHkuaWRcbiAgICAgIE9yZGVyU2VydmljZS5kZWxldGVPcmRlckRldGFpbChvcmRlckRldGFpbElkKS50aGVuKHJlcy5qc29uLmJpbmQocmVzKSkuY2F0Y2gobmV4dClcbiAgICB9KVxuICB9XG59XG4iXX0=
