"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),base_controller_1=require("../base-controller"),local_shop_service_1=require("../../local-shop-services/local-shop-service"),product_service_1=require("../../../services/product-service"),Utils=require("../../../libs/utils"),search_service_1=require("../../../services/search-service"),path=require("path");let log=require("npmlog");const TAG="MainController";class CartController extends base_controller_1.default{constructor(e){super(Object.assign(e,{viewPath:path.join(__dirname,"../../views")})),this.addInterceptor((e,t,r)=>{product_service_1.default.getCategories({},!0).then(e=>{if(!e.status||!e.data)throw new Error("Failed to retrieve categories: "+e.errMessage);Object.keys(Utils).forEach(e=>{t.locals[e]=Utils[e]}),t.locals.categories=e.data,r()}).catch(e=>{r(e)})}),this.routeGet("/search",(e,t,r)=>{log.verbose(TAG,"/search.GET()");const o=e.query.query;Promise.join(search_service_1.default.searchSubCategories(o),search_service_1.default.searchInStockProducts(o),search_service_1.default.searchPOProducts(o)).spread((e,r,a)=>{let s="resp="+JSON.stringify(e,null,2)+"<br><br>";if(s+="resp2="+JSON.stringify(r,null,2)+"<br><br>",s+="resp3="+JSON.stringify(a,null,2),!(e.status&&e.data&&r.status&&r.data&&a.status&&a.data))throw new Error("Failed to retrieve some information: "+e.errMessage||r.errMessage||a.errMessage);t.locals.inStockProducts=r.data.products,t.locals.poProducts=a.data.products,t.locals.searchQuery=o,t.render("search")})}),this.routeGet("/",(e,t,r)=>{log.verbose(TAG,"/.GET()"),t.locals.currentPOProductPage=e.query["po-products-page"]||1,t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1;Promise.join(local_shop_service_1.default.getPromotions(),local_shop_service_1.default.getInStockProducts({pageIndex:t.locals.currentInStockProductPage-1,pageSize:9}),local_shop_service_1.default.getPOProducts({pageIndex:t.locals.currentPOProductPage-1,pageSize:9})).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw new Error("Failed to retrieve some information: "+e.errMessage||r.errMessage||o.errMessage);t.locals.inStockProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,9),t.locals.poProductTotalPage=Utils.getNumberOfPage(o.data.totalProducts,9),t.locals.promotions=e.data.slice(0,2),t.locals.smallPromotions=e.data.slice(2,e.data.length),t.locals.inStockProducts=r.data.products,t.locals.poProducts=o.data.products,t.render("home")}).catch(r)}),this.routeGet("/:categoryId/*/:subCategoryId/*/:productId/*/",(e,t,r)=>{log.verbose(TAG,"/:categoryId/*/:subCategoryId/*/:productId/*/.GET()");e.params.categoryId,e.params.subCategoryId;const o=e.params.productId;Promise.join(local_shop_service_1.default.getInStockProduct(o),local_shop_service_1.default.getPOProduct(o)).spread((e,r)=>{e.status?(t.locals.product=e.data,log.verbose(TAG,"product="+JSON.stringify(e.data)),t.render("instock-product")):r.status?(t.locals.product=r.data,log.verbose(TAG,"product="+JSON.stringify(r.data)),t.render("po-product")):t.render("product-unavailable")}).catch(e=>{r(e)})}),this.routeGet("/:categoryId/*/:subCategoryId/*/",(e,t,r)=>{log.verbose(TAG,"/:categoryId/*/:subCategoryId/*/.GET()");const o=e.params.subCategoryId;t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1,t.locals.currentPOProductPage=e.query["po-products-page"]||1;Promise.join(local_shop_service_1.default.getInStockProducts({subCategoryId:o}),local_shop_service_1.default.getPOProducts({subCategoryId:o}),product_service_1.default.getSubCategory(o)).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw console.dir("resp1="+JSON.stringify(e)),console.dir("resp2="+JSON.stringify(r)),console.dir("resp3="+JSON.stringify(o)),new Error("Failed to retrieve inStockProducts, poProducts, or subCategory: "+(e.errMessage||r.errMessage||o.errMessage));t.locals.inStockProductTotalPage=Utils.getNumberOfPage(e.data.totalProducts,15),t.locals.poProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,15),t.locals.inStockProducts=e.data.products,t.locals.poProducts=r.data.products,t.locals.subCategory=o.data,t.locals.category=o.data.category,t.render("sub-category")}).catch(e=>{r(e)})}),this.routeGet("/:categoryId/*/",(e,t,r)=>{log.verbose(TAG,"/:categoryId/*/.GET()");const o=e.params.categoryId;t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1,t.locals.currentPOProductPage=e.query["po-products-page"]||1;log.verbose(TAG,"/:categoryId/*.GET: req.params="+JSON.stringify(e.params)),Promise.join(local_shop_service_1.default.getInStockProducts({categoryId:o,pageSize:15,pageIndex:t.locals.currentInStockProductPage-1}),local_shop_service_1.default.getPOProducts({categoryId:o,pageSize:15,pageIndex:t.locals.currentPOProductPage-1}),product_service_1.default.getCategory(o)).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw new Error("Failed to retrieve inStockProducts, poProducts, or subCategory: "+e.errMessage||r.errMessage||o.errMessage);t.locals.inStockProductTotalPage=Utils.getNumberOfPage(e.data.totalProducts,15),t.locals.poProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,15),t.locals.inStockProducts=e.data.products,t.locals.poProducts=r.data.products,t.locals.category=o.data,t.render("category")}).catch(e=>{r(e)})})}}exports.default=CartController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvc2hvcC9zaG9wLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJiYXNlX2NvbnRyb2xsZXJfMSIsImxvY2FsX3Nob3Bfc2VydmljZV8xIiwicHJvZHVjdF9zZXJ2aWNlXzEiLCJVdGlscyIsInNlYXJjaF9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwiVEFHIiwiQ2FydENvbnRyb2xsZXIiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwic2l0ZURhdGEiLCJzdXBlciIsIk9iamVjdCIsImFzc2lnbiIsInZpZXdQYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsInRoaXMiLCJhZGRJbnRlcmNlcHRvciIsInJlcSIsInJlcyIsIm5leHQiLCJnZXRDYXRlZ29yaWVzIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJkYXRhIiwiRXJyb3IiLCJlcnJNZXNzYWdlIiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJsb2NhbHMiLCJjYXRlZ29yaWVzIiwiY2F0Y2giLCJlcnIiLCJyb3V0ZUdldCIsInZlcmJvc2UiLCJxdWVyeSIsInNlYXJjaFN1YkNhdGVnb3JpZXMiLCJzZWFyY2hJblN0b2NrUHJvZHVjdHMiLCJzZWFyY2hQT1Byb2R1Y3RzIiwic3ByZWFkIiwicmVzcDIiLCJyZXNwMyIsIkpTT04iLCJzdHJpbmdpZnkiLCJpblN0b2NrUHJvZHVjdHMiLCJwcm9kdWN0cyIsInBvUHJvZHVjdHMiLCJzZWFyY2hRdWVyeSIsInJlbmRlciIsImN1cnJlbnRQT1Byb2R1Y3RQYWdlIiwiY3VycmVudEluU3RvY2tQcm9kdWN0UGFnZSIsImdldFByb21vdGlvbnMiLCJnZXRJblN0b2NrUHJvZHVjdHMiLCJwYWdlSW5kZXgiLCJwYWdlU2l6ZSIsImdldFBPUHJvZHVjdHMiLCJyZXNwNCIsImluU3RvY2tQcm9kdWN0VG90YWxQYWdlIiwiZ2V0TnVtYmVyT2ZQYWdlIiwidG90YWxQcm9kdWN0cyIsInBvUHJvZHVjdFRvdGFsUGFnZSIsInByb21vdGlvbnMiLCJzbGljZSIsInNtYWxsUHJvbW90aW9ucyIsImxlbmd0aCIsInBhcmFtcyIsImNhdGVnb3J5SWQiLCJzdWJDYXRlZ29yeUlkIiwicHJvZHVjdElkIiwiZ2V0SW5TdG9ja1Byb2R1Y3QiLCJnZXRQT1Byb2R1Y3QiLCJyZXNwMSIsInByb2R1Y3QiLCJnZXRTdWJDYXRlZ29yeSIsImNvbnNvbGUiLCJkaXIiLCJzdWJDYXRlZ29yeSIsImNhdGVnb3J5IiwiZ2V0Q2F0ZWdvcnkiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBQUEsTUFBQUEsUUFBQUMsUUFBQSxZQUNBQyxrQkFBQUQsUUFBQSxzQkFFQUUscUJBQUFGLFFBQUEsZ0RBQ0FHLGtCQUFBSCxRQUFBLHFDQUNBSSxNQUFBSixRQUFBLHVCQUNBSyxpQkFBQUwsUUFBQSxvQ0FFTU0sS0FBT04sUUFBUSxRQUVyQixJQUFJTyxJQUFNUCxRQUFRLFVBRWxCLE1BQU1RLElBQU0sdUJBRVpDLHVCQUE0Q1Isa0JBQUFTLFFBQzFDQyxZQUFhQyxHQUNYQyxNQUFNQyxPQUFPQyxPQUFPSCxHQUFZSSxTQUFVVixLQUFLVyxLQUFLQyxVQUFXLGtCQUMvREMsS0FBS0MsZUFBZSxDQUFDQyxFQUFLQyxFQUFLQyxLQUM3QnBCLGtCQUFBTyxRQUFlYyxrQkFBa0IsR0FBTUMsS0FBS0MsSUFDMUMsSUFBSUEsRUFBS0MsU0FBVUQsRUFBS0UsS0FPdEIsTUFBTSxJQUFJQyxNQUFNLGtDQUFvQ0gsRUFBS0ksWUFOekRoQixPQUFPaUIsS0FBSzNCLE9BQU80QixRQUFRQyxJQUN6QlgsRUFBSVksT0FBT0QsR0FBTzdCLE1BQU02QixLQUUxQlgsRUFBSVksT0FBT0MsV0FBYVQsRUFBS0UsS0FDN0JMLE1BSURhLE1BQU1DLElBQ1BkLEVBQUtjLE9BSVRsQixLQUFLbUIsU0FBUyxVQUFXLENBQUNqQixFQUFLQyxFQUFLQyxLQUNsQ2hCLElBQUlnQyxRQUFRL0IsSUFBSyxpQkFDakIsTUFBTWdDLEVBQVFuQixFQUFJbUIsTUFBTUEsTUFF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TzRCLHdCQUEwQjFELE1BQU0yRCxnQkFBZ0JhLEVBQU1oRCxLQUFLb0MsY0FoQjNDLElBaUIzQjFDLEVBQUlZLE9BQU8rQixtQkFBcUI3RCxNQUFNMkQsZ0JBQWdCbEIsRUFBTWpCLEtBQUtvQyxjQWhCM0MsSUFpQnRCMUMsRUFBSVksT0FBT2UsZ0JBQWtCMkIsRUFBTWhELEtBQUtzQixTQUN4QzVCLEVBQUlZLE9BQU9pQixXQUFhTixFQUFNakIsS0FBS3NCLFNBQ25DNUIsRUFBSVksT0FBT2dELFNBQVdwQyxFQUFNbEIsS0FDNUJOLEVBQUkrQixPQUFPLGNBSVpqQixNQUFNQyxJQUNQZCxFQUFLYyxRQXpMYitDLFFBQUExRSxRQUFBRCIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvc2hvcC9zaG9wLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IEJhc2VDb250cm9sbGVyIGZyb20gJy4uL2Jhc2UtY29udHJvbGxlcidcbmltcG9ydCB7IFNpdGVEYXRhIH0gZnJvbSAnLi4vLi4vLi4vc2l0ZS1kZWZpbml0aW9ucydcbmltcG9ydCBMb2NhbFNob3BTZXJ2aWNlIGZyb20gJy4uLy4uL2xvY2FsLXNob3Atc2VydmljZXMvbG9jYWwtc2hvcC1zZXJ2aWNlJ1xuaW1wb3J0IFByb2R1Y3RTZXJ2aWNlIGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL3Byb2R1Y3Qtc2VydmljZSdcbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJy4uLy4uLy4uL2xpYnMvdXRpbHMnXG5pbXBvcnQgU2VhcmNoU2VydmljZSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9zZWFyY2gtc2VydmljZSdcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcblxuY29uc3QgVEFHID0gJ01haW5Db250cm9sbGVyJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYXJ0Q29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKHNpdGVEYXRhOiBTaXRlRGF0YSkge1xuICAgIHN1cGVyKE9iamVjdC5hc3NpZ24oc2l0ZURhdGEsIHsgdmlld1BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi92aWV3cycpIH0pKVxuICAgIHRoaXMuYWRkSW50ZXJjZXB0b3IoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBQcm9kdWN0U2VydmljZS5nZXRDYXRlZ29yaWVzKHt9LCB0cnVlKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgT2JqZWN0LmtleXMoVXRpbHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIHJlcy5sb2NhbHNba2V5XSA9IFV0aWxzW2tleV1cbiAgICAgICAgICB9KVxuICAgICAgICAgIHJlcy5sb2NhbHMuY2F0ZWdvcmllcyA9IHJlc3AuZGF0YVxuICAgICAgICAgIG5leHQoKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGNhdGVnb3JpZXM6ICcgKyByZXNwLmVyck1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZUdldCgnL3NlYXJjaCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnL3NlYXJjaC5HRVQoKScpXG4gICAgICBjb25zdCBxdWVyeSA9IHJlcS5xdWVyeS5xdWVyeVxuXG4gICAgICBQcm9taXNlLmpvaW48YW55PihcbiAgICAgICAgU2VhcmNoU2VydmljZS5zZWFyY2hTdWJDYXRlZ29yaWVzKHF1ZXJ5KSxcbiAgICAgICAgU2VhcmNoU2VydmljZS5zZWFyY2hJblN0b2NrUHJvZHVjdHMocXVlcnkpLFxuICAgICAgICBTZWFyY2hTZXJ2aWNlLnNlYXJjaFBPUHJvZHVjdHMocXVlcnkpXG4gICAgICApLnNwcmVhZCgocmVzcDogTkNSZXNwb25zZTxTdWJDYXRlZ29yeVtdPixcbiAgICAgICAgICAgICAgICByZXNwMjogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLHRvdGFsUHJvZHVjdHM6IG51bWJlciB9PixcbiAgICAgICAgICAgICAgICByZXNwMzogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBQT1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyIH0+KSA9PiB7XG4gICAgICAgIGxldCBkYXRhID0gJ3Jlc3A9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AsIG51bGwsIDIpICsgJzxicj48YnI+J1xuICAgICAgICBkYXRhICs9ICdyZXNwMj0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDIsIG51bGwsIDIpICsgJzxicj48YnI+J1xuICAgICAgICBkYXRhICs9ICdyZXNwMz0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDMsIG51bGwsIDIpXG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmXG4gICAgICAgICAgICByZXNwMy5zdGF0dXMgJiYgcmVzcDMuZGF0YSkge1xuICAgICAgICAgIHJlcy5sb2NhbHMuaW5TdG9ja1Byb2R1Y3RzID0gcmVzcDIuZGF0YS5wcm9kdWN0c1xuICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0cyA9IHJlc3AzLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICByZXMubG9jYWxzLnNlYXJjaFF1ZXJ5ID0gcXVlcnlcbiAgICAgICAgICByZXMucmVuZGVyKCdzZWFyY2gnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHNvbWUgaW5mb3JtYXRpb246ICcgKyByZXNwLmVyck1lc3NhZ2UgfHwgcmVzcDIuZXJyTWVzc2FnZSB8fCByZXNwMy5lcnJNZXNzYWdlKVxuICAgICAgICB9XG5cbiAgICAgICAgLyogcmVzLnNlbmQoZGF0YSkgKi9cbiAgICAgIH0pXG4gICAgfSlcblxuICAgIC8vIExhbmRpbmcgcGFnZVxuICAgIC8vIFRoZSBtYWluIHZpZXcgd2hlcmUgd2Ugc2hvdyBwcm9tb3RlZCBpdGVtcywgY2F0ZWdvcmllcyAmIHN1YnMsIGFuZCBsYXRlc3QgcHJvZHVjdHNcbiAgICAvLyBUT0RPOlxuICAgIC8vIDEuIFNob3cgbGF0ZXN0IHByb2R1Y3RzIGluc3RlYWQgb2YgYWxsIHByb2R1Y3RzXG4gICAgdGhpcy5yb3V0ZUdldCgnLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnLy5HRVQoKScpXG4gICAgICByZXMubG9jYWxzLmN1cnJlbnRQT1Byb2R1Y3RQYWdlID0gcmVxLnF1ZXJ5Wydwby1wcm9kdWN0cy1wYWdlJ10gfHwgMVxuICAgICAgcmVzLmxvY2Fscy5jdXJyZW50SW5TdG9ja1Byb2R1Y3RQYWdlID0gcmVxLnF1ZXJ5Wydpbi1zdG9jay1wcm9kdWN0cy1wYWdlJ10gfHwgMVxuICAgICAgY29uc3QgaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSA9IDlcbiAgICAgIGNvbnN0IHBvUHJvZHVjdFBhZ2VTaXplID0gOVxuXG4gICAgICBQcm9taXNlLmpvaW48TkNSZXNwb25zZTxhbnk+PihcbiAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRQcm9tb3Rpb25zKCksXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgcGFnZUluZGV4OiByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgLSAxLCBwYWdlU2l6ZTogaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSB9KSxcbiAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRQT1Byb2R1Y3RzKHsgcGFnZUluZGV4OiByZXMubG9jYWxzLmN1cnJlbnRQT1Byb2R1Y3RQYWdlIC0gMSwgcGFnZVNpemU6IHBvUHJvZHVjdFBhZ2VTaXplIH0pXG4gICAgICApLnNwcmVhZCgocmVzcDogTkNSZXNwb25zZTxQcm9tb3Rpb25bXT4sXG4gICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8e3Byb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXJ9PixcbiAgICAgICAgICAgICAgICByZXNwNDogTkNSZXNwb25zZTx7cHJvZHVjdHM6IFBPUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXJ9PikgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhICYmXG4gICAgICAgICAgICByZXNwMy5zdGF0dXMgJiYgcmVzcDMuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDQuc3RhdHVzICYmIHJlc3A0LmRhdGEpIHtcbiAgICAgICAgICAvLyAyIHNwb3RzIGZvciBsYXJnZXIgcHJvbW90aW9uIGJhbm5lciwgdGhlIHJlc3QgaXMgcmVndWxhciBwcm9tb3Rpb25zXG4gICAgICAgICAgcmVzLmxvY2Fscy5pblN0b2NrUHJvZHVjdFRvdGFsUGFnZSA9IFV0aWxzLmdldE51bWJlck9mUGFnZShyZXNwMy5kYXRhLnRvdGFsUHJvZHVjdHMsIGluU3RvY2tQcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDQuZGF0YS50b3RhbFByb2R1Y3RzLCBwb1Byb2R1Y3RQYWdlU2l6ZSlcbiAgICAgICAgICByZXMubG9jYWxzLnByb21vdGlvbnMgPSByZXNwLmRhdGEuc2xpY2UoMCwgMilcbiAgICAgICAgICByZXMubG9jYWxzLnNtYWxsUHJvbW90aW9ucyA9IHJlc3AuZGF0YS5zbGljZSgyLCByZXNwLmRhdGEubGVuZ3RoKVxuICAgICAgICAgIHJlcy5sb2NhbHMuaW5TdG9ja1Byb2R1Y3RzID0gcmVzcDMuZGF0YS5wcm9kdWN0c1xuICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0cyA9IHJlc3A0LmRhdGEucHJvZHVjdHNcbiAgICAgICAgICByZXMucmVuZGVyKCdob21lJylcbiAgICAgICAgICAvLyByZXMuc2VuZCgnaGFoYScpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgc29tZSBpbmZvcm1hdGlvbjogJyArXG4gICAgICAgICAgICAgICAgcmVzcC5lcnJNZXNzYWdlIHx8IHJlc3AzLmVyck1lc3NhZ2UgfHwgcmVzcDQuZXJyTWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2gobmV4dClcbiAgICB9KVxuXG4gICAgLy8gUHJvZHVjdCBwYWdlXG4gICAgLy8gSW5mb3JtYXRpb24gcmVsYXRlZCB0byBhIHNwZWNpZmljIHByb2R1Y3QsIGN1c3RvbWVyIGNhbiBvcmRlciBoZXJlXG4gICAgdGhpcy5yb3V0ZUdldCgnLzpjYXRlZ29yeUlkLyovOnN1YkNhdGVnb3J5SWQvKi86cHJvZHVjdElkLyovJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsICcvOmNhdGVnb3J5SWQvKi86c3ViQ2F0ZWdvcnlJZC8qLzpwcm9kdWN0SWQvKi8uR0VUKCknKVxuICAgICAgY29uc3QgY2F0ZWdvcnlJZCA9IHJlcS5wYXJhbXMuY2F0ZWdvcnlJZFxuICAgICAgY29uc3Qgc3ViQ2F0ZWdvcnlJZCA9IHJlcS5wYXJhbXMuc3ViQ2F0ZWdvcnlJZFxuICAgICAgY29uc3QgcHJvZHVjdElkID0gcmVxLnBhcmFtcy5wcm9kdWN0SWRcblxuICAgICAgUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3QocHJvZHVjdElkKSxcbiAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRQT1Byb2R1Y3QocHJvZHVjdElkKVxuICAgICAgKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPEluU3RvY2tQcm9kdWN0PiwgcmVzcDI6IE5DUmVzcG9uc2U8UE9Qcm9kdWN0PikgPT4ge1xuICAgICAgICBpZiAocmVzcDEuc3RhdHVzKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy5wcm9kdWN0ID0gcmVzcDEuZGF0YVxuICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3Byb2R1Y3Q9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AxLmRhdGEpKVxuICAgICAgICAgIHJlcy5yZW5kZXIoJ2luc3RvY2stcHJvZHVjdCcpXG4gICAgICAgIH0gZWxzZSBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy5wcm9kdWN0ID0gcmVzcDIuZGF0YVxuICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3Byb2R1Y3Q9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AyLmRhdGEpKVxuICAgICAgICAgIHJlcy5yZW5kZXIoJ3BvLXByb2R1Y3QnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8qIG5leHQobmV3IEVycm9yKCdQcm9kdWN0IHdpdGggaWQ9JyArIHByb2R1Y3RJZCArICcgaXMgbm90IGZvdW5kIScpKSAqL1xuICAgICAgICAgIC8vIFRPRE86IHJlbmRlciBcIm1hYWYgcHJvZHVrIGluaSBzZWRhbmcgdGlkYWsgdGVyc2VkaWFcIlxuICAgICAgICAgIHJlcy5yZW5kZXIoJ3Byb2R1Y3QtdW5hdmFpbGFibGUnKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIC8vIFN1Yi1jYXRlZ29yeSBwYWdlXG4gICAgdGhpcy5yb3V0ZUdldCgnLzpjYXRlZ29yeUlkLyovOnN1YkNhdGVnb3J5SWQvKi8nLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJy86Y2F0ZWdvcnlJZC8qLzpzdWJDYXRlZ29yeUlkLyovLkdFVCgpJylcbiAgICAgIGNvbnN0IHN1YkNhdGVnb3J5SWQgPSByZXEucGFyYW1zLnN1YkNhdGVnb3J5SWRcbiAgICAgIHJlcy5sb2NhbHMuY3VycmVudEluU3RvY2tQcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsnaW4tc3RvY2stcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgIHJlcy5sb2NhbHMuY3VycmVudFBPUHJvZHVjdFBhZ2UgPSByZXEucXVlcnlbJ3BvLXByb2R1Y3RzLXBhZ2UnXSB8fCAxXG4gICAgICBjb25zdCBpblN0b2NrUHJvZHVjdFBhZ2VTaXplID0gMTVcbiAgICAgIGNvbnN0IHBvUHJvZHVjdFBhZ2VTaXplID0gMTVcblxuICAgICAgUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgc3ViQ2F0ZWdvcnlJZCB9KSxcbiAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRQT1Byb2R1Y3RzKHsgc3ViQ2F0ZWdvcnlJZCB9KSxcbiAgICAgICAgUHJvZHVjdFNlcnZpY2UuZ2V0U3ViQ2F0ZWdvcnkoc3ViQ2F0ZWdvcnlJZClcbiAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4sXG4gICAgICAgICAgICAgICAgcmVzcDI6IE5DUmVzcG9uc2U8eyBwcm9kdWN0czogUE9Qcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlciB9PixcbiAgICAgICAgICAgICAgICByZXNwMzogTkNSZXNwb25zZTxTdWJDYXRlZ29yeT4pID0+IHtcbiAgICAgICAgaWYgKHJlc3AxLnN0YXR1cyAmJiByZXNwMS5kYXRhICYmXG4gICAgICAgICAgICByZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDMuc3RhdHVzICYmIHJlc3AzLmRhdGEpIHtcbiAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0VG90YWxQYWdlID0gVXRpbHMuZ2V0TnVtYmVyT2ZQYWdlKHJlc3AxLmRhdGEudG90YWxQcm9kdWN0cywgaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSlcbiAgICAgICAgICByZXMubG9jYWxzLnBvUHJvZHVjdFRvdGFsUGFnZSA9IFV0aWxzLmdldE51bWJlck9mUGFnZShyZXNwMi5kYXRhLnRvdGFsUHJvZHVjdHMsIHBvUHJvZHVjdFBhZ2VTaXplKVxuICAgICAgICAgIHJlcy5sb2NhbHMuaW5TdG9ja1Byb2R1Y3RzID0gcmVzcDEuZGF0YS5wcm9kdWN0c1xuICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0cyA9IHJlc3AyLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICByZXMubG9jYWxzLnN1YkNhdGVnb3J5ID0gcmVzcDMuZGF0YVxuICAgICAgICAgIHJlcy5sb2NhbHMuY2F0ZWdvcnkgPSByZXNwMy5kYXRhLmNhdGVnb3J5XG4gICAgICAgICAgcmVzLnJlbmRlcignc3ViLWNhdGVnb3J5JylcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmRpcigncmVzcDE9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AxKSlcbiAgICAgICAgICBjb25zb2xlLmRpcigncmVzcDI9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AyKSlcbiAgICAgICAgICBjb25zb2xlLmRpcigncmVzcDM9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AzKSlcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBpblN0b2NrUHJvZHVjdHMsIHBvUHJvZHVjdHMsIG9yIHN1YkNhdGVnb3J5OiAnICsgKHJlc3AxLmVyck1lc3NhZ2UgfHwgcmVzcDIuZXJyTWVzc2FnZSB8fCByZXNwMy5lcnJNZXNzYWdlKSlcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICAvLyBDYXRlZ29yeSBwYWdlXG4gICAgLy8gTk9URTogQmVjYXVzZSB0aGlzIHJvdXRlIHBhdGggaXMgYSAnc3VwZXItcGF0aCcgb2Ygc3ViLWNhdGVnb3J5IHBhZ2UsIHRoaXMgaGFzIHRvIGJlIGRlZmluZWQgbGF0ZXJcbiAgICB0aGlzLnJvdXRlR2V0KCcvOmNhdGVnb3J5SWQvKi8nLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJy86Y2F0ZWdvcnlJZC8qLy5HRVQoKScpXG4gICAgICBjb25zdCBjYXRlZ29yeUlkID0gcmVxLnBhcmFtcy5jYXRlZ29yeUlkXG4gICAgICByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgPSByZXEucXVlcnlbJ2luLXN0b2NrLXByb2R1Y3RzLXBhZ2UnXSB8fCAxXG4gICAgICByZXMubG9jYWxzLmN1cnJlbnRQT1Byb2R1Y3RQYWdlID0gcmVxLnF1ZXJ5Wydwby1wcm9kdWN0cy1wYWdlJ10gfHwgMVxuICAgICAgY29uc3QgaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSA9IDE1XG4gICAgICBjb25zdCBwb1Byb2R1Y3RQYWdlU2l6ZSA9IDE1XG5cbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJy86Y2F0ZWdvcnlJZC8qLkdFVDogcmVxLnBhcmFtcz0nICsgSlNPTi5zdHJpbmdpZnkocmVxLnBhcmFtcykpXG4gICAgICBQcm9taXNlLmpvaW48TkNSZXNwb25zZTxhbnk+PihcbiAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRJblN0b2NrUHJvZHVjdHMoeyBjYXRlZ29yeUlkLCBwYWdlU2l6ZTogaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSxcbiAgICAgICAgICBwYWdlSW5kZXg6IHJlcy5sb2NhbHMuY3VycmVudEluU3RvY2tQcm9kdWN0UGFnZSAtIDEgfSksXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UE9Qcm9kdWN0cyh7IGNhdGVnb3J5SWQsIHBhZ2VTaXplOiBwb1Byb2R1Y3RQYWdlU2l6ZSxcbiAgICAgICAgICBwYWdlSW5kZXg6IHJlcy5sb2NhbHMuY3VycmVudFBPUHJvZHVjdFBhZ2UgLSAxIH0pLFxuICAgICAgICBQcm9kdWN0U2VydmljZS5nZXRDYXRlZ29yeShjYXRlZ29yeUlkKVxuICAgICAgKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPHsgcHJvZHVjdHM6IEluU3RvY2tQcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlcn0+LFxuICAgICAgICAgICAgICAgIHJlc3AyOiBOQ1Jlc3BvbnNlPHsgcHJvZHVjdHM6IFBPUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4sXG4gICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8Q2F0ZWdvcnk+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwMS5zdGF0dXMgJiYgcmVzcDEuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3AzLnN0YXR1cyAmJiByZXNwMy5kYXRhKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy5pblN0b2NrUHJvZHVjdFRvdGFsUGFnZSA9IFV0aWxzLmdldE51bWJlck9mUGFnZShyZXNwMS5kYXRhLnRvdGFsUHJvZHVjdHMsIGluU3RvY2tQcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDIuZGF0YS50b3RhbFByb2R1Y3RzLCBwb1Byb2R1Y3RQYWdlU2l6ZSlcbiAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0cyA9IHJlc3AxLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICByZXMubG9jYWxzLnBvUHJvZHVjdHMgPSByZXNwMi5kYXRhLnByb2R1Y3RzXG4gICAgICAgICAgcmVzLmxvY2Fscy5jYXRlZ29yeSA9IHJlc3AzLmRhdGFcbiAgICAgICAgICByZXMucmVuZGVyKCdjYXRlZ29yeScpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgaW5TdG9ja1Byb2R1Y3RzLCBwb1Byb2R1Y3RzLCBvciBzdWJDYXRlZ29yeTogJyArIHJlc3AxLmVyck1lc3NhZ2UgfHwgcmVzcDIuZXJyTWVzc2FnZSB8fCByZXNwMy5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuIl19
