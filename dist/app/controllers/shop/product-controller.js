"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),base_controller_1=require("../base-controller"),local_shop_service_1=require("../../local-shop-services/local-shop-service"),product_service_1=require("../../../services/product-service"),Utils=require("../../../libs/utils"),path=require("path");let log=require("npmlog");const TAG="MainController";class CartController extends base_controller_1.default{constructor(e){super(Object.assign(e,{viewPath:path.join(__dirname,"../../views")})),this.addInterceptor((e,t,r)=>{product_service_1.default.getCategories({},!0).then(e=>{if(!e.status||!e.data)throw new Error("Failed to retrieve categories: "+e.errMessage);Object.keys(Utils).forEach(e=>{t.locals[e]=Utils[e]}),t.locals.categories=e.data,r()}).catch(e=>{r(e)})}),this.routeGet("/search",(e,t,r)=>{log.verbose(TAG,"/search.GET()")}),this.routeGet("/",(e,t,r)=>{log.verbose(TAG,"/.GET()"),t.locals.currentPOProductPage=e.query["po-products-page"]||1,t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1;Promise.join(local_shop_service_1.default.getPromotions(),local_shop_service_1.default.getInStockProducts({pageIndex:t.locals.currentInStockProductPage-1,pageSize:9}),local_shop_service_1.default.getPOProducts({pageIndex:t.locals.currentPOProductPage-1,pageSize:9})).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw new Error("Failed to retrieve some information: "+e.errMessage||r.errMessage||o.errMessage);t.locals.inStockProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,9),t.locals.poProductTotalPage=Utils.getNumberOfPage(o.data.totalProducts,9),t.locals.promotions=e.data.slice(0,2),t.locals.smallPromotions=e.data.slice(2,e.data.length),t.locals.inStockProducts=r.data.products,t.locals.poProducts=o.data.products,t.render("home")}).catch(r)}),this.routeGet("/:categoryId/*/:subCategoryId/*/:productId/*/",(e,t,r)=>{log.verbose(TAG,"/:categoryId/*/:subCategoryId/*/:productId/*/.GET()");e.params.categoryId,e.params.subCategoryId;const o=e.params.productId;Promise.join(local_shop_service_1.default.getInStockProduct(o),local_shop_service_1.default.getPOProduct(o)).spread((e,r)=>{e.status?(t.locals.product=e.data,log.verbose(TAG,"product="+JSON.stringify(e.data)),t.render("instock-product")):r.status?(t.locals.product=r.data,log.verbose(TAG,"product="+JSON.stringify(r.data)),t.render("po-product")):t.render("product-unavailable")}).catch(e=>{r(e)})}),this.routeGet("/:categoryId/*/:subCategoryId/*/",(e,t,r)=>{log.verbose(TAG,"/:categoryId/*/:subCategoryId/*/.GET()");const o=e.params.subCategoryId;t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1,t.locals.currentPOProductPage=e.query["po-products-page"]||1;Promise.join(local_shop_service_1.default.getInStockProducts({subCategoryId:o}),local_shop_service_1.default.getPOProducts({subCategoryId:o}),product_service_1.default.getSubCategory(o)).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw console.dir("resp1="+JSON.stringify(e)),console.dir("resp2="+JSON.stringify(r)),console.dir("resp3="+JSON.stringify(o)),new Error("Failed to retrieve inStockProducts, poProducts, or subCategory: "+(e.errMessage||r.errMessage||o.errMessage));t.locals.inStockProductTotalPage=Utils.getNumberOfPage(e.data.totalProducts,15),t.locals.poProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,15),t.locals.inStockProducts=e.data.products,t.locals.poProducts=r.data.products,t.locals.subCategory=o.data,t.locals.category=o.data.category,t.render("sub-category")}).catch(e=>{r(e)})}),this.routeGet("/:categoryId/*/",(e,t,r)=>{log.verbose(TAG,"/:categoryId/*/.GET()");const o=e.params.categoryId;t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1,t.locals.currentPOProductPage=e.query["po-products-page"]||1;log.verbose(TAG,"/:categoryId/*.GET: req.params="+JSON.stringify(e.params)),Promise.join(local_shop_service_1.default.getInStockProducts({categoryId:o,pageSize:15,pageIndex:t.locals.currentInStockProductPage-1}),local_shop_service_1.default.getPOProducts({categoryId:o,pageSize:15,pageIndex:t.locals.currentPOProductPage-1}),product_service_1.default.getCategory(o)).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw new Error("Failed to retrieve inStockProducts, poProducts, or subCategory: "+e.errMessage||r.errMessage||o.errMessage);t.locals.inStockProductTotalPage=Utils.getNumberOfPage(e.data.totalProducts,15),t.locals.poProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,15),t.locals.inStockProducts=e.data.products,t.locals.poProducts=r.data.products,t.locals.category=o.data,t.render("category")}).catch(e=>{r(e)})})}}exports.default=CartController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvc2hvcC9wcm9kdWN0LWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJiYXNlX2NvbnRyb2xsZXJfMSIsImxvY2FsX3Nob3Bfc2VydmljZV8xIiwicHJvZHVjdF9zZXJ2aWNlXzEiLCJVdGlscyIsInBhdGgiLCJsb2ciLCJUQUciLCJDYXJ0Q29udHJvbGxlciIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJzaXRlRGF0YSIsInN1cGVyIiwiT2JqZWN0IiwiYXNzaWduIiwidmlld1BhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwidGhpcyIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsImdldENhdGVnb3JpZXMiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsImRhdGEiLCJFcnJvciIsImVyck1lc3NhZ2UiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsImxvY2FscyIsImNhdGVnb3JpZXMiLCJjYXRjaCIsImVyciIsInJvdXRlR2V0IiwidmVyYm9zZSIsImN1cnJlbnRQT1Byb2R1Y3RQYWdlIiwicXVlcnkiLCJjdXJyZW50SW5TdG9ja1Byb2R1Y3RQYWdlIiwiZ2V0UHJvbW90aW9ucyIsImdldEluU3RvY2tQcm9kdWN0cyIsInBhZ2VJbmRleCIsInBhZ2VTaXplIiwiZ2V0UE9Qcm9kdWN0cyIsInNwcmVhZCIsInJlc3AzIiwicmVzcDQiLCJpblN0b2NrUHJvZHVjdFRvdGFsUGFnZSIsImdldE51bWJlck9mUGFnZSIsInRvdGFsUHJvZHVjdHMiLCJwb1Byb2R1Y3RUb3RhbFBhZ2UiLCJwcm9tb3Rpb25zIiwic2xpY2UiLCJzbWFsbFByb21vdGlvbnMiLCJsZW5ndGgiLCJpblN0b2NrUHJvZHVjdHMiLCJwcm9kdWN0cyIsInBvUHJvZHVjdHMiLCJyZW5kZXIiLCJwYXJhbXMiLCJjYXRlZ29yeUlkIiwic3ViQ2F0ZWdvcnlJZCIsInByb2R1Y3RJZCIsImdldEluU3RvY2tQcm9kdWN0IiwiZ2V0UE9Qcm9kdWN0IiwicmVzcDEiLCJyZXNwMiIsInByb2R1Y3QiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0U3ViQ2F0ZWdvcnkiLCJjb25zb2xlIiwiZGlyIiwic3ViQ2F0ZWdvcnkiLCJjYXRlZ29yeSIsImdldENhdGVnb3J5IiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFDQUMsa0JBQUFELFFBQUEsc0JBRUFFLHFCQUFBRixRQUFBLGdEQUNBRyxrQkFBQUgsUUFBQSxxQ0FDQUksTUFBQUosUUFBQSx1QkFFTUssS0FBT0wsUUFBUSxRQUVyQixJQUFJTSxJQUFNTixRQUFRLFVBRWxCLE1BQU1PLElBQU0sdUJBRVpDLHVCQUE0Q1Asa0JBQUFRLFFBQzFDQyxZQUFhQyxHQUNYQyxNQUFNQyxPQUFPQyxPQUFPSCxHQUFZSSxTQUFVVixLQUFLVyxLQUFLQyxVQUFXLGtCQUUvREMsS0FBS0MsZUFBZSxDQUFDQyxFQUFLQyxFQUFLQyxLQUM3Qm5CLGtCQUFBTSxRQUFlYyxrQkFBa0IsR0FBTUMsS0FBS0MsSUFDMUMsSUFBSUEsRUFBS0MsU0FBVUQsRUFBS0UsS0FPdEIsTUFBTSxJQUFJQyxNQUFNLGtDQUFvQ0gsRUFBS0ksWUFOekRoQixPQUFPaUIsS0FBSzFCLE9BQU8yQixRQUFRQyxJQUN6QlgsRUFBSVksT0FBT0QsR0FBTzVCLE1BQU00QixLQUUxQlgsRUFBSVksT0FBT0MsV0FBYVQsRUFBS0UsS0FDN0JMLE1BSURhLE1BQU1DLElBQ1BkLEVBQUtjLE9BSVRsQixLQUFLbUIsU0FBUyxVQUFXLENBQUNqQixFQUFLQyxFQUFLQyxLQUNsQ2hCLElBQUlnQyxRQUFRL0IsSUFBSyxtQkFRbkJXLEtBQUttQixTQUFTLElBQUssQ0FBQ2pCLEVBQUtDLEVBQUtDLEtBQzVCaEIsSUFBSWdDLFFBQVEvQixJQUFLLFdBQ2pCYyxFQUFJWSxPQUFPTSxxQkFBdUJuQixFQUFJb0IsTUFBTSxxQkFBdUIsRUFDbkVuQixFQUFJWSxPQUFPUSwwQkFBNEJyQixFQUFJ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Q3FCLEVBQ0FDLEVBQ0FyQixLQUNSLEtBQUlvQixFQUFNMUMsUUFBVTBDLEVBQU16QyxNQUN0QjBDLEVBQU0zQyxRQUFVMkMsRUFBTTFDLE1BQ3RCcUIsRUFBTXRCLFFBQVVzQixFQUFNckIsTUFReEIsTUFBTSxJQUFJQyxNQUFNLG1FQUFxRXdDLEVBQU12QyxZQUFjd0MsRUFBTXhDLFlBQWNtQixFQUFNbkIsWUFQbklSLEVBQUlZLE9BQU9pQix3QkFBMEI5QyxNQUFNK0MsZ0JBQWdCaUIsRUFBTXpDLEtBQUt5QixjQWhCM0MsSUFpQjNCL0IsRUFBSVksT0FBT29CLG1CQUFxQmpELE1BQU0rQyxnQkFBZ0JrQixFQUFNMUMsS0FBS3lCLGNBaEIzQyxJQWlCdEIvQixFQUFJWSxPQUFPeUIsZ0JBQWtCVSxFQUFNekMsS0FBS2dDLFNBQ3hDdEMsRUFBSVksT0FBTzJCLFdBQWFTLEVBQU0xQyxLQUFLZ0MsU0FDbkN0QyxFQUFJWSxPQUFPNEMsU0FBVzdCLEVBQU1yQixLQUM1Qk4sRUFBSXdDLE9BQU8sY0FJWjFCLE1BQU1DLElBQ1BkLEVBQUtjLFFBbEtiMkMsUUFBQXRFLFFBQUFEIiwiZmlsZSI6ImFwcC9jb250cm9sbGVycy9zaG9wL3Byb2R1Y3QtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgQmFzZUNvbnRyb2xsZXIgZnJvbSAnLi4vYmFzZS1jb250cm9sbGVyJ1xuaW1wb3J0IHsgU2l0ZURhdGEgfSBmcm9tICcuLi8uLi8uLi9zaXRlLWRlZmluaXRpb25zJ1xuaW1wb3J0IExvY2FsU2hvcFNlcnZpY2UgZnJvbSAnLi4vLi4vbG9jYWwtc2hvcC1zZXJ2aWNlcy9sb2NhbC1zaG9wLXNlcnZpY2UnXG5pbXBvcnQgUHJvZHVjdFNlcnZpY2UgZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvcHJvZHVjdC1zZXJ2aWNlJ1xuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vLi4vLi4vbGlicy91dGlscydcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcblxuY29uc3QgVEFHID0gJ01haW5Db250cm9sbGVyJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYXJ0Q29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKHNpdGVEYXRhOiBTaXRlRGF0YSkge1xuICAgIHN1cGVyKE9iamVjdC5hc3NpZ24oc2l0ZURhdGEsIHsgdmlld1BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi92aWV3cycpIH0pKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIFByb2R1Y3RTZXJ2aWNlLmdldENhdGVnb3JpZXMoe30sIHRydWUpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICBPYmplY3Qua2V5cyhVdGlscykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgcmVzLmxvY2Fsc1trZXldID0gVXRpbHNba2V5XVxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmVzLmxvY2Fscy5jYXRlZ29yaWVzID0gcmVzcC5kYXRhXG4gICAgICAgICAgbmV4dCgpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgY2F0ZWdvcmllczogJyArIHJlc3AuZXJyTWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvc2VhcmNoJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsICcvc2VhcmNoLkdFVCgpJylcblxuICAgIH0pXG5cbiAgICAvLyBMYW5kaW5nIHBhZ2VcbiAgICAvLyBUaGUgbWFpbiB2aWV3IHdoZXJlIHdlIHNob3cgcHJvbW90ZWQgaXRlbXMsIGNhdGVnb3JpZXMgJiBzdWJzLCBhbmQgbGF0ZXN0IHByb2R1Y3RzXG4gICAgLy8gVE9ETzpcbiAgICAvLyAxLiBTaG93IGxhdGVzdCBwcm9kdWN0cyBpbnN0ZWFkIG9mIGFsbCBwcm9kdWN0c1xuICAgIHRoaXMucm91dGVHZXQoJy8nLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJy8uR0VUKCknKVxuICAgICAgcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsncG8tcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgIHJlcy5sb2NhbHMuY3VycmVudEluU3RvY2tQcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsnaW4tc3RvY2stcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgIGNvbnN0IGluU3RvY2tQcm9kdWN0UGFnZVNpemUgPSA5XG4gICAgICBjb25zdCBwb1Byb2R1Y3RQYWdlU2l6ZSA9IDlcblxuICAgICAgUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UHJvbW90aW9ucygpLFxuICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldEluU3RvY2tQcm9kdWN0cyh7IHBhZ2VJbmRleDogcmVzLmxvY2Fscy5jdXJyZW50SW5TdG9ja1Byb2R1Y3RQYWdlIC0gMSwgcGFnZVNpemU6IGluU3RvY2tQcm9kdWN0UGFnZVNpemUgfSksXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UE9Qcm9kdWN0cyh7IHBhZ2VJbmRleDogcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSAtIDEsIHBhZ2VTaXplOiBwb1Byb2R1Y3RQYWdlU2l6ZSB9KVxuICAgICAgKS5zcHJlYWQoKHJlc3A6IE5DUmVzcG9uc2U8UHJvbW90aW9uW10+LFxuICAgICAgICAgICAgICAgIHJlc3AzOiBOQ1Jlc3BvbnNlPHtwcm9kdWN0czogSW5TdG9ja1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyfT4sXG4gICAgICAgICAgICAgICAgcmVzcDQ6IE5DUmVzcG9uc2U8e3Byb2R1Y3RzOiBQT1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyfT4pID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDMuc3RhdHVzICYmIHJlc3AzLmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3A0LnN0YXR1cyAmJiByZXNwNC5kYXRhKSB7XG4gICAgICAgICAgLy8gMiBzcG90cyBmb3IgbGFyZ2VyIHByb21vdGlvbiBiYW5uZXIsIHRoZSByZXN0IGlzIHJlZ3VsYXIgcHJvbW90aW9uc1xuICAgICAgICAgIHJlcy5sb2NhbHMuaW5TdG9ja1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDMuZGF0YS50b3RhbFByb2R1Y3RzLCBpblN0b2NrUHJvZHVjdFBhZ2VTaXplKVxuICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0VG90YWxQYWdlID0gVXRpbHMuZ2V0TnVtYmVyT2ZQYWdlKHJlc3A0LmRhdGEudG90YWxQcm9kdWN0cywgcG9Qcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgcmVzLmxvY2Fscy5wcm9tb3Rpb25zID0gcmVzcC5kYXRhLnNsaWNlKDAsIDIpXG4gICAgICAgICAgcmVzLmxvY2Fscy5zbWFsbFByb21vdGlvbnMgPSByZXNwLmRhdGEuc2xpY2UoMiwgcmVzcC5kYXRhLmxlbmd0aClcbiAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0cyA9IHJlc3AzLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICByZXMubG9jYWxzLnBvUHJvZHVjdHMgPSByZXNwNC5kYXRhLnByb2R1Y3RzXG4gICAgICAgICAgcmVzLnJlbmRlcignaG9tZScpXG4gICAgICAgICAgLy8gcmVzLnNlbmQoJ2hhaGEnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHNvbWUgaW5mb3JtYXRpb246ICcgK1xuICAgICAgICAgICAgICAgIHJlc3AuZXJyTWVzc2FnZSB8fCByZXNwMy5lcnJNZXNzYWdlIHx8IHJlc3A0LmVyck1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIC8vIFByb2R1Y3QgcGFnZVxuICAgIC8vIEluZm9ybWF0aW9uIHJlbGF0ZWQgdG8gYSBzcGVjaWZpYyBwcm9kdWN0LCBjdXN0b21lciBjYW4gb3JkZXIgaGVyZVxuICAgIHRoaXMucm91dGVHZXQoJy86Y2F0ZWdvcnlJZC8qLzpzdWJDYXRlZ29yeUlkLyovOnByb2R1Y3RJZC8qLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnLzpjYXRlZ29yeUlkLyovOnN1YkNhdGVnb3J5SWQvKi86cHJvZHVjdElkLyovLkdFVCgpJylcbiAgICAgIGNvbnN0IGNhdGVnb3J5SWQgPSByZXEucGFyYW1zLmNhdGVnb3J5SWRcbiAgICAgIGNvbnN0IHN1YkNhdGVnb3J5SWQgPSByZXEucGFyYW1zLnN1YkNhdGVnb3J5SWRcbiAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IHJlcS5wYXJhbXMucHJvZHVjdElkXG5cbiAgICAgIFByb21pc2Uuam9pbjxOQ1Jlc3BvbnNlPGFueT4+KFxuICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldEluU3RvY2tQcm9kdWN0KHByb2R1Y3RJZCksXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UE9Qcm9kdWN0KHByb2R1Y3RJZClcbiAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTxJblN0b2NrUHJvZHVjdD4sIHJlc3AyOiBOQ1Jlc3BvbnNlPFBPUHJvZHVjdD4pID0+IHtcbiAgICAgICAgaWYgKHJlc3AxLnN0YXR1cykge1xuICAgICAgICAgIHJlcy5sb2NhbHMucHJvZHVjdCA9IHJlc3AxLmRhdGFcbiAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdwcm9kdWN0PScgKyBKU09OLnN0cmluZ2lmeShyZXNwMS5kYXRhKSlcbiAgICAgICAgICByZXMucmVuZGVyKCdpbnN0b2NrLXByb2R1Y3QnKVxuICAgICAgICB9IGVsc2UgaWYgKHJlc3AyLnN0YXR1cykge1xuICAgICAgICAgIHJlcy5sb2NhbHMucHJvZHVjdCA9IHJlc3AyLmRhdGFcbiAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdwcm9kdWN0PScgKyBKU09OLnN0cmluZ2lmeShyZXNwMi5kYXRhKSlcbiAgICAgICAgICByZXMucmVuZGVyKCdwby1wcm9kdWN0JylcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvKiBuZXh0KG5ldyBFcnJvcignUHJvZHVjdCB3aXRoIGlkPScgKyBwcm9kdWN0SWQgKyAnIGlzIG5vdCBmb3VuZCEnKSkgKi9cbiAgICAgICAgICAvLyBUT0RPOiByZW5kZXIgXCJtYWFmIHByb2R1ayBpbmkgc2VkYW5nIHRpZGFrIHRlcnNlZGlhXCJcbiAgICAgICAgICByZXMucmVuZGVyKCdwcm9kdWN0LXVuYXZhaWxhYmxlJylcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICAvLyBTdWItY2F0ZWdvcnkgcGFnZVxuICAgIHRoaXMucm91dGVHZXQoJy86Y2F0ZWdvcnlJZC8qLzpzdWJDYXRlZ29yeUlkLyovJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsICcvOmNhdGVnb3J5SWQvKi86c3ViQ2F0ZWdvcnlJZC8qLy5HRVQoKScpXG4gICAgICBjb25zdCBzdWJDYXRlZ29yeUlkID0gcmVxLnBhcmFtcy5zdWJDYXRlZ29yeUlkXG4gICAgICByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgPSByZXEucXVlcnlbJ2luLXN0b2NrLXByb2R1Y3RzLXBhZ2UnXSB8fCAxXG4gICAgICByZXMubG9jYWxzLmN1cnJlbnRQT1Byb2R1Y3RQYWdlID0gcmVxLnF1ZXJ5Wydwby1wcm9kdWN0cy1wYWdlJ10gfHwgMVxuICAgICAgY29uc3QgaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSA9IDE1XG4gICAgICBjb25zdCBwb1Byb2R1Y3RQYWdlU2l6ZSA9IDE1XG5cbiAgICAgIFByb21pc2Uuam9pbjxOQ1Jlc3BvbnNlPGFueT4+KFxuICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldEluU3RvY2tQcm9kdWN0cyh7IHN1YkNhdGVnb3J5SWQgfSksXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UE9Qcm9kdWN0cyh7IHN1YkNhdGVnb3J5SWQgfSksXG4gICAgICAgIFByb2R1Y3RTZXJ2aWNlLmdldFN1YkNhdGVnb3J5KHN1YkNhdGVnb3J5SWQpXG4gICAgICApLnNwcmVhZCgocmVzcDE6IE5DUmVzcG9uc2U8eyBwcm9kdWN0czogSW5TdG9ja1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyIH0+LFxuICAgICAgICAgICAgICAgIHJlc3AyOiBOQ1Jlc3BvbnNlPHsgcHJvZHVjdHM6IFBPUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4sXG4gICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8U3ViQ2F0ZWdvcnk+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwMS5zdGF0dXMgJiYgcmVzcDEuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3AzLnN0YXR1cyAmJiByZXNwMy5kYXRhKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy5pblN0b2NrUHJvZHVjdFRvdGFsUGFnZSA9IFV0aWxzLmdldE51bWJlck9mUGFnZShyZXNwMS5kYXRhLnRvdGFsUHJvZHVjdHMsIGluU3RvY2tQcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDIuZGF0YS50b3RhbFByb2R1Y3RzLCBwb1Byb2R1Y3RQYWdlU2l6ZSlcbiAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0cyA9IHJlc3AxLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICByZXMubG9jYWxzLnBvUHJvZHVjdHMgPSByZXNwMi5kYXRhLnByb2R1Y3RzXG4gICAgICAgICAgcmVzLmxvY2Fscy5zdWJDYXRlZ29yeSA9IHJlc3AzLmRhdGFcbiAgICAgICAgICByZXMubG9jYWxzLmNhdGVnb3J5ID0gcmVzcDMuZGF0YS5jYXRlZ29yeVxuICAgICAgICAgIHJlcy5yZW5kZXIoJ3N1Yi1jYXRlZ29yeScpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5kaXIoJ3Jlc3AxPScgKyBKU09OLnN0cmluZ2lmeShyZXNwMSkpXG4gICAgICAgICAgY29uc29sZS5kaXIoJ3Jlc3AyPScgKyBKU09OLnN0cmluZ2lmeShyZXNwMikpXG4gICAgICAgICAgY29uc29sZS5kaXIoJ3Jlc3AzPScgKyBKU09OLnN0cmluZ2lmeShyZXNwMykpXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgaW5TdG9ja1Byb2R1Y3RzLCBwb1Byb2R1Y3RzLCBvciBzdWJDYXRlZ29yeTogJyArIChyZXNwMS5lcnJNZXNzYWdlIHx8IHJlc3AyLmVyck1lc3NhZ2UgfHwgcmVzcDMuZXJyTWVzc2FnZSkpXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgLy8gQ2F0ZWdvcnkgcGFnZVxuICAgIC8vIE5PVEU6IEJlY2F1c2UgdGhpcyByb3V0ZSBwYXRoIGlzIGEgJ3N1cGVyLXBhdGgnIG9mIHN1Yi1jYXRlZ29yeSBwYWdlLCB0aGlzIGhhcyB0byBiZSBkZWZpbmVkIGxhdGVyXG4gICAgdGhpcy5yb3V0ZUdldCgnLzpjYXRlZ29yeUlkLyovJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsICcvOmNhdGVnb3J5SWQvKi8uR0VUKCknKVxuICAgICAgY29uc3QgY2F0ZWdvcnlJZCA9IHJlcS5wYXJhbXMuY2F0ZWdvcnlJZFxuICAgICAgcmVzLmxvY2Fscy5jdXJyZW50SW5TdG9ja1Byb2R1Y3RQYWdlID0gcmVxLnF1ZXJ5Wydpbi1zdG9jay1wcm9kdWN0cy1wYWdlJ10gfHwgMVxuICAgICAgcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsncG8tcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgIGNvbnN0IGluU3RvY2tQcm9kdWN0UGFnZVNpemUgPSAxNVxuICAgICAgY29uc3QgcG9Qcm9kdWN0UGFnZVNpemUgPSAxNVxuXG4gICAgICBsb2cudmVyYm9zZShUQUcsICcvOmNhdGVnb3J5SWQvKi5HRVQ6IHJlcS5wYXJhbXM9JyArIEpTT04uc3RyaW5naWZ5KHJlcS5wYXJhbXMpKVxuICAgICAgUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgY2F0ZWdvcnlJZCwgcGFnZVNpemU6IGluU3RvY2tQcm9kdWN0UGFnZVNpemUsXG4gICAgICAgICAgcGFnZUluZGV4OiByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgLSAxIH0pLFxuICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldFBPUHJvZHVjdHMoeyBjYXRlZ29yeUlkLCBwYWdlU2l6ZTogcG9Qcm9kdWN0UGFnZVNpemUsXG4gICAgICAgICAgcGFnZUluZGV4OiByZXMubG9jYWxzLmN1cnJlbnRQT1Byb2R1Y3RQYWdlIC0gMSB9KSxcbiAgICAgICAgUHJvZHVjdFNlcnZpY2UuZ2V0Q2F0ZWdvcnkoY2F0ZWdvcnlJZClcbiAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXJ9PixcbiAgICAgICAgICAgICAgICByZXNwMjogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBQT1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyIH0+LFxuICAgICAgICAgICAgICAgIHJlc3AzOiBOQ1Jlc3BvbnNlPENhdGVnb3J5PikgPT4ge1xuICAgICAgICBpZiAocmVzcDEuc3RhdHVzICYmIHJlc3AxLmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmXG4gICAgICAgICAgICByZXNwMy5zdGF0dXMgJiYgcmVzcDMuZGF0YSkge1xuICAgICAgICAgIHJlcy5sb2NhbHMuaW5TdG9ja1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDEuZGF0YS50b3RhbFByb2R1Y3RzLCBpblN0b2NrUHJvZHVjdFBhZ2VTaXplKVxuICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0VG90YWxQYWdlID0gVXRpbHMuZ2V0TnVtYmVyT2ZQYWdlKHJlc3AyLmRhdGEudG90YWxQcm9kdWN0cywgcG9Qcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgcmVzLmxvY2Fscy5pblN0b2NrUHJvZHVjdHMgPSByZXNwMS5kYXRhLnByb2R1Y3RzXG4gICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RzID0gcmVzcDIuZGF0YS5wcm9kdWN0c1xuICAgICAgICAgIHJlcy5sb2NhbHMuY2F0ZWdvcnkgPSByZXNwMy5kYXRhXG4gICAgICAgICAgcmVzLnJlbmRlcignY2F0ZWdvcnknKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGluU3RvY2tQcm9kdWN0cywgcG9Qcm9kdWN0cywgb3Igc3ViQ2F0ZWdvcnk6ICcgKyByZXNwMS5lcnJNZXNzYWdlIHx8IHJlc3AyLmVyck1lc3NhZ2UgfHwgcmVzcDMuZXJyTWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn1cbiJdfQ==
