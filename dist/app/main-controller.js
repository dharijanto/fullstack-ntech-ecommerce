"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const express=require("express"),app_config_1=require("../app-config"),base_controller_1=require("./controllers/base-controller"),cart_controller_1=require("./controllers/shop/cart-controller"),cms_controller_1=require("./controllers/cms-controller"),local_shop_service_1=require("./local-shop-services/local-shop-service"),shop_controller_1=require("./controllers/shop/shop-controller"),sequelize_service_1=require("../services/sequelize-service"),search_service_1=require("../services/search-service"),path=require("path");let log=require("npmlog");log.level="debug";let CredentialController=require(path.join(__dirname,"controllers/credential-controller"));const TAG="MainController";class Controller extends base_controller_1.default{constructor(e){super(Object.assign(e,{viewPath:path.join(__dirname,"views")})),sequelize_service_1.default.initialize(e.db.sequelize,e.db.models),this.routeUse(app_config_1.default.IMAGE_MOUNT_PATH,express.static(app_config_1.default.IMAGE_PATH)),local_shop_service_1.default.initialize().then(r=>{search_service_1.default.initialize().then(()=>{r.status?(this.addInterceptor((e,r,o)=>{log.verbose(TAG,"req.path="+e.path),log.verbose(TAG,"loggedIn="+e.isAuthenticated()),log.verbose(TAG,"req.on="+JSON.stringify(e.session)),o()}),this.routeUse("/cms",new cms_controller_1.default(e).getRouter()),this.routeUse("/cart",new cart_controller_1.default(e).getRouter()),this.routeUse("/",new shop_controller_1.default(e).getRouter())):this.routeGet("*",(e,o,t)=>{o.status(500).send(r.errMessage)})})})}}module.exports=Controller;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbWFpbi1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImV4cHJlc3MiLCJyZXF1aXJlIiwiYXBwX2NvbmZpZ18xIiwiYmFzZV9jb250cm9sbGVyXzEiLCJjYXJ0X2NvbnRyb2xsZXJfMSIsImNtc19jb250cm9sbGVyXzEiLCJsb2NhbF9zaG9wX3NlcnZpY2VfMSIsInNob3BfY29udHJvbGxlcl8xIiwic2VxdWVsaXplX3NlcnZpY2VfMSIsInNlYXJjaF9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwibGV2ZWwiLCJDcmVkZW50aWFsQ29udHJvbGxlciIsImpvaW4iLCJfX2Rpcm5hbWUiLCJUQUciLCJDb250cm9sbGVyIiwiZGVmYXVsdCIsIltvYmplY3QgT2JqZWN0XSIsInNpdGVEYXRhIiwic3VwZXIiLCJPYmplY3QiLCJhc3NpZ24iLCJ2aWV3UGF0aCIsImluaXRpYWxpemUiLCJkYiIsInNlcXVlbGl6ZSIsIm1vZGVscyIsInRoaXMiLCJyb3V0ZVVzZSIsIklNQUdFX01PVU5UX1BBVEgiLCJzdGF0aWMiLCJJTUFHRV9QQVRIIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJhZGRJbnRlcmNlcHRvciIsInJlcSIsInJlcyIsIm5leHQiLCJ2ZXJib3NlIiwiaXNBdXRoZW50aWNhdGVkIiwiSlNPTiIsInN0cmluZ2lmeSIsInNlc3Npb24iLCJnZXRSb3V0ZXIiLCJyb3V0ZUdldCIsInNlbmQiLCJlcnJNZXNzYWdlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsV0FHQUMsYUFBQUQsUUFBQSxpQkFDQUUsa0JBQUFGLFFBQUEsaUNBQ0FHLGtCQUFBSCxRQUFBLHNDQUNBSSxpQkFBQUosUUFBQSxnQ0FDQUsscUJBQUFMLFFBQUEsNENBQ0FNLGtCQUFBTixRQUFBLHNDQUNBTyxvQkFBQVAsUUFBQSxpQ0FDQVEsaUJBQUFSLFFBQUEsOEJBR01TLEtBQU9ULFFBQVEsUUFFckIsSUFBSVUsSUFBTVYsUUFBUSxVQUNsQlUsSUFBSUMsTUFBUSxRQUVaLElBQUlDLHFCQUF1QlosUUFBUVMsS0FBS0ksS0FBS0MsVUFBVyxzQ0FFeEQsTUFBTUMsSUFBTSx1QkFFWkMsbUJBQXlCZCxrQkFBQWUsUUFDdkJDLFlBQWFDLEdBQ1hDLE1BQU1DLE9BQU9DLE9BQU9ILEdBQVlJLFNBQVVkLEtBQUtJLEtBQUtDLFVBQVcsWUFDL0RQLG9CQUFBVSxRQUFpQk8sV0FBV0wsRUFBU00sR0FBR0MsVUFBV1AsRUFBU00sR0FBR0UsUUFFL0RDLEtBQUtDLFNBQVM1QixhQUFBZ0IsUUFBVWEsaUJBQWtCL0IsUUFBUWdDLE9BQU85QixhQUFBZ0IsUUFBVWUsYUFFbkUzQixxQkFBQVksUUFBaUJPLGFBQWFTLEtBQUtDLElBQ2pDMUIsaUJBQUFTLFFBQWNPLGFBQWFTLEtBQUssS0FDekJDLEVBQUtDLFFBS1JQLEtBQUtRLGVBQWUsQ0FBQ0MsRUFBS0MsRUFBS0MsS0FDN0I3QixJQUFJOEIsUUFBUXpCLElBQUssWUFBY3NCLEVBQUk1QixNQUNuQ0MsSUFBSThCLFFBQVF6QixJQUFLLFlBQWNzQixFQUFJSSxtQkFDbkMvQixJQUFJOEIsUUFBUXpCLElBQUssVUFBWTJCLEtBQUtDLFVBQVVOLEVBQUlPLFVBQ2hETCxNQUVGWCxLQUFLQyxTQUFTLE9BQVMsSUFBSXpCLGlCQUFBYSxRQUFjRSxHQUFVMEIsYUFFbkRqQixLQUFLQyxTQUFTLFFBQVUsSUFBSTFCLGtCQUFBYyxRQUFlRSxHQUFVMEIsYUFDckRqQixLQUFLQyxTQUFTLElBQU0sSUFBSXZCLGtCQUFBVyxRQUFlRSxHQUFVMEIsY0FiakRqQixLQUFLa0IsU0FBUyxJQUFLLENBQUNULEVBQUtDLEVBQUtDLEtBQzVCRCxFQUFJSCxPQUFPLEtBQUtZLEtBQUtiLEVBQUtjLG1CQW9CdENDLE9BQU9DLFFBQVVsQyIsImZpbGUiOiJhcHAvbWFpbi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJ1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi9hcHAtY29uZmlnJ1xuaW1wb3J0IEJhc2VDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvYmFzZS1jb250cm9sbGVyJ1xuaW1wb3J0IENhcnRDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvc2hvcC9jYXJ0LWNvbnRyb2xsZXInXG5pbXBvcnQgQ01TQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL2Ntcy1jb250cm9sbGVyJ1xuaW1wb3J0IExvY2FsU2hvcFNlcnZpY2UgZnJvbSAnLi9sb2NhbC1zaG9wLXNlcnZpY2VzL2xvY2FsLXNob3Atc2VydmljZSdcbmltcG9ydCBTaG9wQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL3Nob3Avc2hvcC1jb250cm9sbGVyJ1xuaW1wb3J0IFNlcXVlbGl6ZVNlcnZpY2UgZnJvbSAnLi4vc2VydmljZXMvc2VxdWVsaXplLXNlcnZpY2UnXG5pbXBvcnQgU2VhcmNoU2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9zZWFyY2gtc2VydmljZSdcbmltcG9ydCB7IFNpdGVEYXRhIH0gZnJvbSAnLi4vc2l0ZS1kZWZpbml0aW9ucydcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbmxvZy5sZXZlbCA9ICdkZWJ1ZydcblxubGV0IENyZWRlbnRpYWxDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvY3JlZGVudGlhbC1jb250cm9sbGVyJykpXG5cbmNvbnN0IFRBRyA9ICdNYWluQ29udHJvbGxlcidcblxuY2xhc3MgQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKHNpdGVEYXRhOiBTaXRlRGF0YSkge1xuICAgIHN1cGVyKE9iamVjdC5hc3NpZ24oc2l0ZURhdGEsIHsgdmlld1BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICd2aWV3cycpIH0pKVxuICAgIFNlcXVlbGl6ZVNlcnZpY2UuaW5pdGlhbGl6ZShzaXRlRGF0YS5kYi5zZXF1ZWxpemUsIHNpdGVEYXRhLmRiLm1vZGVscylcblxuICAgIHRoaXMucm91dGVVc2UoQXBwQ29uZmlnLklNQUdFX01PVU5UX1BBVEgsIGV4cHJlc3Muc3RhdGljKEFwcENvbmZpZy5JTUFHRV9QQVRIKSlcblxuICAgIExvY2FsU2hvcFNlcnZpY2UuaW5pdGlhbGl6ZSgpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBTZWFyY2hTZXJ2aWNlLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgaWYgKCFyZXNwLnN0YXR1cykge1xuICAgICAgICAgIHRoaXMucm91dGVHZXQoJyonLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNTAwKS5zZW5kKHJlc3AuZXJyTWVzc2FnZSlcbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuYWRkSW50ZXJjZXB0b3IoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdyZXEucGF0aD0nICsgcmVxLnBhdGgpXG4gICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdsb2dnZWRJbj0nICsgcmVxLmlzQXV0aGVudGljYXRlZCgpKVxuICAgICAgICAgICAgbG9nLnZlcmJvc2UoVEFHLCAncmVxLm9uPScgKyBKU09OLnN0cmluZ2lmeShyZXEuc2Vzc2lvbikpXG4gICAgICAgICAgICBuZXh0KClcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMucm91dGVVc2UoJy9jbXMnLCAobmV3IENNU0NvbnRyb2xsZXIoc2l0ZURhdGEpLmdldFJvdXRlcigpKSlcbiAgICAgICAgICAvLyBNb3JlIGludm9sdmVkIGxvZ2ljcyBhcmUgc2VwYXJhdGVkIGludG8gZGlmZmVyZW50IGNvbnRyb2xsZXJzXG4gICAgICAgICAgdGhpcy5yb3V0ZVVzZSgnL2NhcnQnLCAobmV3IENhcnRDb250cm9sbGVyKHNpdGVEYXRhKS5nZXRSb3V0ZXIoKSkpXG4gICAgICAgICAgdGhpcy5yb3V0ZVVzZSgnLycsIChuZXcgU2hvcENvbnRyb2xsZXIoc2l0ZURhdGEpLmdldFJvdXRlcigpKSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC8qIHRoaXMucm91dGVVc2UoKG5ldyBDcmVkZW50aWFsQ29udHJvbGxlcihpbml0RGF0YSkpLmdldFJvdXRlcigpKSAqL1xuICAgIH0pXG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDb250cm9sbGVyXG4iXX0=
