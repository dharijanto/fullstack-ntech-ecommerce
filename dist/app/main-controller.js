"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const express=require("express"),app_config_1=require("../app-config"),Promise=require("bluebird"),base_controller_1=require("./controllers/base-controller"),cart_controller_1=require("./controllers/cart-controller"),cms_controller_1=require("./controllers/cms-controller"),product_service_1=require("../services/product-service"),local_shop_service_1=require("../services/local-shop-service"),sequelize_service_1=require("../services/sequelize-service"),Utils=require("../libs/utils"),path=require("path");let log=require("npmlog");log.level="debug";let CredentialController=require(path.join(__dirname,"controllers/credential-controller"));const TAG="MainController";class Controller extends base_controller_1.default{constructor(e){super(Object.assign(e,{viewPath:path.join(__dirname,"views")})),sequelize_service_1.default.initialize(e.db.sequelize,e.db.models),this.routeUse(app_config_1.default.IMAGE_MOUNT_PATH,express.static(app_config_1.default.IMAGE_PATH)),local_shop_service_1.default.initialize().then(t=>{t.status?(this.addInterceptor((e,t,r)=>{log.verbose(TAG,"req.path="+e.path),log.verbose(TAG,"loggedIn="+e.isAuthenticated()),log.verbose(TAG,"req.on="+JSON.stringify(e.session)),product_service_1.default.getCategories({},!0).then(e=>{if(!e.status||!e.data)throw new Error("Failed to retrieve categories: "+e.errMessage);Object.keys(Utils).forEach(e=>{t.locals[e]=Utils[e]}),t.locals.categories=e.data,r()}).catch(e=>{r(e)})}),this.routeUse("/cms",new cms_controller_1.default(e).getRouter()),this.routeUse("/cart",new cart_controller_1.default(e).getRouter()),this.routeGet("/",(e,t,r)=>{t.locals.currentPOProductPage=e.query["po-products-page"]||1,t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1;Promise.join(local_shop_service_1.default.getPromotion(),local_shop_service_1.default.getInStockProducts({pageIndex:t.locals.currentInStockProductPage-1,pageSize:9}),local_shop_service_1.default.getPOProducts({pageIndex:t.locals.currentPOProductPage-1,pageSize:9})).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw new Error("Failed to retrieve some information: "+e.errMessage||r.errMessage||o.errMessage);t.locals.inStockProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,9),t.locals.poProductTotalPage=Utils.getNumberOfPage(o.data.totalProducts,9),t.locals.promotions=e.data.slice(0,2),t.locals.smallPromotions=e.data.slice(2,e.data.length),t.locals.inStockProducts=r.data.products,t.locals.poProducts=o.data.products,t.render("home")}).catch(r)}),this.routeGet("/:categoryId/*/:subCategoryId/*/:productId/*/",(e,t,r)=>{e.params.categoryId,e.params.subCategoryId;const o=e.params.productId;Promise.join(local_shop_service_1.default.getInStockProduct(o),local_shop_service_1.default.getPOProduct(o)).spread((e,r)=>{e.status?(t.locals.product=e.data,log.verbose(TAG,"product="+JSON.stringify(e.data)),t.render("instock-product")):r.status?(t.locals.product=r.data,log.verbose(TAG,"product="+JSON.stringify(r.data)),t.render("po-product")):t.render("product-unavailable")}).catch(e=>{r(e)})}),this.routeGet("/:categoryId/*/:subCategoryId/*/",(e,t,r)=>{const o=e.params.subCategoryId;t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1,t.locals.currentPOProductPage=e.query["po-products-page"]||1;Promise.join(local_shop_service_1.default.getInStockProducts({subCategoryId:o}),local_shop_service_1.default.getPOProducts({subCategoryId:o}),product_service_1.default.getSubCategory(o)).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw console.dir("resp1="+JSON.stringify(e)),console.dir("resp2="+JSON.stringify(r)),console.dir("resp3="+JSON.stringify(o)),new Error("Failed to retrieve inStockProducts, poProducts, or subCategory: "+(e.errMessage||r.errMessage||o.errMessage));t.locals.inStockProductTotalPage=Utils.getNumberOfPage(e.data.totalProducts,15),t.locals.poProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,15),t.locals.inStockProducts=e.data.products,t.locals.poProducts=r.data.products,t.locals.subCategory=o.data,t.locals.category=o.data.category,t.render("sub-category")}).catch(e=>{r(e)})}),this.routeGet("/:categoryId/*/",(e,t,r)=>{const o=e.params.categoryId;t.locals.currentInStockProductPage=e.query["in-stock-products-page"]||1,t.locals.currentPOProductPage=e.query["po-products-page"]||1;log.verbose(TAG,"/:categoryId/*.GET: req.params="+JSON.stringify(e.params)),Promise.join(local_shop_service_1.default.getInStockProducts({categoryId:o,pageSize:15,pageIndex:t.locals.currentInStockProductPage-1}),local_shop_service_1.default.getPOProducts({categoryId:o,pageSize:15,pageIndex:t.locals.currentPOProductPage-1}),product_service_1.default.getCategory(o)).spread((e,r,o)=>{if(!(e.status&&e.data&&r.status&&r.data&&o.status&&o.data))throw new Error("Failed to retrieve inStockProducts, poProducts, or subCategory: "+e.errMessage||r.errMessage||o.errMessage);t.locals.inStockProductTotalPage=Utils.getNumberOfPage(e.data.totalProducts,15),t.locals.poProductTotalPage=Utils.getNumberOfPage(r.data.totalProducts,15),t.locals.inStockProducts=e.data.products,t.locals.poProducts=r.data.products,t.locals.category=o.data,t.render("category")}).catch(e=>{r(e)})})):this.routeGet("*",(e,r,o)=>{r.status(500).send(t.errMessage)})})}}module.exports=Controller;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbWFpbi1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImV4cHJlc3MiLCJyZXF1aXJlIiwiYXBwX2NvbmZpZ18xIiwiUHJvbWlzZSIsImJhc2VfY29udHJvbGxlcl8xIiwiY2FydF9jb250cm9sbGVyXzEiLCJjbXNfY29udHJvbGxlcl8xIiwicHJvZHVjdF9zZXJ2aWNlXzEiLCJsb2NhbF9zaG9wX3NlcnZpY2VfMSIsInNlcXVlbGl6ZV9zZXJ2aWNlXzEiLCJVdGlscyIsInBhdGgiLCJsb2ciLCJsZXZlbCIsIkNyZWRlbnRpYWxDb250cm9sbGVyIiwiam9pbiIsIl9fZGlybmFtZSIsIlRBRyIsIkNvbnRyb2xsZXIiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwic2l0ZURhdGEiLCJzdXBlciIsIk9iamVjdCIsImFzc2lnbiIsInZpZXdQYXRoIiwiaW5pdGlhbGl6ZSIsImRiIiwic2VxdWVsaXplIiwibW9kZWxzIiwidGhpcyIsInJvdXRlVXNlIiwiSU1BR0VfTU9VTlRfUEFUSCIsInN0YXRpYyIsIklNQUdFX1BBVEgiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsInZlcmJvc2UiLCJpc0F1dGhlbnRpY2F0ZWQiLCJKU09OIiwic3RyaW5naWZ5Iiwic2Vzc2lvbiIsImdldENhdGVnb3JpZXMiLCJkYXRhIiwiRXJyb3IiLCJlcnJNZXNzYWdlIiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJsb2NhbHMiLCJjYXRlZ29yaWVzIiwiY2F0Y2giLCJlcnIiLCJnZXRSb3V0ZXIiLCJyb3V0ZUdldCIsImN1cnJlbnRQT1Byb2R1Y3RQYWdlIiwicXVlcnkiLCJjdXJyZW50SW5TdG9ja1Byb2R1Y3RQYWdlIiwiZ2V0UHJvbW90aW9uIiwiZ2V0SW5TdG9ja1Byb2R1Y3RzIiwicGFnZUluZGV4IiwicGFnZVNpemUiLCJnZXRQT1Byb2R1Y3RzIiwic3ByZWFkIiwicmVzcDMiLCJyZXNwNCIsImluU3RvY2tQcm9kdWN0VG90YWxQYWdlIiwiZ2V0TnVtYmVyT2ZQYWdlIiwidG90YWxQcm9kdWN0cyIsInBvUHJvZHVjdFRvdGFsUGFnZSIsInByb21vdGlvbnMiLCJzbGljZSIsInNtYWxsUHJvbW90aW9ucyIsImxlbmd0aCIsImluU3RvY2tQcm9kdWN0cyIsInByb2R1Y3RzIiwicG9Qcm9kdWN0cyIsInJlbmRlciIsInBhcmFtcyIsImNhdGVnb3J5SWQiLCJzdWJDYXRlZ29yeUlkIiwicHJvZHVjdElkIiwiZ2V0SW5TdG9ja1Byb2R1Y3QiLCJnZXRQT1Byb2R1Y3QiLCJyZXNwMSIsInJlc3AyIiwicHJvZHVjdCIsImdldFN1YkNhdGVnb3J5IiwiY29uc29sZSIsImRpciIsInN1YkNhdGVnb3J5IiwiY2F0ZWdvcnkiLCJnZXRDYXRlZ29yeSIsInNlbmQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBQUEsTUFBQUEsUUFBQUMsUUFBQSxXQUNBQyxhQUFBRCxRQUFBLGlCQUNBRSxRQUFBRixRQUFBLFlBRUFHLGtCQUFBSCxRQUFBLGlDQUNBSSxrQkFBQUosUUFBQSxpQ0FDQUssaUJBQUFMLFFBQUEsZ0NBQ0FNLGtCQUFBTixRQUFBLCtCQUNBTyxxQkFBQVAsUUFBQSxrQ0FDQVEsb0JBQUFSLFFBQUEsaUNBRUFTLE1BQUFULFFBQUEsaUJBRU1VLEtBQU9WLFFBQVEsUUFFckIsSUFBSVcsSUFBTVgsUUFBUSxVQUNsQlcsSUFBSUMsTUFBUSxRQUVaLElBQUlDLHFCQUF1QmIsUUFBUVUsS0FBS0ksS0FBS0MsVUFBVyxzQ0FFeEQsTUFBTUMsSUFBTSx1QkFFWkMsbUJBQXlCZCxrQkFBQWUsUUFDdkJDLFlBQWFDLEdBQ1hDLE1BQU1DLE9BQU9DLE9BQU9ILEdBQVlJLFNBQVVkLEtBQUtJLEtBQUtDLFVBQVcsWUFDL0RQLG9CQUFBVSxRQUFpQk8sV0FBV0wsRUFBU00sR0FBR0MsVUFBV1AsRUFBU00sR0FBR0UsUUFFL0RDLEtBQUtDLFNBQVM3QixhQUFBaUIsUUFBVWEsaUJBQWtCaEMsUUFBUWlDLE9BQU8vQixhQUFBaUIsUUFBVWUsYUFFbkUxQixxQkFBQVcsUUFBaUJPLGFBQWFTLEtBQUtDLElBQzVCQSxFQUFLQyxRQUtSUCxLQUFLUSxlQUFlLENBQUNDLEVBQUtDLEVBQUtDLEtBQzdCN0IsSUFBSThCLFFBQVF6QixJQUFLLFlBQWNzQixFQUFJNUIsTUFDbkNDLElBQUk4QixRQUFRekIsSUFBSyxZQUFjc0IsRUFBSUksbUJBQ25DL0IsSUFBSThCLFFBQVF6QixJQUFLLFVBQVkyQixLQUFLQyxVQUFVTixFQUFJTyxVQUNoRHZDLGtCQUFBWSxRQUFlNEIsa0JBQWtCLEdBQU1aLEtBQUtDLElBQzFDLElBQUlBLEVBQUtDLFNBQVVELEVBQUtZLEtBT3RCLE1BQU0sSUFBSUMsTUFBTSxrQ0FBb0NiLEVBQUtjLFlBTnpEM0IsT0FBTzRCLEtBQUt6QyxPQUFPMEMsUUFBUUMsSUFDekJiLEVBQUljLE9BQU9ELEdBQU8zQyxNQUFNMkMsS0FFMUJiLEVBQUljLE9BQU9DLFdBQWFuQixFQUFLWSxLQUM3QlAsTUFJRGUsTUFBTUMsSUFDUGhCLEVBQUtnQixPQUlUM0IsS0FBS0MsU0FBUyxPQUFTLElBQUl6QixpQkFBQWEsUUFBY0UsR0FBVXFDLGFBR25ENUIsS0FBS0MsU0FBUyxRQUFVLElBQUkxQixrQkFBQWMsUUFBZUUsR0FBVXFDLGFBTXJENUIsS0FBSzZCLFNBQVMsSUFBSyxDQUFDcEIsRUFBS0MsRUFBS0MsS0FDNUJELEVBQUljLE9BQU9NLHFCQUF1QnJCLEVBQUlzQixNQUFNLHFCQUF1QixFQUNuRXJCLEVBQUljLE9BQU9RLDBCQUE0QnZCLEVBQUlzQixNQUFNLDJCQUE2QixFQUk5RTFELFFBQVFZLEtBQ05QLHFCQUFBVyxRQUFpQjRDLGVBQ2pCdkQscUJBQUFXLFFBQWlCNkMsb0JBQXFCQyxVQUFXekIsRUFBSWMsT0FBT1EsMEJBQTRCLEVBQUdJLFNBTDlELElBTTdCMUQscUJBQUFXLFFBQWlCZ0QsZUFBZ0JGLFVBQVd6QixFQUFJYyxPQUFPTSxxQkFBdUIsRUFBR00sU0FMekQsS0FNeEJFLE9BQU8sQ0FBQ2hDLEVBQ0FpQyxFQUNBQyxLQUNSLEtBQUlsQyxFQUFLQyxRQUFVRCxFQUFLWSxNQUNwQnFCLEVBQU1oQyxRQUFVZ0MsRUFBTXJCLE1BQ3RCc0IsRUFBTWpDLFFBQVVpQyxFQUFNdEIsTUFXeEIsTUFBTSxJQUFJQyxNQUFNLHdDQUNWYixFQUFLYyxZQUFjbUIsRUFBTW5CLFlBQWNvQixFQUFNcEIsWUFWbkRWLEVBQUljLE9BQU9pQix3QkFBMEI3RCxNQUFNOEQsZ0JBQWdCSCxFQUFNckIsS0FBS3lCLGNBZDNDLEdBZTNCakMsRUFBSWMsT0FBT29CLG1CQUFxQmhFLE1BQU04RCxnQkFBZ0JGLEVBQU10QixLQUFLeUIsY0FkM0MsR0FldEJqQyxFQUFJYyxPQUFPcUIsV0FBYXZDLEVBQUtZLEtBQUs0QixNQUFNLEVBQUcsR0FDM0NwQyxFQUFJYyxPQUFPdUIsZ0JBQWtCekMsRUFBS1ksS0FBSzRCLE1BQU0sRUFBR3hDLEVBQUtZLEtBQUs4QixRQUMxRHRDLEVBQUljLE9BQU95QixnQkFBa0JWLEVBQU1yQixLQUFLZ0MsU0FDeEN4QyxFQUFJYyxPQUFPMkIsV0FBYVgsRUFBTXRCLEtBQUtnQyxTQUNuQ3hDLEVBQUkwQyxPQUFPLFVBTVoxQixNQUFNZixLQUtYWCxLQUFLNkIsU0FBUyxnREFBaUQsQ0FBQ3BCLEVBQUtDLEVBQUtDLEtBQ3JERixFQUFJNEMsT0FBT0MsV0FDUjdDLEVBQUk0QyxPQUFPRSxjQURqQyxNQUVNQyxFQUFZL0MsRUFBSTRDLE9BQU9HLFVBRTdCbkYsUUFBUVksS0FDTlAscUJBQUFXLFFBQWlCb0Usa0JBQWtCRCxHQUNuQzlFLHFCQUFBVyxRQUFpQnFFLGFBQWFGLElBQzlCbEIsT0FBTyxDQUFDcUIsRUFBbUNDLEtBQ3ZDRCxFQUFNcEQsUUFDUkcsRUFBSWMsT0FBT3FDLFFBQVVGLEVBQU16QyxLQUMzQnBDLElBQUk4QixRQUFRekIsSUFBSyxXQUFhMkIsS0FBS0MsVUFBVTRDLEVBQU16QyxPQUNuRFIsRUFBSTBDLE9BQU8sb0JBQ0ZRLEVBQU1yRCxRQUNmRyxFQUFJYyxPQUFPcUMsUUFBVUQsRUFBTTFDLEtBQzNCcEMsSUFBSThCLFFBQVF6QixJQUFLLFdBQWEyQixLQUFLQyxVQUFVNkMsRUFBTTFDLE9BQ25EUixFQUFJMEMsT0FBTyxlQUlYMUMsRUFBSTBDLE9BQU8seUJBRVoxQixNQUFNQyxJQUNQaEIsRUFBS2dCLE9BS1QzQixLQUFLNkIsU0FBUyxtQ0FBb0MsQ0FBQ3BCLEVBQUtDLEVBQUtDLEtBQzNELE1BQU00QyxFQUFnQjlDLEVBQUk0QyxPQUFPRSxjQUNqQzdDLEVBQUljLE9BQU9RLDBCQUE0QnZCLEVBQUlzQixNQUFNLDJCQUE2QixFQUM5RXJCLEVBQUljLE9BQU9NLHFCQUF1QnJCLEVBQUlzQixNQUFNLHFCQUF1QixFQUluRTFELFFBQVFZLEtBQ05QLHFCQUFBVyxRQUFpQjZDLG9CQUFxQnFCLGNBQUFBLElBQ3RDN0UscUJBQUFXLFFBQWlCZ0QsZUFBZ0JrQixjQUFBQSxJQUNqQzlFLGtCQUFBWSxRQUFleUUsZUFBZVAsSUFDOUJqQixPQUFPLENBQUNxQixFQUNBQyxFQUNBckIsS0FDUixLQUFJb0IsRUFBTXBELFFBQVVvRCxFQUFNekMsTUFDdEIwQyxFQUFNckQsUUFBVXFELEVBQU0xQyxNQUN0QnFCLEVBQU1oQyxRQUFVZ0MsRUFBTXJCLE1BWXhCLE1BSEE2QyxRQUFRQyxJQUFJLFNBQVdsRCxLQUFLQyxVQUFVNEMsSUFDdENJLFFBQVFDLElBQUksU0FBV2xELEtBQUtDLFVBQVU2QyxJQUN0Q0csUUFBUUMsSUFBSSxTQUFXbEQsS0FBS0MsVUFBVXdCLElBQ2hDLElBQUlwQixNQUFNLG9FQUFzRXdDLEVBQU12QyxZQUFjd0MsRUFBTXhDLFlBQWNtQixFQUFNbkIsYUFYcElWLEVBQUljLE9BQU9pQix3QkFBMEI3RCxNQUFNOEQsZ0JBQWdCaUIsRUFBTXpDLEtBQUt5QixjQWIzQyxJQWMzQmpDLEVBQUljLE9BQU9vQixtQkFBcUJoRSxNQUFNOEQsZ0JBQWdCa0IsRUFBTTFDLEtBQUt5QixjQWIzQyxJQWN0QmpDLEVBQUljLE9BQU95QixnQkFBa0JVLEVBQU16QyxLQUFLZ0MsU0FDeEN4QyxFQUFJYyxPQUFPMkIsV0FBYVMsRUFBTTFDLEtBQUtnQyxTQUNuQ3hDLEVBQUljLE9BQU95QyxZQUFjMUIsRUFBTXJCLEtBQy9CUixFQUFJYyxPQUFPMEMsU0FBVzNCLEVBQU1yQixLQUFLZ0QsU0FDakN4RCxFQUFJMEMsT0FBTyxrQkFPWjFCLE1BQU1DLElBQ1BoQixFQUFLZ0IsT0FNVDNCLEtBQUs2QixTQUFTLGtCQUFtQixDQUFDcEIsRUFBS0MsRUFBS0MsS0FDMUMsTUFBTTJDLEVBQWE3QyxFQUFJNEMsT0FBT0MsV0FDOUI1QyxFQUFJYyxPQUFPUSwwQkFBNEJ2QixFQUFJc0IsTUFBTSwyQkFBNkIsRUFDOUVyQixFQUFJYyxPQUFPTSxxQkFBdUJyQixFQUFJc0IsTUFBTSxxQkFBdUIsRUFJbkVqRCxJQUFJOEIsUUFBUXpCLElBQUssa0NBQW9DMkIsS0FBS0MsVUFBVU4sRUFBSTRDLFNBQ3hFaEYsUUFBUVksS0FDTlAscUJBQUFXLFFBQWlCNkMsb0JBQXFCb0IsV0FBQUEsRUFBWWxCLFNBTHJCLEdBTTNCRCxVQUFXekIsRUFBSWMsT0FBT1EsMEJBQTRCLElBQ3BEdEQscUJBQUFXLFFBQWlCZ0QsZUFBZ0JpQixXQUFBQSxFQUFZbEIsU0FOckIsR0FPdEJELFVBQVd6QixFQUFJYyxPQUFPTSxxQkFBdUIsSUFDL0NyRCxrQkFBQVksUUFBZThFLFlBQVliLElBQzNCaEIsT0FBTyxDQUFDcUIsRUFDQUMsRUFDQXJCLEtBQ1IsS0FBSW9CLEVBQU1wRCxRQUFVb0QsRUFBTXpDLE1BQ3RCMEMsRUFBTXJELFFBQVVxRCxFQUFNMUMsTUFDdEJxQixFQUFNaEMsUUFBVWdDLEVBQU1yQixNQVF4QixNQUFNLElBQUlDLE1BQU0sbUVBQXFFd0MsRUFBTXZDLFlBQWN3QyxFQUFNeEMsWUFBY21CLEVBQU1uQixZQVBuSVYsRUFBSWMsT0FBT2lCLHdCQUEwQjdELE1BQU04RCxnQkFBZ0JpQixFQUFNekMsS0FBS3lCLGNBaEIzQyxJQWlCM0JqQyxFQUFJYyxPQUFPb0IsbUJBQXFCaEUsTUFBTThELGdCQUFnQmtCLEVBQU0xQyxLQUFLeUIsY0FoQjNDLElBaUJ0QmpDLEVBQUljLE9BQU95QixnQkFBa0JVLEVBQU16QyxLQUFLZ0MsU0FDeEN4QyxFQUFJYyxPQUFPMkIsV0FBYVMsRUFBTTFDLEtBQUtnQyxTQUNuQ3hDLEVBQUljLE9BQU8wQyxTQUFXM0IsRUFBTXJCLEtBQzVCUixFQUFJMEMsT0FBTyxjQUlaMUIsTUFBTUMsSUFDUGhCLEVBQUtnQixRQWpLVDNCLEtBQUs2QixTQUFTLElBQUssQ0FBQ3BCLEVBQUtDLEVBQUtDLEtBQzVCRCxFQUFJSCxPQUFPLEtBQUs2RCxLQUFLOUQsRUFBS2MsaUJBMEtwQ2lELE9BQU9DLFFBQVVsRiIsImZpbGUiOiJhcHAvbWFpbi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJ1xuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi9hcHAtY29uZmlnJ1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IEJhc2VDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvYmFzZS1jb250cm9sbGVyJ1xuaW1wb3J0IENhcnRDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvY2FydC1jb250cm9sbGVyJ1xuaW1wb3J0IENNU0NvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9jbXMtY29udHJvbGxlcidcbmltcG9ydCBQcm9kdWN0U2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9wcm9kdWN0LXNlcnZpY2UnXG5pbXBvcnQgTG9jYWxTaG9wU2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9sb2NhbC1zaG9wLXNlcnZpY2UnXG5pbXBvcnQgU2VxdWVsaXplU2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9zZXF1ZWxpemUtc2VydmljZSdcbmltcG9ydCB7IFNpdGVEYXRhIH0gZnJvbSAnLi4vc2l0ZS1kZWZpbml0aW9ucydcbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJy4uL2xpYnMvdXRpbHMnXG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxubGV0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5sb2cubGV2ZWwgPSAnZGVidWcnXG5cbmxldCBDcmVkZW50aWFsQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NvbnRyb2xsZXJzL2NyZWRlbnRpYWwtY29udHJvbGxlcicpKVxuXG5jb25zdCBUQUcgPSAnTWFpbkNvbnRyb2xsZXInXG5cbmNsYXNzIENvbnRyb2xsZXIgZXh0ZW5kcyBCYXNlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yIChzaXRlRGF0YTogU2l0ZURhdGEpIHtcbiAgICBzdXBlcihPYmplY3QuYXNzaWduKHNpdGVEYXRhLCB7IHZpZXdQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndmlld3MnKSB9KSlcbiAgICBTZXF1ZWxpemVTZXJ2aWNlLmluaXRpYWxpemUoc2l0ZURhdGEuZGIuc2VxdWVsaXplLCBzaXRlRGF0YS5kYi5tb2RlbHMpXG5cbiAgICB0aGlzLnJvdXRlVXNlKEFwcENvbmZpZy5JTUFHRV9NT1VOVF9QQVRILCBleHByZXNzLnN0YXRpYyhBcHBDb25maWcuSU1BR0VfUEFUSCkpXG5cbiAgICBMb2NhbFNob3BTZXJ2aWNlLmluaXRpYWxpemUoKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKCFyZXNwLnN0YXR1cykge1xuICAgICAgICB0aGlzLnJvdXRlR2V0KCcqJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg1MDApLnNlbmQocmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdyZXEucGF0aD0nICsgcmVxLnBhdGgpXG4gICAgICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnbG9nZ2VkSW49JyArIHJlcS5pc0F1dGhlbnRpY2F0ZWQoKSlcbiAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdyZXEub249JyArIEpTT04uc3RyaW5naWZ5KHJlcS5zZXNzaW9uKSlcbiAgICAgICAgICBQcm9kdWN0U2VydmljZS5nZXRDYXRlZ29yaWVzKHt9LCB0cnVlKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgICBPYmplY3Qua2V5cyhVdGlscykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgICAgIHJlcy5sb2NhbHNba2V5XSA9IFV0aWxzW2tleV1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5jYXRlZ29yaWVzID0gcmVzcC5kYXRhXG4gICAgICAgICAgICAgIG5leHQoKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgY2F0ZWdvcmllczogJyArIHJlc3AuZXJyTWVzc2FnZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgbmV4dChlcnIpXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLnJvdXRlVXNlKCcvY21zJywgKG5ldyBDTVNDb250cm9sbGVyKHNpdGVEYXRhKS5nZXRSb3V0ZXIoKSkpXG5cbiAgICAgICAgLy8gTW9yZSBpbnZvbHZlZCBsb2dpY3MgYXJlIHNlcGFyYXRlZCBpbnRvIGRpZmZlcmVudCBjb250cm9sbGVyc1xuICAgICAgICB0aGlzLnJvdXRlVXNlKCcvY2FydCcsIChuZXcgQ2FydENvbnRyb2xsZXIoc2l0ZURhdGEpLmdldFJvdXRlcigpKSlcblxuICAgICAgICAvLyBMYW5kaW5nIHBhZ2VcbiAgICAgICAgLy8gVGhlIG1haW4gdmlldyB3aGVyZSB3ZSBzaG93IHByb21vdGVkIGl0ZW1zLCBjYXRlZ29yaWVzICYgc3VicywgYW5kIGxhdGVzdCBwcm9kdWN0c1xuICAgICAgICAvLyBUT0RPOlxuICAgICAgICAvLyAxLiBTaG93IGxhdGVzdCBwcm9kdWN0cyBpbnN0ZWFkIG9mIGFsbCBwcm9kdWN0c1xuICAgICAgICB0aGlzLnJvdXRlR2V0KCcvJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsncG8tcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgICAgICByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgPSByZXEucXVlcnlbJ2luLXN0b2NrLXByb2R1Y3RzLXBhZ2UnXSB8fCAxXG4gICAgICAgICAgY29uc3QgaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSA9IDlcbiAgICAgICAgICBjb25zdCBwb1Byb2R1Y3RQYWdlU2l6ZSA9IDlcblxuICAgICAgICAgIFByb21pc2Uuam9pbjxOQ1Jlc3BvbnNlPGFueT4+KFxuICAgICAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRQcm9tb3Rpb24oKSxcbiAgICAgICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgcGFnZUluZGV4OiByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgLSAxLCBwYWdlU2l6ZTogaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSB9KSxcbiAgICAgICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UE9Qcm9kdWN0cyh7IHBhZ2VJbmRleDogcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSAtIDEsIHBhZ2VTaXplOiBwb1Byb2R1Y3RQYWdlU2l6ZSB9KVxuICAgICAgICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPFByb21vdGlvbltdPixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8e3Byb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXJ9PixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDQ6IE5DUmVzcG9uc2U8e3Byb2R1Y3RzOiBQT1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyfT4pID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEgJiZcbiAgICAgICAgICAgICAgICByZXNwMy5zdGF0dXMgJiYgcmVzcDMuZGF0YSAmJlxuICAgICAgICAgICAgICAgIHJlc3A0LnN0YXR1cyAmJiByZXNwNC5kYXRhKSB7XG4gICAgICAgICAgICAgIC8vIDIgc3BvdHMgZm9yIGxhcmdlciBwcm9tb3Rpb24gYmFubmVyLCB0aGUgcmVzdCBpcyByZWd1bGFyIHByb21vdGlvbnNcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5pblN0b2NrUHJvZHVjdFRvdGFsUGFnZSA9IFV0aWxzLmdldE51bWJlck9mUGFnZShyZXNwMy5kYXRhLnRvdGFsUHJvZHVjdHMsIGluU3RvY2tQcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0VG90YWxQYWdlID0gVXRpbHMuZ2V0TnVtYmVyT2ZQYWdlKHJlc3A0LmRhdGEudG90YWxQcm9kdWN0cywgcG9Qcm9kdWN0UGFnZVNpemUpXG4gICAgICAgICAgICAgIHJlcy5sb2NhbHMucHJvbW90aW9ucyA9IHJlc3AuZGF0YS5zbGljZSgwLCAyKVxuICAgICAgICAgICAgICByZXMubG9jYWxzLnNtYWxsUHJvbW90aW9ucyA9IHJlc3AuZGF0YS5zbGljZSgyLCByZXNwLmRhdGEubGVuZ3RoKVxuICAgICAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0cyA9IHJlc3AzLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RzID0gcmVzcDQuZGF0YS5wcm9kdWN0c1xuICAgICAgICAgICAgICByZXMucmVuZGVyKCdob21lJylcbiAgICAgICAgICAgICAgLy8gcmVzLnNlbmQoJ2hhaGEnKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgc29tZSBpbmZvcm1hdGlvbjogJyArXG4gICAgICAgICAgICAgICAgICAgIHJlc3AuZXJyTWVzc2FnZSB8fCByZXNwMy5lcnJNZXNzYWdlIHx8IHJlc3A0LmVyck1lc3NhZ2UpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkuY2F0Y2gobmV4dClcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBQcm9kdWN0IHBhZ2VcbiAgICAgICAgLy8gSW5mb3JtYXRpb24gcmVsYXRlZCB0byBhIHNwZWNpZmljIHByb2R1Y3QsIGN1c3RvbWVyIGNhbiBvcmRlciBoZXJlXG4gICAgICAgIHRoaXMucm91dGVHZXQoJy86Y2F0ZWdvcnlJZC8qLzpzdWJDYXRlZ29yeUlkLyovOnByb2R1Y3RJZC8qLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNhdGVnb3J5SWQgPSByZXEucGFyYW1zLmNhdGVnb3J5SWRcbiAgICAgICAgICBjb25zdCBzdWJDYXRlZ29yeUlkID0gcmVxLnBhcmFtcy5zdWJDYXRlZ29yeUlkXG4gICAgICAgICAgY29uc3QgcHJvZHVjdElkID0gcmVxLnBhcmFtcy5wcm9kdWN0SWRcblxuICAgICAgICAgIFByb21pc2Uuam9pbjxOQ1Jlc3BvbnNlPGFueT4+KFxuICAgICAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRJblN0b2NrUHJvZHVjdChwcm9kdWN0SWQpLFxuICAgICAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRQT1Byb2R1Y3QocHJvZHVjdElkKVxuICAgICAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTxJblN0b2NrUHJvZHVjdD4sIHJlc3AyOiBOQ1Jlc3BvbnNlPFBPUHJvZHVjdD4pID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwMS5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5wcm9kdWN0ID0gcmVzcDEuZGF0YVxuICAgICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdwcm9kdWN0PScgKyBKU09OLnN0cmluZ2lmeShyZXNwMS5kYXRhKSlcbiAgICAgICAgICAgICAgcmVzLnJlbmRlcignaW5zdG9jay1wcm9kdWN0JylcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgICAgIHJlcy5sb2NhbHMucHJvZHVjdCA9IHJlc3AyLmRhdGFcbiAgICAgICAgICAgICAgbG9nLnZlcmJvc2UoVEFHLCAncHJvZHVjdD0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDIuZGF0YSkpXG4gICAgICAgICAgICAgIHJlcy5yZW5kZXIoJ3BvLXByb2R1Y3QnKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgLyogbmV4dChuZXcgRXJyb3IoJ1Byb2R1Y3Qgd2l0aCBpZD0nICsgcHJvZHVjdElkICsgJyBpcyBub3QgZm91bmQhJykpICovXG4gICAgICAgICAgICAgIC8vIFRPRE86IHJlbmRlciBcIm1hYWYgcHJvZHVrIGluaSBzZWRhbmcgdGlkYWsgdGVyc2VkaWFcIlxuICAgICAgICAgICAgICByZXMucmVuZGVyKCdwcm9kdWN0LXVuYXZhaWxhYmxlJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgbmV4dChlcnIpXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBTdWItY2F0ZWdvcnkgcGFnZVxuICAgICAgICB0aGlzLnJvdXRlR2V0KCcvOmNhdGVnb3J5SWQvKi86c3ViQ2F0ZWdvcnlJZC8qLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHN1YkNhdGVnb3J5SWQgPSByZXEucGFyYW1zLnN1YkNhdGVnb3J5SWRcbiAgICAgICAgICByZXMubG9jYWxzLmN1cnJlbnRJblN0b2NrUHJvZHVjdFBhZ2UgPSByZXEucXVlcnlbJ2luLXN0b2NrLXByb2R1Y3RzLXBhZ2UnXSB8fCAxXG4gICAgICAgICAgcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsncG8tcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgICAgICBjb25zdCBpblN0b2NrUHJvZHVjdFBhZ2VTaXplID0gMTVcbiAgICAgICAgICBjb25zdCBwb1Byb2R1Y3RQYWdlU2l6ZSA9IDE1XG5cbiAgICAgICAgICBQcm9taXNlLmpvaW48TkNSZXNwb25zZTxhbnk+PihcbiAgICAgICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgc3ViQ2F0ZWdvcnlJZCB9KSxcbiAgICAgICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0UE9Qcm9kdWN0cyh7IHN1YkNhdGVnb3J5SWQgfSksXG4gICAgICAgICAgICBQcm9kdWN0U2VydmljZS5nZXRTdWJDYXRlZ29yeShzdWJDYXRlZ29yeUlkKVxuICAgICAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4sXG4gICAgICAgICAgICAgICAgICAgIHJlc3AyOiBOQ1Jlc3BvbnNlPHsgcHJvZHVjdHM6IFBPUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4sXG4gICAgICAgICAgICAgICAgICAgIHJlc3AzOiBOQ1Jlc3BvbnNlPFN1YkNhdGVnb3J5PikgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3AxLnN0YXR1cyAmJiByZXNwMS5kYXRhICYmXG4gICAgICAgICAgICAgICAgcmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEgJiZcbiAgICAgICAgICAgICAgICByZXNwMy5zdGF0dXMgJiYgcmVzcDMuZGF0YSkge1xuICAgICAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0VG90YWxQYWdlID0gVXRpbHMuZ2V0TnVtYmVyT2ZQYWdlKHJlc3AxLmRhdGEudG90YWxQcm9kdWN0cywgaW5TdG9ja1Byb2R1Y3RQYWdlU2l6ZSlcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDIuZGF0YS50b3RhbFByb2R1Y3RzLCBwb1Byb2R1Y3RQYWdlU2l6ZSlcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5pblN0b2NrUHJvZHVjdHMgPSByZXNwMS5kYXRhLnByb2R1Y3RzXG4gICAgICAgICAgICAgIHJlcy5sb2NhbHMucG9Qcm9kdWN0cyA9IHJlc3AyLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5zdWJDYXRlZ29yeSA9IHJlc3AzLmRhdGFcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5jYXRlZ29yeSA9IHJlc3AzLmRhdGEuY2F0ZWdvcnlcbiAgICAgICAgICAgICAgcmVzLnJlbmRlcignc3ViLWNhdGVnb3J5JylcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZGlyKCdyZXNwMT0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDEpKVxuICAgICAgICAgICAgICBjb25zb2xlLmRpcigncmVzcDI9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AyKSlcbiAgICAgICAgICAgICAgY29uc29sZS5kaXIoJ3Jlc3AzPScgKyBKU09OLnN0cmluZ2lmeShyZXNwMykpXG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGluU3RvY2tQcm9kdWN0cywgcG9Qcm9kdWN0cywgb3Igc3ViQ2F0ZWdvcnk6ICcgKyAocmVzcDEuZXJyTWVzc2FnZSB8fCByZXNwMi5lcnJNZXNzYWdlIHx8IHJlc3AzLmVyck1lc3NhZ2UpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgICAgIC8vIENhdGVnb3J5IHBhZ2VcbiAgICAgICAgLy8gTk9URTogQmVjYXVzZSB0aGlzIHJvdXRlIHBhdGggaXMgYSAnc3VwZXItcGF0aCcgb2Ygc3ViLWNhdGVnb3J5IHBhZ2UsIHRoaXMgaGFzIHRvIGJlIGRlZmluZWQgbGF0ZXJcbiAgICAgICAgdGhpcy5yb3V0ZUdldCgnLzpjYXRlZ29yeUlkLyovJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgY29uc3QgY2F0ZWdvcnlJZCA9IHJlcS5wYXJhbXMuY2F0ZWdvcnlJZFxuICAgICAgICAgIHJlcy5sb2NhbHMuY3VycmVudEluU3RvY2tQcm9kdWN0UGFnZSA9IHJlcS5xdWVyeVsnaW4tc3RvY2stcHJvZHVjdHMtcGFnZSddIHx8IDFcbiAgICAgICAgICByZXMubG9jYWxzLmN1cnJlbnRQT1Byb2R1Y3RQYWdlID0gcmVxLnF1ZXJ5Wydwby1wcm9kdWN0cy1wYWdlJ10gfHwgMVxuICAgICAgICAgIGNvbnN0IGluU3RvY2tQcm9kdWN0UGFnZVNpemUgPSAxNVxuICAgICAgICAgIGNvbnN0IHBvUHJvZHVjdFBhZ2VTaXplID0gMTVcblxuICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJy86Y2F0ZWdvcnlJZC8qLkdFVDogcmVxLnBhcmFtcz0nICsgSlNPTi5zdHJpbmdpZnkocmVxLnBhcmFtcykpXG4gICAgICAgICAgUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldEluU3RvY2tQcm9kdWN0cyh7IGNhdGVnb3J5SWQsIHBhZ2VTaXplOiBpblN0b2NrUHJvZHVjdFBhZ2VTaXplLFxuICAgICAgICAgICAgICBwYWdlSW5kZXg6IHJlcy5sb2NhbHMuY3VycmVudEluU3RvY2tQcm9kdWN0UGFnZSAtIDEgfSksXG4gICAgICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldFBPUHJvZHVjdHMoeyBjYXRlZ29yeUlkLCBwYWdlU2l6ZTogcG9Qcm9kdWN0UGFnZVNpemUsXG4gICAgICAgICAgICAgIHBhZ2VJbmRleDogcmVzLmxvY2Fscy5jdXJyZW50UE9Qcm9kdWN0UGFnZSAtIDEgfSksXG4gICAgICAgICAgICBQcm9kdWN0U2VydmljZS5nZXRDYXRlZ29yeShjYXRlZ29yeUlkKVxuICAgICAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXJ9PixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDI6IE5DUmVzcG9uc2U8eyBwcm9kdWN0czogUE9Qcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlciB9PixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8Q2F0ZWdvcnk+KSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcDEuc3RhdHVzICYmIHJlc3AxLmRhdGEgJiZcbiAgICAgICAgICAgICAgICByZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJlxuICAgICAgICAgICAgICAgIHJlc3AzLnN0YXR1cyAmJiByZXNwMy5kYXRhKSB7XG4gICAgICAgICAgICAgIHJlcy5sb2NhbHMuaW5TdG9ja1Byb2R1Y3RUb3RhbFBhZ2UgPSBVdGlscy5nZXROdW1iZXJPZlBhZ2UocmVzcDEuZGF0YS50b3RhbFByb2R1Y3RzLCBpblN0b2NrUHJvZHVjdFBhZ2VTaXplKVxuICAgICAgICAgICAgICByZXMubG9jYWxzLnBvUHJvZHVjdFRvdGFsUGFnZSA9IFV0aWxzLmdldE51bWJlck9mUGFnZShyZXNwMi5kYXRhLnRvdGFsUHJvZHVjdHMsIHBvUHJvZHVjdFBhZ2VTaXplKVxuICAgICAgICAgICAgICByZXMubG9jYWxzLmluU3RvY2tQcm9kdWN0cyA9IHJlc3AxLmRhdGEucHJvZHVjdHNcbiAgICAgICAgICAgICAgcmVzLmxvY2Fscy5wb1Byb2R1Y3RzID0gcmVzcDIuZGF0YS5wcm9kdWN0c1xuICAgICAgICAgICAgICByZXMubG9jYWxzLmNhdGVnb3J5ID0gcmVzcDMuZGF0YVxuICAgICAgICAgICAgICByZXMucmVuZGVyKCdjYXRlZ29yeScpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBpblN0b2NrUHJvZHVjdHMsIHBvUHJvZHVjdHMsIG9yIHN1YkNhdGVnb3J5OiAnICsgcmVzcDEuZXJyTWVzc2FnZSB8fCByZXNwMi5lcnJNZXNzYWdlIHx8IHJlc3AzLmVyck1lc3NhZ2UpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIG5leHQoZXJyKVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcbiAgICAvKiB0aGlzLnJvdXRlVXNlKChuZXcgQ3JlZGVudGlhbENvbnRyb2xsZXIoaW5pdERhdGEpKS5nZXRSb3V0ZXIoKSkgKi9cblxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29udHJvbGxlclxuIl19
