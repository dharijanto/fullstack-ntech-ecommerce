"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const crud_service_1=require("../../services/crud-service"),shop_service_1=require("../../services/shop-service"),Promise=require("bluebird"),app_config_1=require("../../app-config"),Utils=require("../../libs/utils"),a={status:!1,errMessage:""};class LocalShopService extends crud_service_1.CRUDService{constructor(){super(...arguments),this.localShopId=-1}initialize(){return app_config_1.default.LOCAL_SHOP_INFORMATION&&app_config_1.default.LOCAL_SHOP_INFORMATION.NAME?-1===this.localShopId?super.readOne("Shop",{name:app_config_1.default.LOCAL_SHOP_INFORMATION.NAME}).then(e=>e.status&&e.data?(this.localShopId=e.data.id,{status:!0,data:null}):{status:!1,errMessage:"Shop name is not found!"}):Promise.resolve({status:!0,data:null}):Promise.resolve({status:!1,errMessage:"Local Shop Information is not defined!"})}getLocalShopId(){if(-1!==this.localShopId)return this.localShopId;throw new Error("Local shop id is not yet retrieved!")}getShopifiedProducts(){return shop_service_1.default.getShopifiedProducts(this.getLocalShopId())}getInStockProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:s=null,subCategoryId:o=null}){return shop_service_1.default.getInStockProducts({pageSize:e,pageIndex:t,productId:r,categoryId:s,subCategoryId:o},this.localShopId)}getInStockProduct(e){return this.getInStockProducts({productId:e,pageSize:1,pageIndex:0}).then(e=>e.status&&e.data?e.data&&e.data.products.length>0?{status:!0,data:e.data.products[0]}:{status:!1,errMessage:"Product not found!"}:{status:!1,errMessage:e.errMessage})}getPOProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:s=null,subCategoryId:o=null}){return shop_service_1.default.getPOProducts({pageSize:e,pageIndex:t,productId:r,categoryId:s,subCategoryId:o},this.localShopId)}getPOProduct(e){return this.getPOProducts({pageSize:1,pageIndex:0,productId:e}).then(e=>e.status&&e.data?e.data.products.length?{status:!0,data:e.data.products[0]}:{status:!1,errMessage:"Product not found!"}:{status:!1,errMessage:e.errMessage})}getProductsByCategories(){const e=[];let t;function r(r,s){if(!s.subCategory||!s.subCategory.category)throw new Error("Product does not have category or subCategory defined!");const o=s.subCategory.name,a=function(t,r){const s=function(t){let r=e.find(e=>e.name===t);return r||(r={name:t,subCategories:[]},e.push(r)),r}(t).subCategories;let o=s.find(e=>e.name===r);return o||(o={name:r,poProducts:[],inStockProducts:[]},s.push(o)),o}(s.subCategory.category.name,o);r?a.inStockProducts.push(s):a.poProducts.push(s),t=t?s.updatedAt>t?s.updatedAt:t:s.updatedAt}return Promise.join(this.getInStockProducts({}),this.getPOProducts({})).spread((s,o)=>s.status&&s.data&&o.status&&o.data?(s.data.forEach(e=>{r(!0,e)}),o.data.forEach(e=>{r(!1,e)}),{status:!0,data:{categories:e,lastUpdated:t}}):{status:!1,errMessage:s.errMessage||o.errMessage})}getShopifiedVariants(e){return shop_service_1.default.getShopifiedVariants(this.localShopId,e)}updateProduct(e,t){const{price:r,preOrderAllowed:s,preOrderDuration:o,disabled:a}=t;return this.getModels("ShopProduct").findOne({where:{shopId:this.localShopId,productId:e}}).then(t=>({id:t&&t.id,productId:e,shopId:this.localShopId,price:r,preOrderAllowed:s,preOrderDuration:o,disabled:a})).then(e=>this.getModels("ShopProduct").upsert(e).then(e=>({status:!0})))}getVariantInformation(e){return this.readOne("Variant",{id:e}).then(t=>{if(t.status&&t.data){const r=t.data.productId;return Promise.join(super.getSequelize().query(`SELECT * FROM shopifiedVariantsView WHERE id = ${e} AND shopId=${this.localShopId}`,{type:super.getSequelize().QueryTypes.SELECT}),super.getSequelize().query(`SELECT * FROM shopifiedProductsView WHERE id = ${r} AND shopId=${this.localShopId}`,{type:super.getSequelize().QueryTypes.SELECT})).spread((t,s)=>{if(t&&s){return{status:!0,data:{variant:Utils.objectify(t)[0],product:Utils.objectify(s)[0]}}}return t?{status:!1,errMessage:`productId=${r} is not found!`}:{status:!1,errMessage:`variantId=${e} is not found!`}})}return{status:!1,errMessage:"variantId="+e+" is not found!"}})}getVariantPrice(e){return this.readOne("Variant",{id:e}).then(t=>{if(t.status&&t.data){const e=t.data.productId;return super.getSequelize().query(`SELECT shopPrice FROM shopifiedProductsView WHERE id = ${e} AND shopId = ${this.getLocalShopId()}`,{type:super.getSequelize().QueryTypes.SELECT}).then(t=>{if(t&&t.length>0){return{status:!0,data:t[0].shopPrice}}return{status:!1,errMessage:"productId="+e+" is not found!"}})}return{status:!1,errMessage:"variantId="+e+" is not found!"}})}getVariantAvailability(e){return this.rawReadOneQuery(`\n    SELECT * FROM shopifiedVariantsView WHERE id = ${e} AND shopId = ${this.getLocalShopId()}\n    `).then(e=>{if(e.status&&e.data){return{status:!0,data:{status:e.data.stockQuantity>0?"readyStock":"preOrder",quantity:e.data.stockQuantity}}}return{status:!1,errMessage:e.errMessage}})}getPromotions(){return shop_service_1.default.getPromotion(this.getLocalShopId())}createPromotion(e,t){return e?super.create("Promotion",Object.assign({shopId:this.getLocalShopId(),productId:e},t)):Promise.resolve({status:!1,errMessage:"productId is required!"})}updatePromotion(e,t,r){return r.id?super.update("Promotion",Object.assign({shopId:this.getLocalShopId(),productId:e},r),{id:t}):Promise.resolve({status:!1,errMessage:"promotionId is required!"})}deletePromotion(e){return e?super.delete("Promotion",{id:e}):Promise.resolve({status:!1,errMessage:"promoitonId is required!"})}}exports.default=new LocalShopService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbG9jYWwtc2hvcC1zZXJ2aWNlcy9sb2NhbC1zaG9wLXNlcnZpY2UudHMiXSwibmFtZXMiOlsiY3J1ZF9zZXJ2aWNlXzEiLCJyZXF1aXJlIiwic2hvcF9zZXJ2aWNlXzEiLCJQcm9taXNlIiwiYXBwX2NvbmZpZ18xIiwiVXRpbHMiLCJhIiwic3RhdHVzIiwiZXJyTWVzc2FnZSIsIkxvY2FsU2hvcFNlcnZpY2UiLCJDUlVEU2VydmljZSIsIltvYmplY3QgT2JqZWN0XSIsInRoaXMiLCJsb2NhbFNob3BJZCIsImRlZmF1bHQiLCJMT0NBTF9TSE9QX0lORk9STUFUSU9OIiwiTkFNRSIsInN1cGVyIiwicmVhZE9uZSIsIm5hbWUiLCJ0aGVuIiwicmVzcCIsImRhdGEiLCJpZCIsInJlc29sdmUiLCJFcnJvciIsImdldFNob3BpZmllZFByb2R1Y3RzIiwiZ2V0TG9jYWxTaG9wSWQiLCJwYWdlU2l6ZSIsInBhZ2VJbmRleCIsInByb2R1Y3RJZCIsImNhdGVnb3J5SWQiLCJzdWJDYXRlZ29yeUlkIiwiZ2V0SW5TdG9ja1Byb2R1Y3RzIiwicHJvZHVjdHMiLCJsZW5ndGgiLCJnZXRQT1Byb2R1Y3RzIiwiY2F0ZWdvcmllcyIsImxhc3RVcGRhdGVkIiwiYWRkUHJvZHVjdCIsImluU3RvY2tQcm9kdWN0IiwicHJvZHVjdCIsInN1YkNhdGVnb3J5IiwiY2F0ZWdvcnkiLCJzdWJDYXRlZ29yeU5hbWUiLCJjYXRlZ29yeU5hbWUiLCJzdWJDYXRlZ29yaWVzIiwiZmluZCIsInB1c2giLCJnZXRDYXRlZ29yeSIsInBvUHJvZHVjdHMiLCJpblN0b2NrUHJvZHVjdHMiLCJnZXRTdWJDYXRlZ29yeSIsInVwZGF0ZWRBdCIsImpvaW4iLCJzcHJlYWQiLCJyZXNwMSIsInJlc3AyIiwiZm9yRWFjaCIsInBvUHJvZHVjdCIsImdldFNob3BpZmllZFZhcmlhbnRzIiwicHJpY2UiLCJwcmVPcmRlckFsbG93ZWQiLCJwcmVPcmRlckR1cmF0aW9uIiwiZGlzYWJsZWQiLCJnZXRNb2RlbHMiLCJmaW5kT25lIiwid2hlcmUiLCJzaG9wSWQiLCJzaG9wUHJvZHVjdCIsInVwc2VydCIsImNvdW50IiwidmFyaWFudElkIiwiZ2V0U2VxdWVsaXplIiwicXVlcnkiLCJ0eXBlIiwiUXVlcnlUeXBlcyIsIlNFTEVDVCIsInJhd1ZhcmlhbnQiLCJyYXdQcm9kdWN0IiwidmFyaWFudCIsIm9iamVjdGlmeSIsInJlc3VsdCIsInNob3BQcmljZSIsInJhd1JlYWRPbmVRdWVyeSIsInN0b2NrUXVhbnRpdHkiLCJxdWFudGl0eSIsImdldFByb21vdGlvbiIsImNyZWF0ZSIsIk9iamVjdCIsImFzc2lnbiIsInByb21vdGlvbklkIiwidXBkYXRlIiwiZGVsZXRlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUVBLE1BQUFBLGVBQUFDLFFBQUEsK0JBQ0FDLGVBQUFELFFBQUEsK0JBRUFFLFFBQUFGLFFBQUEsWUFFQUcsYUFBQUgsUUFBQSxvQkFDQUksTUFBQUosUUFBQSxvQkFnQk1LLEdBQXdCQyxRQUFRLEVBQU9DLFdBQVksVUFPekRDLHlCQUErQlQsZUFBQVUsWUFBL0JDLGtDQUNVQyxLQUFBQyxhQUF1QixFQUMvQkYsYUFDRSxPQUFLUCxhQUFBVSxRQUFVQyx3QkFBMkJYLGFBQUFVLFFBQVVDLHVCQUF1QkMsTUFHL0MsSUFBdEJKLEtBQUtDLFlBQ0FJLE1BQU1DLFFBQWMsUUFBVUMsS0FBTWYsYUFBQVUsUUFBVUMsdUJBQXVCQyxPQUFRSSxLQUFLQyxHQUNuRkEsRUFBS2QsUUFBVWMsRUFBS0MsTUFDdEJWLEtBQUtDLFlBQWNRLEVBQUtDLEtBQUtDLElBQ3BCaEIsUUFBUSxFQUFNZSxLQUFNLFFBRXBCZixRQUFRLEVBQU9DLFdBQVksNEJBSWpDTCxRQUFRcUIsU0FBVWpCLFFBQVEsRUFBTWUsS0FBTSxPQVp4Q25CLFFBQVFxQixTQUFVakIsUUFBUSxFQUFPQyxXQUFZLDJDQWlCeERHLGlCQUNFLElBQTBCLElBQXRCQyxLQUFLQyxZQUNQLE9BQU9ELEtBQUtDLFlBRVosTUFBTSxJQUFJWSxN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RWpHbkIsUUFBUXFCLFNBQVVqQixRQUFRLEVBQU9DLFdBQVksMkJBSXhERyxnQkFBaUJtQixFQUFtQjZELEVBQXFCckUsR0FDdkQsT0FBSUEsRUFBS0MsR0FDQU4sTUFBTTJFLE9BQWtCLFlBQzNCSCxPQUFPQyxRQUFTdEIsT0FBUXhELEtBQUtlLGlCQUFrQkcsVUFBQUEsR0FBYVIsSUFBU0MsR0FBSW9FLElBRXRFeEYsUUFBUXFCLFNBQVVqQixRQUFRLEVBQU9DLFdBQVksNkJBS3hERyxnQkFBaUJnRixHQUNmLE9BQUlBLEVBQ0sxRSxNQUFNNEUsT0FBa0IsYUFBZXRFLEdBQUlvRSxJQUUzQ3hGLFFBQVFxQixTQUFVakIsUUFBUSxFQUFPQyxXQUFZLDhCQUsxRHNGLFFBQUFoRixRQUFlLElBQUlMIiwiZmlsZSI6ImFwcC9sb2NhbC1zaG9wLXNlcnZpY2VzL2xvY2FsLXNob3Atc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHV0aWwgZnJvbSAndXRpbCdcblxuaW1wb3J0IHsgQ1JVRFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jcnVkLXNlcnZpY2UnXG5pbXBvcnQgU2hvcFNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvc2hvcC1zZXJ2aWNlJ1xuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICdzZXF1ZWxpemUnXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuXG5pbXBvcnQgQXBwQ29uZmlnIGZyb20gJy4uLy4uL2FwcC1jb25maWcnXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICcuLi8uLi9saWJzL3V0aWxzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFZhcmlhbnRBdmFpbGFiaWxpdHkge1xuICBzdGF0dXM6ICdyZWFkeVN0b2NrJyB8ICdwcmVPcmRlcidcbiAgcXVhbnRpdHk/OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYXRlZ29yaXplZFByb2R1Y3Qge1xuICBuYW1lOiBzdHJpbmcgLy8gQ2F0ZWdvcnkgbmFtZVxuICBzdWJDYXRlZ29yaWVzOiBBcnJheTx7XG4gICAgbmFtZTogc3RyaW5nXG4gICAgaW5TdG9ja1Byb2R1Y3RzOiBBcnJheTxJblN0b2NrUHJvZHVjdD5cbiAgICBwb1Byb2R1Y3RzOiBBcnJheTxQT1Byb2R1Y3Q+XG4gIH0+XG59XG5cbmNvbnN0IGE6IE5DUmVzcG9uc2U8bnVsbD4gPSB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICcnIH1cblxuLypcbiAgVXNlZCBmb3Igc2hvcC1zcGVjaWZpYyBjb2RlLiBUaGlzIHNob3VsZCByZS11c2Ugd2hhdCdzIGluIHNob3Atc2VydmljZSBhcyBtdWNoIGFzIHBvc3NpYmxlLCB0aG91Z2guXG5cbiAgVE9ETzogTW92ZSBvdXQgdGhlIGxvZ2ljcyBoZXJlIHRvIHNlcGFyYXRlIGZpbGVzLiBUaGlzIGZpbGUgc2hvdWxkIG9ubHkgY29udGFpbiBnZXRMb2NhbFNob3BJZCgpIGFuZCBpbml0aWFsaXphdGlvblxuICovXG5jbGFzcyBMb2NhbFNob3BTZXJ2aWNlIGV4dGVuZHMgQ1JVRFNlcnZpY2Uge1xuICBwcml2YXRlIGxvY2FsU2hvcElkOiBudW1iZXIgPSAtMVxuICBpbml0aWFsaXplICgpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVsbD4+IHtcbiAgICBpZiAoIUFwcENvbmZpZy5MT0NBTF9TSE9QX0lORk9STUFUSU9OIHx8ICFBcHBDb25maWcuTE9DQUxfU0hPUF9JTkZPUk1BVElPTi5OQU1FKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0xvY2FsIFNob3AgSW5mb3JtYXRpb24gaXMgbm90IGRlZmluZWQhJyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5sb2NhbFNob3BJZCA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8U2hvcD4oJ1Nob3AnLCB7IG5hbWU6IEFwcENvbmZpZy5MT0NBTF9TSE9QX0lORk9STUFUSU9OLk5BTUUgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsU2hvcElkID0gcmVzcC5kYXRhLmlkXG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IG51bGwgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnU2hvcCBuYW1lIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBudWxsIH0pXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0TG9jYWxTaG9wSWQgKCk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMubG9jYWxTaG9wSWQgIT09IC0xKSB7XG4gICAgICByZXR1cm4gdGhpcy5sb2NhbFNob3BJZFxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvY2FsIHNob3AgaWQgaXMgbm90IHlldCByZXRyaWV2ZWQhJylcbiAgICB9XG4gIH1cblxuICBnZXRTaG9waWZpZWRQcm9kdWN0cyAoKSB7XG4gICAgcmV0dXJuIFNob3BTZXJ2aWNlLmdldFNob3BpZmllZFByb2R1Y3RzKHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSlcbiAgfVxuXG4gIC8qXG4gICAgSW5TdG9ja1Byb2R1Y3RbXSB3aXRoOlxuICAgIC1wcmltYXJ5SW1hZ2VcbiAgICAtc3ViQ2F0ZWdvcmllc1xuXG4gICAgVGhpcyBpcyB1c2VkIGJ5IGxhbmRpbmcgcGFnZSwgd2hlcmUgd2UgZGlzcGxheVxuICAqL1xuICBnZXRJblN0b2NrUHJvZHVjdHMgKHsgcGFnZVNpemUgPSAxMCwgcGFnZUluZGV4ID0gMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3RJZCA9IG51bGwsIGNhdGVnb3J5SWQgPSBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3ViQ2F0ZWdvcnlJZCA9IG51bGwgfSk6IFByb21pc2U8TkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4+IHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgcGFnZVNpemUsIHBhZ2VJbmRleCwgcHJvZHVjdElkLCBjYXRlZ29yeUlkLCBzdWJDYXRlZ29yeUlkIH0sIHRoaXMubG9jYWxTaG9wSWQpXG4gIH1cblxuICBnZXRJblN0b2NrUHJvZHVjdCAocHJvZHVjdElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEluU3RvY2tQcm9kdWN0Pj4ge1xuICAgIHJldHVybiB0aGlzLmdldEluU3RvY2tQcm9kdWN0cyh7IHByb2R1Y3RJZCwgcGFnZVNpemU6IDEsIHBhZ2VJbmRleDogMCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhICYmIHJlc3AuZGF0YS5wcm9kdWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwLmRhdGEucHJvZHVjdHNbMF0gfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdQcm9kdWN0IG5vdCBmb3VuZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UE9Qcm9kdWN0cyAoeyBwYWdlU2l6ZSA9IDEwLCBwYWdlSW5kZXggPSAwLFxuICAgICAgICAgICAgICAgICAgIHByb2R1Y3RJZCA9IG51bGwsIGNhdGVnb3J5SWQgPSBudWxsLFxuICAgICAgICAgICAgICAgICAgIHN1YkNhdGVnb3J5SWQgPSBudWxsIH0pOiBQcm9taXNlPE5DUmVzcG9uc2U8eyBwcm9kdWN0czogUE9Qcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlciB9Pj4ge1xuICAgIHJldHVybiBTaG9wU2VydmljZS5nZXRQT1Byb2R1Y3RzKHsgcGFnZVNpemUsIHBhZ2VJbmRleCwgcHJvZHVjdElkLCBjYXRlZ29yeUlkLCBzdWJDYXRlZ29yeUlkIH0sIHRoaXMubG9jYWxTaG9wSWQpXG4gIH1cblxuICBnZXRQT1Byb2R1Y3QgKHByb2R1Y3RJZCk6IFByb21pc2U8TkNSZXNwb25zZTxQT1Byb2R1Y3Q+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UE9Qcm9kdWN0cyh7IHBhZ2VTaXplOiAxLCBwYWdlSW5kZXg6IDAsIHByb2R1Y3RJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhLnByb2R1Y3RzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcC5kYXRhLnByb2R1Y3RzWzBdIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnUHJvZHVjdCBub3QgZm91bmQhJyB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFByb2R1Y3RzQnlDYXRlZ29yaWVzICgpOiBQcm9taXNlPE5DUmVzcG9uc2U8e2NhdGVnb3JpZXM6IENhdGVnb3JpemVkUHJvZHVjdFtdLCBsYXN0VXBkYXRlZDogc3RyaW5nfT4+IHtcbiAgICAvKlxuICAgICAgV2UnbGwgaGF2ZSBhdCBtb3N0IHRob3VzYW5kcyBvZiBwcm9kdWN0cyBhbmQgZ2V0dGluZyBwcmljZSBsaXN0IGlzXG4gICAgICBub3Qgc29tZXRoaW5nIGRvbmUgdG9vIG9mdGVuLiBTbyBmb3Igbm93LCB3ZSBjYW4gZ2V0IGJ5IGRvaW5nIHRoZSBwcm9kdWN0XG4gICAgICBncm91cGluZyBtYW51YWxseS5cbiAgICAqL1xuICAgIGNvbnN0IGNhdGVnb3JpZXM6IENhdGVnb3JpemVkUHJvZHVjdFtdID0gW11cbiAgICBsZXQgbGFzdFVwZGF0ZWQ6IHN0cmluZ1xuICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBoZWxwIGdyb3VwaW5nXG4gICAgZnVuY3Rpb24gYWRkUHJvZHVjdCAoaW5TdG9ja1Byb2R1Y3Q6IGJvb2xlYW4sIHByb2R1Y3Q6IEluU3RvY2tQcm9kdWN0IHwgUE9Qcm9kdWN0KSB7XG4gICAgICBmdW5jdGlvbiBnZXRTdWJDYXRlZ29yeSAoY2F0ZWdvcnlOYW1lLCBzdWJDYXRlZ29yeU5hbWUpIHtcbiAgICAgICAgZnVuY3Rpb24gZ2V0Q2F0ZWdvcnkgKGNhdGVnb3J5TmFtZSkge1xuICAgICAgICAgIGxldCBjYXRlZ29yeSA9IGNhdGVnb3JpZXMuZmluZChjYXRlZ29yeSA9PiBjYXRlZ29yeS5uYW1lID09PSBjYXRlZ29yeU5hbWUpXG4gICAgICAgICAgaWYgKCFjYXRlZ29yeSkge1xuICAgICAgICAgICAgY2F0ZWdvcnkgPSB7XG4gICAgICAgICAgICAgIG5hbWU6IGNhdGVnb3J5TmFtZSxcbiAgICAgICAgICAgICAgc3ViQ2F0ZWdvcmllczogW11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGVnb3JpZXMucHVzaChjYXRlZ29yeSlcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGNhdGVnb3J5XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3ViQ2F0ZWdvcmllcyA9IGdldENhdGVnb3J5KGNhdGVnb3J5TmFtZSkuc3ViQ2F0ZWdvcmllc1xuICAgICAgICBsZXQgc3ViQ2F0ZWdvcnkgPSBzdWJDYXRlZ29yaWVzLmZpbmQoc3ViQ2F0ZWdvcnkgPT4gc3ViQ2F0ZWdvcnkubmFtZSA9PT0gc3ViQ2F0ZWdvcnlOYW1lKVxuICAgICAgICBpZiAoIXN1YkNhdGVnb3J5KSB7XG4gICAgICAgICAgc3ViQ2F0ZWdvcnkgPSB7XG4gICAgICAgICAgICBuYW1lOiBzdWJDYXRlZ29yeU5hbWUsXG4gICAgICAgICAgICBwb1Byb2R1Y3RzOiBbXSxcbiAgICAgICAgICAgIGluU3RvY2tQcm9kdWN0czogW11cbiAgICAgICAgICB9XG4gICAgICAgICAgc3ViQ2F0ZWdvcmllcy5wdXNoKHN1YkNhdGVnb3J5KVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdWJDYXRlZ29yeVxuICAgICAgfVxuICAgICAgaWYgKCFwcm9kdWN0LnN1YkNhdGVnb3J5IHx8ICFwcm9kdWN0LnN1YkNhdGVnb3J5LmNhdGVnb3J5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUHJvZHVjdCBkb2VzIG5vdCBoYXZlIGNhdGVnb3J5IG9yIHN1YkNhdGVnb3J5IGRlZmluZWQhJylcbiAgICAgIH1cbiAgICAgIGNvbnN0IHN1YkNhdGVnb3J5TmFtZSA9IHByb2R1Y3Quc3ViQ2F0ZWdvcnkubmFtZVxuICAgICAgY29uc3QgY2F0ZWdvcnlOYW1lID0gcHJvZHVjdC5zdWJDYXRlZ29yeS5jYXRlZ29yeS5uYW1lXG4gICAgICBjb25zdCBzdWJDYXRlZ29yeSA9IGdldFN1YkNhdGVnb3J5KGNhdGVnb3J5TmFtZSwgc3ViQ2F0ZWdvcnlOYW1lKVxuICAgICAgaWYgKGluU3RvY2tQcm9kdWN0KSB7XG4gICAgICAgIHN1YkNhdGVnb3J5LmluU3RvY2tQcm9kdWN0cy5wdXNoKHByb2R1Y3QgYXMgSW5TdG9ja1Byb2R1Y3QpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdWJDYXRlZ29yeS5wb1Byb2R1Y3RzLnB1c2gocHJvZHVjdCBhcyBQT1Byb2R1Y3QpXG4gICAgICB9XG4gICAgICBpZiAoIWxhc3RVcGRhdGVkKSB7XG4gICAgICAgIGxhc3RVcGRhdGVkID0gcHJvZHVjdC51cGRhdGVkQXRcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxhc3RVcGRhdGVkID0gcHJvZHVjdC51cGRhdGVkQXQgPiBsYXN0VXBkYXRlZCA/IHByb2R1Y3QudXBkYXRlZEF0IDogbGFzdFVwZGF0ZWRcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICB0aGlzLmdldEluU3RvY2tQcm9kdWN0cyh7fSksXG4gICAgICB0aGlzLmdldFBPUHJvZHVjdHMoe30pXG4gICAgKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPEluU3RvY2tQcm9kdWN0W10+LCByZXNwMjogTkNSZXNwb25zZTxQT1Byb2R1Y3RbXT4pID0+IHtcbiAgICAgIGlmIChyZXNwMS5zdGF0dXMgJiYgcmVzcDEuZGF0YSAmJiByZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICByZXNwMS5kYXRhLmZvckVhY2goaW5TdG9ja1Byb2R1Y3QgPT4ge1xuICAgICAgICAgIGFkZFByb2R1Y3QodHJ1ZSwgaW5TdG9ja1Byb2R1Y3QpXG4gICAgICAgIH0pXG4gICAgICAgIHJlc3AyLmRhdGEuZm9yRWFjaChwb1Byb2R1Y3QgPT4ge1xuICAgICAgICAgIGFkZFByb2R1Y3QoZmFsc2UsIHBvUHJvZHVjdClcbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgY2F0ZWdvcmllcywgbGFzdFVwZGF0ZWQgfSB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwMS5lcnJNZXNzYWdlIHx8IHJlc3AyLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRTaG9waWZpZWRWYXJpYW50cyAocHJvZHVjdElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFNob3BpZmllZFZhcmlhbnRbXT4+IHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0U2hvcGlmaWVkVmFyaWFudHModGhpcy5sb2NhbFNob3BJZCwgcHJvZHVjdElkKVxuICB9XG5cbiAgLy8gVXBkYXRlIHNob3BQcm9kdWN0IGVudHJ5XG4gIC8vIEluIGFjdHVhbGl0eSwgdGhpcyBjYW4gYmUgaW5zZXJ0L3VwZGF0ZVxuICB1cGRhdGVQcm9kdWN0IChwcm9kdWN0SWQ6IG51bWJlciwgZGF0YTogUGFydGlhbDxTaG9wUHJvZHVjdD4pIHtcbiAgICBjb25zdCB7IHByaWNlLCBwcmVPcmRlckFsbG93ZWQsIHByZU9yZGVyRHVyYXRpb24sIGRpc2FibGVkIH0gPSBkYXRhXG4gICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdTaG9wUHJvZHVjdCcpLmZpbmRPbmUoeyB3aGVyZTogeyBzaG9wSWQ6IHRoaXMubG9jYWxTaG9wSWQsIHByb2R1Y3RJZCB9IH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogZGF0YSAmJiBkYXRhLmlkLFxuICAgICAgICBwcm9kdWN0SWQsXG4gICAgICAgIHNob3BJZDogdGhpcy5sb2NhbFNob3BJZCxcbiAgICAgICAgcHJpY2UsXG4gICAgICAgIHByZU9yZGVyQWxsb3dlZCxcbiAgICAgICAgcHJlT3JkZXJEdXJhdGlvbixcbiAgICAgICAgZGlzYWJsZWRcbiAgICAgIH1cbiAgICB9KS50aGVuKHNob3BQcm9kdWN0ID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnU2hvcFByb2R1Y3QnKS51cHNlcnQoc2hvcFByb2R1Y3QpLnRoZW4oY291bnQgPT4ge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgZ2V0VmFyaWFudEluZm9ybWF0aW9uICh2YXJpYW50SWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8e3Byb2R1Y3Q6IFNob3BpZmllZFByb2R1Y3QsIHZhcmlhbnQ6IFNob3BpZmllZFZhcmlhbnR9Pj4ge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmU8VmFyaWFudD4oJ1ZhcmlhbnQnLCB7XG4gICAgICBpZDogdmFyaWFudElkXG4gICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3QgcHJvZHVjdElkID0gcmVzcC5kYXRhLnByb2R1Y3RJZFxuICAgICAgICByZXR1cm4gUHJvbWlzZS5qb2luKFxuICAgICAgICAgIHN1cGVyLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgICAgICAgYFNFTEVDVCAqIEZST00gc2hvcGlmaWVkVmFyaWFudHNWaWV3IFdIRVJFIGlkID0gJHt2YXJpYW50SWR9IEFORCBzaG9wSWQ9JHt0aGlzLmxvY2FsU2hvcElkfWAsXG4gICAgICAgICAgICB7IHR5cGU6IHN1cGVyLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLFxuICAgICAgICAgIHN1cGVyLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgICAgICAgYFNFTEVDVCAqIEZST00gc2hvcGlmaWVkUHJvZHVjdHNWaWV3IFdIRVJFIGlkID0gJHtwcm9kdWN0SWR9IEFORCBzaG9wSWQ9JHt0aGlzLmxvY2FsU2hvcElkfWAsXG4gICAgICAgICAgICB7IHR5cGU6IHN1cGVyLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pXG4gICAgICAgICkuc3ByZWFkKChyYXdWYXJpYW50LCByYXdQcm9kdWN0KSA9PiB7XG4gICAgICAgICAgaWYgKHJhd1ZhcmlhbnQgJiYgcmF3UHJvZHVjdCkge1xuICAgICAgICAgICAgY29uc3QgdmFyaWFudCA9IFV0aWxzLm9iamVjdGlmeShyYXdWYXJpYW50KVswXVxuICAgICAgICAgICAgY29uc3QgcHJvZHVjdCA9IFV0aWxzLm9iamVjdGlmeShyYXdQcm9kdWN0KVswXVxuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHZhcmlhbnQsIHByb2R1Y3QgfSB9XG4gICAgICAgICAgfSBlbHNlIGlmICghcmF3VmFyaWFudCkge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYHZhcmlhbnRJZD0ke3ZhcmlhbnRJZH0gaXMgbm90IGZvdW5kIWAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgcHJvZHVjdElkPSR7cHJvZHVjdElkfSBpcyBub3QgZm91bmQhYCB9XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3ZhcmlhbnRJZD0nICsgdmFyaWFudElkICsgJyBpcyBub3QgZm91bmQhJyB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFZhcmlhbnRQcmljZSAodmFyaWFudElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPFZhcmlhbnQ+KCdWYXJpYW50Jywge1xuICAgICAgaWQ6IHZhcmlhbnRJZFxuICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IHJlc3AuZGF0YS5wcm9kdWN0SWRcbiAgICAgICAgcmV0dXJuIHN1cGVyLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgICAgIGBTRUxFQ1Qgc2hvcFByaWNlIEZST00gc2hvcGlmaWVkUHJvZHVjdHNWaWV3IFdIRVJFIGlkID0gJHtwcm9kdWN0SWR9IEFORCBzaG9wSWQgPSAke3RoaXMuZ2V0TG9jYWxTaG9wSWQoKX1gLFxuICAgICAgICAgIHsgdHlwZTogc3VwZXIuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBjb25zdCBzaG9waWZpZWRQcm9kdWN0ID0gcmVzdWx0WzBdXG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogc2hvcGlmaWVkUHJvZHVjdC5zaG9wUHJpY2UgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3Byb2R1Y3RJZD0nICsgcHJvZHVjdElkICsgJyBpcyBub3QgZm91bmQhJyB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICd2YXJpYW50SWQ9JyArIHZhcmlhbnRJZCArICcgaXMgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBUT0RPOiBUaGlzIHJldHVybnMgdGhlIHF1YW50aXR5IG9mIHRoZSBwcm9kdWN0LCBidXQgd2hhdCB3ZSB3YW50IGlzIHRoZSBxdWFudGl0eSBvZiBhIHNwZWNpZmljIHZhcmlhbnQsXG4gIC8vICAgICAgIG5vdCBhbGwgb2YgdGhlbSFcbiAgZ2V0VmFyaWFudEF2YWlsYWJpbGl0eSAodmFyaWFudElkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8VmFyaWFudEF2YWlsYWJpbGl0eT4+IHtcbiAgICByZXR1cm4gdGhpcy5yYXdSZWFkT25lUXVlcnkoYFxuICAgIFNFTEVDVCAqIEZST00gc2hvcGlmaWVkVmFyaWFudHNWaWV3IFdIRVJFIGlkID0gJHt2YXJpYW50SWR9IEFORCBzaG9wSWQgPSAke3RoaXMuZ2V0TG9jYWxTaG9wSWQoKX1cbiAgICBgKS50aGVuKChyZXNwOiBOQ1Jlc3BvbnNlPFNob3BpZmllZFZhcmlhbnQ+KSA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IHtcbiAgICAgICAgICBzdGF0dXM6IHJlc3AuZGF0YS5zdG9ja1F1YW50aXR5ID4gMCA/ICdyZWFkeVN0b2NrJyA6ICdwcmVPcmRlcicsXG4gICAgICAgICAgcXVhbnRpdHk6IHJlc3AuZGF0YS5zdG9ja1F1YW50aXR5XG4gICAgICAgIH0gYXMgVmFyaWFudEF2YWlsYWJpbGl0eVxuXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogYXZhaWxhYmlsaXR5IH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFByb21vdGlvbnMgKCk6IFByb21pc2U8TkNSZXNwb25zZTxTaG9waWZpZWRQcm9tb3Rpb25bXT4+IHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0UHJvbW90aW9uKHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSlcbiAgfVxuXG4gIGNyZWF0ZVByb21vdGlvbiAocHJvZHVjdElkOiBudW1iZXIsIGRhdGE6IFBhcnRpYWw8UHJvbW90aW9uPik6IFByb21pc2U8TkNSZXNwb25zZTxQcm9tb3Rpb24+PiB7XG4gICAgaWYgKHByb2R1Y3RJZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLmNyZWF0ZTxQcm9tb3Rpb24+KCdQcm9tb3Rpb24nLCBPYmplY3QuYXNzaWduKHsgc2hvcElkOiB0aGlzLmdldExvY2FsU2hvcElkKCksIHByb2R1Y3RJZCB9LCBkYXRhKSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdwcm9kdWN0SWQgaXMgcmVxdWlyZWQhJyB9KVxuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVByb21vdGlvbiAocHJvZHVjdElkOiBudW1iZXIsIHByb21vdGlvbklkOiBudW1iZXIsIGRhdGE6IFBhcnRpYWw8UHJvbW90aW9uPik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgaWYgKGRhdGEuaWQpIHtcbiAgICAgIHJldHVybiBzdXBlci51cGRhdGU8UHJvbW90aW9uPignUHJvbW90aW9uJyxcbiAgICAgICAgICBPYmplY3QuYXNzaWduKHsgc2hvcElkOiB0aGlzLmdldExvY2FsU2hvcElkKCksIHByb2R1Y3RJZCB9LCBkYXRhKSwgeyBpZDogcHJvbW90aW9uSWQgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdwcm9tb3Rpb25JZCBpcyByZXF1aXJlZCEnIH0pXG4gICAgfVxuICB9XG5cbiAgLy8gVE9ETzogQWRkIHNob3BJZDogdGhpcy5nZXRMb2NhbFNob3BJZCgpIGZvciBzZWN1cml0eVxuICBkZWxldGVQcm9tb3Rpb24gKHByb21vdGlvbklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIGlmIChwcm9tb3Rpb25JZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLmRlbGV0ZTxQcm9tb3Rpb24+KCdQcm9tb3Rpb24nLCB7IGlkOiBwcm9tb3Rpb25JZCB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3Byb21vaXRvbklkIGlzIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IExvY2FsU2hvcFNlcnZpY2UoKVxuIl19
