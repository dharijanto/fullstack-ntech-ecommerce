"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),moment=require("moment"),log=require("npmlog"),app_config_1=require("../../app-config"),crud_service_1=require("../../services/crud-service"),local_shop_service_1=require("./local-shop-service"),order_service_1=require("../../services/order-service"),print_service_1=require("../../services/print-service"),stock_service_1=require("./stock-service"),TAG="OrderService";class LocalOrderService extends crud_service_1.default{constructor(){super(),this.receiptPrinter=new print_service_1.default(app_config_1.default.RECEIPT_PRINTER.DEVICE_NAME,app_config_1.default.RECEIPT_PRINTER.PAPER_WIDTH)}getOrders(){return order_service_1.default.getOrders(local_shop_service_1.default.getLocalShopId())}getOpenOrders(){return this.getSequelize().query(`SELECT * FROM ordersView WHERE shopId = ${local_shop_service_1.default.getLocalShopId()} AND status != 'Close' AND status != 'Cancelled'`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getClosedOrders(){return this.getSequelize().query(`SELECT * FROM ordersView WHERE shopId = ${local_shop_service_1.default.getLocalShopId()} AND status = 'Close' OR status = 'Cancelled'`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getOrderDetails(e){return order_service_1.default.getOrderDetails(e)}getCustomerOrderDetails(e){return this.getSequelize().query(`SELECT * FROM customerOrderDetailsView WHERE orderId = ${e}`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}addOrder(e){return super.create("Order",Object.assign(e,{status:"Open",shopId:local_shop_service_1.default.getLocalShopId()}))}editOrder(e){const t={fullName:e.fullName,phoneNumber:e.phoneNumber,notes:e.notes};return e.id?super.readOne("Order",{id:e.id}).then(r=>r.status&&r.data?"Open"!==r.data.status?{status:!1,errMessage:"Only open order can be editted!"}:e.fullName?super.update("Order",t,{id:e.id}):Promise.resolve({status:!1,errMssage:"fullName is required!"}):{status:!1,errMessage:"Order is not found!"}):Promise.resolve({status:!1,errMessage:"Order is required!"})}cancelOrder(e){return super.readOne("Order",{id:e}).then(t=>t.status&&t.data?"Open"!==t.data.status?{status:!1,errMessage:"Only open order can be cancelled!"}:super.update("Order",{status:"Cancelled"},{id:e}):{status:!1,errMessage:"Order is not found!"})}closeOrder(e){return super.readOne("Order",{id:e}).then(t=>t.status&&t.data?"Open"===t.data.status?super.read("OrderDetail",{orderId:e}).then(t=>{if(t.status){if(t.data){const r=t.data;let s=!1;return r.forEach(e=>{"PO"===e.status&&(s=!0)}),super.update("Order",{status:s?"PO":"Close"},{id:e})}return{status:!1,errMessage:"Order is empty!"}}return{status:!1,errMessage:t.errMessage}}):(console.log("status="+JSON.stringify(t.data)),{status:!1,errMessage:"Only open order can be closed!"}):{status:!1,errMessage:"Order is not found!"})}finishPOOrder(e){return super.readOne("Order",{id:e}).then(t=>{if(t.status&&t.data){return"PO"===t.data.status?super.update("Order",{status:"Close"},{id:e}):{status:!1,errMessage:"Only PO order can be finished!"}}return{status:!1,errMessage:"Order is not found!"}})}isOpenOrder(e){return super.readOne("Order",{id:e}).then(e=>e.status&&e.data?"Open"===e.data.status?{status:!0}:{status:!1,errMessage:"Order is not of 'Open' status!"}:{status:!1,errMessage:"Order not found!"})}addPOOrderDetail(e,t,r){return local_shop_service_1.default.getVariantPrice(t).then(s=>{if(s.status&&s.data){const a=s.data;return super.getModels("OrderDetail").bulkCreate([{variantId:t,orderId:e,status:"PO",quantity:r,price:a}]).then(e=>({status:!0,data:e}))}return{status:!1,errMessage:"Failed to get variant price: "+s.errMessage}})}addInStockOrderDetail(e,t,r){return log.verbose(TAG,`addOrderDetailWithStatus(): orderId=${e} variantId=${t}`),local_shop_service_1.default.getVariantPrice(t).then(s=>{if(s.status&&s.data){const a=s.data;return stock_service_1.default.getStocksGroupedByAisle(t).then(s=>{if(s.status&&s.data){const d=s.data;let u=r;const i=[];for(let r=0;r<d.length;r++){const s=d[r];if(u<=s.quantity){i.push({orderId:e,status:"Ready",variantId:t,quantity:u,price:a,aisle:s.aisle}),u=0;break}i.push({orderId:e,status:"Ready",variantId:t,quantity:s.quantity,price:a,aisle:s.aisle}),u-=s.quantity}return u>0?{status:!1,errMessage:"No enough quantity available!"}:super.getModels("OrderDetail").bulkCreate(i).then(e=>e.length?{status:!0,data:e}:{status:!1,errMessage:"Failed to create order details!"})}return{status:!1,errMessage:"shopStocks not found!"}})}throw new Error(`variantId=${t} is not found!`)})}addOrderDetail(e,t,r){return r<=0?Promise.resolve({status:!1,errMessage:"Quantity needs to be a positive number!"}):this.isOpenOrder(e).then(s=>s.status?local_shop_service_1.default.getVariantAvailability(t).then(s=>{if(s.status&&s.data){const a=s.data;return log.verbose(TAG,`addOrderDetail(): quantity=${r} availability.quantity=${a.quantity}`),"readyStock"===a.status&&r>(a.quantity||0)?{status:!1,errMessage:`Only ${a.quantity} ready stock(s) left!`}:"preOrder"===a.status?this.addPOOrderDetail(e,t,r):this.addInStockOrderDetail(e,t,r)}return{status:!1,errMessage:"Failed to get variant information: "+s.errMessage}}):{status:!1,errMessage:s.errMessage})}editOrderDetail(e,t,r){}deleteOrderDetail(e){return e?super.readOne("OrderDetail",{id:e}).then(t=>{if(t.status&&t.data){const r=t.data.orderId;return this.isOpenOrder(r).then(t=>t.status?super.delete("OrderDetail",{id:e}):{status:!1,errMessage:t.errMessage})}return{status:!1,errMessage:t.errMessage}}):Promise.resolve({status:!1,errMessage:"orderDetailId is reuqired!"})}printReceipt(e,t=1){return Promise.resolve(this.receiptPrinter.printURL(e,t).then(e=>e.status?{status:!0}:{status:!1,errMessage:e.errMessage}))}getReceipt(e){return e?order_service_1.default.getOrder(e).then(t=>{if(t.status&&t.data){const r=t.data;if("Close"===r.status||"PO"===r.status){let s={orderId:r.id,fullName:r.fullName,phoneNumber:r.phoneNumber,status:r.status,totalPrice:r.price,poDuration:void 0,orderDate:moment(t.data.updatedAt).format("DD-MM-YY HH:mm"),printDate:moment().format("DD-MM-YY HH:mm"),items:[]};return this.getCustomerOrderDetails(e).then(e=>e.status&&e.data?(e.data.forEach(e=>{s.items.push({name:e.productName,status:e.status,variant:e.variantName,price:e.price,quantity:e.quantity}),"PO"===e.status&&(s.poDuration?s.poDuration=Math.max(s.poDuration,e.preOrderDuration):s.poDuration=e.preOrderDuration)}),{status:!0,data:s}):{status:!1,errMessage:"Order is empty!"})}return{status:!1,errMessage:"Only closed or PO order can be printed!"}}return{status:!1,errMessage:"Order is not found!"}}):Promise.resolve({status:!1,errMessage:"orderId is required!"})}}exports.default=new LocalOrderService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbG9jYWwtc2hvcC1zZXJ2aWNlcy9vcmRlci1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwibW9tZW50IiwibG9nIiwiYXBwX2NvbmZpZ18xIiwiY3J1ZF9zZXJ2aWNlXzEiLCJsb2NhbF9zaG9wX3NlcnZpY2VfMSIsIm9yZGVyX3NlcnZpY2VfMSIsInByaW50X3NlcnZpY2VfMSIsInN0b2NrX3NlcnZpY2VfMSIsIlRBRyIsIkxvY2FsT3JkZXJTZXJ2aWNlIiwiZGVmYXVsdCIsIltvYmplY3QgT2JqZWN0XSIsInN1cGVyIiwidGhpcyIsInJlY2VpcHRQcmludGVyIiwiUkVDRUlQVF9QUklOVEVSIiwiREVWSUNFX05BTUUiLCJQQVBFUl9XSURUSCIsImdldE9yZGVycyIsImdldExvY2FsU2hvcElkIiwiZ2V0U2VxdWVsaXplIiwicXVlcnkiLCJ0eXBlIiwiUXVlcnlUeXBlcyIsIlNFTEVDVCIsInRoZW4iLCJyZXN1bHQiLCJzdGF0dXMiLCJkYXRhIiwib3JkZXJJZCIsImdldE9yZGVyRGV0YWlscyIsImNyZWF0ZSIsIk9iamVjdCIsImFzc2lnbiIsInNob3BJZCIsImVkaXR0YWJsZURhdGEiLCJmdWxsTmFtZSIsInBob25lTnVtYmVyIiwibm90ZXMiLCJpZCIsInJlYWRPbmUiLCJyZXNwIiwiZXJyTWVzc2FnZSIsInVwZGF0ZSIsInJlc29sdmUiLCJlcnJNc3NhZ2UiLCJyZWFkIiwicmVzcDIiLCJvcmRlckRldGFpbHMiLCJpc1BPIiwiZm9yRWFjaCIsIm9yZGVyRGV0YWlsIiwiY29uc29sZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ2YXJpYW50SWQiLCJxdWFudGl0eSIsImdldFZhcmlhbnRQcmljZSIsInByaWNlIiwiZ2V0TW9kZWxzIiwiYnVsa0NyZWF0ZSIsInZlcmJvc2UiLCJnZXRTdG9ja3NHcm91cGVkQnlBaXNsZSIsInN0b2NrcyIsInJlbWFpbmluZ1F1YW50aXR5IiwiaSIsImxlbmd0aCIsInN0b2NrIiwicHVzaCIsImFpc2xlIiwiRXJyb3IiLCJpc09wZW5PcmRlciIsImdldFZhcmlhbnRBdmFpbGFiaWxpdHkiLCJhdmFpbGFiaWxpdHkiLCJhZGRQT09yZGVyRGV0YWlsIiwiYWRkSW5TdG9ja09yZGVyRGV0YWlsIiwib3JkZXJEZXRhaWxJZCIsImRlbGV0ZSIsImZ1bGxVUkwiLCJudW1Db3BpZXMiLCJwcmludFVSTCIsImdldE9yZGVyIiwib3JkZXIiLCJyZWNlaXB0IiwidG90YWxQcmljZSIsInBvRHVyYXRpb24iLCJ1bmRlZmluZWQiLCJvcmRlckRhdGUiLCJ1cGRhdGVkQXQiLCJmb3JtYXQiLCJwcmludERhdGUiLCJpdGVtcyIsImdldEN1c3RvbWVyT3JkZXJEZXRhaWxzIiwibmFtZSIsInByb2R1Y3ROYW1lIiwidmFyaWFudCIsInZhcmlhbnROYW1lIiwiTWF0aCIsIm1heCIsInByZU9yZGVyRHVyYXRpb24iLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBRUEsTUFBQUEsUUFBQUMsUUFBQSxZQUVBQyxPQUFBRCxRQUFBLFVBQ0FFLElBQUFGLFFBQUEsVUFFQUcsYUFBQUgsUUFBQSxvQkFDQUksZUFBQUosUUFBQSwrQkFDQUsscUJBQUFMLFFBQUEsd0JBQ0FNLGdCQUFBTixRQUFBLGdDQUNBTyxnQkFBQVAsUUFBQSxnQ0FDQVEsZ0JBQUFSLFFBQUEsbUJBRU1TLElBQU0scUJBMENaQywwQkFBZ0NOLGVBQUFPLFFBRTlCQyxjQUNFQyxRQUNBQyxLQUFLQyxlQUFpQixJQUFJUixnQkFBQUksUUFBYVIsYUFBQVEsUUFBVUssZ0JBQWdCQyxZQUFhZCxhQUFBUSxRQUFVSyxnQkFBZ0JFLGFBRzFHTixZQUNFLE9BQU9OLGdCQUFBSyxRQUFhUSxVQUFVZCxxQkFBQU0sUUFBaUJTLGtCQUdqRFIsZ0JBQ0UsT0FBT0UsS0FBS08sZUFBZUMsaURBQ1lqQixxQkFBQU0sUUFBaUJTLG9FQUNwREcsS0FBTVQsS0FBS08sZUFBZUcsV0FBV0MsU0FBVUMsS0FBS0MsR0FDaERBLEdBQ09DLFFBQVEsRUFBTUMsS0FB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dkYsT0FBT3lDLEVBQUtiLEtBQUs0RCxXQUFXQyxPQUFPLGtCQUM5Q0MsVUFBVzFGLFNBQVN5RixPQUFPLGtCQUMzQkUsVUFFRixPQUFPOUUsS0FBSytFLHdCQUF3Qi9ELEdBQVNKLEtBQUtnQixHQUM1Q0EsRUFBS2QsUUFBVWMsRUFBS2IsTUFDdEJhLEVBQUtiLEtBQUtzQixRQUFRQyxJQUNoQmdDLEVBQVFRLE1BQU12QixNQUNaeUIsS0FBTTFDLEVBQVkyQyxZQUNsQm5FLE9BQVF3QixFQUFZeEIsT0FDcEJvRSxRQUFTNUMsRUFBWTZDLFlBQ3JCdEMsTUFBT1AsRUFBWU8sTUFDbkJGLFNBQVVMLEVBQVlLLFdBRUcsT0FBdkJMLEVBQVl4QixTQUNUd0QsRUFBUUUsV0FHWEYsRUFBUUUsV0FBYVksS0FBS0MsSUFBSWYsRUFBUUUsV0FBWWxDLEVBQVlnRCxrQkFGOURoQixFQUFRRSxXQUFhbEMsRUFBWWdELHFCQU05QnhFLFFBQVEsRUFBTUMsS0FBTXVELEtBRXBCeEQsUUFBUSxFQUFPZSxXQUFZLG9CQUl4QyxPQUFTZixRQUFRLEVBQU9lLFdBQVksMkNBR3RDLE9BQVNmLFFBQVEsRUFBT2UsV0FBWSx5QkFJakM1QyxRQUFROEMsU0FBVWpCLFFBQVEsRUFBT2UsV0FBWSwwQkFLMUQwRCxRQUFBMUYsUUFBZSxJQUFJRCIsImZpbGUiOiJhcHAvbG9jYWwtc2hvcC1zZXJ2aWNlcy9vcmRlci1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdXRpbCBmcm9tICd1dGlsJ1xuXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICdzZXF1ZWxpemUnXG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50J1xuaW1wb3J0ICogYXMgbG9nIGZyb20gJ25wbWxvZydcblxuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi8uLi9hcHAtY29uZmlnJ1xuaW1wb3J0IENSVURTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL2NydWQtc2VydmljZSdcbmltcG9ydCBMb2NhbFNob3BTZXJ2aWNlIGZyb20gJy4vbG9jYWwtc2hvcC1zZXJ2aWNlJ1xuaW1wb3J0IE9yZGVyU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9vcmRlci1zZXJ2aWNlJ1xuaW1wb3J0IFByaW50U2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wcmludC1zZXJ2aWNlJ1xuaW1wb3J0IFN0b2NrU2VydmljZSBmcm9tICcuL3N0b2NrLXNlcnZpY2UnXG5cbmNvbnN0IFRBRyA9ICdPcmRlclNlcnZpY2UnXG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvZHVjdEF2YWlsYWJpbGl0eSB7XG4gIHN0YXR1czogJ3JlYWR5U3RvY2snIHwgJ3ByZU9yZGVyJyB8ICd1bmF2YWlsYWJsZSdcbiAgcXVhbnRpdHk/OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPcmRlclJlY2VpcHQge1xuICBvcmRlcklkOiBudW1iZXJcbiAgZnVsbE5hbWU6IHN0cmluZ1xuICBwaG9uZU51bWJlcjogc3RyaW5nXG4gIHN0YXR1czogJ0Nsb3NlJyB8ICdQTycgfCAnT3BlbicgfCAnQ2FuY2VsbGVkJ1xuICB0b3RhbFByaWNlOiBudW1iZXJcbiAgcG9EdXJhdGlvbj86IG51bWJlclxuICBvcmRlckRhdGU6IHN0cmluZ1xuICBwcmludERhdGU6IHN0cmluZ1xuICBpdGVtczoge1xuICAgIHN0YXR1czogJ1BPJyB8ICdSZWFkeSdcbiAgICBuYW1lOiBzdHJpbmdcbiAgICB2YXJpYW50OiBzdHJpbmdcbiAgICBwcmljZTogbnVtYmVyXG4gICAgcXVhbnRpdHk6IG51bWJlclxuICB9W11cbn1cblxuaW50ZXJmYWNlIEN1c3RvbWVyT3JkZXJEZXRhaWwge1xuICBvcmRlcklkOiBudW1iZXJcbiAgcXVhbnRpdHk6IG51bWJlclxuICBwcmljZTogbnVtYmVyXG4gIHN0YXR1czogJ1BPJyB8ICdSZWFkeSdcbiAgdmFyaWFudE5hbWU6IHN0cmluZ1xuICBwcm9kdWN0TmFtZTogc3RyaW5nXG4gIHByZU9yZGVyRHVyYXRpb246IG51bWJlclxufVxuXG4vKlxuICBVc2VkIGZvciBzaG9wLXNwZWNpZmljIGNvZGUuIFRoaXMgc2hvdWxkIHJlLXVzZSB3aGF0J3MgaW4gc2hvcC1zZXJ2aWNlIGFzIG11Y2ggYXMgcG9zc2libGUsIHRob3VnaC5cblxuICBUT0RPOlxuICAxLiBVcGRhdGUgb3JkZXJIaXN0b3JpZXMgd2hlbmV2ZXIgYW4gdXBkYXRlIGlzIG1hZGUgdG8gb3JkZXIgdGFibGUsIHNvIHRoYXQgd2UgaGF2ZSBiZXR0ZXIgaWRlYXMgd2hlblxuICAgICBhIHByb2JsZW0gaGFwcGVuc1xuICovXG5jbGFzcyBMb2NhbE9yZGVyU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWNlaXB0UHJpbnRlcjogUHJpbnRTZXJ2aWNlXG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5yZWNlaXB0UHJpbnRlciA9IG5ldyBQcmludFNlcnZpY2UoQXBwQ29uZmlnLlJFQ0VJUFRfUFJJTlRFUi5ERVZJQ0VfTkFNRSwgQXBwQ29uZmlnLlJFQ0VJUFRfUFJJTlRFUi5QQVBFUl9XSURUSClcbiAgfVxuXG4gIGdldE9yZGVycyAoKSB7XG4gICAgcmV0dXJuIE9yZGVyU2VydmljZS5nZXRPcmRlcnMoTG9jYWxTaG9wU2VydmljZS5nZXRMb2NhbFNob3BJZCgpKVxuICB9XG5cbiAgZ2V0T3Blbk9yZGVycyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoXG5gU0VMRUNUICogRlJPTSBvcmRlcnNWaWV3IFdIRVJFIHNob3BJZCA9ICR7TG9jYWxTaG9wU2VydmljZS5nZXRMb2NhbFNob3BJZCgpfSBBTkQgc3RhdHVzICE9ICdDbG9zZScgQU5EIHN0YXR1cyAhPSAnQ2FuY2VsbGVkJ2AsXG4gICAgICB7IHR5cGU6IHRoaXMuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXN1bHQgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UgfVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG5cbiAgZ2V0Q2xvc2VkT3JkZXJzICgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShcbmBTRUxFQ1QgKiBGUk9NIG9yZGVyc1ZpZXcgV0hFUkUgc2hvcElkID0gJHtMb2NhbFNob3BTZXJ2aWNlLmdldExvY2FsU2hvcElkKCl9IEFORCBzdGF0dXMgPSAnQ2xvc2UnIE9SIHN0YXR1cyA9ICdDYW5jZWxsZWQnYCxcbiAgICAgIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3VsdCB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gIH1cblxuICBnZXRPcmRlckRldGFpbHMgKG9yZGVySWQpIHtcbiAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLmdldE9yZGVyRGV0YWlscyhvcmRlcklkKVxuICB9XG5cbiAgZ2V0Q3VzdG9tZXJPcmRlckRldGFpbHMgKG9yZGVySWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8Q3VzdG9tZXJPcmRlckRldGFpbFtdPj4ge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIGN1c3RvbWVyT3JkZXJEZXRhaWxzVmlldyBXSEVSRSBvcmRlcklkID0gJHtvcmRlcklkfWAsXG4gICAgICB7IHR5cGU6IHRoaXMuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXN1bHQgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UgfVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG5cbiAgYWRkT3JkZXIgKGRhdGE6IFBhcnRpYWw8T3JkZXI+KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPE9yZGVyPj4ge1xuICAgIHJldHVybiBzdXBlci5jcmVhdGU8T3JkZXI+KCdPcmRlcicsIE9iamVjdC5hc3NpZ24oZGF0YSwgeyBzdGF0dXM6ICdPcGVuJywgc2hvcElkOiBMb2NhbFNob3BTZXJ2aWNlLmdldExvY2FsU2hvcElkKCkgfSkpXG4gIH1cblxuICBlZGl0T3JkZXIgKGRhdGE6IFBhcnRpYWw8T3JkZXI+KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICAvLyBNYWtlIHN1cmUgbm8gb3RoZXIgZmllbGRzIGdldCBlZGl0dGVkIGJ5IGhhY2tlclxuICAgIGNvbnN0IGVkaXR0YWJsZURhdGEgPSB7XG4gICAgICBmdWxsTmFtZTogZGF0YS5mdWxsTmFtZSxcbiAgICAgIHBob25lTnVtYmVyOiBkYXRhLnBob25lTnVtYmVyLFxuICAgICAgbm90ZXM6IGRhdGEubm90ZXNcbiAgICB9XG4gICAgaWYgKGRhdGEuaWQpIHtcbiAgICAgIHJldHVybiBzdXBlci5yZWFkT25lPE9yZGVyPignT3JkZXInLCB7IGlkOiBkYXRhLmlkIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICBpZiAocmVzcC5kYXRhLnN0YXR1cyAhPT0gJ09wZW4nKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT25seSBvcGVuIG9yZGVyIGNhbiBiZSBlZGl0dGVkIScgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZGF0YS5mdWxsTmFtZSkge1xuICAgICAgICAgICAgICByZXR1cm4gc3VwZXIudXBkYXRlPE9yZGVyPignT3JkZXInLCBlZGl0dGFibGVEYXRhLCB7IGlkOiBkYXRhLmlkIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTXNzYWdlOiAnZnVsbE5hbWUgaXMgcmVxdWlyZWQhJyB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgbm90IGZvdW5kIScgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cblxuICBjYW5jZWxPcmRlciAob3JkZXJJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlcj4oJ09yZGVyJywgeyBpZDogb3JkZXJJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhLnN0YXR1cyAhPT0gJ09wZW4nKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09ubHkgb3BlbiBvcmRlciBjYW4gYmUgY2FuY2VsbGVkIScgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8T3JkZXI+KCdPcmRlcicsIHsgc3RhdHVzOiAnQ2FuY2VsbGVkJyB9LCB7IGlkOiBvcmRlcklkIH0pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBub3QgZm91bmQhJyB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8qXG4gICAgMS4gQ2hlY2sgd2hldGhlciB0aGVyZSdzIFBPIG9yZGVyIG9yIG5vdC5cbiAgICAyLiBJZiB0aGVyZSdzLCBzZXQgc3RhdHVzIHRvICdQTydcbiAgICAzLiBJZiBub3QsIHNldCBzdGF0dXMgdG8gJ0ZpbmlzaCdcbiAgICovXG4gIGNsb3NlT3JkZXIgKG9yZGVySWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8T3JkZXI+KCdPcmRlcicsIHsgaWQ6IG9yZGVySWQgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgaWYgKHJlc3AuZGF0YS5zdGF0dXMgPT09ICdPcGVuJykge1xuICAgICAgICAgIHJldHVybiBzdXBlci5yZWFkPE9yZGVyRGV0YWlsPignT3JkZXJEZXRhaWwnLCB7IG9yZGVySWQgfSkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgICAgIGlmIChyZXNwMi5kYXRhKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb3JkZXJEZXRhaWxzID0gcmVzcDIuZGF0YVxuICAgICAgICAgICAgICAgIGxldCBpc1BPID0gZmFsc2VcbiAgICAgICAgICAgICAgICBvcmRlckRldGFpbHMuZm9yRWFjaChvcmRlckRldGFpbCA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAob3JkZXJEZXRhaWwuc3RhdHVzID09PSAnUE8nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzUE8gPSB0cnVlXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICByZXR1cm4gc3VwZXIudXBkYXRlPE9yZGVyPignT3JkZXInLCB7IHN0YXR1czogaXNQTyA/ICdQTycgOiAnQ2xvc2UnIH0sIHsgaWQ6IG9yZGVySWQgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgZW1wdHkhJyB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AyLmVyck1lc3NhZ2UgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ3N0YXR1cz0nICsgSlNPTi5zdHJpbmdpZnkocmVzcC5kYXRhKSlcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT25seSBvcGVuIG9yZGVyIGNhbiBiZSBjbG9zZWQhJyB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBub3QgZm91bmQhJyB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGZpbmlzaFBPT3JkZXIgKG9yZGVySWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8T3JkZXI+KCdPcmRlcicsIHsgaWQ6IG9yZGVySWQgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3Qgb3JkZXIgPSByZXNwLmRhdGFcbiAgICAgICAgaWYgKG9yZGVyLnN0YXR1cyA9PT0gJ1BPJykge1xuICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8T3JkZXI+KCdPcmRlcicsIHsgc3RhdHVzOiAnQ2xvc2UnIH0sIHsgaWQ6IG9yZGVySWQgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT25seSBQTyBvcmRlciBjYW4gYmUgZmluaXNoZWQhJyB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBub3QgZm91bmQhJyB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgaXNPcGVuT3JkZXIgKG9yZGVySWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxudWxsPj4ge1xuICAgIHJldHVybiBzdXBlci5yZWFkT25lPE9yZGVyPignT3JkZXInLCB7IGlkOiBvcmRlcklkIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGlmIChyZXNwLmRhdGEuc3RhdHVzID09PSAnT3BlbicpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBub3Qgb2YgXFwnT3BlblxcJyBzdGF0dXMhJyB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBub3QgZm91bmQhJyB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIFRPRE86IEZpbmlzaCB0aGlzIG9mZlxuICBhZGRQT09yZGVyRGV0YWlsIChvcmRlcklkOiBudW1iZXIsIHZhcmlhbnRJZDogbnVtYmVyLCBxdWFudGl0eTogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFBhcnRpYWw8T3JkZXJEZXRhaWxbXT4+PiB7XG4gICAgcmV0dXJuIExvY2FsU2hvcFNlcnZpY2UuZ2V0VmFyaWFudFByaWNlKHZhcmlhbnRJZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3QgcHJpY2UgPSByZXNwLmRhdGFcbiAgICAgICAgcmV0dXJuIHN1cGVyLmdldE1vZGVscygnT3JkZXJEZXRhaWwnKS5idWxrQ3JlYXRlKFt7IHZhcmlhbnRJZCwgb3JkZXJJZCwgc3RhdHVzOiAnUE8nLCBxdWFudGl0eSwgcHJpY2UgfV0pLnRoZW4oKGRhdGE6IFBhcnRpYWw8T3JkZXJEZXRhaWw+W10pID0+IHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGEgfSBhcyBOQ1Jlc3BvbnNlPFBhcnRpYWw8T3JkZXJEZXRhaWxbXT4+XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIGdldCB2YXJpYW50IHByaWNlOiAnICsgcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgYWRkSW5TdG9ja09yZGVyRGV0YWlsIChvcmRlcklkOiBudW1iZXIsIHZhcmlhbnRJZDogbnVtYmVyLCBxdWFudGl0eTogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFBhcnRpYWw8T3JkZXJEZXRhaWxbXT4+PiB7XG4gICAgbG9nLnZlcmJvc2UoVEFHLCBgYWRkT3JkZXJEZXRhaWxXaXRoU3RhdHVzKCk6IG9yZGVySWQ9JHtvcmRlcklkfSB2YXJpYW50SWQ9JHt2YXJpYW50SWR9YClcbiAgICByZXR1cm4gTG9jYWxTaG9wU2VydmljZS5nZXRWYXJpYW50UHJpY2UodmFyaWFudElkKS50aGVuKHJlc3AyID0+IHtcbiAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICBjb25zdCBwcmljZSA9IHJlc3AyLmRhdGFcbiAgICAgICAgcmV0dXJuIFN0b2NrU2VydmljZS5nZXRTdG9ja3NHcm91cGVkQnlBaXNsZSh2YXJpYW50SWQpLnRoZW4oKHJlc3A6IE5DUmVzcG9uc2U8U2hvcFN0b2NrW10+KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgY29uc3Qgc3RvY2tzID0gcmVzcC5kYXRhXG4gICAgICAgICAgICBsZXQgcmVtYWluaW5nUXVhbnRpdHkgPSBxdWFudGl0eVxuICAgICAgICAgICAgY29uc3Qgb3JkZXJEZXRhaWxzOiBQYXJ0aWFsPE9yZGVyRGV0YWlsPltdID0gW11cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RvY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHN0b2NrID0gc3RvY2tzW2ldXG4gICAgICAgICAgICAgIGlmIChyZW1haW5pbmdRdWFudGl0eSA8PSBzdG9jay5xdWFudGl0eSkge1xuICAgICAgICAgICAgICAgIG9yZGVyRGV0YWlscy5wdXNoKHsgb3JkZXJJZCwgc3RhdHVzOiAnUmVhZHknLCB2YXJpYW50SWQsIHF1YW50aXR5OiByZW1haW5pbmdRdWFudGl0eSwgcHJpY2UsIGFpc2xlOiBzdG9jay5haXNsZSB9KVxuICAgICAgICAgICAgICAgIHJlbWFpbmluZ1F1YW50aXR5ID0gMFxuICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3JkZXJEZXRhaWxzLnB1c2goeyBvcmRlcklkLCBzdGF0dXM6ICdSZWFkeScsIHZhcmlhbnRJZCwgcXVhbnRpdHk6IHN0b2NrLnF1YW50aXR5LCBwcmljZSwgYWlzbGU6IHN0b2NrLmFpc2xlIH0pXG4gICAgICAgICAgICAgICAgcmVtYWluaW5nUXVhbnRpdHkgLT0gc3RvY2sucXVhbnRpdHlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlbWFpbmluZ1F1YW50aXR5ID4gMCkge1xuICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnTm8gZW5vdWdoIHF1YW50aXR5IGF2YWlsYWJsZSEnIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBzdXBlci5nZXRNb2RlbHMoJ09yZGVyRGV0YWlsJykuYnVsa0NyZWF0ZShvcmRlckRldGFpbHMpLnRoZW4oKGRhdGE6IEFycmF5PE9yZGVyRGV0YWlsPikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0ZhaWxlZCB0byBjcmVhdGUgb3JkZXIgZGV0YWlscyEnIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdzaG9wU3RvY2tzIG5vdCBmb3VuZCEnIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHZhcmlhbnRJZD0ke3ZhcmlhbnRJZH0gaXMgbm90IGZvdW5kIWApXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGFkZE9yZGVyRGV0YWlsIChvcmRlcklkOiBudW1iZXIsIHZhcmlhbnRJZDogbnVtYmVyLCBxdWFudGl0eTogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFBhcnRpYWw8T3JkZXJEZXRhaWxbXT4+PiB7XG4gICAgLypcbiAgICAgIDEuIFZhbGlkYXRlIG9yZGVySWQgLT4gdmFsaWQgb3JkZXIgd2hvc2Ugc3RhdHVzIGlzIG5vdCBjbG9zZWQgLyBQT1xuICAgICAgMi4gVmFsaWRhdGUgdmFyaWFudElkIC0+IHByb2R1Y3Qgd2l0aCB0aGlzIGlkIGV4aXN0c1xuICAgICAgMy4gVmFsaWRhdGUgcXVhbnRpdHkgLT4gbm9uLW5lZ2F0aXZlLCBhbmQgaWYgc3RhdHVzIGlzIHJlYWR5LCBxdWFudGl0eSBkb2Vzbid0IGV4Y2VlZCB3aGF0J3MgYXZhaWxhYmxlXG4gICAgICovXG4gICAgaWYgKHF1YW50aXR5IDw9IDApIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnUXVhbnRpdHkgbmVlZHMgdG8gYmUgYSBwb3NpdGl2ZSBudW1iZXIhJyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5pc09wZW5PcmRlcihvcmRlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICByZXR1cm4gTG9jYWxTaG9wU2VydmljZS5nZXRWYXJpYW50QXZhaWxhYmlsaXR5KHZhcmlhbnRJZCkudGhlbigocmVzcDI6IE5DUmVzcG9uc2U8UHJvZHVjdEF2YWlsYWJpbGl0eT4pID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgICBjb25zdCBhdmFpbGFiaWxpdHkgPSByZXNwMi5kYXRhXG4gICAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgYGFkZE9yZGVyRGV0YWlsKCk6IHF1YW50aXR5PSR7cXVhbnRpdHl9IGF2YWlsYWJpbGl0eS5xdWFudGl0eT0ke2F2YWlsYWJpbGl0eS5xdWFudGl0eX1gKVxuICAgICAgICAgICAgICBpZiAoYXZhaWxhYmlsaXR5LnN0YXR1cyA9PT0gJ3JlYWR5U3RvY2snICYmIHF1YW50aXR5ID4gKGF2YWlsYWJpbGl0eS5xdWFudGl0eSB8fCAwKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBPbmx5ICR7YXZhaWxhYmlsaXR5LnF1YW50aXR5fSByZWFkeSBzdG9jayhzKSBsZWZ0IWAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChhdmFpbGFiaWxpdHkuc3RhdHVzID09PSAncHJlT3JkZXInKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkUE9PcmRlckRldGFpbChvcmRlcklkLCB2YXJpYW50SWQsIHF1YW50aXR5KVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEluU3RvY2tPcmRlckRldGFpbChvcmRlcklkLCB2YXJpYW50SWQsIHF1YW50aXR5KVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIGdldCB2YXJpYW50IGluZm9ybWF0aW9uOiAnICsgcmVzcDIuZXJyTWVzc2FnZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGVkaXRPcmRlckRldGFpbCAob3JkZXJEZXRhaWxJZDogbnVtYmVyLCB2YXJpYW50SWQ6IG51bWJlciwgcXVhbnRpdHk6IG51bWJlcikge1xuICAgIC8vIFRPRE86IFRvIG1ha2UgdGhpbmdzIGVhc3ksIHdlIGRvbid0IGN1cnJlbnRseSBpbXBsZW1lbnQgZWRpdFxuICAgIC8vICAgICAgIFRoZSBsb2dpYyBpcyBtb3JlIGNvbXBsZXggdGhhbiBhZGRPcmRlckRldGFpbCBiZWNhdXNlIHdlIG5lZWQgdG9cbiAgICAvLyAgICAgICB0YWtlIGludG8gYWNjb3VudCB0aGUgZGVsdGEgc3RvY2tcbiAgfVxuXG4gIGRlbGV0ZU9yZGVyRGV0YWlsIChvcmRlckRldGFpbElkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIGlmIChvcmRlckRldGFpbElkKSB7XG4gICAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlckRldGFpbD4oJ09yZGVyRGV0YWlsJywgeyBpZDogb3JkZXJEZXRhaWxJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb3JkZXJJZCA9IHJlc3AuZGF0YS5vcmRlcklkXG4gICAgICAgICAgcmV0dXJuIHRoaXMuaXNPcGVuT3JkZXIob3JkZXJJZCkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgICAgIHJldHVybiBzdXBlci5kZWxldGU8T3JkZXJEZXRhaWw+KCdPcmRlckRldGFpbCcsIHsgaWQ6IG9yZGVyRGV0YWlsSWQgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AyLmVyck1lc3NhZ2UgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdvcmRlckRldGFpbElkIGlzIHJldXFpcmVkIScgfSlcbiAgICB9XG4gIH1cblxuICAvLyBmdWxsVVJMOiBub24tcmVsYXRpdmUgVVJMIHRvIGdldCBIVE1MIHZlcnNpb24gb2YgdGhlIHJlY2VpcHRcbiAgcHJpbnRSZWNlaXB0IChmdWxsVVJMOiBzdHJpbmcsIG51bUNvcGllczogbnVtYmVyID0gMSk6IFByb21pc2U8TkNSZXNwb25zZTxudWxsPj4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5yZWNlaXB0UHJpbnRlci5wcmludFVSTChmdWxsVVJMLCBudW1Db3BpZXMpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSkpXG4gIH1cblxuICAvLyBUT0RPOiBNb2RpZnkgdGhpcyBzbyB3ZSBncm91cGVkIHRoZSBvcmRlciBkZXRhaWxzIGJ5IHZhcmlhbnRJZCwgYmVjYXVzZSB3ZSBjdXN0b21lcnMgZG9uJ3RcbiAgLy8gICAgICAgbmVlZCBhaXNsZSBpbmZvcm1hdGlvblxuICBnZXRSZWNlaXB0IChvcmRlcklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8T3JkZXJSZWNlaXB0Pj4ge1xuICAgIGlmIChvcmRlcklkKSB7XG4gICAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLmdldE9yZGVyKG9yZGVySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICBjb25zdCBvcmRlciA9IHJlc3AuZGF0YVxuICAgICAgICAgIGlmIChvcmRlci5zdGF0dXMgPT09ICdDbG9zZScgfHwgb3JkZXIuc3RhdHVzID09PSAnUE8nKSB7XG4gICAgICAgICAgICBsZXQgcmVjZWlwdDogT3JkZXJSZWNlaXB0ID0ge1xuICAgICAgICAgICAgICBvcmRlcklkOiBvcmRlci5pZCxcbiAgICAgICAgICAgICAgZnVsbE5hbWU6IG9yZGVyLmZ1bGxOYW1lLFxuICAgICAgICAgICAgICBwaG9uZU51bWJlcjogb3JkZXIucGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgIHN0YXR1czogb3JkZXIuc3RhdHVzLFxuICAgICAgICAgICAgICB0b3RhbFByaWNlOiBvcmRlci5wcmljZSxcbiAgICAgICAgICAgICAgcG9EdXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICBvcmRlckRhdGU6IG1vbWVudChyZXNwLmRhdGEudXBkYXRlZEF0KS5mb3JtYXQoJ0RELU1NLVlZIEhIOm1tJyksXG4gICAgICAgICAgICAgIHByaW50RGF0ZTogbW9tZW50KCkuZm9ybWF0KCdERC1NTS1ZWSBISDptbScpLFxuICAgICAgICAgICAgICBpdGVtczogW11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEN1c3RvbWVyT3JkZXJEZXRhaWxzKG9yZGVySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICAgICAgICByZXNwLmRhdGEuZm9yRWFjaChvcmRlckRldGFpbCA9PiB7XG4gICAgICAgICAgICAgICAgICByZWNlaXB0Lml0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBvcmRlckRldGFpbC5wcm9kdWN0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBvcmRlckRldGFpbC5zdGF0dXMsXG4gICAgICAgICAgICAgICAgICAgIHZhcmlhbnQ6IG9yZGVyRGV0YWlsLnZhcmlhbnROYW1lLFxuICAgICAgICAgICAgICAgICAgICBwcmljZTogb3JkZXJEZXRhaWwucHJpY2UsXG4gICAgICAgICAgICAgICAgICAgIHF1YW50aXR5OiBvcmRlckRldGFpbC5xdWFudGl0eVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgIGlmIChvcmRlckRldGFpbC5zdGF0dXMgPT09ICdQTycpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWNlaXB0LnBvRHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICByZWNlaXB0LnBvRHVyYXRpb24gPSBvcmRlckRldGFpbC5wcmVPcmRlckR1cmF0aW9uXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVjZWlwdC5wb0R1cmF0aW9uID0gTWF0aC5tYXgocmVjZWlwdC5wb0R1cmF0aW9uLCBvcmRlckRldGFpbC5wcmVPcmRlckR1cmF0aW9uKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlY2VpcHQgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBlbXB0eSEnIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09ubHkgY2xvc2VkIG9yIFBPIG9yZGVyIGNhbiBiZSBwcmludGVkIScgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgbm90IGZvdW5kIScgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ29yZGVySWQgaXMgcmVxdWlyZWQhJyB9KVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgTG9jYWxPcmRlclNlcnZpY2UoKVxuIl19
