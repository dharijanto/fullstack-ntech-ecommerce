"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),Utils=require("../../libs/utils"),crud_service_1=require("../../services/crud-service"),local_shop_service_1=require("../local-shop-services/local-shop-service"),order_service_1=require("../local-shop-services/order-service"),product_service_1=require("../../services/product-service"),formatter_1=require("../../libs/formatter");class CartService extends crud_service_1.CRUDService{addItemToCart(e,r,t){let a;const s=(a=r||{readyStock:[],preOrder:[]})[e].find(e=>e.variantId===t.variantId),i=s?s.quantity+t.quantity:t.quantity;return local_shop_service_1.default.getVariantAvailability(t.variantId).then(r=>{if(r.status&&r.data){const t=r.data.quantity||0;return"readyStock"===r.data.status?"preOrder"===e?{status:!1,errMessage:"Product is ready stock!"}:i>t?{status:!1,errMessage:`Only ${t} items left!`}:{status:!0}:"preOrder"===r.data.status?"readyStock"===e?{status:!1,errMessage:"Product is not ready stock!"}:{status:!0}:{status:!1,errMessage:"Product is not available!"}}return{status:!1,errMessage:r.errMessage}}).then(r=>r.status?(s?(s.quantity=i,s.quantity<=0&&(a[e]=a[e].filter(e=>e.variantId!==s.variantId))):a[e].push(t),this.getCart(a)):r)}getCartItemDetail(e){return Promise.join(product_service_1.default.getVariantImage(e.variantId),local_shop_service_1.default.getVariantInformation(e.variantId)).spread((r,t)=>{if(t.status&&t.data)return{variantId:e.variantId,quantity:e.quantity,product:t.data.product,variant:t.data.variant,image:r.data&&Utils.getImageURL(r.data.imageFilename)};throw new Error("variantId="+e.variantId+" is not found!")})}placeOrder(e,r,t,a){if(void 0===a||0===a.preOrder.length&&0===a.readyStock.length)return Promise.resolve({status:!1,errMessage:"Cart is empty!"});if(e){const s=local_shop_service_1.default.getLocalShopId();return a.preOrder.length>0&&!formatter_1.default.validatePhoneNumber(r)?Promise.resolve({status:!1,errMessage:"Correct phone number is required for PO order!"}):super.create("Order",{fullName:e,phoneNumber:r,notes:t,shopId:s,status:"Open"}).then(e=>{if(e.status&&e.data){const r=e.data.id;return Promise.join(Promise.map(a.preOrder,e=>order_service_1.default.addPOOrderDetail(r,e.variantId,e.quantity)),Promise.map(a.readyStock,e=>order_service_1.default.addInStockOrderDetail(r,e.variantId,e.quantity))).spread((e,r)=>{return e.concat(r).reduce((e,r)=>({status:e.status&&r.status,errMessage:e.errMessage||r.errMessage}),{status:!0,errMessage:""})})}return console.log("here"),Promise.resolve({status:!1,errMessage:e.errMessage})})}return Promise.resolve({status:!1,errMessage:"fullName is required!"})}emptyCart(e){return e?(e.preOrder=[],e.readyStock=[],Promise.resolve({status:!0})):Promise.resolve({status:!1,errMessage:"currentCart is not defined!"})}getCart(e){return e?Promise.join(Promise.map(e.readyStock||[],e=>this.getCartItemDetail(e)),Promise.map(e.preOrder||[],e=>this.getCartItemDetail(e))).spread((e,r)=>{const t=e.concat(r).reduce((e,r)=>e+r.product.shopPrice*r.quantity,0);return{status:!0,data:{preOrder:r,readyStock:e,totalPrice:t}}}):Promise.resolve({status:!0,data:{readyStock:[],preOrder:[],totalPrice:0}})}}exports.default=new CartService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbG9jYWwtc2hvcC1zZXJ2aWNlcy9jYXJ0LXNlcnZpY2UudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJVdGlscyIsImNydWRfc2VydmljZV8xIiwibG9jYWxfc2hvcF9zZXJ2aWNlXzEiLCJvcmRlcl9zZXJ2aWNlXzEiLCJwcm9kdWN0X3NlcnZpY2VfMSIsImZvcm1hdHRlcl8xIiwiQ2FydFNlcnZpY2UiLCJDUlVEU2VydmljZSIsIltvYmplY3QgT2JqZWN0XSIsInR5cGUiLCJjdXJyZW50Q2FydCIsIml0ZW0iLCJjYXJ0IiwiZXhpc3RpbmdJdGVtIiwicmVhZHlTdG9jayIsInByZU9yZGVyIiwiZmluZCIsImN1cnJlbnRJdGVtIiwidmFyaWFudElkIiwicmVxdWVzdGVkUXVhbnRpdHkiLCJxdWFudGl0eSIsImRlZmF1bHQiLCJnZXRWYXJpYW50QXZhaWxhYmlsaXR5IiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJkYXRhIiwiYXZhaWxhYmxlUXVhbnRpdHkiLCJlcnJNZXNzYWdlIiwiZmlsdGVyIiwicHVzaCIsInRoaXMiLCJnZXRDYXJ0Iiwiam9pbiIsImdldFZhcmlhbnRJbWFnZSIsImdldFZhcmlhbnRJbmZvcm1hdGlvbiIsInNwcmVhZCIsInJlc3AyIiwicHJvZHVjdCIsInZhcmlhbnQiLCJpbWFnZSIsImdldEltYWdlVVJMIiwiaW1hZ2VGaWxlbmFtZSIsIkVycm9yIiwiZnVsbE5hbWUiLCJwaG9uZU51bWJlciIsIm5vdGVzIiwidW5kZWZpbmVkIiwibGVuZ3RoIiwicmVzb2x2ZSIsImxvY2FsU2hvcElkIiwiZ2V0TG9jYWxTaG9wSWQiLCJ2YWxpZGF0ZVBob25lTnVtYmVyIiwic3VwZXIiLCJjcmVhdGUiLCJzaG9wSWQiLCJvcmRlcklkIiwiaWQiLCJtYXAiLCJjYXJ0SXRlbSIsImFkZFBPT3JkZXJEZXRhaWwiLCJhZGRJblN0b2NrT3JkZXJEZXRhaWwiLCJwb1Jlc3VsdHMiLCJyZWFkeVJlc3VsdHMiLCJjb25jYXQiLCJyZWR1Y2UiLCJhY2MiLCJyZXN1bHQiLCJjb25zb2xlIiwibG9nIiwiZ2V0Q2FydEl0ZW1EZXRhaWwiLCJ0b3RhbFByaWNlIiwic2hvcFByaWNlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUNBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsTUFBQUQsUUFBQSxvQkFDQUUsZUFBQUYsUUFBQSwrQkFDQUcscUJBQUFILFFBQUEsNkNBQ0FJLGdCQUFBSixRQUFBLHdDQUNBSyxrQkFBQUwsUUFBQSxrQ0FDQU0sWUFBQU4sUUFBQSw4QkErQkFPLG9CQUEwQkwsZUFBQU0sWUFDeEJDLGNBQWVDLEVBQWlDQyxFQUEyQkMsR0FDekUsSUFBSUMsRUFNSixNQUFNQyxHQUpKRCxFQURFRixJQUdPSSxjQUFnQkMsY0FFeUJOLEdBQU1PLEtBQUtDLEdBQ3REQSxFQUFZQyxZQUFjUCxFQUFLTyxXQUVsQ0MsRUFBb0JOLEVBQWVBLEVBQWFPLFNBQVdULEVBQUtTLFNBQVdULEVBQUtTLFNBQ3RGLE9BQU9sQixxQkFBQW1CLFFBQWlCQyx1QkFBdUJYLEVBQUtPLFdBQVdLLEtBQUtDLElBQ2xFLEdBQUlBLEVBQUtDLFFBQVVELEVBQUtFLEtBQU0sQ0FDNUIsTUFBTUMsRUFBb0JILEVBQUtFLEtBQUtOLFVBQVksRUFDaEQsTUFBeUIsZUFBckJJLEVBQUtFLEtBQUtELE9BQ0MsYUFBVGhCLEdBQ09nQixRQUFRLEVBQU9HLFdBQVksMkJBRWhDVCxFQUFvQlEsR0FDYkYsUUFBUSxFQUFPRyxtQkFBb0JELGtCQUVuQ0YsUUFBUSxHQUdTLGFBQXJCRCxFQUFLRSxLQUFLRCxPQUNOLGVBQVRoQixHQUNPZ0IsUUFBUSxFQUFPRyxXQUFZLGdDQUUzQkgsUUFBUSxJQUdWQSxRQUFRLEVBQU9HLFdBQVksNkJBR3RDLE9BQVNILFFBQVEsRUFBT0csV0FBWUosRUFBS0ksY0FFMUNMLEtBQUtDLEdBQ0ZBLEVBQUtDLFFBQ0haLEdBQ0ZBLEVBQWFPLFNBQVdELEVBRXBCTixFQUFhTyxVQUFZLElBQzNCUixFQUFLSCxHQUFRRyxFQUFL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QUNILE9BQ0VLLFFBQVEsRUFDUkMsTUFDRVgsU0FBQUEsRUFDQUQsV0FBQUEsRUFDQXlELFdBQUFBLE1BekJDekUsUUFBUW1ELFNBQ2J4QixRQUFRLEVBQ1JDLE1BQ0VaLGNBQ0FDLFlBQ0F3RCxXQUFZLE1BNEJ0QkUsUUFBQXBELFFBQWUsSUFBSWYiLCJmaWxlIjoiYXBwL2xvY2FsLXNob3Atc2VydmljZXMvY2FydC1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kZWwgfSBmcm9tICdzZXF1ZWxpemUnXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICcuLi8uLi9saWJzL3V0aWxzJ1xuaW1wb3J0IHsgQ1JVRFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jcnVkLXNlcnZpY2UnXG5pbXBvcnQgTG9jYWxTaG9wU2VydmljZSBmcm9tICcuLi9sb2NhbC1zaG9wLXNlcnZpY2VzL2xvY2FsLXNob3Atc2VydmljZSdcbmltcG9ydCBPcmRlclNlcnZpY2UgZnJvbSAnLi4vbG9jYWwtc2hvcC1zZXJ2aWNlcy9vcmRlci1zZXJ2aWNlJ1xuaW1wb3J0IFByb2R1Y3RTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL3Byb2R1Y3Qtc2VydmljZSdcbmltcG9ydCBGb3JtYXR0ZXIgZnJvbSAnLi4vLi4vbGlicy9mb3JtYXR0ZXInXG5cbmludGVyZmFjZSBDYXJ0SXRlbU1ldGEge1xuICB2YXJpYW50SWQ6IG51bWJlclxuICBxdWFudGl0eTogbnVtYmVyXG59XG5cbmludGVyZmFjZSBDYXJ0TWV0YURhdGEge1xuICByZWFkeVN0b2NrOiBBcnJheTxDYXJ0SXRlbU1ldGE+XG4gIHByZU9yZGVyOiBBcnJheTxDYXJ0SXRlbU1ldGE+XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FydEl0ZW0ge1xuICB2YXJpYW50SWQ6IG51bWJlclxuICBxdWFudGl0eTogbnVtYmVyXG4gIGltYWdlOiBzdHJpbmdcbiAgcHJvZHVjdDogU2hvcGlmaWVkUHJvZHVjdFxuICB2YXJpYW50OiBTaG9waWZpZWRWYXJpYW50XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FydCB7XG4gIHJlYWR5U3RvY2s6IEFycmF5PENhcnRJdGVtPlxuICBwcmVPcmRlcjogQXJyYXk8Q2FydEl0ZW0+XG4gIHRvdGFsUHJpY2U6IG51bWJlclxufVxuXG4vKlxuQ2FydCBpcyBub3QgYWN0dWFsbHkgc3RvcmVkIGluIGRhdGFiYXNlLCBpdCdzIHN0b3JlZCBpbiB0aGUgc2Vzc2lvbi5cbkZ1bmN0aW9ucyBpbiB0aGlzIHNlcnZpY2UgcmVxdWlyZXMgY3VycmVudENhcnQsIHdoaWNoIGlzIGNhcnQgaW5mb3JtYXRpb24gc3RvcmVkXG5vbiB0aGUgc2Vzc2lvbi5cbiAqL1xuY2xhc3MgQ2FydFNlcnZpY2UgZXh0ZW5kcyBDUlVEU2VydmljZSB7XG4gIGFkZEl0ZW1Ub0NhcnQgKHR5cGU6ICdyZWFkeVN0b2NrJyB8ICdwcmVPcmRlcicsIGN1cnJlbnRDYXJ0OiBDYXJ0TWV0YURhdGEsIGl0ZW06IENhcnRJdGVtTWV0YSk6IFByb21pc2U8TkNSZXNwb25zZTxDYXJ0TWV0YURhdGE+PiB7XG4gICAgbGV0IGNhcnQ6IENhcnRNZXRhRGF0YVxuICAgIGlmIChjdXJyZW50Q2FydCkge1xuICAgICAgY2FydCA9IGN1cnJlbnRDYXJ0XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhcnQgPSB7IHJlYWR5U3RvY2s6IFtdLCBwcmVPcmRlcjogW10gfVxuICAgIH1cbiAgICBjb25zdCBleGlzdGluZ0l0ZW06IENhcnRJdGVtTWV0YSB8IHVuZGVmaW5lZCA9IGNhcnRbdHlwZV0uZmluZChjdXJyZW50SXRlbSA9PiB7XG4gICAgICByZXR1cm4gY3VycmVudEl0ZW0udmFyaWFudElkID09PSBpdGVtLnZhcmlhbnRJZFxuICAgIH0pXG4gICAgY29uc3QgcmVxdWVzdGVkUXVhbnRpdHkgPSBleGlzdGluZ0l0ZW0gPyBleGlzdGluZ0l0ZW0ucXVhbnRpdHkgKyBpdGVtLnF1YW50aXR5IDogaXRlbS5xdWFudGl0eVxuICAgIHJldHVybiBMb2NhbFNob3BTZXJ2aWNlLmdldFZhcmlhbnRBdmFpbGFiaWxpdHkoaXRlbS52YXJpYW50SWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGF2YWlsYWJsZVF1YW50aXR5ID0gcmVzcC5kYXRhLnF1YW50aXR5IHx8IDBcbiAgICAgICAgaWYgKHJlc3AuZGF0YS5zdGF0dXMgPT09ICdyZWFkeVN0b2NrJykge1xuICAgICAgICAgIGlmICh0eXBlID09PSAncHJlT3JkZXInKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnUHJvZHVjdCBpcyByZWFkeSBzdG9jayEnIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlcXVlc3RlZFF1YW50aXR5ID4gYXZhaWxhYmxlUXVhbnRpdHkpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYE9ubHkgJHthdmFpbGFibGVRdWFudGl0eX0gaXRlbXMgbGVmdCFgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHJlc3AuZGF0YS5zdGF0dXMgPT09ICdwcmVPcmRlcicpIHtcbiAgICAgICAgICBpZiAodHlwZSA9PT0gJ3JlYWR5U3RvY2snKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnUHJvZHVjdCBpcyBub3QgcmVhZHkgc3RvY2shJyB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdQcm9kdWN0IGlzIG5vdCBhdmFpbGFibGUhJyB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICBpZiAoZXhpc3RpbmdJdGVtKSB7XG4gICAgICAgICAgZXhpc3RpbmdJdGVtLnF1YW50aXR5ID0gcmVxdWVzdGVkUXVhbnRpdHlcbiAgICAgICAgICAvLyBSZW1vdmUgdGhlIGl0ZW0gZnJvbSB0aGUgY2FydFxuICAgICAgICAgIGlmIChleGlzdGluZ0l0ZW0ucXVhbnRpdHkgPD0gMCkge1xuICAgICAgICAgICAgY2FydFt0eXBlXSA9IGNhcnRbdHlwZV0uZmlsdGVyKGN1cnJlbnRJdGVtID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRJdGVtLnZhcmlhbnRJZCAhPT0gZXhpc3RpbmdJdGVtLnZhcmlhbnRJZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY2FydFt0eXBlXS5wdXNoKGl0ZW0pXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2FydChjYXJ0KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3BcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDYXJ0SXRlbURldGFpbCAoaXRlbTogQ2FydEl0ZW1NZXRhKSB7XG4gICAgcmV0dXJuIFByb21pc2Uuam9pbjxOQ1Jlc3BvbnNlPGFueT4+KFxuICAgICAgUHJvZHVjdFNlcnZpY2UuZ2V0VmFyaWFudEltYWdlKGl0ZW0udmFyaWFudElkKSxcbiAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0VmFyaWFudEluZm9ybWF0aW9uKGl0ZW0udmFyaWFudElkKVxuICAgICkuc3ByZWFkKChyZXNwMjogTkNSZXNwb25zZTxQcm9kdWN0SW1hZ2U+LCByZXNwOiBOQ1Jlc3BvbnNlPHt2YXJpYW50OiBTaG9waWZpZWRWYXJpYW50LCBwcm9kdWN0OiBTaG9waWZpZWRQcm9kdWN0fT4pID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YXJpYW50SWQ6IGl0ZW0udmFyaWFudElkLFxuICAgICAgICAgIHF1YW50aXR5OiBpdGVtLnF1YW50aXR5LFxuICAgICAgICAgIHByb2R1Y3Q6IHJlc3AuZGF0YS5wcm9kdWN0LFxuICAgICAgICAgIHZhcmlhbnQ6IHJlc3AuZGF0YS52YXJpYW50LFxuICAgICAgICAgIGltYWdlOiByZXNwMi5kYXRhICYmIFV0aWxzLmdldEltYWdlVVJMKHJlc3AyLmRhdGEuaW1hZ2VGaWxlbmFtZSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd2YXJpYW50SWQ9JyArIGl0ZW0udmFyaWFudElkICsgJyBpcyBub3QgZm91bmQhJylcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcGxhY2VPcmRlciAoZnVsbE5hbWU6IHN0cmluZywgcGhvbmVOdW1iZXI6IHN0cmluZywgbm90ZXM6IHN0cmluZywgY3VycmVudENhcnQ6IENhcnRNZXRhRGF0YSk6IFByb21pc2U8TkNSZXNwb25zZTxhbnk+PiB7XG4gICAgLy8gVE9ETzogVXNlIHRyYW5zYWN0aW9uIHNvIHdlIGNhbiByb2xsYmFja1xuICAgIGlmIChjdXJyZW50Q2FydCA9PT0gdW5kZWZpbmVkIHx8IChjdXJyZW50Q2FydC5wcmVPcmRlci5sZW5ndGggPT09IDAgJiYgY3VycmVudENhcnQucmVhZHlTdG9jay5sZW5ndGggPT09IDApKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0NhcnQgaXMgZW1wdHkhJyB9KVxuICAgIH0gZWxzZSBpZiAoIWZ1bGxOYW1lKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ2Z1bGxOYW1lIGlzIHJlcXVpcmVkIScgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbG9jYWxTaG9wSWQgPSBMb2NhbFNob3BTZXJ2aWNlLmdldExvY2FsU2hvcElkKClcbiAgICAgIGlmIChjdXJyZW50Q2FydC5wcmVPcmRlci5sZW5ndGggPiAwKSB7XG4gICAgICAgIGlmICghRm9ybWF0dGVyLnZhbGlkYXRlUGhvbmVOdW1iZXIocGhvbmVOdW1iZXIpKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdDb3JyZWN0IHBob25lIG51bWJlciBpcyByZXF1aXJlZCBmb3IgUE8gb3JkZXIhJyB9KVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRPRE86IEFkZCBsb2NrXG4gICAgICByZXR1cm4gc3VwZXIuY3JlYXRlPE9yZGVyPignT3JkZXInLCB7XG4gICAgICAgIGZ1bGxOYW1lLFxuICAgICAgICBwaG9uZU51bWJlcixcbiAgICAgICAgbm90ZXMsXG4gICAgICAgIHNob3BJZDogbG9jYWxTaG9wSWQsXG4gICAgICAgIHN0YXR1czogJ09wZW4nXG4gICAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb3JkZXJJZCA9IHJlc3AuZGF0YS5pZFxuICAgICAgICAgIHJldHVybiBQcm9taXNlLmpvaW4oXG4gICAgICAgICAgICBQcm9taXNlLm1hcChjdXJyZW50Q2FydC5wcmVPcmRlciwgY2FydEl0ZW0gPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLmFkZFBPT3JkZXJEZXRhaWwob3JkZXJJZCwgY2FydEl0ZW0udmFyaWFudElkLCBjYXJ0SXRlbS5xdWFudGl0eSlcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgUHJvbWlzZS5tYXAoY3VycmVudENhcnQucmVhZHlTdG9jaywgY2FydEl0ZW0gPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLmFkZEluU3RvY2tPcmRlckRldGFpbChvcmRlcklkLCBjYXJ0SXRlbS52YXJpYW50SWQsIGNhcnRJdGVtLnF1YW50aXR5KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApLnNwcmVhZCgocG9SZXN1bHRzOiBBcnJheTxOQ1Jlc3BvbnNlPGFueT4+LCByZWFkeVJlc3VsdHM6IEFycmF5PE5DUmVzcG9uc2U8YW55Pj4pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbmFsUmVzdWx0ID0gcG9SZXN1bHRzLmNvbmNhdChyZWFkeVJlc3VsdHMpLnJlZHVjZSgoYWNjLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBhY2Muc3RhdHVzICYmIHJlc3VsdC5zdGF0dXMsIGVyck1lc3NhZ2U6IGFjYy5lcnJNZXNzYWdlIHx8IHJlc3VsdC5lcnJNZXNzYWdlIH1cbiAgICAgICAgICAgIH0sIHsgc3RhdHVzOiB0cnVlLCBlcnJNZXNzYWdlOiAnJyB9KVxuICAgICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnaGVyZScpXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGVtcHR5Q2FydCAoY3VycmVudENhcnQ6IENhcnRNZXRhRGF0YSkge1xuICAgIGlmIChjdXJyZW50Q2FydCkge1xuICAgICAgY3VycmVudENhcnQucHJlT3JkZXIgPSBbXVxuICAgICAgY3VycmVudENhcnQucmVhZHlTdG9jayA9IFtdXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiB0cnVlIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnY3VycmVudENhcnQgaXMgbm90IGRlZmluZWQhJyB9KVxuICAgIH1cbiAgfVxuXG4gIGdldENhcnQgKGN1cnJlbnRDYXJ0OiBDYXJ0TWV0YURhdGEpOiBQcm9taXNlPE5DUmVzcG9uc2U8Q2FydD4+IHtcbiAgICBpZiAoIWN1cnJlbnRDYXJ0KSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcmVhZHlTdG9jazogW10sXG4gICAgICAgICAgcHJlT3JkZXI6IFtdLFxuICAgICAgICAgIHRvdGFsUHJpY2U6IDBcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2Uuam9pbihcbiAgICAgICAgUHJvbWlzZS5tYXAoY3VycmVudENhcnQucmVhZHlTdG9jayB8fCBbXSwgaXRlbSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2FydEl0ZW1EZXRhaWwoaXRlbSlcbiAgICAgICAgfSksXG4gICAgICAgIFByb21pc2UubWFwKGN1cnJlbnRDYXJ0LnByZU9yZGVyIHx8IFtdLCBpdGVtID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDYXJ0SXRlbURldGFpbChpdGVtKVxuICAgICAgICB9KVxuICAgICAgKS5zcHJlYWQoKHJlYWR5U3RvY2s6IEFycmF5PGFueT4sIHByZU9yZGVyOiBBcnJheTxhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IHRvdGFsUHJpY2UgPSByZWFkeVN0b2NrLmNvbmNhdChwcmVPcmRlcikucmVkdWNlKChhY2MsIGl0ZW0pID0+IHtcbiAgICAgICAgICByZXR1cm4gYWNjICsgaXRlbS5wcm9kdWN0LnNob3BQcmljZSAqIGl0ZW0ucXVhbnRpdHlcbiAgICAgICAgfSwgMClcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgcHJlT3JkZXIsXG4gICAgICAgICAgICByZWFkeVN0b2NrLFxuICAgICAgICAgICAgdG90YWxQcmljZVxuICAgICAgICAgIH0gYXMgQ2FydFxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgQ2FydFNlcnZpY2UoKVxuIl19
