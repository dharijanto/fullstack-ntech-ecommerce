"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),moment=require("moment"),app_config_1=require("../app-config"),crud_service_1=require("../services/crud-service"),local_shop_service_1=require("../services/local-shop-service"),order_service_1=require("../services/order-service"),print_service_1=require("../services/print-service");class LocalOrderService extends crud_service_1.default{constructor(){super(),this.receiptPrinter=new print_service_1.default(app_config_1.default.RECEIPT_PRINTER.DEVICE_NAME,app_config_1.default.RECEIPT_PRINTER.PAPER_WIDTH)}getOrders(){return order_service_1.default.getOrders(local_shop_service_1.default.getLocalShopId())}getOpenOrders(){return this.getSequelize().query(`SELECT * FROM ordersView WHERE shopId = ${local_shop_service_1.default.getLocalShopId()} AND status != 'Close' AND status != 'Cancelled'`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getClosedOrders(){return this.getSequelize().query(`SELECT * FROM ordersView WHERE shopId = ${local_shop_service_1.default.getLocalShopId()} AND status = 'Close' OR status = 'Cancelled'`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getOrderDetails(e){return order_service_1.default.getOrderDetails(e)}addOrder(e){return super.create("Order",Object.assign(e,{status:"Open",shopId:local_shop_service_1.default.getLocalShopId()}))}editOrder(e){const r={fullName:e.fullName,phoneNumber:e.phoneNumber,notes:e.notes};return e.id?super.readOne("Order",{id:e.id}).then(t=>t.status&&t.data?"Open"!==t.data.status?{status:!1,errMessage:"Only open order can be editted!"}:e.fullName?super.update("Order",r,{id:e.id}):Promise.resolve({status:!1,errMssage:"fullName is required!"}):{status:!1,errMessage:"Order is not found!"}):Promise.resolve({status:!1,errMessage:"Order is required!"})}cancelOrder(e){return super.readOne("Order",{id:e}).then(r=>r.status&&r.data?"Open"!==r.data.status?{status:!1,errMessage:"Only open order can be cancelled!"}:super.update("Order",{status:"Cancelled"},{id:e}):{status:!1,errMessage:"Order is not found!"})}closeOrder(e){return super.readOne("Order",{id:e}).then(r=>r.status&&r.data?"Open"===r.data.status?super.read("OrderDetail",{orderId:e}).then(r=>{if(r.status){if(r.data){const t=r.data;let s=!1;return t.forEach(e=>{"PO"===e.status&&(s=!0)}),super.update("Order",{status:s?"PO":"Close"},{id:e})}return{status:!1,errMessage:"Order is empty!"}}return{status:!1,errMessage:r.errMessage}}):(console.log("status="+JSON.stringify(r.data)),{status:!1,errMessage:"Only open order can be closed!"}):{status:!1,errMessage:"Order is not found!"})}finishPOOrder(e){return super.readOne("Order",{id:e}).then(r=>{if(r.status&&r.data){return"PO"===r.data.status?super.update("Order",{status:"Close"},{id:e}):{status:!1,errMessage:"Only PO order can be finished!"}}return{status:!1,errMessage:"Order is not found!"}})}isOpenOrder(e){return super.readOne("Order",{id:e}).then(e=>e.status&&e.data?"Open"===e.data.status?{status:!0}:{status:!1,errMessage:"Order is not of 'Open' status!"}:{status:!1,errMessage:"Order not found!"})}addOrderDetail(e,r,t){return t<=0?Promise.resolve({status:!1,errMessage:"Quantity needs to be a positive number!"}):this.isOpenOrder(e).then(s=>s.status?Promise.join(local_shop_service_1.default.getVariantAvailability(r),local_shop_service_1.default.getVariantInformation(r)).spread((s,a)=>{if(s.status&&s.data&&a.status&&a.data){const d=s.data;if("readyStock"===d.status&&t>(d.quantity||0))return{status:!1,errMessage:`Only ${d.quantity} ready stock(s) left!`};const u=a.data.product.shopPrice,i="preOrder"===d.status?"PO":"Ready";return super.create("OrderDetail",{variantId:r,orderId:e,status:i,quantity:t,price:u})}return{status:!1,errMessage:"Failed to get variant information: "+s.errMessage||a.errMessage}}):{status:!1,errMessage:s.errMessage})}editOrderDetail(e,r,t){}deleteOrderDetail(e){return e?super.readOne("OrderDetail",{id:e}).then(r=>{if(r.status&&r.data){const t=r.data.orderId;return this.isOpenOrder(t).then(r=>r.status?super.delete("OrderDetail",{id:e}):{status:!1,errMessage:r.errMessage})}return{status:!1,errMessage:r.errMessage}}):Promise.resolve({status:!1,errMessage:"orderDetailId is reuqired!"})}printReceipt(e,r=1){return Promise.resolve(this.receiptPrinter.printURL(e,r).then(e=>e.status?{status:!0}:{status:!1,errMessage:e.errMessage}))}getReceipt(e){return e?order_service_1.default.getOrder(e).then(r=>{if(r.status&&r.data){const t=r.data;if("Close"===t.status||"PO"===t.status){let s={orderId:t.id,fullName:t.fullName,phoneNumber:t.phoneNumber,status:t.status,totalPrice:t.price,poDuration:void 0,orderDate:moment(r.data.updatedAt).format("DD-MM-YY HH:mm"),printDate:moment().format("DD-MM-YY HH:mm"),items:[]};return this.getOrderDetails(e).then(e=>e.status&&e.data?(e.data.forEach(e=>{s.items.push({name:e.productName,status:e.status,variant:e.variantName,price:e.price,quantity:e.quantity}),"PO"===e.status&&(s.poDuration?s.poDuration=Math.max(s.poDuration,e.preOrderDuration):s.poDuration=e.preOrderDuration)}),{status:!0,data:s}):{status:!1,errMessage:"Order is empty!"})}return{status:!1,errMessage:"Only closed or PO order can be printed!"}}return{status:!1,errMessage:"Order is not found!"}}):Promise.resolve({status:!1,errMessage:"orderId is required!"})}}exports.default=new LocalOrderService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sb2NhbC1zaG9wLXNlcnZpY2Uvb3JkZXItc2VydmljZS50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsIm1vbWVudCIsImFwcF9jb25maWdfMSIsImNydWRfc2VydmljZV8xIiwibG9jYWxfc2hvcF9zZXJ2aWNlXzEiLCJvcmRlcl9zZXJ2aWNlXzEiLCJwcmludF9zZXJ2aWNlXzEiLCJMb2NhbE9yZGVyU2VydmljZSIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJzdXBlciIsInRoaXMiLCJyZWNlaXB0UHJpbnRlciIsIlJFQ0VJUFRfUFJJTlRFUiIsIkRFVklDRV9OQU1FIiwiUEFQRVJfV0lEVEgiLCJnZXRPcmRlcnMiLCJnZXRMb2NhbFNob3BJZCIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJ0aGVuIiwicmVzdWx0Iiwic3RhdHVzIiwiZGF0YSIsIm9yZGVySWQiLCJnZXRPcmRlckRldGFpbHMiLCJjcmVhdGUiLCJPYmplY3QiLCJhc3NpZ24iLCJzaG9wSWQiLCJlZGl0dGFibGVEYXRhIiwiZnVsbE5hbWUiLCJwaG9uZU51bWJlciIsIm5vdGVzIiwiaWQiLCJyZWFkT25lIiwicmVzcCIsImVyck1lc3NhZ2UiLCJ1cGRhdGUiLCJyZXNvbHZlIiwiZXJyTXNzYWdlIiwicmVhZCIsInJlc3AyIiwib3JkZXJEZXRhaWxzIiwiaXNQTyIsImZvckVhY2giLCJvcmRlckRldGFpbCIsImNvbnNvbGUiLCJsb2ciLCJKU09OIiwic3RyaW5naWZ5IiwidmFyaWFudElkIiwicXVhbnRpdHkiLCJpc09wZW5PcmRlciIsImpvaW4iLCJnZXRWYXJpYW50QXZhaWxhYmlsaXR5IiwiZ2V0VmFyaWFudEluZm9ybWF0aW9uIiwic3ByZWFkIiwicmVzcDMiLCJhdmFpbGFiaWxpdHkiLCJwcmljZSIsInByb2R1Y3QiLCJzaG9wUHJpY2UiLCJvcmRlckRldGFpbFN0YXR1cyIsIm9yZGVyRGV0YWlsSWQiLCJkZWxldGUiLCJmdWxsVVJMIiwibnVtQ29waWVzIiwicHJpbnRVUkwiLCJnZXRPcmRlciIsIm9yZGVyIiwicmVjZWlwdCIsInRvdGFsUHJpY2UiLCJwb0R1cmF0aW9uIiwidW5kZWZpbmVkIiwib3JkZXJEYXRlIiwidXBkYXRlZEF0IiwiZm9ybWF0IiwicHJpbnREYXRlIiwiaXRlbXMiLCJwdXNoIiwibmFtZSIsInByb2R1Y3ROYW1lIiwidmFyaWFudCIsInZhcmlhbnROYW1lIiwiTWF0aCIsIm1heCIsInByZU9yZGVyRHVyYXRpb24iLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBRUEsTUFBQUEsUUFBQUMsUUFBQSxZQUVBQyxPQUFBRCxRQUFBLFVBRUFFLGFBQUFGLFFBQUEsaUJBQ0FHLGVBQUFILFFBQUEsNEJBQ0FJLHFCQUFBSixRQUFBLGtDQUNBSyxnQkFBQUwsUUFBQSw2QkFDQU0sZ0JBQUFOLFFBQUEsbUNBZ0NBTywwQkFBZ0NKLGVBQUFLLFFBRTlCQyxjQUNFQyxRQUNBQyxLQUFLQyxlQUFpQixJQUFJTixnQkFBQUUsUUFBYU4sYUFBQU0sUUFBVUssZ0JBQWdCQyxZQUFhWixhQUFBTSxRQUFVSyxnQkFBZ0JFLGFBRzFHTixZQUNFLE9BQU9KLGdCQUFBRyxRQUFhUSxVQUFVWixxQkFBQUksUUFBaUJTLGtCQUdqRFIsZ0JBQ0UsT0FBT0UsS0FBS08sZUFBZUMsaURBQ1lmLHFCQUFBSSxRQUFpQlMsb0VBQ3BERyxLQUFNVCxLQUFLTyxlQUFlRyxXQUFXQyxTQUFVQyxLQUFLQyxHQUNoREEsR0FDT0MsUUFBUSxFQUFNQyxLQUFNRixJQUVwQkMsUUFBUSxJQUt6QmhCLGtCQUNFLE9BQU9FLEtBQUtPLGVBQWVDLGlEQUNZZixxQkFBQUksUUFBaUJTLGlFQUNwREcsS0FBTVQsS0FBS08sZUFBZUcsV0FBV0MsU0FBVUMsS0FBS0MsR0FDaERBLEdBQ09DLFFBQVEsRUFBTUMsS0FBTUYsSUFFcEJDLFFBQVEsSUFLekJoQixnQkFBaUJrQixHQUNmLE9BQU90QixnQkFBQUcsUUFBYW9CLGdCQUFn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QUFZLHlCQUlqQ3pDLFFBQVEyQyxTQUFVakIsUUFBUSxFQUFPZSxXQUFZLDBCQUsxRG1ELFFBQUFuRixRQUFlLElBQUlEIiwiZmlsZSI6ImxvY2FsLXNob3Atc2VydmljZS9vcmRlci1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdXRpbCBmcm9tICd1dGlsJ1xuXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICdzZXF1ZWxpemUnXG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50J1xuXG5pbXBvcnQgQXBwQ29uZmlnIGZyb20gJy4uL2FwcC1jb25maWcnXG5pbXBvcnQgQ1JVRFNlcnZpY2UgZnJvbSAnLi4vc2VydmljZXMvY3J1ZC1zZXJ2aWNlJ1xuaW1wb3J0IExvY2FsU2hvcFNlcnZpY2UgZnJvbSAnLi4vc2VydmljZXMvbG9jYWwtc2hvcC1zZXJ2aWNlJ1xuaW1wb3J0IE9yZGVyU2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9vcmRlci1zZXJ2aWNlJ1xuaW1wb3J0IFByaW50U2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9wcmludC1zZXJ2aWNlJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFByb2R1Y3RBdmFpbGFiaWxpdHkge1xuICBzdGF0dXM6ICdyZWFkeVN0b2NrJyB8ICdwcmVPcmRlcicgfCAndW5hdmFpbGFibGUnXG4gIHF1YW50aXR5PzogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3JkZXJSZWNlaXB0IHtcbiAgb3JkZXJJZDogbnVtYmVyXG4gIGZ1bGxOYW1lOiBzdHJpbmdcbiAgcGhvbmVOdW1iZXI6IHN0cmluZ1xuICBzdGF0dXM6ICdDbG9zZScgfCAnUE8nIHwgJ09wZW4nIHwgJ0NhbmNlbGxlZCdcbiAgdG90YWxQcmljZTogbnVtYmVyXG4gIHBvRHVyYXRpb24/OiBudW1iZXJcbiAgb3JkZXJEYXRlOiBzdHJpbmdcbiAgcHJpbnREYXRlOiBzdHJpbmdcbiAgaXRlbXM6IHtcbiAgICBzdGF0dXM6ICdQTycgfCAnUmVhZHknXG4gICAgbmFtZTogc3RyaW5nXG4gICAgdmFyaWFudDogc3RyaW5nXG4gICAgcHJpY2U6IG51bWJlclxuICAgIHF1YW50aXR5OiBudW1iZXJcbiAgfVtdXG59XG5cbi8qXG4gIFVzZWQgZm9yIHNob3Atc3BlY2lmaWMgY29kZS4gVGhpcyBzaG91bGQgcmUtdXNlIHdoYXQncyBpbiBzaG9wLXNlcnZpY2UgYXMgbXVjaCBhcyBwb3NzaWJsZSwgdGhvdWdoLlxuXG4gIFRPRE86XG4gIDEuIFVwZGF0ZSBvcmRlckhpc3RvcmllcyB3aGVuZXZlciBhbiB1cGRhdGUgaXMgbWFkZSB0byBvcmRlciB0YWJsZSwgc28gdGhhdCB3ZSBoYXZlIGJldHRlciBpZGVhcyB3aGVuXG4gICAgIGEgcHJvYmxlbSBoYXBwZW5zXG4gKi9cbmNsYXNzIExvY2FsT3JkZXJTZXJ2aWNlIGV4dGVuZHMgQ1JVRFNlcnZpY2Uge1xuICBwcml2YXRlIHJlY2VpcHRQcmludGVyOiBQcmludFNlcnZpY2VcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLnJlY2VpcHRQcmludGVyID0gbmV3IFByaW50U2VydmljZShBcHBDb25maWcuUkVDRUlQVF9QUklOVEVSLkRFVklDRV9OQU1FLCBBcHBDb25maWcuUkVDRUlQVF9QUklOVEVSLlBBUEVSX1dJRFRIKVxuICB9XG5cbiAgZ2V0T3JkZXJzICgpIHtcbiAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLmdldE9yZGVycyhMb2NhbFNob3BTZXJ2aWNlLmdldExvY2FsU2hvcElkKCkpXG4gIH1cblxuICBnZXRPcGVuT3JkZXJzICgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShcbmBTRUxFQ1QgKiBGUk9NIG9yZGVyc1ZpZXcgV0hFUkUgc2hvcElkID0gJHtMb2NhbFNob3BTZXJ2aWNlLmdldExvY2FsU2hvcElkKCl9IEFORCBzdGF0dXMgIT0gJ0Nsb3NlJyBBTkQgc3RhdHVzICE9ICdDYW5jZWxsZWQnYCxcbiAgICAgIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3VsdCB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gIH1cblxuICBnZXRDbG9zZWRPcmRlcnMgKCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuYFNFTEVDVCAqIEZST00gb3JkZXJzVmlldyBXSEVSRSBzaG9wSWQgPSAke0xvY2FsU2hvcFNlcnZpY2UuZ2V0TG9jYWxTaG9wSWQoKX0gQU5EIHN0YXR1cyA9ICdDbG9zZScgT1Igc3RhdHVzID0gJ0NhbmNlbGxlZCdgLFxuICAgICAgeyB0eXBlOiB0aGlzLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzdWx0IH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgfVxuXG4gIGdldE9yZGVyRGV0YWlscyAob3JkZXJJZCkge1xuICAgIHJldHVybiBPcmRlclNlcnZpY2UuZ2V0T3JkZXJEZXRhaWxzKG9yZGVySWQpXG4gIH1cblxuICBhZGRPcmRlciAoZGF0YTogUGFydGlhbDxPcmRlcj4pOiBQcm9taXNlPE5DUmVzcG9uc2U8T3JkZXI+PiB7XG4gICAgcmV0dXJuIHN1cGVyLmNyZWF0ZTxPcmRlcj4oJ09yZGVyJywgT2JqZWN0LmFzc2lnbihkYXRhLCB7IHN0YXR1czogJ09wZW4nLCBzaG9wSWQ6IExvY2FsU2hvcFNlcnZpY2UuZ2V0TG9jYWxTaG9wSWQoKSB9KSlcbiAgfVxuXG4gIGVkaXRPcmRlciAoZGF0YTogUGFydGlhbDxPcmRlcj4pOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIC8vIE1ha2Ugc3VyZSBubyBvdGhlciBmaWVsZHMgZ2V0IGVkaXR0ZWQgYnkgaGFja2VyXG4gICAgY29uc3QgZWRpdHRhYmxlRGF0YSA9IHtcbiAgICAgIGZ1bGxOYW1lOiBkYXRhLmZ1bGxOYW1lLFxuICAgICAgcGhvbmVOdW1iZXI6IGRhdGEucGhvbmVOdW1iZXIsXG4gICAgICBub3RlczogZGF0YS5ub3Rlc1xuICAgIH1cbiAgICBpZiAoZGF0YS5pZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8T3JkZXI+KCdPcmRlcicsIHsgaWQ6IGRhdGEuaWQgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGlmIChyZXNwLmRhdGEuc3RhdHVzICE9PSAnT3BlbicpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPbmx5IG9wZW4gb3JkZXIgY2FuIGJlIGVkaXR0ZWQhJyB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChkYXRhLmZ1bGxOYW1lKSB7XG4gICAgICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8T3JkZXI+KCdPcmRlcicsIGVkaXR0YWJsZURhdGEsIHsgaWQ6IGRhdGEuaWQgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNc3NhZ2U6ICdmdWxsTmFtZSBpcyByZXF1aXJlZCEnIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBub3QgZm91bmQhJyB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgcmVxdWlyZWQhJyB9KVxuICAgIH1cbiAgfVxuXG4gIGNhbmNlbE9yZGVyIChvcmRlcklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIHJldHVybiBzdXBlci5yZWFkT25lPE9yZGVyPignT3JkZXInLCB7IGlkOiBvcmRlcklkIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGlmIChyZXNwLmRhdGEuc3RhdHVzICE9PSAnT3BlbicpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT25seSBvcGVuIG9yZGVyIGNhbiBiZSBjYW5jZWxsZWQhJyB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxPcmRlcj4oJ09yZGVyJywgeyBzdGF0dXM6ICdDYW5jZWxsZWQnIH0sIHsgaWQ6IG9yZGVySWQgfSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLypcbiAgICAxLiBDaGVjayB3aGV0aGVyIHRoZXJlJ3MgUE8gb3JkZXIgb3Igbm90LlxuICAgIDIuIElmIHRoZXJlJ3MsIHNldCBzdGF0dXMgdG8gJ1BPJ1xuICAgIDMuIElmIG5vdCwgc2V0IHN0YXR1cyB0byAnRmluaXNoJ1xuICAgKi9cbiAgY2xvc2VPcmRlciAob3JkZXJJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlcj4oJ09yZGVyJywgeyBpZDogb3JkZXJJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhLnN0YXR1cyA9PT0gJ09wZW4nKSB7XG4gICAgICAgICAgcmV0dXJuIHN1cGVyLnJlYWQ8T3JkZXJEZXRhaWw+KCdPcmRlckRldGFpbCcsIHsgb3JkZXJJZCB9KS50aGVuKHJlc3AyID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgaWYgKHJlc3AyLmRhdGEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBvcmRlckRldGFpbHMgPSByZXNwMi5kYXRhXG4gICAgICAgICAgICAgICAgbGV0IGlzUE8gPSBmYWxzZVxuICAgICAgICAgICAgICAgIG9yZGVyRGV0YWlscy5mb3JFYWNoKG9yZGVyRGV0YWlsID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmIChvcmRlckRldGFpbC5zdGF0dXMgPT09ICdQTycpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNQTyA9IHRydWVcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8T3JkZXI+KCdPcmRlcicsIHsgc3RhdHVzOiBpc1BPID8gJ1BPJyA6ICdDbG9zZScgfSwgeyBpZDogb3JkZXJJZCB9KVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBlbXB0eSEnIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcDIuZXJyTWVzc2FnZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnc3RhdHVzPScgKyBKU09OLnN0cmluZ2lmeShyZXNwLmRhdGEpKVxuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPbmx5IG9wZW4gb3JkZXIgY2FuIGJlIGNsb3NlZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZmluaXNoUE9PcmRlciAob3JkZXJJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlcj4oJ09yZGVyJywgeyBpZDogb3JkZXJJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCBvcmRlciA9IHJlc3AuZGF0YVxuICAgICAgICBpZiAob3JkZXIuc3RhdHVzID09PSAnUE8nKSB7XG4gICAgICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxPcmRlcj4oJ09yZGVyJywgeyBzdGF0dXM6ICdDbG9zZScgfSwgeyBpZDogb3JkZXJJZCB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPbmx5IFBPIG9yZGVyIGNhbiBiZSBmaW5pc2hlZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBpc09wZW5PcmRlciAob3JkZXJJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bGw+PiB7XG4gICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8T3JkZXI+KCdPcmRlcicsIHsgaWQ6IG9yZGVySWQgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgaWYgKHJlc3AuZGF0YS5zdGF0dXMgPT09ICdPcGVuJykge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIG5vdCBvZiBcXCdPcGVuXFwnIHN0YXR1cyEnIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIG5vdCBmb3VuZCEnIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgYWRkT3JkZXJEZXRhaWwgKG9yZGVySWQ6IG51bWJlciwgdmFyaWFudElkOiBudW1iZXIsIHF1YW50aXR5OiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8T3JkZXJEZXRhaWw+PiB7XG4gICAgLypcbiAgICAgIDEuIFZhbGlkYXRlIG9yZGVySWQgLT4gdmFsaWQgb3JkZXIgd2hvc2Ugc3RhdHVzIGlzIG5vdCBjbG9zZWQgLyBQT1xuICAgICAgMi4gVmFsaWRhdGUgdmFyaWFudElkIC0+IHByb2R1Y3Qgd2l0aCB0aGlzIGlkIGV4aXN0c1xuICAgICAgMy4gVmFsaWRhdGUgcXVhbnRpdHkgLT4gbm9uLW5lZ2F0aXZlLCBhbmQgaWYgc3RhdHVzIGlzIHJlYWR5LCBxdWFudGl0eSBkb2Vzbid0IGV4Y2VlZCB3aGF0J3MgYXZhaWxhYmxlXG4gICAgICovXG4gICAgaWYgKHF1YW50aXR5IDw9IDApIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnUXVhbnRpdHkgbmVlZHMgdG8gYmUgYSBwb3NpdGl2ZSBudW1iZXIhJyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5pc09wZW5PcmRlcihvcmRlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5qb2luPGFueT4oXG4gICAgICAgICAgICBMb2NhbFNob3BTZXJ2aWNlLmdldFZhcmlhbnRBdmFpbGFiaWxpdHkodmFyaWFudElkKSxcbiAgICAgICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0VmFyaWFudEluZm9ybWF0aW9uKHZhcmlhbnRJZClcbiAgICAgICAgICApLnNwcmVhZCgocmVzcDI6IE5DUmVzcG9uc2U8UHJvZHVjdEF2YWlsYWJpbGl0eT4sXG4gICAgICAgICAgICAgICAgICAgIHJlc3AzOiBOQ1Jlc3BvbnNlPHtwcm9kdWN0OiBTaG9waWZpZWRQcm9kdWN0LCB2YXJpYW50OiBTaG9waWZpZWRWYXJpYW50fT4pID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJiByZXNwMy5zdGF0dXMgJiYgcmVzcDMuZGF0YSkge1xuICAgICAgICAgICAgICBjb25zdCBhdmFpbGFiaWxpdHkgPSByZXNwMi5kYXRhXG4gICAgICAgICAgICAgIGlmIChhdmFpbGFiaWxpdHkuc3RhdHVzID09PSAncmVhZHlTdG9jaycgJiYgcXVhbnRpdHkgPiAoYXZhaWxhYmlsaXR5LnF1YW50aXR5IHx8IDApKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYE9ubHkgJHthdmFpbGFiaWxpdHkucXVhbnRpdHl9IHJlYWR5IHN0b2NrKHMpIGxlZnQhYCB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29uc3QgcHJpY2UgPSByZXNwMy5kYXRhLnByb2R1Y3Quc2hvcFByaWNlXG4gICAgICAgICAgICAgIGNvbnN0IG9yZGVyRGV0YWlsU3RhdHVzID0gYXZhaWxhYmlsaXR5LnN0YXR1cyA9PT0gJ3ByZU9yZGVyJyA/ICdQTycgOiAnUmVhZHknXG4gICAgICAgICAgICAgIHJldHVybiBzdXBlci5jcmVhdGU8T3JkZXJEZXRhaWw+KCdPcmRlckRldGFpbCcsIHsgdmFyaWFudElkLCBvcmRlcklkLCBzdGF0dXM6IG9yZGVyRGV0YWlsU3RhdHVzLCBxdWFudGl0eSwgcHJpY2UgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdGYWlsZWQgdG8gZ2V0IHZhcmlhbnQgaW5mb3JtYXRpb246ICcgKyByZXNwMi5lcnJNZXNzYWdlIHx8IHJlc3AzLmVyck1lc3NhZ2UgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBlZGl0T3JkZXJEZXRhaWwgKG9yZGVyRGV0YWlsSWQ6IG51bWJlciwgdmFyaWFudElkOiBudW1iZXIsIHF1YW50aXR5OiBudW1iZXIpIHtcbiAgICAvLyBUT0RPOiBUbyBtYWtlIHRoaW5ncyBlYXN5LCB3ZSBkb24ndCBjdXJyZW50bHkgaW1wbGVtZW50IGVkaXRcbiAgICAvLyAgICAgICBUaGUgbG9naWMgaXMgbW9yZSBjb21wbGV4IHRoYW4gYWRkT3JkZXJEZXRhaWwgYmVjYXVzZSB3ZSBuZWVkIHRvXG4gICAgLy8gICAgICAgdGFrZSBpbnRvIGFjY291bnQgdGhlIGRlbHRhIHN0b2NrXG4gIH1cblxuICBkZWxldGVPcmRlckRldGFpbCAob3JkZXJEZXRhaWxJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICBpZiAob3JkZXJEZXRhaWxJZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8T3JkZXJEZXRhaWw+KCdPcmRlckRldGFpbCcsIHsgaWQ6IG9yZGVyRGV0YWlsSWQgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IG9yZGVySWQgPSByZXNwLmRhdGEub3JkZXJJZFxuICAgICAgICAgIHJldHVybiB0aGlzLmlzT3Blbk9yZGVyKG9yZGVySWQpLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cykge1xuICAgICAgICAgICAgICByZXR1cm4gc3VwZXIuZGVsZXRlPE9yZGVyRGV0YWlsPignT3JkZXJEZXRhaWwnLCB7IGlkOiBvcmRlckRldGFpbElkIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwMi5lcnJNZXNzYWdlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnb3JkZXJEZXRhaWxJZCBpcyByZXVxaXJlZCEnIH0pXG4gICAgfVxuICB9XG5cbiAgLy8gZnVsbFVSTDogbm9uLXJlbGF0aXZlIFVSTCB0byBnZXQgSFRNTCB2ZXJzaW9uIG9mIHRoZSByZWNlaXB0XG4gIHByaW50UmVjZWlwdCAoZnVsbFVSTDogc3RyaW5nLCBudW1Db3BpZXM6IG51bWJlciA9IDEpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVsbD4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMucmVjZWlwdFByaW50ZXIucHJpbnRVUkwoZnVsbFVSTCwgbnVtQ29waWVzKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pKVxuICB9XG5cbiAgZ2V0UmVjZWlwdCAob3JkZXJJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPE9yZGVyUmVjZWlwdD4+IHtcbiAgICBpZiAob3JkZXJJZCkge1xuICAgICAgcmV0dXJuIE9yZGVyU2VydmljZS5nZXRPcmRlcihvcmRlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb3JkZXIgPSByZXNwLmRhdGFcbiAgICAgICAgICBpZiAob3JkZXIuc3RhdHVzID09PSAnQ2xvc2UnIHx8IG9yZGVyLnN0YXR1cyA9PT0gJ1BPJykge1xuICAgICAgICAgICAgbGV0IHJlY2VpcHQ6IE9yZGVyUmVjZWlwdCA9IHtcbiAgICAgICAgICAgICAgb3JkZXJJZDogb3JkZXIuaWQsXG4gICAgICAgICAgICAgIGZ1bGxOYW1lOiBvcmRlci5mdWxsTmFtZSxcbiAgICAgICAgICAgICAgcGhvbmVOdW1iZXI6IG9yZGVyLnBob25lTnVtYmVyLFxuICAgICAgICAgICAgICBzdGF0dXM6IG9yZGVyLnN0YXR1cyxcbiAgICAgICAgICAgICAgdG90YWxQcmljZTogb3JkZXIucHJpY2UsXG4gICAgICAgICAgICAgIHBvRHVyYXRpb246IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgb3JkZXJEYXRlOiBtb21lbnQocmVzcC5kYXRhLnVwZGF0ZWRBdCkuZm9ybWF0KCdERC1NTS1ZWSBISDptbScpLFxuICAgICAgICAgICAgICBwcmludERhdGU6IG1vbWVudCgpLmZvcm1hdCgnREQtTU0tWVkgSEg6bW0nKSxcbiAgICAgICAgICAgICAgaXRlbXM6IFtdXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRPcmRlckRldGFpbHMob3JkZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgICAgIHJlc3AuZGF0YS5mb3JFYWNoKG9yZGVyRGV0YWlsID0+IHtcbiAgICAgICAgICAgICAgICAgIHJlY2VpcHQuaXRlbXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG9yZGVyRGV0YWlsLnByb2R1Y3ROYW1lLFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IG9yZGVyRGV0YWlsLnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFudDogb3JkZXJEZXRhaWwudmFyaWFudE5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHByaWNlOiBvcmRlckRldGFpbC5wcmljZSxcbiAgICAgICAgICAgICAgICAgICAgcXVhbnRpdHk6IG9yZGVyRGV0YWlsLnF1YW50aXR5XG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgaWYgKG9yZGVyRGV0YWlsLnN0YXR1cyA9PT0gJ1BPJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXJlY2VpcHQucG9EdXJhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgIHJlY2VpcHQucG9EdXJhdGlvbiA9IG9yZGVyRGV0YWlsLnByZU9yZGVyRHVyYXRpb25cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICByZWNlaXB0LnBvRHVyYXRpb24gPSBNYXRoLm1heChyZWNlaXB0LnBvRHVyYXRpb24sIG9yZGVyRGV0YWlsLnByZU9yZGVyRHVyYXRpb24pXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVjZWlwdCB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIGVtcHR5IScgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT25seSBjbG9zZWQgb3IgUE8gb3JkZXIgY2FuIGJlIHByaW50ZWQhJyB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyBub3QgZm91bmQhJyB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnb3JkZXJJZCBpcyByZXF1aXJlZCEnIH0pXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBMb2NhbE9yZGVyU2VydmljZSgpXG4iXX0=
