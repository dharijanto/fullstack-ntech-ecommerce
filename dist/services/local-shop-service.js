"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const crud_service_1=require("./crud-service"),shop_service_1=require("./shop-service"),Promise=require("bluebird"),app_config_1=require("../app-config"),Utils=require("../libs/utils");class LocalShopService extends crud_service_1.CRUDService{constructor(){super(...arguments),this.localShopId=-1}initialize(){return app_config_1.default.LOCAL_SHOP_INFORMATION&&app_config_1.default.LOCAL_SHOP_INFORMATION.NAME?-1===this.localShopId?super.readOne("Shop",{name:app_config_1.default.LOCAL_SHOP_INFORMATION.NAME}).then(e=>e.status&&e.data?(this.localShopId=e.data.id,{status:!0,data:null}):{status:!1,errMessage:"Shop name is not found!"}):Promise.resolve({status:!0,data:null}):Promise.resolve({status:!1,errMessage:"Local Shop Information is not defined!"})}getLocalShopId(){if(-1!==this.localShopId)return this.localShopId;throw new Error("Local shop id is not yet retrieved!")}getShopifiedProducts(){return shop_service_1.default.getShopifiedProducts(this.getLocalShopId())}getShopStock(e={}){return shop_service_1.default.getShopStock(this.getLocalShopId(),e)}getInStockProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:s=null,subCategoryId:o=null}){return shop_service_1.default.getInStockProducts({pageSize:e,pageIndex:t,productId:r,categoryId:s,subCategoryId:o},this.localShopId)}getInStockProduct(e){return this.getInStockProducts({productId:e,pageSize:1,pageIndex:0}).then(e=>e.status&&e.data?e.data&&e.data.products.length>0?{status:!0,data:e.data.products[0]}:{status:!1,errMessage:"Product not found!"}:{status:!1,errMessage:e.errMessage})}getPOProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:s=null,subCategoryId:o=null}){return shop_service_1.default.getPOProducts({pageSize:e,pageIndex:t,productId:r,categoryId:s,subCategoryId:o},this.localShopId)}getPOProduct(e){return this.getPOProducts({pageSize:1,pageIndex:0,productId:e}).then(e=>e.status&&e.data?e.data.products.length?{status:!0,data:e.data.products[0]}:{status:!1,errMessage:"Product not found!"}:{status:!1,errMessage:e.errMessage})}getProductsByCategories(){const e=[];let t;function r(r,s){if(!s.subCategory||!s.subCategory.category)throw new Error("Product does not have category or subCategory defined!");const o=s.subCategory.name,a=function(t,r){const s=function(t){let r=e.find(e=>e.name===t);return r||(r={name:t,subCategories:[]},e.push(r)),r}(t).subCategories;let o=s.find(e=>e.name===r);return o||(o={name:r,poProducts:[],inStockProducts:[]},s.push(o)),o}(s.subCategory.category.name,o);r?a.inStockProducts.push(s):a.poProducts.push(s),t=t?s.updatedAt>t?s.updatedAt:t:s.updatedAt}return Promise.join(this.getInStockProducts({}),this.getPOProducts({})).spread((s,o)=>s.status&&s.data&&o.status&&o.data?(s.data.forEach(e=>{r(!0,e)}),o.data.forEach(e=>{r(!1,e)}),{status:!0,data:{categories:e,lastUpdated:t}}):{status:!1,errMessage:s.errMessage||o.errMessage})}getShopifiedVariants(e){return shop_service_1.default.getShopifiedVariants(this.localShopId,e)}updateProduct(e,t){const{price:r,preOrderAllowed:s,preOrderDuration:o,disabled:a}=t;return this.getModels("ShopProduct").findOne({where:{shopId:this.localShopId,productId:e}}).then(t=>({id:t&&t.id,productId:e,shopId:this.localShopId,price:r,preOrderAllowed:s,preOrderDuration:o,disabled:a})).then(e=>this.getModels("ShopProduct").upsert(e).then(e=>({status:!0})))}addShopStock(e){const{variantId:t,price:r,quantity:s,date:o,description:a}=e;return a?this.create("ShopStock",{shopId:this.localShopId,variantId:t,price:r,quantity:s,date:o,description:a}):Promise.resolve({status:!1,errMessage:"Description is required!"})}getVariantInformation(e){return this.readOne("Variant",{id:e}).then(t=>{if(t.status&&t.data){const r=t.data.productId;return Promise.join(super.getSequelize().query(`SELECT * FROM shopifiedVariantsView WHERE id = ${e} AND shopId=${this.localShopId}`,{type:super.getSequelize().QueryTypes.SELECT}),super.getSequelize().query(`SELECT * FROM shopifiedProductsView WHERE id = ${r} AND shopId=${this.localShopId}`,{type:super.getSequelize().QueryTypes.SELECT})).spread((t,s)=>{if(t&&s){return{status:!0,data:{variant:Utils.objectify(t)[0],product:Utils.objectify(s)[0]}}}return t?{status:!1,errMessage:`productId=${r} is not found!`}:{status:!1,errMessage:`variantId=${e} is not found!`}})}return{status:!1,errMessage:"variantId="+e+" is not found!"}})}getVariantPrice(e){return this.readOne("Variant",{id:e}).then(t=>{if(t.status&&t.data){const e=t.data.productId;return super.getSequelize().query(`SELECT shopPrice FROM shopifiedProductsView WHERE id = ${e} AND shopId = ${this.getLocalShopId()}`,{type:super.getSequelize().QueryTypes.SELECT}).then(t=>{if(t&&t.length>0){return{status:!0,data:t[0].shopPrice}}return{status:!1,errMessage:"productId="+e+" is not found!"}})}return{status:!1,errMessage:"variantId="+e+" is not found!"}})}getProductAvailability(e){return Promise.join(this.getInStockProduct(e),this.getPOProduct(e)).spread((e,t)=>{let r={status:"readyStock"};if(e.status&&e.data)r.status="readyStock",r.quantity=e.data.stockQuantity;else{if(!t.status)return{status:!1,errMessage:e.errMessage||t.errMessage};r.status="preOrder"}return{status:!0,data:r}})}getVariantAvailability(e){return this.readOne("Variant",{id:e}).then(e=>{if(e.status&&e.data){const t=e.data.productId;return this.getProductAvailability(t)}return{status:!1,errMessage:e.errMessage}})}getPromotions(){return shop_service_1.default.getPromotion(this.getLocalShopId())}createPromotion(e,t){return e?super.create("Promotion",Object.assign({shopId:this.getLocalShopId(),productId:e},t)):Promise.resolve({status:!1,errMessage:"productId is required!"})}updatePromotion(e,t,r){return r.id?super.update("Promotion",Object.assign({shopId:this.getLocalShopId(),productId:e},r),{id:t}):Promise.resolve({status:!1,errMessage:"promotionId is required!"})}deletePromotion(e){return e?super.delete("Promotion",{id:e}):Promise.resolve({status:!1,errMessage:"promoitonId is required!"})}}exports.default=new LocalShopService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9sb2NhbC1zaG9wLXNlcnZpY2UudHMiXSwibmFtZXMiOlsiY3J1ZF9zZXJ2aWNlXzEiLCJyZXF1aXJlIiwic2hvcF9zZXJ2aWNlXzEiLCJQcm9taXNlIiwiYXBwX2NvbmZpZ18xIiwiVXRpbHMiLCJMb2NhbFNob3BTZXJ2aWNlIiwiQ1JVRFNlcnZpY2UiLCJbb2JqZWN0IE9iamVjdF0iLCJ0aGlzIiwibG9jYWxTaG9wSWQiLCJkZWZhdWx0IiwiTE9DQUxfU0hPUF9JTkZPUk1BVElPTiIsIk5BTUUiLCJzdXBlciIsInJlYWRPbmUiLCJuYW1lIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJkYXRhIiwiaWQiLCJlcnJNZXNzYWdlIiwicmVzb2x2ZSIsIkVycm9yIiwiZ2V0U2hvcGlmaWVkUHJvZHVjdHMiLCJnZXRMb2NhbFNob3BJZCIsInNlYXJjaENsYXVzZSIsImdldFNob3BTdG9jayIsInBhZ2VTaXplIiwicGFnZUluZGV4IiwicHJvZHVjdElkIiwiY2F0ZWdvcnlJZCIsInN1YkNhdGVnb3J5SWQiLCJnZXRJblN0b2NrUHJvZHVjdHMiLCJwcm9kdWN0cyIsImxlbmd0aCIsImdldFBPUHJvZHVjdHMiLCJjYXRlZ29yaWVzIiwibGFzdFVwZGF0ZWQiLCJhZGRQcm9kdWN0IiwiaW5TdG9ja1Byb2R1Y3QiLCJwcm9kdWN0Iiwic3ViQ2F0ZWdvcnkiLCJjYXRlZ29yeSIsInN1YkNhdGVnb3J5TmFtZSIsImNhdGVnb3J5TmFtZSIsInN1YkNhdGVnb3JpZXMiLCJmaW5kIiwicHVzaCIsImdldENhdGVnb3J5IiwicG9Qcm9kdWN0cyIsImluU3RvY2tQcm9kdWN0cyIsImdldFN1YkNhdGVnb3J5IiwidXBkYXRlZEF0Iiwiam9pbiIsInNwcmVhZCIsInJlc3AxIiwicmVzcDIiLCJmb3JFYWNoIiwicG9Qcm9kdWN0IiwiZ2V0U2hvcGlmaWVkVmFyaWFudHMiLCJwcmljZSIsInByZU9yZGVyQWxsb3dlZCIsInByZU9yZGVyRHVyYXRpb24iLCJkaXNhYmxlZCIsImdldE1vZGVscyIsImZpbmRPbmUiLCJ3aGVyZSIsInNob3BJZCIsInNob3BQcm9kdWN0IiwidXBzZXJ0IiwiY291bnQiLCJ2YXJpYW50SWQiLCJxdWFudGl0eSIsImRhdGUiLCJkZXNjcmlwdGlvbiIsImNyZWF0ZSIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJyYXdWYXJpYW50IiwicmF3UHJvZHVjdCIsInZhcmlhbnQiLCJvYmplY3RpZnkiLCJyZXN1bHQiLCJzaG9wUHJpY2UiLCJnZXRJblN0b2NrUHJvZHVjdCIsImdldFBPUHJvZHVjdCIsImF2YWlsYWJpbGl0eSIsInN0b2NrUXVhbnRpdHkiLCJnZXRQcm9kdWN0QXZhaWxhYmlsaXR5IiwiZ2V0UHJvbW90aW9uIiwiT2JqZWN0IiwiYXNzaWduIiwicHJvbW90aW9uSWQiLCJ1cGRhdGUiLCJkZWxldGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBRUEsTUFBQUEsZUFBQUMsUUFBQSxrQkFDQUMsZUFBQUQsUUFBQSxrQkFFQUUsUUFBQUYsUUFBQSxZQUVBRyxhQUFBSCxRQUFBLGlCQUNBSSxNQUFBSixRQUFBLHVCQW1CQUsseUJBQStCTixlQUFBTyxZQUEvQkMsa0NBQ1VDLEtBQUFDLGFBQXVCLEVBQy9CRixhQUNFLE9BQUtKLGFBQUFPLFFBQVVDLHdCQUEyQlIsYUFBQU8sUUFBVUMsdUJBQXVCQyxNQUcvQyxJQUF0QkosS0FBS0MsWUFDQUksTUFBTUMsUUFBYyxRQUFVQyxLQUFNWixhQUFBTyxRQUFVQyx1QkFBdUJDLE9BQVFJLEtBQUtDLEdBQ25GQSxFQUFLQyxRQUFVRCxFQUFLRSxNQUN0QlgsS0FBS0MsWUFBY1EsRUFBS0UsS0FBS0MsSUFDcEJGLFFBQVEsRUFBTUMsS0FBTSxRQUVwQkQsUUFBUSxFQUFPRyxXQUFZLDRCQUlqQ25CLFFBQVFvQixTQUFVSixRQUFRLEVBQU1DLEtBQU0sT0FaeENqQixRQUFRb0IsU0FBVUosUUFBUSxFQUFPRyxXQUFZLDJDQWlCeERkLGlC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ZixPQUFJQSxFQUNLbkYsTUFBTXFGLE9BQWtCLGFBQWU5RSxHQUFJNEUsSUFFM0M5RixRQUFRb0IsU0FBVUosUUFBUSxFQUFPRyxXQUFZLDhCQU0xRDhFLFFBQUF6RixRQUFlLElBQUlMIiwiZmlsZSI6InNlcnZpY2VzL2xvY2FsLXNob3Atc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHV0aWwgZnJvbSAndXRpbCdcblxuaW1wb3J0IHsgQ1JVRFNlcnZpY2UgfSBmcm9tICcuL2NydWQtc2VydmljZSdcbmltcG9ydCBTaG9wU2VydmljZSBmcm9tICcuL3Nob3Atc2VydmljZSdcbmltcG9ydCB7IE1vZGVsIH0gZnJvbSAnc2VxdWVsaXplJ1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi9hcHAtY29uZmlnJ1xuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vbGlicy91dGlscydcblxuZXhwb3J0IGludGVyZmFjZSBQcm9kdWN0QXZhaWxhYmlsaXR5IHtcbiAgc3RhdHVzOiAncmVhZHlTdG9jaycgfCAncHJlT3JkZXInXG4gIHF1YW50aXR5PzogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2F0ZWdvcml6ZWRQcm9kdWN0IHtcbiAgbmFtZTogc3RyaW5nIC8vIENhdGVnb3J5IG5hbWVcbiAgc3ViQ2F0ZWdvcmllczogQXJyYXk8e1xuICAgIG5hbWU6IHN0cmluZ1xuICAgIGluU3RvY2tQcm9kdWN0czogQXJyYXk8SW5TdG9ja1Byb2R1Y3Q+XG4gICAgcG9Qcm9kdWN0czogQXJyYXk8UE9Qcm9kdWN0PlxuICB9PlxufVxuXG4vKlxuICBVc2VkIGZvciBzaG9wLXNwZWNpZmljIGNvZGUuIFRoaXMgc2hvdWxkIHJlLXVzZSB3aGF0J3MgaW4gc2hvcC1zZXJ2aWNlIGFzIG11Y2ggYXMgcG9zc2libGUsIHRob3VnaC5cbiAqL1xuY2xhc3MgTG9jYWxTaG9wU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBsb2NhbFNob3BJZDogbnVtYmVyID0gLTFcbiAgaW5pdGlhbGl6ZSAoKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bGw+PiB7XG4gICAgaWYgKCFBcHBDb25maWcuTE9DQUxfU0hPUF9JTkZPUk1BVElPTiB8fCAhQXBwQ29uZmlnLkxPQ0FMX1NIT1BfSU5GT1JNQVRJT04uTkFNRSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdMb2NhbCBTaG9wIEluZm9ybWF0aW9uIGlzIG5vdCBkZWZpbmVkIScgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMubG9jYWxTaG9wSWQgPT09IC0xKSB7XG4gICAgICAgIHJldHVybiBzdXBlci5yZWFkT25lPFNob3A+KCdTaG9wJywgeyBuYW1lOiBBcHBDb25maWcuTE9DQUxfU0hPUF9JTkZPUk1BVElPTi5OQU1FIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgdGhpcy5sb2NhbFNob3BJZCA9IHJlc3AuZGF0YS5pZFxuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBudWxsIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ1Nob3AgbmFtZSBpcyBub3QgZm91bmQhJyB9XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogdHJ1ZSwgZGF0YTogbnVsbCB9KVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldExvY2FsU2hvcElkICgpOiBudW1iZXIge1xuICAgIGlmICh0aGlzLmxvY2FsU2hvcElkICE9PSAtMSkge1xuICAgICAgcmV0dXJuIHRoaXMubG9jYWxTaG9wSWRcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdMb2NhbCBzaG9wIGlkIGlzIG5vdCB5ZXQgcmV0cmlldmVkIScpXG4gICAgfVxuICB9XG5cbiAgZ2V0U2hvcGlmaWVkUHJvZHVjdHMgKCkge1xuICAgIHJldHVybiBTaG9wU2VydmljZS5nZXRTaG9waWZpZWRQcm9kdWN0cyh0aGlzLmdldExvY2FsU2hvcElkKCkpXG4gIH1cblxuICBnZXRTaG9wU3RvY2sgKHNlYXJjaENsYXVzZSA9IHt9KSB7XG4gICAgcmV0dXJuIFNob3BTZXJ2aWNlLmdldFNob3BTdG9jayh0aGlzLmdldExvY2FsU2hvcElkKCksIHNlYXJjaENsYXVzZSlcbiAgfVxuXG4gIC8qXG4gICAgSW5TdG9ja1Byb2R1Y3RbXSB3aXRoOlxuICAgIC1wcmltYXJ5SW1hZ2VcbiAgICAtc3ViQ2F0ZWdvcmllc1xuXG4gICAgVGhpcyBpcyB1c2VkIGJ5IGxhbmRpbmcgcGFnZSwgd2hlcmUgd2UgZGlzcGxheVxuICAqL1xuICBnZXRJblN0b2NrUHJvZHVjdHMgKHsgcGFnZVNpemUgPSAxMCwgcGFnZUluZGV4ID0gMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3RJZCA9IG51bGwsIGNhdGVnb3J5SWQgPSBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3ViQ2F0ZWdvcnlJZCA9IG51bGwgfSk6IFByb21pc2U8TkNSZXNwb25zZTx7IHByb2R1Y3RzOiBJblN0b2NrUHJvZHVjdFtdLCB0b3RhbFByb2R1Y3RzOiBudW1iZXIgfT4+IHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgcGFnZVNpemUsIHBhZ2VJbmRleCwgcHJvZHVjdElkLCBjYXRlZ29yeUlkLCBzdWJDYXRlZ29yeUlkIH0sIHRoaXMubG9jYWxTaG9wSWQpXG4gIH1cblxuICBnZXRJblN0b2NrUHJvZHVjdCAocHJvZHVjdElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEluU3RvY2tQcm9kdWN0Pj4ge1xuICAgIHJldHVybiB0aGlzLmdldEluU3RvY2tQcm9kdWN0cyh7IHByb2R1Y3RJZCwgcGFnZVNpemU6IDEsIHBhZ2VJbmRleDogMCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhICYmIHJlc3AuZGF0YS5wcm9kdWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwLmRhdGEucHJvZHVjdHNbMF0gfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdQcm9kdWN0IG5vdCBmb3VuZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UE9Qcm9kdWN0cyAoeyBwYWdlU2l6ZSA9IDEwLCBwYWdlSW5kZXggPSAwLFxuICAgICAgICAgICAgICAgICAgIHByb2R1Y3RJZCA9IG51bGwsIGNhdGVnb3J5SWQgPSBudWxsLFxuICAgICAgICAgICAgICAgICAgIHN1YkNhdGVnb3J5SWQgPSBudWxsIH0pOiBQcm9taXNlPE5DUmVzcG9uc2U8eyBwcm9kdWN0czogUE9Qcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlciB9Pj4ge1xuICAgIHJldHVybiBTaG9wU2VydmljZS5nZXRQT1Byb2R1Y3RzKHsgcGFnZVNpemUsIHBhZ2VJbmRleCwgcHJvZHVjdElkLCBjYXRlZ29yeUlkLCBzdWJDYXRlZ29yeUlkIH0sIHRoaXMubG9jYWxTaG9wSWQpXG4gIH1cblxuICBnZXRQT1Byb2R1Y3QgKHByb2R1Y3RJZCk6IFByb21pc2U8TkNSZXNwb25zZTxQT1Byb2R1Y3Q+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UE9Qcm9kdWN0cyh7IHBhZ2VTaXplOiAxLCBwYWdlSW5kZXg6IDAsIHByb2R1Y3RJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhLnByb2R1Y3RzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcC5kYXRhLnByb2R1Y3RzWzBdIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnUHJvZHVjdCBub3QgZm91bmQhJyB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFByb2R1Y3RzQnlDYXRlZ29yaWVzICgpOiBQcm9taXNlPE5DUmVzcG9uc2U8e2NhdGVnb3JpZXM6IENhdGVnb3JpemVkUHJvZHVjdFtdLCBsYXN0VXBkYXRlZDogc3RyaW5nfT4+IHtcbiAgICAvKlxuICAgICAgV2UnbGwgaGF2ZSBhdCBtb3N0IHRob3VzYW5kcyBvZiBwcm9kdWN0cyBhbmQgZ2V0dGluZyBwcmljZSBsaXN0IGlzXG4gICAgICBub3Qgc29tZXRoaW5nIGRvbmUgdG9vIG9mdGVuLiBTbyBmb3Igbm93LCB3ZSBjYW4gZ2V0IGJ5IGRvaW5nIHRoZSBwcm9kdWN0XG4gICAgICBncm91cGluZyBtYW51YWxseS5cbiAgICAqL1xuICAgIGNvbnN0IGNhdGVnb3JpZXM6IENhdGVnb3JpemVkUHJvZHVjdFtdID0gW11cbiAgICBsZXQgbGFzdFVwZGF0ZWQ6IHN0cmluZ1xuICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBoZWxwIGdyb3VwaW5nXG4gICAgZnVuY3Rpb24gYWRkUHJvZHVjdCAoaW5TdG9ja1Byb2R1Y3Q6IGJvb2xlYW4sIHByb2R1Y3Q6IEluU3RvY2tQcm9kdWN0IHwgUE9Qcm9kdWN0KSB7XG4gICAgICBmdW5jdGlvbiBnZXRTdWJDYXRlZ29yeSAoY2F0ZWdvcnlOYW1lLCBzdWJDYXRlZ29yeU5hbWUpIHtcbiAgICAgICAgZnVuY3Rpb24gZ2V0Q2F0ZWdvcnkgKGNhdGVnb3J5TmFtZSkge1xuICAgICAgICAgIGxldCBjYXRlZ29yeSA9IGNhdGVnb3JpZXMuZmluZChjYXRlZ29yeSA9PiBjYXRlZ29yeS5uYW1lID09PSBjYXRlZ29yeU5hbWUpXG4gICAgICAgICAgaWYgKCFjYXRlZ29yeSkge1xuICAgICAgICAgICAgY2F0ZWdvcnkgPSB7XG4gICAgICAgICAgICAgIG5hbWU6IGNhdGVnb3J5TmFtZSxcbiAgICAgICAgICAgICAgc3ViQ2F0ZWdvcmllczogW11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGVnb3JpZXMucHVzaChjYXRlZ29yeSlcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGNhdGVnb3J5XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3ViQ2F0ZWdvcmllcyA9IGdldENhdGVnb3J5KGNhdGVnb3J5TmFtZSkuc3ViQ2F0ZWdvcmllc1xuICAgICAgICBsZXQgc3ViQ2F0ZWdvcnkgPSBzdWJDYXRlZ29yaWVzLmZpbmQoc3ViQ2F0ZWdvcnkgPT4gc3ViQ2F0ZWdvcnkubmFtZSA9PT0gc3ViQ2F0ZWdvcnlOYW1lKVxuICAgICAgICBpZiAoIXN1YkNhdGVnb3J5KSB7XG4gICAgICAgICAgc3ViQ2F0ZWdvcnkgPSB7XG4gICAgICAgICAgICBuYW1lOiBzdWJDYXRlZ29yeU5hbWUsXG4gICAgICAgICAgICBwb1Byb2R1Y3RzOiBbXSxcbiAgICAgICAgICAgIGluU3RvY2tQcm9kdWN0czogW11cbiAgICAgICAgICB9XG4gICAgICAgICAgc3ViQ2F0ZWdvcmllcy5wdXNoKHN1YkNhdGVnb3J5KVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdWJDYXRlZ29yeVxuICAgICAgfVxuICAgICAgaWYgKCFwcm9kdWN0LnN1YkNhdGVnb3J5IHx8ICFwcm9kdWN0LnN1YkNhdGVnb3J5LmNhdGVnb3J5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUHJvZHVjdCBkb2VzIG5vdCBoYXZlIGNhdGVnb3J5IG9yIHN1YkNhdGVnb3J5IGRlZmluZWQhJylcbiAgICAgIH1cbiAgICAgIGNvbnN0IHN1YkNhdGVnb3J5TmFtZSA9IHByb2R1Y3Quc3ViQ2F0ZWdvcnkubmFtZVxuICAgICAgY29uc3QgY2F0ZWdvcnlOYW1lID0gcHJvZHVjdC5zdWJDYXRlZ29yeS5jYXRlZ29yeS5uYW1lXG4gICAgICBjb25zdCBzdWJDYXRlZ29yeSA9IGdldFN1YkNhdGVnb3J5KGNhdGVnb3J5TmFtZSwgc3ViQ2F0ZWdvcnlOYW1lKVxuICAgICAgaWYgKGluU3RvY2tQcm9kdWN0KSB7XG4gICAgICAgIHN1YkNhdGVnb3J5LmluU3RvY2tQcm9kdWN0cy5wdXNoKHByb2R1Y3QgYXMgSW5TdG9ja1Byb2R1Y3QpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdWJDYXRlZ29yeS5wb1Byb2R1Y3RzLnB1c2gocHJvZHVjdCBhcyBQT1Byb2R1Y3QpXG4gICAgICB9XG4gICAgICBpZiAoIWxhc3RVcGRhdGVkKSB7XG4gICAgICAgIGxhc3RVcGRhdGVkID0gcHJvZHVjdC51cGRhdGVkQXRcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxhc3RVcGRhdGVkID0gcHJvZHVjdC51cGRhdGVkQXQgPiBsYXN0VXBkYXRlZCA/IHByb2R1Y3QudXBkYXRlZEF0IDogbGFzdFVwZGF0ZWRcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICB0aGlzLmdldEluU3RvY2tQcm9kdWN0cyh7fSksXG4gICAgICB0aGlzLmdldFBPUHJvZHVjdHMoe30pXG4gICAgKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPEluU3RvY2tQcm9kdWN0W10+LCByZXNwMjogTkNSZXNwb25zZTxQT1Byb2R1Y3RbXT4pID0+IHtcbiAgICAgIGlmIChyZXNwMS5zdGF0dXMgJiYgcmVzcDEuZGF0YSAmJiByZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICByZXNwMS5kYXRhLmZvckVhY2goaW5TdG9ja1Byb2R1Y3QgPT4ge1xuICAgICAgICAgIGFkZFByb2R1Y3QodHJ1ZSwgaW5TdG9ja1Byb2R1Y3QpXG4gICAgICAgIH0pXG4gICAgICAgIHJlc3AyLmRhdGEuZm9yRWFjaChwb1Byb2R1Y3QgPT4ge1xuICAgICAgICAgIGFkZFByb2R1Y3QoZmFsc2UsIHBvUHJvZHVjdClcbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgY2F0ZWdvcmllcywgbGFzdFVwZGF0ZWQgfSB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwMS5lcnJNZXNzYWdlIHx8IHJlc3AyLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRTaG9waWZpZWRWYXJpYW50cyAocHJvZHVjdElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFNob3BpZmllZFZhcmlhbnRbXT4+IHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0U2hvcGlmaWVkVmFyaWFudHModGhpcy5sb2NhbFNob3BJZCwgcHJvZHVjdElkKVxuICB9XG5cbiAgLy8gVXBkYXRlIHNob3BQcm9kdWN0IGVudHJ5XG4gIC8vIEluIGFjdHVhbGl0eSwgdGhpcyBjYW4gYmUgaW5zZXJ0L3VwZGF0ZVxuICB1cGRhdGVQcm9kdWN0IChwcm9kdWN0SWQ6IG51bWJlciwgZGF0YTogUGFydGlhbDxTaG9wUHJvZHVjdD4pIHtcbiAgICBjb25zdCB7IHByaWNlLCBwcmVPcmRlckFsbG93ZWQsIHByZU9yZGVyRHVyYXRpb24sIGRpc2FibGVkIH0gPSBkYXRhXG4gICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdTaG9wUHJvZHVjdCcpLmZpbmRPbmUoeyB3aGVyZTogeyBzaG9wSWQ6IHRoaXMubG9jYWxTaG9wSWQsIHByb2R1Y3RJZCB9IH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogZGF0YSAmJiBkYXRhLmlkLFxuICAgICAgICBwcm9kdWN0SWQsXG4gICAgICAgIHNob3BJZDogdGhpcy5sb2NhbFNob3BJZCxcbiAgICAgICAgcHJpY2UsXG4gICAgICAgIHByZU9yZGVyQWxsb3dlZCxcbiAgICAgICAgcHJlT3JkZXJEdXJhdGlvbixcbiAgICAgICAgZGlzYWJsZWRcbiAgICAgIH1cbiAgICB9KS50aGVuKHNob3BQcm9kdWN0ID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnU2hvcFByb2R1Y3QnKS51cHNlcnQoc2hvcFByb2R1Y3QpLnRoZW4oY291bnQgPT4ge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgYWRkU2hvcFN0b2NrIChkYXRhOiBQYXJ0aWFsPFNob3BTdG9jaz4pOiBQcm9taXNlPE5DUmVzcG9uc2U8U2hvcFN0b2NrPj4ge1xuICAgIGNvbnN0IHsgdmFyaWFudElkLCBwcmljZSwgcXVhbnRpdHksIGRhdGUsIGRlc2NyaXB0aW9uIH0gPSBkYXRhXG4gICAgaWYgKCFkZXNjcmlwdGlvbikge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdEZXNjcmlwdGlvbiBpcyByZXF1aXJlZCEnIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZTxTaG9wU3RvY2s+KCdTaG9wU3RvY2snLCB7XG4gICAgICAgIHNob3BJZDogdGhpcy5sb2NhbFNob3BJZCxcbiAgICAgICAgdmFyaWFudElkLFxuICAgICAgICBwcmljZSxcbiAgICAgICAgcXVhbnRpdHksXG4gICAgICAgIGRhdGUsXG4gICAgICAgIGRlc2NyaXB0aW9uXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGdldFZhcmlhbnRJbmZvcm1hdGlvbiAodmFyaWFudElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPHtwcm9kdWN0OiBTaG9waWZpZWRQcm9kdWN0LCB2YXJpYW50OiBTaG9waWZpZWRWYXJpYW50fT4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPFZhcmlhbnQ+KCdWYXJpYW50Jywge1xuICAgICAgaWQ6IHZhcmlhbnRJZFxuICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IHJlc3AuZGF0YS5wcm9kdWN0SWRcbiAgICAgICAgcmV0dXJuIFByb21pc2Uuam9pbihcbiAgICAgICAgICBzdXBlci5nZXRTZXF1ZWxpemUoKS5xdWVyeShcbiAgICAgICAgICAgIGBTRUxFQ1QgKiBGUk9NIHNob3BpZmllZFZhcmlhbnRzVmlldyBXSEVSRSBpZCA9ICR7dmFyaWFudElkfSBBTkQgc2hvcElkPSR7dGhpcy5sb2NhbFNob3BJZH1gLFxuICAgICAgICAgICAgeyB0eXBlOiBzdXBlci5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KSxcbiAgICAgICAgICBzdXBlci5nZXRTZXF1ZWxpemUoKS5xdWVyeShcbiAgICAgICAgICAgIGBTRUxFQ1QgKiBGUk9NIHNob3BpZmllZFByb2R1Y3RzVmlldyBXSEVSRSBpZCA9ICR7cHJvZHVjdElkfSBBTkQgc2hvcElkPSR7dGhpcy5sb2NhbFNob3BJZH1gLFxuICAgICAgICAgICAgeyB0eXBlOiBzdXBlci5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KVxuICAgICAgICApLnNwcmVhZCgocmF3VmFyaWFudCwgcmF3UHJvZHVjdCkgPT4ge1xuICAgICAgICAgIGlmIChyYXdWYXJpYW50ICYmIHJhd1Byb2R1Y3QpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhcmlhbnQgPSBVdGlscy5vYmplY3RpZnkocmF3VmFyaWFudClbMF1cbiAgICAgICAgICAgIGNvbnN0IHByb2R1Y3QgPSBVdGlscy5vYmplY3RpZnkocmF3UHJvZHVjdClbMF1cbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB2YXJpYW50LCBwcm9kdWN0IH0gfVxuICAgICAgICAgIH0gZWxzZSBpZiAoIXJhd1ZhcmlhbnQpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGB2YXJpYW50SWQ9JHt2YXJpYW50SWR9IGlzIG5vdCBmb3VuZCFgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYHByb2R1Y3RJZD0ke3Byb2R1Y3RJZH0gaXMgbm90IGZvdW5kIWAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICd2YXJpYW50SWQ9JyArIHZhcmlhbnRJZCArICcgaXMgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRWYXJpYW50UHJpY2UgKHZhcmlhbnRJZCk6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxWYXJpYW50PignVmFyaWFudCcsIHtcbiAgICAgIGlkOiB2YXJpYW50SWRcbiAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCBwcm9kdWN0SWQgPSByZXNwLmRhdGEucHJvZHVjdElkXG4gICAgICAgIHJldHVybiBzdXBlci5nZXRTZXF1ZWxpemUoKS5xdWVyeShcbiAgICAgICAgICBgU0VMRUNUIHNob3BQcmljZSBGUk9NIHNob3BpZmllZFByb2R1Y3RzVmlldyBXSEVSRSBpZCA9ICR7cHJvZHVjdElkfSBBTkQgc2hvcElkID0gJHt0aGlzLmdldExvY2FsU2hvcElkKCl9YCxcbiAgICAgICAgICB7IHR5cGU6IHN1cGVyLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgY29uc3Qgc2hvcGlmaWVkUHJvZHVjdCA9IHJlc3VsdFswXVxuICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHNob3BpZmllZFByb2R1Y3Quc2hvcFByaWNlIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdwcm9kdWN0SWQ9JyArIHByb2R1Y3RJZCArICcgaXMgbm90IGZvdW5kIScgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAndmFyaWFudElkPScgKyB2YXJpYW50SWQgKyAnIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UHJvZHVjdEF2YWlsYWJpbGl0eSAocHJvZHVjdElkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8UHJvZHVjdEF2YWlsYWJpbGl0eT4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5qb2luPE5DUmVzcG9uc2U8YW55Pj4oXG4gICAgICB0aGlzLmdldEluU3RvY2tQcm9kdWN0KHByb2R1Y3RJZCksXG4gICAgICB0aGlzLmdldFBPUHJvZHVjdChwcm9kdWN0SWQpXG4gICAgKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPEluU3RvY2tQcm9kdWN0PiwgcmVzcDI6IE5DUmVzcG9uc2U8UE9Qcm9kdWN0PikgPT4ge1xuICAgICAgbGV0IGF2YWlsYWJpbGl0eTogUHJvZHVjdEF2YWlsYWJpbGl0eSA9IHtcbiAgICAgICAgc3RhdHVzOiAncmVhZHlTdG9jaydcbiAgICAgIH1cbiAgICAgIGlmIChyZXNwMS5zdGF0dXMgJiYgcmVzcDEuZGF0YSkge1xuICAgICAgICBhdmFpbGFiaWxpdHkuc3RhdHVzID0gJ3JlYWR5U3RvY2snXG4gICAgICAgIGF2YWlsYWJpbGl0eS5xdWFudGl0eSA9IHJlc3AxLmRhdGEuc3RvY2tRdWFudGl0eVxuICAgICAgfSBlbHNlIGlmIChyZXNwMi5zdGF0dXMpIHtcbiAgICAgICAgYXZhaWxhYmlsaXR5LnN0YXR1cyA9ICdwcmVPcmRlcidcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AxLmVyck1lc3NhZ2UgfHwgcmVzcDIuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGF2YWlsYWJpbGl0eSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFZhcmlhbnRBdmFpbGFiaWxpdHkgKHZhcmlhbnRJZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFByb2R1Y3RBdmFpbGFiaWxpdHk+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxWYXJpYW50PignVmFyaWFudCcsIHtcbiAgICAgIGlkOiB2YXJpYW50SWRcbiAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCBwcm9kdWN0SWQgPSByZXNwLmRhdGEucHJvZHVjdElkXG4gICAgICAgIHJldHVybiB0aGlzLmdldFByb2R1Y3RBdmFpbGFiaWxpdHkocHJvZHVjdElkKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UHJvbW90aW9ucyAoKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFNob3BpZmllZFByb21vdGlvbltdPj4ge1xuICAgIHJldHVybiBTaG9wU2VydmljZS5nZXRQcm9tb3Rpb24odGhpcy5nZXRMb2NhbFNob3BJZCgpKVxuICB9XG5cbiAgY3JlYXRlUHJvbW90aW9uIChwcm9kdWN0SWQ6IG51bWJlciwgZGF0YTogUGFydGlhbDxQcm9tb3Rpb24+KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFByb21vdGlvbj4+IHtcbiAgICBpZiAocHJvZHVjdElkKSB7XG4gICAgICByZXR1cm4gc3VwZXIuY3JlYXRlPFByb21vdGlvbj4oJ1Byb21vdGlvbicsIE9iamVjdC5hc3NpZ24oeyBzaG9wSWQ6IHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSwgcHJvZHVjdElkIH0sIGRhdGEpKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3Byb2R1Y3RJZCBpcyByZXF1aXJlZCEnIH0pXG4gICAgfVxuICB9XG5cbiAgdXBkYXRlUHJvbW90aW9uIChwcm9kdWN0SWQ6IG51bWJlciwgcHJvbW90aW9uSWQ6IG51bWJlciwgZGF0YTogUGFydGlhbDxQcm9tb3Rpb24+KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICBpZiAoZGF0YS5pZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxQcm9tb3Rpb24+KCdQcm9tb3Rpb24nLFxuICAgICAgICAgIE9iamVjdC5hc3NpZ24oeyBzaG9wSWQ6IHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSwgcHJvZHVjdElkIH0sIGRhdGEpLCB7IGlkOiBwcm9tb3Rpb25JZCB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3Byb21vdGlvbklkIGlzIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cblxuICAvLyBUT0RPOiBBZGQgc2hvcElkOiB0aGlzLmdldExvY2FsU2hvcElkKCkgZm9yIHNlY3VyaXR5XG4gIGRlbGV0ZVByb21vdGlvbiAocHJvbW90aW9uSWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgaWYgKHByb21vdGlvbklkKSB7XG4gICAgICByZXR1cm4gc3VwZXIuZGVsZXRlPFByb21vdGlvbj4oJ1Byb21vdGlvbicsIHsgaWQ6IHByb21vdGlvbklkIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAncHJvbW9pdG9uSWQgaXMgcmVxdWlyZWQhJyB9KVxuICAgIH1cbiAgfVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBMb2NhbFNob3BTZXJ2aWNlKClcbiJdfQ==
