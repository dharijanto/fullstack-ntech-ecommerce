"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const crud_service_1=require("./crud-service"),shop_service_1=require("./shop-service"),Promise=require("bluebird"),app_config_1=require("../app-config"),Utils=require("../libs/utils");class LocalShopService extends crud_service_1.CRUDService{constructor(){super(...arguments),this.localShopId=-1}initialize(){return app_config_1.default.LOCAL_SHOP_INFORMATION&&app_config_1.default.LOCAL_SHOP_INFORMATION.NAME?-1===this.localShopId?super.readOne("Shop",{name:app_config_1.default.LOCAL_SHOP_INFORMATION.NAME}).then(e=>e.status&&e.data?(this.localShopId=e.data.id,{status:!0,data:null}):{status:!1,errMessage:"Shop name is not found!"}):Promise.resolve({status:!0,data:null}):Promise.resolve({status:!1,errMessage:"Local Shop Information is not defined!"})}getLocalShopId(){if(-1!==this.localShopId)return this.localShopId;throw new Error("Local shop id is not yet retrieved!")}getShopifiedProducts(){return shop_service_1.default.getShopifiedProducts(this.getLocalShopId())}getShopStock(e={}){return shop_service_1.default.getShopStock(this.getLocalShopId(),e)}getInStockProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:s=null,subCategoryId:a=null}){return shop_service_1.default.getInStockProducts({pageSize:e,pageIndex:t,productId:r,categoryId:s,subCategoryId:a},this.localShopId)}getInStockProduct(e){return this.getInStockProducts({productId:e,pageSize:1,pageIndex:0}).then(e=>e.status&&e.data?e.data&&e.data.products.length>0?{status:!0,data:e.data.products[0]}:{status:!1,errMessage:"Product not found!"}:{status:!1,errMessage:e.errMessage})}getPOProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:s=null,subCategoryId:a=null}){return shop_service_1.default.getPOProducts({pageSize:e,pageIndex:t,productId:r,categoryId:s,subCategoryId:a},this.localShopId)}getPOProduct(e){return this.getPOProducts({pageSize:1,pageIndex:0,productId:e}).then(e=>e.status&&e.data?e.data.products.length?{status:!0,data:e.data.products[0]}:{status:!1,errMessage:"Product not found!"}:{status:!1,errMessage:e.errMessage})}getProductsByCategories(){const e=[];let t;function r(r,s){if(!s.subCategory||!s.subCategory.category)throw new Error("Product does not have category or subCategory defined!");const a=s.subCategory.name,o=function(t,r){const s=function(t){let r=e.find(e=>e.name===t);return r||(r={name:t,subCategories:[]},e.push(r)),r}(t).subCategories;let a=s.find(e=>e.name===r);return a||(a={name:r,poProducts:[],inStockProducts:[]},s.push(a)),a}(s.subCategory.category.name,a);r?o.inStockProducts.push(s):o.poProducts.push(s),t=t?s.updatedAt>t?s.updatedAt:t:s.updatedAt}return Promise.join(this.getInStockProducts({}),this.getPOProducts({})).spread((s,a)=>s.status&&s.data&&a.status&&a.data?(s.data.forEach(e=>{r(!0,e)}),a.data.forEach(e=>{r(!1,e)}),{status:!0,data:{categories:e,lastUpdated:t}}):{status:!1,errMessage:s.errMessage||a.errMessage})}getShopifiedVariants(e){return shop_service_1.default.getShopifiedVariants(this.localShopId,e)}updateProduct(e,t){const{price:r,preOrderAllowed:s,preOrderDuration:a,disabled:o}=t;return this.getModels("ShopProduct").findOne({where:{shopId:this.localShopId,productId:e}}).then(t=>({id:t&&t.id,productId:e,shopId:this.localShopId,price:r,preOrderAllowed:s,preOrderDuration:a,disabled:o})).then(e=>this.getModels("ShopProduct").upsert(e).then(e=>({status:!0})))}addShopStock(e){const{variantId:t,price:r,quantity:s,date:a}=e;return this.create("ShopStock",{shopId:this.localShopId,variantId:t,price:r,quantity:s,date:a})}getVariantInformation(e){return this.readOne("Variant",{id:e}).then(t=>{if(t.status&&t.data){const r=t.data.productId;return Promise.join(super.getSequelize().query(`SELECT * FROM shopifiedVariantsView WHERE id = ${e} AND shopId=${this.localShopId}`,{type:super.getSequelize().QueryTypes.SELECT}),super.getSequelize().query(`SELECT * FROM shopifiedProductsView WHERE id = ${r} AND shopId=${this.localShopId}`,{type:super.getSequelize().QueryTypes.SELECT})).spread((t,s)=>{if(t&&s){return{status:!0,data:{variant:Utils.objectify(t)[0],product:Utils.objectify(s)[0]}}}return t?{status:!1,errMessage:`productId=${r} is not found!`}:{status:!1,errMessage:`variantId=${e} is not found!`}})}return{status:!1,errMessage:"variantId="+e+" is not found!"}})}getVariantPrice(e){return this.readOne("Variant",{id:e}).then(t=>{if(t.status&&t.data){const e=t.data.productId;return super.getSequelize().query(`SELECT shopPrice FROM shopifiedProductsView WHERE id = ${e} AND shopId = ${this.getLocalShopId()}`,{type:super.getSequelize().QueryTypes.SELECT}).then(t=>{if(t&&t.length>0){return{status:!0,data:t[0].shopPrice}}return{status:!1,errMessage:"productId="+e+" is not found!"}})}return{status:!1,errMessage:"variantId="+e+" is not found!"}})}getProductAvailability(e){return Promise.join(this.getInStockProduct(e),this.getPOProduct(e)).spread((e,t)=>{let r={status:"readyStock"};if(e.status&&e.data)r.status="readyStock",r.quantity=e.data.stockQuantity;else{if(!t.status)return{status:!1,errMessage:e.errMessage||t.errMessage};r.status="preOrder"}return{status:!0,data:r}})}getVariantAvailability(e){return this.readOne("Variant",{id:e}).then(e=>{if(e.status&&e.data){const t=e.data.productId;return this.getProductAvailability(t)}return{status:!1,errMessage:e.errMessage}})}getPromotion(){return shop_service_1.default.getPromotion(this.getLocalShopId())}createPromotion(e,t){return e?super.create("Promotion",Object.assign({shopId:this.getLocalShopId(),productId:e},t)):Promise.resolve({status:!1,errMessage:"productId is required!"})}updatePromotion(e,t,r){return r.id?super.update("Promotion",Object.assign({shopId:this.getLocalShopId(),productId:e},r),{id:t}):Promise.resolve({status:!1,errMessage:"promotionId is required!"})}deletePromotion(e){return e?super.delete("Promotion",{id:e}):Promise.resolve({status:!1,errMessage:"promoitonId is required!"})}}exports.default=new LocalShopService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9sb2NhbC1zaG9wLXNlcnZpY2UudHMiXSwibmFtZXMiOlsiY3J1ZF9zZXJ2aWNlXzEiLCJyZXF1aXJlIiwic2hvcF9zZXJ2aWNlXzEiLCJQcm9taXNlIiwiYXBwX2NvbmZpZ18xIiwiVXRpbHMiLCJMb2NhbFNob3BTZXJ2aWNlIiwiQ1JVRFNlcnZpY2UiLCJbb2JqZWN0IE9iamVjdF0iLCJ0aGlzIiwibG9jYWxTaG9wSWQiLCJkZWZhdWx0IiwiTE9DQUxfU0hPUF9JTkZPUk1BVElPTiIsIk5BTUUiLCJzdXBlciIsInJlYWRPbmUiLCJuYW1lIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJkYXRhIiwiaWQiLCJlcnJNZXNzYWdlIiwicmVzb2x2ZSIsIkVycm9yIiwiZ2V0U2hvcGlmaWVkUHJvZHVjdHMiLCJnZXRMb2NhbFNob3BJZCIsInNlYXJjaENsYXVzZSIsImdldFNob3BTdG9jayIsInBhZ2VTaXplIiwicGFnZUluZGV4IiwicHJvZHVjdElkIiwiY2F0ZWdvcnlJZCIsInN1YkNhdGVnb3J5SWQiLCJnZXRJblN0b2NrUHJvZHVjdHMiLCJwcm9kdWN0cyIsImxlbmd0aCIsImdldFBPUHJvZHVjdHMiLCJjYXRlZ29yaWVzIiwibGFzdFVwZGF0ZWQiLCJhZGRQcm9kdWN0IiwiaW5TdG9ja1Byb2R1Y3QiLCJwcm9kdWN0Iiwic3ViQ2F0ZWdvcnkiLCJjYXRlZ29yeSIsInN1YkNhdGVnb3J5TmFtZSIsImNhdGVnb3J5TmFtZSIsInN1YkNhdGVnb3JpZXMiLCJmaW5kIiwicHVzaCIsImdldENhdGVnb3J5IiwicG9Qcm9kdWN0cyIsImluU3RvY2tQcm9kdWN0cyIsImdldFN1YkNhdGVnb3J5IiwidXBkYXRlZEF0Iiwiam9pbiIsInNwcmVhZCIsInJlc3AxIiwicmVzcDIiLCJmb3JFYWNoIiwicG9Qcm9kdWN0IiwiZ2V0U2hvcGlmaWVkVmFyaWFudHMiLCJwcmljZSIsInByZU9yZGVyQWxsb3dlZCIsInByZU9yZGVyRHVyYXRpb24iLCJkaXNhYmxlZCIsImdldE1vZGVscyIsImZpbmRPbmUiLCJ3aGVyZSIsInNob3BJZCIsInNob3BQcm9kdWN0IiwidXBzZXJ0IiwiY291bnQiLCJ2YXJpYW50SWQiLCJxdWFudGl0eSIsImRhdGUiLCJjcmVhdGUiLCJnZXRTZXF1ZWxpemUiLCJxdWVyeSIsInR5cGUiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwicmF3VmFyaWFudCIsInJhd1Byb2R1Y3QiLCJ2YXJpYW50Iiwib2JqZWN0aWZ5IiwicmVzdWx0Iiwic2hvcFByaWNlIiwiZ2V0SW5TdG9ja1Byb2R1Y3QiLCJnZXRQT1Byb2R1Y3QiLCJhdmFpbGFiaWxpdHkiLCJzdG9ja1F1YW50aXR5IiwiZ2V0UHJvZHVjdEF2YWlsYWJpbGl0eSIsImdldFByb21vdGlvbiIsIk9iamVjdCIsImFzc2lnbiIsInByb21vdGlvbklkIiwidXBkYXRlIiwiZGVsZXRlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUVBLE1BQUFBLGVBQUFDLFFBQUEsa0JBQ0FDLGVBQUFELFFBQUEsa0JBRUFFLFFBQUFGLFFBQUEsWUFFQUcsYUFBQUgsUUFBQSxpQkFDQUksTUFBQUosUUFBQSx1QkFtQkFLLHlCQUErQk4sZUFBQU8sWUFBL0JDLGtDQUNVQyxLQUFBQyxhQUF1QixFQUMvQkYsYUFDRSxPQUFLSixhQUFBTyxRQUFVQyx3QkFBMkJSLGFBQUFPLFFBQVVDLHVCQUF1QkMsTUFHL0MsSUFBdEJKLEtBQUtDLFlBQ0FJLE1BQU1DLFFBQWMsUUFBVUMsS0FBTVosYUFBQU8sUUFBVUMsdUJBQXVCQyxPQUFRSSxLQUFLQyxHQUNuRkEsRUFBS0MsUUFBVUQsRUFBS0UsTUFDdEJYLEtBQUtDLFlBQWNRLEVBQUtFLEtBQUtDLElBQ3BCRixRQUFRLEVBQU1DLEtBQU0sUUFFcEJELFFBQVEsRUFBT0csV0FBWSw0QkFJakNuQixRQUFRb0IsU0FBVUosUUFBUSxFQUFNQyxLQUFNLE9BWnhDakIsUUFBUW9CLFNBQVVKLFFBQVEsRUFBT0csV0FBWSwyQ0FpQnhEZCxpQkFDRSxJQUEwQixJQUF0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NkUsUUFBQXhGLFFBQWUsSUFBSUwiLCJmaWxlIjoic2VydmljZXMvbG9jYWwtc2hvcC1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdXRpbCBmcm9tICd1dGlsJ1xuXG5pbXBvcnQgeyBDUlVEU2VydmljZSB9IGZyb20gJy4vY3J1ZC1zZXJ2aWNlJ1xuaW1wb3J0IFNob3BTZXJ2aWNlIGZyb20gJy4vc2hvcC1zZXJ2aWNlJ1xuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICdzZXF1ZWxpemUnXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuXG5pbXBvcnQgQXBwQ29uZmlnIGZyb20gJy4uL2FwcC1jb25maWcnXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICcuLi9saWJzL3V0aWxzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFByb2R1Y3RBdmFpbGFiaWxpdHkge1xuICBzdGF0dXM6ICdyZWFkeVN0b2NrJyB8ICdwcmVPcmRlcidcbiAgcXVhbnRpdHk/OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYXRlZ29yaXplZFByb2R1Y3Qge1xuICBuYW1lOiBzdHJpbmcgLy8gQ2F0ZWdvcnkgbmFtZVxuICBzdWJDYXRlZ29yaWVzOiBBcnJheTx7XG4gICAgbmFtZTogc3RyaW5nXG4gICAgaW5TdG9ja1Byb2R1Y3RzOiBBcnJheTxJblN0b2NrUHJvZHVjdD5cbiAgICBwb1Byb2R1Y3RzOiBBcnJheTxQT1Byb2R1Y3Q+XG4gIH0+XG59XG5cbi8qXG4gIFVzZWQgZm9yIHNob3Atc3BlY2lmaWMgY29kZS4gVGhpcyBzaG91bGQgcmUtdXNlIHdoYXQncyBpbiBzaG9wLXNlcnZpY2UgYXMgbXVjaCBhcyBwb3NzaWJsZSwgdGhvdWdoLlxuICovXG5jbGFzcyBMb2NhbFNob3BTZXJ2aWNlIGV4dGVuZHMgQ1JVRFNlcnZpY2Uge1xuICBwcml2YXRlIGxvY2FsU2hvcElkOiBudW1iZXIgPSAtMVxuICBpbml0aWFsaXplICgpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVsbD4+IHtcbiAgICBpZiAoIUFwcENvbmZpZy5MT0NBTF9TSE9QX0lORk9STUFUSU9OIHx8ICFBcHBDb25maWcuTE9DQUxfU0hPUF9JTkZPUk1BVElPTi5OQU1FKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0xvY2FsIFNob3AgSW5mb3JtYXRpb24gaXMgbm90IGRlZmluZWQhJyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5sb2NhbFNob3BJZCA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8U2hvcD4oJ1Nob3AnLCB7IG5hbWU6IEFwcENvbmZpZy5MT0NBTF9TSE9QX0lORk9STUFUSU9OLk5BTUUgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsU2hvcElkID0gcmVzcC5kYXRhLmlkXG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IG51bGwgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnU2hvcCBuYW1lIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBudWxsIH0pXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0TG9jYWxTaG9wSWQgKCk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMubG9jYWxTaG9wSWQgIT09IC0xKSB7XG4gICAgICByZXR1cm4gdGhpcy5sb2NhbFNob3BJZFxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvY2FsIHNob3AgaWQgaXMgbm90IHlldCByZXRyaWV2ZWQhJylcbiAgICB9XG4gIH1cblxuICBnZXRTaG9waWZpZWRQcm9kdWN0cyAoKSB7XG4gICAgcmV0dXJuIFNob3BTZXJ2aWNlLmdldFNob3BpZmllZFByb2R1Y3RzKHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSlcbiAgfVxuXG4gIGdldFNob3BTdG9jayAoc2VhcmNoQ2xhdXNlID0ge30pIHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0U2hvcFN0b2NrKHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSwgc2VhcmNoQ2xhdXNlKVxuICB9XG5cbiAgLypcbiAgICBJblN0b2NrUHJvZHVjdFtdIHdpdGg6XG4gICAgLXByaW1hcnlJbWFnZVxuICAgIC1zdWJDYXRlZ29yaWVzXG5cbiAgICBUaGlzIGlzIHVzZWQgYnkgbGFuZGluZyBwYWdlLCB3aGVyZSB3ZSBkaXNwbGF5XG4gICovXG4gIGdldEluU3RvY2tQcm9kdWN0cyAoeyBwYWdlU2l6ZSA9IDEwLCBwYWdlSW5kZXggPSAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZHVjdElkID0gbnVsbCwgY2F0ZWdvcnlJZCA9IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJDYXRlZ29yeUlkID0gbnVsbCB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPHsgcHJvZHVjdHM6IEluU3RvY2tQcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlciB9Pj4ge1xuICAgIHJldHVybiBTaG9wU2VydmljZS5nZXRJblN0b2NrUHJvZHVjdHMoeyBwYWdlU2l6ZSwgcGFnZUluZGV4LCBwcm9kdWN0SWQsIGNhdGVnb3J5SWQsIHN1YkNhdGVnb3J5SWQgfSwgdGhpcy5sb2NhbFNob3BJZClcbiAgfVxuXG4gIGdldEluU3RvY2tQcm9kdWN0IChwcm9kdWN0SWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8SW5TdG9ja1Byb2R1Y3Q+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0SW5TdG9ja1Byb2R1Y3RzKHsgcHJvZHVjdElkLCBwYWdlU2l6ZTogMSwgcGFnZUluZGV4OiAwIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGlmIChyZXNwLmRhdGEgJiYgcmVzcC5kYXRhLnByb2R1Y3RzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3AuZGF0YS5wcm9kdWN0c1swXSB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ1Byb2R1Y3Qgbm90IGZvdW5kIScgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRQT1Byb2R1Y3RzICh7IHBhZ2VTaXplID0gMTAsIHBhZ2VJbmRleCA9IDAsXG4gICAgICAgICAgICAgICAgICAgcHJvZHVjdElkID0gbnVsbCwgY2F0ZWdvcnlJZCA9IG51bGwsXG4gICAgICAgICAgICAgICAgICAgc3ViQ2F0ZWdvcnlJZCA9IG51bGwgfSk6IFByb21pc2U8TkNSZXNwb25zZTx7IHByb2R1Y3RzOiBQT1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyIH0+PiB7XG4gICAgcmV0dXJuIFNob3BTZXJ2aWNlLmdldFBPUHJvZHVjdHMoeyBwYWdlU2l6ZSwgcGFnZUluZGV4LCBwcm9kdWN0SWQsIGNhdGVnb3J5SWQsIHN1YkNhdGVnb3J5SWQgfSwgdGhpcy5sb2NhbFNob3BJZClcbiAgfVxuXG4gIGdldFBPUHJvZHVjdCAocHJvZHVjdElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFBPUHJvZHVjdD4+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRQT1Byb2R1Y3RzKHsgcGFnZVNpemU6IDEsIHBhZ2VJbmRleDogMCwgcHJvZHVjdElkIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGlmIChyZXNwLmRhdGEucHJvZHVjdHMubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwLmRhdGEucHJvZHVjdHNbMF0gfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdQcm9kdWN0IG5vdCBmb3VuZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UHJvZHVjdHNCeUNhdGVnb3JpZXMgKCk6IFByb21pc2U8TkNSZXNwb25zZTx7Y2F0ZWdvcmllczogQ2F0ZWdvcml6ZWRQcm9kdWN0W10sIGxhc3RVcGRhdGVkOiBzdHJpbmd9Pj4ge1xuICAgIC8qXG4gICAgICBXZSdsbCBoYXZlIGF0IG1vc3QgdGhvdXNhbmRzIG9mIHByb2R1Y3RzIGFuZCBnZXR0aW5nIHByaWNlIGxpc3QgaXNcbiAgICAgIG5vdCBzb21ldGhpbmcgZG9uZSB0b28gb2Z0ZW4uIFNvIGZvciBub3csIHdlIGNhbiBnZXQgYnkgZG9pbmcgdGhlIHByb2R1Y3RcbiAgICAgIGdyb3VwaW5nIG1hbnVhbGx5LlxuICAgICovXG4gICAgY29uc3QgY2F0ZWdvcmllczogQ2F0ZWdvcml6ZWRQcm9kdWN0W10gPSBbXVxuICAgIGxldCBsYXN0VXBkYXRlZDogc3RyaW5nXG4gICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGhlbHAgZ3JvdXBpbmdcbiAgICBmdW5jdGlvbiBhZGRQcm9kdWN0IChpblN0b2NrUHJvZHVjdDogYm9vbGVhbiwgcHJvZHVjdDogSW5TdG9ja1Byb2R1Y3QgfCBQT1Byb2R1Y3QpIHtcbiAgICAgIGZ1bmN0aW9uIGdldFN1YkNhdGVnb3J5IChjYXRlZ29yeU5hbWUsIHN1YkNhdGVnb3J5TmFtZSkge1xuICAgICAgICBmdW5jdGlvbiBnZXRDYXRlZ29yeSAoY2F0ZWdvcnlOYW1lKSB7XG4gICAgICAgICAgbGV0IGNhdGVnb3J5ID0gY2F0ZWdvcmllcy5maW5kKGNhdGVnb3J5ID0+IGNhdGVnb3J5Lm5hbWUgPT09IGNhdGVnb3J5TmFtZSlcbiAgICAgICAgICBpZiAoIWNhdGVnb3J5KSB7XG4gICAgICAgICAgICBjYXRlZ29yeSA9IHtcbiAgICAgICAgICAgICAgbmFtZTogY2F0ZWdvcnlOYW1lLFxuICAgICAgICAgICAgICBzdWJDYXRlZ29yaWVzOiBbXVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0ZWdvcmllcy5wdXNoKGNhdGVnb3J5KVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gY2F0ZWdvcnlcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdWJDYXRlZ29yaWVzID0gZ2V0Q2F0ZWdvcnkoY2F0ZWdvcnlOYW1lKS5zdWJDYXRlZ29yaWVzXG4gICAgICAgIGxldCBzdWJDYXRlZ29yeSA9IHN1YkNhdGVnb3JpZXMuZmluZChzdWJDYXRlZ29yeSA9PiBzdWJDYXRlZ29yeS5uYW1lID09PSBzdWJDYXRlZ29yeU5hbWUpXG4gICAgICAgIGlmICghc3ViQ2F0ZWdvcnkpIHtcbiAgICAgICAgICBzdWJDYXRlZ29yeSA9IHtcbiAgICAgICAgICAgIG5hbWU6IHN1YkNhdGVnb3J5TmFtZSxcbiAgICAgICAgICAgIHBvUHJvZHVjdHM6IFtdLFxuICAgICAgICAgICAgaW5TdG9ja1Byb2R1Y3RzOiBbXVxuICAgICAgICAgIH1cbiAgICAgICAgICBzdWJDYXRlZ29yaWVzLnB1c2goc3ViQ2F0ZWdvcnkpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN1YkNhdGVnb3J5XG4gICAgICB9XG4gICAgICBpZiAoIXByb2R1Y3Quc3ViQ2F0ZWdvcnkgfHwgIXByb2R1Y3Quc3ViQ2F0ZWdvcnkuY2F0ZWdvcnkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm9kdWN0IGRvZXMgbm90IGhhdmUgY2F0ZWdvcnkgb3Igc3ViQ2F0ZWdvcnkgZGVmaW5lZCEnKVxuICAgICAgfVxuICAgICAgY29uc3Qgc3ViQ2F0ZWdvcnlOYW1lID0gcHJvZHVjdC5zdWJDYXRlZ29yeS5uYW1lXG4gICAgICBjb25zdCBjYXRlZ29yeU5hbWUgPSBwcm9kdWN0LnN1YkNhdGVnb3J5LmNhdGVnb3J5Lm5hbWVcbiAgICAgIGNvbnN0IHN1YkNhdGVnb3J5ID0gZ2V0U3ViQ2F0ZWdvcnkoY2F0ZWdvcnlOYW1lLCBzdWJDYXRlZ29yeU5hbWUpXG4gICAgICBpZiAoaW5TdG9ja1Byb2R1Y3QpIHtcbiAgICAgICAgc3ViQ2F0ZWdvcnkuaW5TdG9ja1Byb2R1Y3RzLnB1c2gocHJvZHVjdCBhcyBJblN0b2NrUHJvZHVjdClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1YkNhdGVnb3J5LnBvUHJvZHVjdHMucHVzaChwcm9kdWN0IGFzIFBPUHJvZHVjdClcbiAgICAgIH1cbiAgICAgIGlmICghbGFzdFVwZGF0ZWQpIHtcbiAgICAgICAgbGFzdFVwZGF0ZWQgPSBwcm9kdWN0LnVwZGF0ZWRBdFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGFzdFVwZGF0ZWQgPSBwcm9kdWN0LnVwZGF0ZWRBdCA+IGxhc3RVcGRhdGVkID8gcHJvZHVjdC51cGRhdGVkQXQgOiBsYXN0VXBkYXRlZFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmpvaW48TkNSZXNwb25zZTxhbnk+PihcbiAgICAgIHRoaXMuZ2V0SW5TdG9ja1Byb2R1Y3RzKHt9KSxcbiAgICAgIHRoaXMuZ2V0UE9Qcm9kdWN0cyh7fSlcbiAgICApLnNwcmVhZCgocmVzcDE6IE5DUmVzcG9uc2U8SW5TdG9ja1Byb2R1Y3RbXT4sIHJlc3AyOiBOQ1Jlc3BvbnNlPFBPUHJvZHVjdFtdPikgPT4ge1xuICAgICAgaWYgKHJlc3AxLnN0YXR1cyAmJiByZXNwMS5kYXRhICYmIHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhKSB7XG4gICAgICAgIHJlc3AxLmRhdGEuZm9yRWFjaChpblN0b2NrUHJvZHVjdCA9PiB7XG4gICAgICAgICAgYWRkUHJvZHVjdCh0cnVlLCBpblN0b2NrUHJvZHVjdClcbiAgICAgICAgfSlcbiAgICAgICAgcmVzcDIuZGF0YS5mb3JFYWNoKHBvUHJvZHVjdCA9PiB7XG4gICAgICAgICAgYWRkUHJvZHVjdChmYWxzZSwgcG9Qcm9kdWN0KVxuICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBjYXRlZ29yaWVzLCBsYXN0VXBkYXRlZCB9IH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AxLmVyck1lc3NhZ2UgfHwgcmVzcDIuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFNob3BpZmllZFZhcmlhbnRzIChwcm9kdWN0SWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8U2hvcGlmaWVkVmFyaWFudFtdPj4ge1xuICAgIHJldHVybiBTaG9wU2VydmljZS5nZXRTaG9waWZpZWRWYXJpYW50cyh0aGlzLmxvY2FsU2hvcElkLCBwcm9kdWN0SWQpXG4gIH1cblxuICAvLyBVcGRhdGUgc2hvcFByb2R1Y3QgZW50cnlcbiAgLy8gSW4gYWN0dWFsaXR5LCB0aGlzIGNhbiBiZSBpbnNlcnQvdXBkYXRlXG4gIHVwZGF0ZVByb2R1Y3QgKHByb2R1Y3RJZDogbnVtYmVyLCBkYXRhOiBQYXJ0aWFsPFNob3BQcm9kdWN0Pikge1xuICAgIGNvbnN0IHsgcHJpY2UsIHByZU9yZGVyQWxsb3dlZCwgcHJlT3JkZXJEdXJhdGlvbiwgZGlzYWJsZWQgfSA9IGRhdGFcbiAgICByZXR1cm4gdGhpcy5nZXRNb2RlbHMoJ1Nob3BQcm9kdWN0JykuZmluZE9uZSh7IHdoZXJlOiB7IHNob3BJZDogdGhpcy5sb2NhbFNob3BJZCwgcHJvZHVjdElkIH0gfSkudGhlbihkYXRhID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBkYXRhICYmIGRhdGEuaWQsXG4gICAgICAgIHByb2R1Y3RJZCxcbiAgICAgICAgc2hvcElkOiB0aGlzLmxvY2FsU2hvcElkLFxuICAgICAgICBwcmljZSxcbiAgICAgICAgcHJlT3JkZXJBbGxvd2VkLFxuICAgICAgICBwcmVPcmRlckR1cmF0aW9uLFxuICAgICAgICBkaXNhYmxlZFxuICAgICAgfVxuICAgIH0pLnRoZW4oc2hvcFByb2R1Y3QgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdTaG9wUHJvZHVjdCcpLnVwc2VydChzaG9wUHJvZHVjdCkudGhlbihjb3VudCA9PiB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBhZGRTaG9wU3RvY2sgKGRhdGE6IFBhcnRpYWw8U2hvcFN0b2NrPikge1xuICAgIGNvbnN0IHsgdmFyaWFudElkLCBwcmljZSwgcXVhbnRpdHksIGRhdGUgfSA9IGRhdGFcbiAgICByZXR1cm4gdGhpcy5jcmVhdGU8U2hvcFN0b2NrPignU2hvcFN0b2NrJywge1xuICAgICAgc2hvcElkOiB0aGlzLmxvY2FsU2hvcElkLFxuICAgICAgdmFyaWFudElkLFxuICAgICAgcHJpY2UsXG4gICAgICBxdWFudGl0eSxcbiAgICAgIGRhdGVcbiAgICB9KVxuICB9XG5cbiAgZ2V0VmFyaWFudEluZm9ybWF0aW9uICh2YXJpYW50SWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8e3Byb2R1Y3Q6IFNob3BpZmllZFByb2R1Y3QsIHZhcmlhbnQ6IFNob3BpZmllZFZhcmlhbnR9Pj4ge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmU8VmFyaWFudD4oJ1ZhcmlhbnQnLCB7XG4gICAgICBpZDogdmFyaWFudElkXG4gICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3QgcHJvZHVjdElkID0gcmVzcC5kYXRhLnByb2R1Y3RJZFxuICAgICAgICByZXR1cm4gUHJvbWlzZS5qb2luKFxuICAgICAgICAgIHN1cGVyLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgICAgICAgYFNFTEVDVCAqIEZST00gc2hvcGlmaWVkVmFyaWFudHNWaWV3IFdIRVJFIGlkID0gJHt2YXJpYW50SWR9IEFORCBzaG9wSWQ9JHt0aGlzLmxvY2FsU2hvcElkfWAsXG4gICAgICAgICAgICB7IHR5cGU6IHN1cGVyLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLFxuICAgICAgICAgIHN1cGVyLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgICAgICAgYFNFTEVDVCAqIEZST00gc2hvcGlmaWVkUHJvZHVjdHNWaWV3IFdIRVJFIGlkID0gJHtwcm9kdWN0SWR9IEFORCBzaG9wSWQ9JHt0aGlzLmxvY2FsU2hvcElkfWAsXG4gICAgICAgICAgICB7IHR5cGU6IHN1cGVyLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pXG4gICAgICAgICkuc3ByZWFkKChyYXdWYXJpYW50LCByYXdQcm9kdWN0KSA9PiB7XG4gICAgICAgICAgaWYgKHJhd1ZhcmlhbnQgJiYgcmF3UHJvZHVjdCkge1xuICAgICAgICAgICAgY29uc3QgdmFyaWFudCA9IFV0aWxzLm9iamVjdGlmeShyYXdWYXJpYW50KVswXVxuICAgICAgICAgICAgY29uc3QgcHJvZHVjdCA9IFV0aWxzLm9iamVjdGlmeShyYXdQcm9kdWN0KVswXVxuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHZhcmlhbnQsIHByb2R1Y3QgfSB9XG4gICAgICAgICAgfSBlbHNlIGlmICghcmF3VmFyaWFudCkge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYHZhcmlhbnRJZD0ke3ZhcmlhbnRJZH0gaXMgbm90IGZvdW5kIWAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgcHJvZHVjdElkPSR7cHJvZHVjdElkfSBpcyBub3QgZm91bmQhYCB9XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3ZhcmlhbnRJZD0nICsgdmFyaWFudElkICsgJyBpcyBub3QgZm91bmQhJyB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFZhcmlhbnRQcmljZSAodmFyaWFudElkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPFZhcmlhbnQ+KCdWYXJpYW50Jywge1xuICAgICAgaWQ6IHZhcmlhbnRJZFxuICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IHJlc3AuZGF0YS5wcm9kdWN0SWRcbiAgICAgICAgcmV0dXJuIHN1cGVyLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgICAgIGBTRUxFQ1Qgc2hvcFByaWNlIEZST00gc2hvcGlmaWVkUHJvZHVjdHNWaWV3IFdIRVJFIGlkID0gJHtwcm9kdWN0SWR9IEFORCBzaG9wSWQgPSAke3RoaXMuZ2V0TG9jYWxTaG9wSWQoKX1gLFxuICAgICAgICAgIHsgdHlwZTogc3VwZXIuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBjb25zdCBzaG9waWZpZWRQcm9kdWN0ID0gcmVzdWx0WzBdXG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogc2hvcGlmaWVkUHJvZHVjdC5zaG9wUHJpY2UgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3Byb2R1Y3RJZD0nICsgcHJvZHVjdElkICsgJyBpcyBub3QgZm91bmQhJyB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICd2YXJpYW50SWQ9JyArIHZhcmlhbnRJZCArICcgaXMgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRQcm9kdWN0QXZhaWxhYmlsaXR5IChwcm9kdWN0SWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxQcm9kdWN0QXZhaWxhYmlsaXR5Pj4ge1xuICAgIHJldHVybiBQcm9taXNlLmpvaW48TkNSZXNwb25zZTxhbnk+PihcbiAgICAgIHRoaXMuZ2V0SW5TdG9ja1Byb2R1Y3QocHJvZHVjdElkKSxcbiAgICAgIHRoaXMuZ2V0UE9Qcm9kdWN0KHByb2R1Y3RJZClcbiAgICApLnNwcmVhZCgocmVzcDE6IE5DUmVzcG9uc2U8SW5TdG9ja1Byb2R1Y3Q+LCByZXNwMjogTkNSZXNwb25zZTxQT1Byb2R1Y3Q+KSA9PiB7XG4gICAgICBsZXQgYXZhaWxhYmlsaXR5OiBQcm9kdWN0QXZhaWxhYmlsaXR5ID0ge1xuICAgICAgICBzdGF0dXM6ICdyZWFkeVN0b2NrJ1xuICAgICAgfVxuICAgICAgaWYgKHJlc3AxLnN0YXR1cyAmJiByZXNwMS5kYXRhKSB7XG4gICAgICAgIGF2YWlsYWJpbGl0eS5zdGF0dXMgPSAncmVhZHlTdG9jaydcbiAgICAgICAgYXZhaWxhYmlsaXR5LnF1YW50aXR5ID0gcmVzcDEuZGF0YS5zdG9ja1F1YW50aXR5XG4gICAgICB9IGVsc2UgaWYgKHJlc3AyLnN0YXR1cykge1xuICAgICAgICBhdmFpbGFiaWxpdHkuc3RhdHVzID0gJ3ByZU9yZGVyJ1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcDEuZXJyTWVzc2FnZSB8fCByZXNwMi5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogYXZhaWxhYmlsaXR5IH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0VmFyaWFudEF2YWlsYWJpbGl0eSAodmFyaWFudElkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8UHJvZHVjdEF2YWlsYWJpbGl0eT4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPFZhcmlhbnQ+KCdWYXJpYW50Jywge1xuICAgICAgaWQ6IHZhcmlhbnRJZFxuICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IHJlc3AuZGF0YS5wcm9kdWN0SWRcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHJvZHVjdEF2YWlsYWJpbGl0eShwcm9kdWN0SWQpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRQcm9tb3Rpb24gKCk6IFByb21pc2U8TkNSZXNwb25zZTxTaG9waWZpZWRQcm9tb3Rpb25bXT4+IHtcbiAgICByZXR1cm4gU2hvcFNlcnZpY2UuZ2V0UHJvbW90aW9uKHRoaXMuZ2V0TG9jYWxTaG9wSWQoKSlcbiAgfVxuXG4gIGNyZWF0ZVByb21vdGlvbiAocHJvZHVjdElkOiBudW1iZXIsIGRhdGE6IFBhcnRpYWw8UHJvbW90aW9uPik6IFByb21pc2U8TkNSZXNwb25zZTxQcm9tb3Rpb24+PiB7XG4gICAgaWYgKHByb2R1Y3RJZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLmNyZWF0ZTxQcm9tb3Rpb24+KCdQcm9tb3Rpb24nLCBPYmplY3QuYXNzaWduKHsgc2hvcElkOiB0aGlzLmdldExvY2FsU2hvcElkKCksIHByb2R1Y3RJZCB9LCBkYXRhKSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdwcm9kdWN0SWQgaXMgcmVxdWlyZWQhJyB9KVxuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVByb21vdGlvbiAocHJvZHVjdElkOiBudW1iZXIsIHByb21vdGlvbklkOiBudW1iZXIsIGRhdGE6IFBhcnRpYWw8UHJvbW90aW9uPik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgaWYgKGRhdGEuaWQpIHtcbiAgICAgIHJldHVybiBzdXBlci51cGRhdGU8UHJvbW90aW9uPignUHJvbW90aW9uJyxcbiAgICAgICAgICBPYmplY3QuYXNzaWduKHsgc2hvcElkOiB0aGlzLmdldExvY2FsU2hvcElkKCksIHByb2R1Y3RJZCB9LCBkYXRhKSwgeyBpZDogcHJvbW90aW9uSWQgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdwcm9tb3Rpb25JZCBpcyByZXF1aXJlZCEnIH0pXG4gICAgfVxuICB9XG5cbiAgZGVsZXRlUHJvbW90aW9uIChwcm9tb3Rpb25JZDogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICBpZiAocHJvbW90aW9uSWQpIHtcbiAgICAgIHJldHVybiBzdXBlci5kZWxldGU8UHJvbW90aW9uPignUHJvbW90aW9uJywgeyBpZDogcHJvbW90aW9uSWQgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdwcm9tb2l0b25JZCBpcyByZXF1aXJlZCEnIH0pXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBMb2NhbFNob3BTZXJ2aWNlKClcbiJdfQ==
