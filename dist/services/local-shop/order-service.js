"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),moment=require("moment"),app_config_1=require("../../app-config"),crud_service_1=require("../crud-service"),local_shop_service_1=require("../local-shop-service"),order_service_1=require("../order-service"),print_service_1=require("../print-service");class LocalOrderService extends crud_service_1.default{constructor(){super(),this.receiptPrinter=new print_service_1.default(app_config_1.default.RECEIPT_PRINTER.DEVICE_NAME,app_config_1.default.RECEIPT_PRINTER.PAPER_WIDTH)}getOrders(){return order_service_1.default.getOrders(local_shop_service_1.default.getLocalShopId())}getOpenOrders(){return this.getSequelize().query(`SELECT * FROM ordersView WHERE shopId = ${local_shop_service_1.default.getLocalShopId()} AND status != 'Close' AND status != 'Cancelled'`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getClosedOrders(){return this.getSequelize().query(`SELECT * FROM ordersView WHERE shopId = ${local_shop_service_1.default.getLocalShopId()} AND status = 'Close' OR status = 'Cancelled'`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getOrderDetails(e){return order_service_1.default.getOrderDetails(e)}addOrder(e){return super.create("Order",Object.assign(e,{status:"Open",shopId:local_shop_service_1.default.getLocalShopId()}))}editOrder(e){const r={fullName:e.fullName,phoneNumber:e.phoneNumber,notes:e.notes};return e.id?super.readOne("Order",{id:e.id}).then(t=>t.status&&t.data?"Open"!==t.data.status?{status:!1,errMessage:"Only open order can be editted!"}:e.fullName?super.update("Order",r,{id:e.id}):Promise.resolve({status:!1,errMssage:"fullName is required!"}):{status:!1,errMessage:"Order is not found!"}):Promise.resolve({status:!1,errMessage:"Order is required!"})}cancelOrder(e){return super.readOne("Order",{id:e}).then(r=>r.status&&r.data?"Open"!==r.data.status?{status:!1,errMessage:"Only open order can be cancelled!"}:super.update("Order",{status:"Cancelled"},{id:e}):{status:!1,errMessage:"Order is not found!"})}closeOrder(e){return super.readOne("Order",{id:e}).then(r=>r.status&&r.data?"Open"===r.data.status?super.read("OrderDetail",{orderId:e}).then(r=>{if(r.status){if(r.data){const t=r.data;let s=!1;return t.forEach(e=>{"PO"===e.status&&(s=!0)}),super.update("Order",{status:s?"PO":"Close"},{id:e})}return{status:!1,errMessage:"Order is empty!"}}return{status:!1,errMessage:r.errMessage}}):(console.log("status="+JSON.stringify(r.data)),{status:!1,errMessage:"Only open order can be closed!"}):{status:!1,errMessage:"Order is not found!"})}finishPOOrder(e){return super.readOne("Order",{id:e}).then(r=>{if(r.status&&r.data){return"PO"===r.data.status?super.update("Order",{status:"Close"},{id:e}):{status:!1,errMessage:"Only PO order can be finished!"}}return{status:!1,errMessage:"Order is not found!"}})}isOpenOrder(e){return super.readOne("Order",{id:e}).then(e=>e.status&&e.data?"Open"===e.data.status?{status:!0}:{status:!1,errMessage:"Order is not of 'Open' status!"}:{status:!1,errMessage:"Order not found!"})}addOrderDetail(e,r,t){return t<=0?Promise.resolve({status:!1,errMessage:"Quantity needs to be a positive number!"}):this.isOpenOrder(e).then(s=>s.status?Promise.join(local_shop_service_1.default.getVariantAvailability(r),local_shop_service_1.default.getVariantInformation(r)).spread((s,a)=>{if(s.status&&s.data&&a.status&&a.data){const d=s.data;if("readyStock"===d.status&&t>(d.quantity||0))return{status:!1,errMessage:`Only ${d.quantity} ready stock(s) left!`};const u=a.data.product.shopPrice,i="preOrder"===d.status?"PO":"Ready";return super.create("OrderDetail",{variantId:r,orderId:e,status:i,quantity:t,price:u})}return{status:!1,errMessage:"Failed to get variant information: "+s.errMessage||a.errMessage}}):{status:!1,errMessage:s.errMessage})}editOrderDetail(e,r,t){}deleteOrderDetail(e){return e?super.readOne("OrderDetail",{id:e}).then(r=>{if(r.status&&r.data){const t=r.data.orderId;return this.isOpenOrder(t).then(r=>r.status?super.delete("OrderDetail",{id:e}):{status:!1,errMessage:r.errMessage})}return{status:!1,errMessage:r.errMessage}}):Promise.resolve({status:!1,errMessage:"orderDetailId is reuqired!"})}printReceipt(e,r=1){return Promise.resolve(this.receiptPrinter.printURL(e,r).then(e=>e.status?{status:!0}:{status:!1,errMessage:e.errMessage}))}getReceipt(e){return e?order_service_1.default.getOrder(e).then(r=>{if(r.status&&r.data){const t=r.data;if("Close"===t.status||"PO"===t.status){let s={orderId:t.id,fullName:t.fullName,phoneNumber:t.phoneNumber,status:t.status,totalPrice:t.price,poDuration:void 0,orderDate:moment(r.data.updatedAt).format("DD-MM-YY HH:mm"),printDate:moment().format("DD-MM-YY HH:mm"),items:[]};return this.getOrderDetails(e).then(e=>e.status&&e.data?(e.data.forEach(e=>{s.items.push({name:e.productName,status:e.status,variant:e.variantName,price:e.price,quantity:e.quantity}),"PO"===e.status&&(s.poDuration?s.poDuration=Math.max(s.poDuration,e.preOrderDuration):s.poDuration=e.preOrderDuration)}),{status:!0,data:s}):{status:!1,errMessage:"Order is empty!"})}return{status:!1,errMessage:"Only closed or PO order can be printed!"}}return{status:!1,errMessage:"Order is not found!"}}):Promise.resolve({status:!1,errMessage:"orderId is required!"})}}exports.default=new LocalOrderService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9sb2NhbC1zaG9wL29yZGVyLXNlcnZpY2UudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJtb21lbnQiLCJhcHBfY29uZmlnXzEiLCJjcnVkX3NlcnZpY2VfMSIsImxvY2FsX3Nob3Bfc2VydmljZV8xIiwib3JkZXJfc2VydmljZV8xIiwicHJpbnRfc2VydmljZV8xIiwiTG9jYWxPcmRlclNlcnZpY2UiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwic3VwZXIiLCJ0aGlzIiwicmVjZWlwdFByaW50ZXIiLCJSRUNFSVBUX1BSSU5URVIiLCJERVZJQ0VfTkFNRSIsIlBBUEVSX1dJRFRIIiwiZ2V0T3JkZXJzIiwiZ2V0TG9jYWxTaG9wSWQiLCJnZXRTZXF1ZWxpemUiLCJxdWVyeSIsInR5cGUiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwidGhlbiIsInJlc3VsdCIsInN0YXR1cyIsImRhdGEiLCJvcmRlcklkIiwiZ2V0T3JkZXJEZXRhaWxzIiwiY3JlYXRlIiwiT2JqZWN0IiwiYXNzaWduIiwic2hvcElkIiwiZWRpdHRhYmxlRGF0YSIsImZ1bGxOYW1lIiwicGhvbmVOdW1iZXIiLCJub3RlcyIsImlkIiwicmVhZE9uZSIsInJlc3AiLCJlcnJNZXNzYWdlIiwidXBkYXRlIiwicmVzb2x2ZSIsImVyck1zc2FnZSIsInJlYWQiLCJyZXNwMiIsIm9yZGVyRGV0YWlscyIsImlzUE8iLCJmb3JFYWNoIiwib3JkZXJEZXRhaWwiLCJjb25zb2xlIiwibG9nIiwiSlNPTiIsInN0cmluZ2lmeSIsInZhcmlhbnRJZCIsInF1YW50aXR5IiwiaXNPcGVuT3JkZXIiLCJqb2luIiwiZ2V0VmFyaWFudEF2YWlsYWJpbGl0eSIsImdldFZhcmlhbnRJbmZvcm1hdGlvbiIsInNwcmVhZCIsInJlc3AzIiwiYXZhaWxhYmlsaXR5IiwicHJpY2UiLCJwcm9kdWN0Iiwic2hvcFByaWNlIiwib3JkZXJEZXRhaWxTdGF0dXMiLCJvcmRlckRldGFpbElkIiwiZGVsZXRlIiwiZnVsbFVSTCIsIm51bUNvcGllcyIsInByaW50VVJMIiwiZ2V0T3JkZXIiLCJvcmRlciIsInJlY2VpcHQiLCJ0b3RhbFByaWNlIiwicG9EdXJhdGlvbiIsInVuZGVmaW5lZCIsIm9yZGVyRGF0ZSIsInVwZGF0ZWRBdCIsImZvcm1hdCIsInByaW50RGF0ZSIsIml0ZW1zIiwicHVzaCIsIm5hbWUiLCJwcm9kdWN0TmFtZSIsInZhcmlhbnQiLCJ2YXJpYW50TmFtZSIsIk1hdGgiLCJtYXgiLCJwcmVPcmRlckR1cmF0aW9uIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUVBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsT0FBQUQsUUFBQSxVQUVBRSxhQUFBRixRQUFBLG9CQUNBRyxlQUFBSCxRQUFBLG1CQUNBSSxxQkFBQUosUUFBQSx5QkFDQUssZ0JBQUFMLFFBQUEsb0JBQ0FNLGdCQUFBTixRQUFBLDBCQWdDQU8sMEJBQWdDSixlQUFBSyxRQUU5QkMsY0FDRUMsUUFDQUMsS0FBS0MsZUFBaUIsSUFBSU4sZ0JBQUFFLFFBQWFOLGFBQUFNLFFBQVVLLGdCQUFnQkMsWUFBYVosYUFBQU0sUUFBVUssZ0JBQWdCRSxhQUcxR04sWUFDRSxPQUFPSixnQkFBQUcsUUFBYVEsVUFBVVoscUJBQUFJLFFBQWlCUyxrQkFHakRSLGdCQUNFLE9BQU9FLEtBQUtPLGVBQWVDLGlEQUNZZixxQkFBQUksUUFBaUJTLG9FQUNwREcsS0FBTVQsS0FBS08sZUFBZUcsV0FBV0MsU0FBVUMsS0FBS0MsR0FDaERBLEdBQ09DLFFBQVEsRUFBTUMsS0FBTUYsSUFFcEJDLFFBQVEsSUFLekJoQixrQkFDRSxPQUFPRSxLQUFLTyxlQUFlQyxpREFDWWYscUJBQUFJLFFBQWlCUyxpRUFDcERHLEtBQU1ULEtBQUtPLGVBQWVHLFdBQVdDLFNBQVVDLEtBQUtDLEdBQ2hEQSxHQUNPQyxRQUFRLEVBQU1DLEtBQU1GLElBRXBCQyxRQUFRLElBS3pCaEIsZ0JBQWlCa0IsR0FDZixPQUFPdEIsZ0JBQUFHLFFBQWFvQixnQkFB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V0FBWSx5QkFJakN6QyxRQUFRMkMsU0FBVWpCLFFBQVEsRUFBT2UsV0FBWSwwQkFLMURtRCxRQUFBbkYsUUFBZSxJQUFJRCIsImZpbGUiOiJzZXJ2aWNlcy9sb2NhbC1zaG9wL29yZGVyLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gJ3V0aWwnXG5cbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgeyBNb2RlbCB9IGZyb20gJ3NlcXVlbGl6ZSdcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQnXG5cbmltcG9ydCBBcHBDb25maWcgZnJvbSAnLi4vLi4vYXBwLWNvbmZpZydcbmltcG9ydCBDUlVEU2VydmljZSBmcm9tICcuLi9jcnVkLXNlcnZpY2UnXG5pbXBvcnQgTG9jYWxTaG9wU2VydmljZSBmcm9tICcuLi9sb2NhbC1zaG9wLXNlcnZpY2UnXG5pbXBvcnQgT3JkZXJTZXJ2aWNlIGZyb20gJy4uL29yZGVyLXNlcnZpY2UnXG5pbXBvcnQgUHJpbnRTZXJ2aWNlIGZyb20gJy4uL3ByaW50LXNlcnZpY2UnXG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvZHVjdEF2YWlsYWJpbGl0eSB7XG4gIHN0YXR1czogJ3JlYWR5U3RvY2snIHwgJ3ByZU9yZGVyJyB8ICd1bmF2YWlsYWJsZSdcbiAgcXVhbnRpdHk/OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPcmRlclJlY2VpcHQge1xuICBvcmRlcklkOiBudW1iZXJcbiAgZnVsbE5hbWU6IHN0cmluZ1xuICBwaG9uZU51bWJlcjogc3RyaW5nXG4gIHN0YXR1czogJ0Nsb3NlJyB8ICdQTycgfCAnT3BlbicgfCAnQ2FuY2VsbGVkJ1xuICB0b3RhbFByaWNlOiBudW1iZXJcbiAgcG9EdXJhdGlvbj86IG51bWJlclxuICBvcmRlckRhdGU6IHN0cmluZ1xuICBwcmludERhdGU6IHN0cmluZ1xuICBpdGVtczoge1xuICAgIHN0YXR1czogJ1BPJyB8ICdSZWFkeSdcbiAgICBuYW1lOiBzdHJpbmdcbiAgICB2YXJpYW50OiBzdHJpbmdcbiAgICBwcmljZTogbnVtYmVyXG4gICAgcXVhbnRpdHk6IG51bWJlclxuICB9W11cbn1cblxuLypcbiAgVXNlZCBmb3Igc2hvcC1zcGVjaWZpYyBjb2RlLiBUaGlzIHNob3VsZCByZS11c2Ugd2hhdCdzIGluIHNob3Atc2VydmljZSBhcyBtdWNoIGFzIHBvc3NpYmxlLCB0aG91Z2guXG5cbiAgVE9ETzpcbiAgMS4gVXBkYXRlIG9yZGVySGlzdG9yaWVzIHdoZW5ldmVyIGFuIHVwZGF0ZSBpcyBtYWRlIHRvIG9yZGVyIHRhYmxlLCBzbyB0aGF0IHdlIGhhdmUgYmV0dGVyIGlkZWFzIHdoZW5cbiAgICAgYSBwcm9ibGVtIGhhcHBlbnNcbiAqL1xuY2xhc3MgTG9jYWxPcmRlclNlcnZpY2UgZXh0ZW5kcyBDUlVEU2VydmljZSB7XG4gIHByaXZhdGUgcmVjZWlwdFByaW50ZXI6IFByaW50U2VydmljZVxuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMucmVjZWlwdFByaW50ZXIgPSBuZXcgUHJpbnRTZXJ2aWNlKEFwcENvbmZpZy5SRUNFSVBUX1BSSU5URVIuREVWSUNFX05BTUUsIEFwcENvbmZpZy5SRUNFSVBUX1BSSU5URVIuUEFQRVJfV0lEVEgpXG4gIH1cblxuICBnZXRPcmRlcnMgKCkge1xuICAgIHJldHVybiBPcmRlclNlcnZpY2UuZ2V0T3JkZXJzKExvY2FsU2hvcFNlcnZpY2UuZ2V0TG9jYWxTaG9wSWQoKSlcbiAgfVxuXG4gIGdldE9wZW5PcmRlcnMgKCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuYFNFTEVDVCAqIEZST00gb3JkZXJzVmlldyBXSEVSRSBzaG9wSWQgPSAke0xvY2FsU2hvcFNlcnZpY2UuZ2V0TG9jYWxTaG9wSWQoKX0gQU5EIHN0YXR1cyAhPSAnQ2xvc2UnIEFORCBzdGF0dXMgIT0gJ0NhbmNlbGxlZCdgLFxuICAgICAgeyB0eXBlOiB0aGlzLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzdWx0IH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgfVxuXG4gIGdldENsb3NlZE9yZGVycyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoXG5gU0VMRUNUICogRlJPTSBvcmRlcnNWaWV3IFdIRVJFIHNob3BJZCA9ICR7TG9jYWxTaG9wU2VydmljZS5nZXRMb2NhbFNob3BJZCgpfSBBTkQgc3RhdHVzID0gJ0Nsb3NlJyBPUiBzdGF0dXMgPSAnQ2FuY2VsbGVkJ2AsXG4gICAgICB7IHR5cGU6IHRoaXMuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXN1bHQgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UgfVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG5cbiAgZ2V0T3JkZXJEZXRhaWxzIChvcmRlcklkKSB7XG4gICAgcmV0dXJuIE9yZGVyU2VydmljZS5nZXRPcmRlckRldGFpbHMob3JkZXJJZClcbiAgfVxuXG4gIGFkZE9yZGVyIChkYXRhOiBQYXJ0aWFsPE9yZGVyPik6IFByb21pc2U8TkNSZXNwb25zZTxPcmRlcj4+IHtcbiAgICByZXR1cm4gc3VwZXIuY3JlYXRlPE9yZGVyPignT3JkZXInLCBPYmplY3QuYXNzaWduKGRhdGEsIHsgc3RhdHVzOiAnT3BlbicsIHNob3BJZDogTG9jYWxTaG9wU2VydmljZS5nZXRMb2NhbFNob3BJZCgpIH0pKVxuICB9XG5cbiAgZWRpdE9yZGVyIChkYXRhOiBQYXJ0aWFsPE9yZGVyPik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgLy8gTWFrZSBzdXJlIG5vIG90aGVyIGZpZWxkcyBnZXQgZWRpdHRlZCBieSBoYWNrZXJcbiAgICBjb25zdCBlZGl0dGFibGVEYXRhID0ge1xuICAgICAgZnVsbE5hbWU6IGRhdGEuZnVsbE5hbWUsXG4gICAgICBwaG9uZU51bWJlcjogZGF0YS5waG9uZU51bWJlcixcbiAgICAgIG5vdGVzOiBkYXRhLm5vdGVzXG4gICAgfVxuICAgIGlmIChkYXRhLmlkKSB7XG4gICAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlcj4oJ09yZGVyJywgeyBpZDogZGF0YS5pZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgaWYgKHJlc3AuZGF0YS5zdGF0dXMgIT09ICdPcGVuJykge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09ubHkgb3BlbiBvcmRlciBjYW4gYmUgZWRpdHRlZCEnIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGRhdGEuZnVsbE5hbWUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxPcmRlcj4oJ09yZGVyJywgZWRpdHRhYmxlRGF0YSwgeyBpZDogZGF0YS5pZCB9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1zc2FnZTogJ2Z1bGxOYW1lIGlzIHJlcXVpcmVkIScgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPcmRlciBpcyByZXF1aXJlZCEnIH0pXG4gICAgfVxuICB9XG5cbiAgY2FuY2VsT3JkZXIgKG9yZGVySWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8T3JkZXI+KCdPcmRlcicsIHsgaWQ6IG9yZGVySWQgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgaWYgKHJlc3AuZGF0YS5zdGF0dXMgIT09ICdPcGVuJykge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPbmx5IG9wZW4gb3JkZXIgY2FuIGJlIGNhbmNlbGxlZCEnIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gc3VwZXIudXBkYXRlPE9yZGVyPignT3JkZXInLCB7IHN0YXR1czogJ0NhbmNlbGxlZCcgfSwgeyBpZDogb3JkZXJJZCB9KVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvKlxuICAgIDEuIENoZWNrIHdoZXRoZXIgdGhlcmUncyBQTyBvcmRlciBvciBub3QuXG4gICAgMi4gSWYgdGhlcmUncywgc2V0IHN0YXR1cyB0byAnUE8nXG4gICAgMy4gSWYgbm90LCBzZXQgc3RhdHVzIHRvICdGaW5pc2gnXG4gICAqL1xuICBjbG9zZU9yZGVyIChvcmRlcklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIHJldHVybiBzdXBlci5yZWFkT25lPE9yZGVyPignT3JkZXInLCB7IGlkOiBvcmRlcklkIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGlmIChyZXNwLmRhdGEuc3RhdHVzID09PSAnT3BlbicpIHtcbiAgICAgICAgICByZXR1cm4gc3VwZXIucmVhZDxPcmRlckRldGFpbD4oJ09yZGVyRGV0YWlsJywgeyBvcmRlcklkIH0pLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cykge1xuICAgICAgICAgICAgICBpZiAocmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9yZGVyRGV0YWlscyA9IHJlc3AyLmRhdGFcbiAgICAgICAgICAgICAgICBsZXQgaXNQTyA9IGZhbHNlXG4gICAgICAgICAgICAgICAgb3JkZXJEZXRhaWxzLmZvckVhY2gob3JkZXJEZXRhaWwgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKG9yZGVyRGV0YWlsLnN0YXR1cyA9PT0gJ1BPJykge1xuICAgICAgICAgICAgICAgICAgICBpc1BPID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxPcmRlcj4oJ09yZGVyJywgeyBzdGF0dXM6IGlzUE8gPyAnUE8nIDogJ0Nsb3NlJyB9LCB7IGlkOiBvcmRlcklkIH0pXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIGVtcHR5IScgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwMi5lcnJNZXNzYWdlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdzdGF0dXM9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AuZGF0YSkpXG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09ubHkgb3BlbiBvcmRlciBjYW4gYmUgY2xvc2VkIScgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBmaW5pc2hQT09yZGVyIChvcmRlcklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIHJldHVybiBzdXBlci5yZWFkT25lPE9yZGVyPignT3JkZXInLCB7IGlkOiBvcmRlcklkIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IG9yZGVyID0gcmVzcC5kYXRhXG4gICAgICAgIGlmIChvcmRlci5zdGF0dXMgPT09ICdQTycpIHtcbiAgICAgICAgICByZXR1cm4gc3VwZXIudXBkYXRlPE9yZGVyPignT3JkZXInLCB7IHN0YXR1czogJ0Nsb3NlJyB9LCB7IGlkOiBvcmRlcklkIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09ubHkgUE8gb3JkZXIgY2FuIGJlIGZpbmlzaGVkIScgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGlzT3Blbk9yZGVyIChvcmRlcklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVsbD4+IHtcbiAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlcj4oJ09yZGVyJywgeyBpZDogb3JkZXJJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBpZiAocmVzcC5kYXRhLnN0YXR1cyA9PT0gJ09wZW4nKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgbm90IG9mIFxcJ09wZW5cXCcgc3RhdHVzIScgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgbm90IGZvdW5kIScgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBhZGRPcmRlckRldGFpbCAob3JkZXJJZDogbnVtYmVyLCB2YXJpYW50SWQ6IG51bWJlciwgcXVhbnRpdHk6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxPcmRlckRldGFpbD4+IHtcbiAgICAvKlxuICAgICAgMS4gVmFsaWRhdGUgb3JkZXJJZCAtPiB2YWxpZCBvcmRlciB3aG9zZSBzdGF0dXMgaXMgbm90IGNsb3NlZCAvIFBPXG4gICAgICAyLiBWYWxpZGF0ZSB2YXJpYW50SWQgLT4gcHJvZHVjdCB3aXRoIHRoaXMgaWQgZXhpc3RzXG4gICAgICAzLiBWYWxpZGF0ZSBxdWFudGl0eSAtPiBub24tbmVnYXRpdmUsIGFuZCBpZiBzdGF0dXMgaXMgcmVhZHksIHF1YW50aXR5IGRvZXNuJ3QgZXhjZWVkIHdoYXQncyBhdmFpbGFibGVcbiAgICAgKi9cbiAgICBpZiAocXVhbnRpdHkgPD0gMCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdRdWFudGl0eSBuZWVkcyB0byBiZSBhIHBvc2l0aXZlIG51bWJlciEnIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmlzT3Blbk9yZGVyKG9yZGVySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLmpvaW48YW55PihcbiAgICAgICAgICAgIExvY2FsU2hvcFNlcnZpY2UuZ2V0VmFyaWFudEF2YWlsYWJpbGl0eSh2YXJpYW50SWQpLFxuICAgICAgICAgICAgTG9jYWxTaG9wU2VydmljZS5nZXRWYXJpYW50SW5mb3JtYXRpb24odmFyaWFudElkKVxuICAgICAgICAgICkuc3ByZWFkKChyZXNwMjogTkNSZXNwb25zZTxQcm9kdWN0QXZhaWxhYmlsaXR5PixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8e3Byb2R1Y3Q6IFNob3BpZmllZFByb2R1Y3QsIHZhcmlhbnQ6IFNob3BpZmllZFZhcmlhbnR9PikgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmIHJlc3AzLnN0YXR1cyAmJiByZXNwMy5kYXRhKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IHJlc3AyLmRhdGFcbiAgICAgICAgICAgICAgaWYgKGF2YWlsYWJpbGl0eS5zdGF0dXMgPT09ICdyZWFkeVN0b2NrJyAmJiBxdWFudGl0eSA+IChhdmFpbGFiaWxpdHkucXVhbnRpdHkgfHwgMCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgT25seSAke2F2YWlsYWJpbGl0eS5xdWFudGl0eX0gcmVhZHkgc3RvY2socykgbGVmdCFgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBwcmljZSA9IHJlc3AzLmRhdGEucHJvZHVjdC5zaG9wUHJpY2VcbiAgICAgICAgICAgICAgY29uc3Qgb3JkZXJEZXRhaWxTdGF0dXMgPSBhdmFpbGFiaWxpdHkuc3RhdHVzID09PSAncHJlT3JkZXInID8gJ1BPJyA6ICdSZWFkeSdcbiAgICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmNyZWF0ZTxPcmRlckRldGFpbD4oJ09yZGVyRGV0YWlsJywgeyB2YXJpYW50SWQsIG9yZGVySWQsIHN0YXR1czogb3JkZXJEZXRhaWxTdGF0dXMsIHF1YW50aXR5LCBwcmljZSB9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0ZhaWxlZCB0byBnZXQgdmFyaWFudCBpbmZvcm1hdGlvbjogJyArIHJlc3AyLmVyck1lc3NhZ2UgfHwgcmVzcDMuZXJyTWVzc2FnZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGVkaXRPcmRlckRldGFpbCAob3JkZXJEZXRhaWxJZDogbnVtYmVyLCB2YXJpYW50SWQ6IG51bWJlciwgcXVhbnRpdHk6IG51bWJlcikge1xuICAgIC8vIFRPRE86IFRvIG1ha2UgdGhpbmdzIGVhc3ksIHdlIGRvbid0IGN1cnJlbnRseSBpbXBsZW1lbnQgZWRpdFxuICAgIC8vICAgICAgIFRoZSBsb2dpYyBpcyBtb3JlIGNvbXBsZXggdGhhbiBhZGRPcmRlckRldGFpbCBiZWNhdXNlIHdlIG5lZWQgdG9cbiAgICAvLyAgICAgICB0YWtlIGludG8gYWNjb3VudCB0aGUgZGVsdGEgc3RvY2tcbiAgfVxuXG4gIGRlbGV0ZU9yZGVyRGV0YWlsIChvcmRlckRldGFpbElkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIGlmIChvcmRlckRldGFpbElkKSB7XG4gICAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxPcmRlckRldGFpbD4oJ09yZGVyRGV0YWlsJywgeyBpZDogb3JkZXJEZXRhaWxJZCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb3JkZXJJZCA9IHJlc3AuZGF0YS5vcmRlcklkXG4gICAgICAgICAgcmV0dXJuIHRoaXMuaXNPcGVuT3JkZXIob3JkZXJJZCkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgICAgIHJldHVybiBzdXBlci5kZWxldGU8T3JkZXJEZXRhaWw+KCdPcmRlckRldGFpbCcsIHsgaWQ6IG9yZGVyRGV0YWlsSWQgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AyLmVyck1lc3NhZ2UgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdvcmRlckRldGFpbElkIGlzIHJldXFpcmVkIScgfSlcbiAgICB9XG4gIH1cblxuICAvLyBmdWxsVVJMOiBub24tcmVsYXRpdmUgVVJMIHRvIGdldCBIVE1MIHZlcnNpb24gb2YgdGhlIHJlY2VpcHRcbiAgcHJpbnRSZWNlaXB0IChmdWxsVVJMOiBzdHJpbmcsIG51bUNvcGllczogbnVtYmVyID0gMSk6IFByb21pc2U8TkNSZXNwb25zZTxudWxsPj4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5yZWNlaXB0UHJpbnRlci5wcmludFVSTChmdWxsVVJMLCBudW1Db3BpZXMpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSkpXG4gIH1cblxuICBnZXRSZWNlaXB0IChvcmRlcklkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8T3JkZXJSZWNlaXB0Pj4ge1xuICAgIGlmIChvcmRlcklkKSB7XG4gICAgICByZXR1cm4gT3JkZXJTZXJ2aWNlLmdldE9yZGVyKG9yZGVySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICBjb25zdCBvcmRlciA9IHJlc3AuZGF0YVxuICAgICAgICAgIGlmIChvcmRlci5zdGF0dXMgPT09ICdDbG9zZScgfHwgb3JkZXIuc3RhdHVzID09PSAnUE8nKSB7XG4gICAgICAgICAgICBsZXQgcmVjZWlwdDogT3JkZXJSZWNlaXB0ID0ge1xuICAgICAgICAgICAgICBvcmRlcklkOiBvcmRlci5pZCxcbiAgICAgICAgICAgICAgZnVsbE5hbWU6IG9yZGVyLmZ1bGxOYW1lLFxuICAgICAgICAgICAgICBwaG9uZU51bWJlcjogb3JkZXIucGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgIHN0YXR1czogb3JkZXIuc3RhdHVzLFxuICAgICAgICAgICAgICB0b3RhbFByaWNlOiBvcmRlci5wcmljZSxcbiAgICAgICAgICAgICAgcG9EdXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICBvcmRlckRhdGU6IG1vbWVudChyZXNwLmRhdGEudXBkYXRlZEF0KS5mb3JtYXQoJ0RELU1NLVlZIEhIOm1tJyksXG4gICAgICAgICAgICAgIHByaW50RGF0ZTogbW9tZW50KCkuZm9ybWF0KCdERC1NTS1ZWSBISDptbScpLFxuICAgICAgICAgICAgICBpdGVtczogW11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE9yZGVyRGV0YWlscyhvcmRlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgICAgICAgcmVzcC5kYXRhLmZvckVhY2gob3JkZXJEZXRhaWwgPT4ge1xuICAgICAgICAgICAgICAgICAgcmVjZWlwdC5pdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogb3JkZXJEZXRhaWwucHJvZHVjdE5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogb3JkZXJEZXRhaWwuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICB2YXJpYW50OiBvcmRlckRldGFpbC52YXJpYW50TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcHJpY2U6IG9yZGVyRGV0YWlsLnByaWNlLFxuICAgICAgICAgICAgICAgICAgICBxdWFudGl0eTogb3JkZXJEZXRhaWwucXVhbnRpdHlcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICBpZiAob3JkZXJEZXRhaWwuc3RhdHVzID09PSAnUE8nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVjZWlwdC5wb0R1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVjZWlwdC5wb0R1cmF0aW9uID0gb3JkZXJEZXRhaWwucHJlT3JkZXJEdXJhdGlvblxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgIHJlY2VpcHQucG9EdXJhdGlvbiA9IE1hdGgubWF4KHJlY2VpcHQucG9EdXJhdGlvbiwgb3JkZXJEZXRhaWwucHJlT3JkZXJEdXJhdGlvbilcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZWNlaXB0IH1cbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnT3JkZXIgaXMgZW1wdHkhJyB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdPbmx5IGNsb3NlZCBvciBQTyBvcmRlciBjYW4gYmUgcHJpbnRlZCEnIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ09yZGVyIGlzIG5vdCBmb3VuZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdvcmRlcklkIGlzIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IExvY2FsT3JkZXJTZXJ2aWNlKClcbiJdfQ==
