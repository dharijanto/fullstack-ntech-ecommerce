"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),crud_service_1=require("./crud-service"),Utils=require("../libs/utils");class ShopService extends crud_service_1.CRUDService{getShops(){return this.read("Shop",{}).then(e=>e)}getShopifiedProducts(e,t=!1,r={},i={}){return this.getSequelize().query(`SELECT * FROM shopifiedProductsView WHERE shopId = ${e}`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getInStockProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:i=null,subCategoryId:s=null},a){if(null!==r&&!Utils.isNumber(r))return Promise.reject("productId has to be number!");if(null!==i&&!Utils.isNumber(i))return Promise.reject("categoryId has to be number!");if(null!==s&&!Utils.isNumber(s))return Promise.reject("subCategoryId has to be number!");const o=`\n      SELECT\n        inStockProductsView.id as id,\n        inStockProductsView.shopId as shopId,\n        inStockProductsView.name as name,\n        inStockProductsView.description as description,\n        inStockProductsView.warranty as warranty,\n        inStockProductsView.price as price,\n        inStockProductsView.stockQuantity as stockQuantity,\n        inStockProductsView.updatedAt as updatedAt,\n        primaryImages.imageFilename as \`primaryImage.imageFilename\`,\n        primaryImages.productId as \`primaryImage.productId\`,\n        productImages.imageFilename as \`images.imageFilename\`,\n        productImages.productId as \`images.productId\`,\n        subCategories.id as \`subCategory.id\`,\n        subCategories.name as \`subCategory.name\`,\n        subCategories.description as \`subCategory.description\`,\n        subCategories.categoryId as \`subCategory.categoryId\`,\n        subCategories.imageFilename as \`subCategory.imageFilename\`,\n        categories.id as \`subCategory.category.id\`,\n        categories.name as \`subCategory.category.name\`,\n        categories.description as \`subCategory.category.description\`,\n        inStockVariantsView.id as \`variants.id\`,\n        inStockVariantsView.shopId as \`variants.shopId\`,\n        inStockVariantsView.productId as \`variants.productId\`,\n        inStockVariantsView.name as \`variants.name\`,\n        inStockVariantsView.stockQuantity as \`variants.stockQuantity\`\n    FROM (SELECT *\n          FROM inStockProductsView\n          WHERE inStockProductsView.shopId = ${a}\n                ${r?"AND inStockProductsView.id ="+r:""}\n                ${s?" AND inStockProductsView.subCategoryId ="+s:""}\n                ${i?" AND inStockProductsView.categoryId = "+i:""}\n          LIMIT ${e*t}, ${e}\n         ) as inStockProductsView\n    LEFT OUTER JOIN productImages ON inStockProductsView.id = productImages.productId\n    LEFT OUTER JOIN\n      (SELECT * FROM productImages WHERE \`primary\` = TRUE) as primaryImages ON inStockProductsView.id = primaryImages.productId\n    INNER JOIN subCategories ON subCategories.id = inStockProductsView.subCategoryId\n    INNER JOIN categories ON subCategories.categoryId = categories.id\n    LEFT OUTER JOIN inStockVariantsView ON inStockVariantsView.productId = inStockProductsView.id AND inStockVariantsView.shopId = ${a}\n    ORDER BY inStockProductsView.id;`,n=`\n      SELECT COUNT(*) AS count\n        FROM (SELECT *\n              FROM inStockProductsView\n              WHERE inStockProductsView.shopId = ${a}\n                    ${r?"AND inStockProductsView.id ="+r:""}\n                    ${s?" AND inStockProductsView.subCategoryId ="+s:""}\n                    ${i?" AND inStockProductsView.categoryId = "+i:""}\n              ) as inStockProductsView;`;return Promise.join(this.getSequelize().query(o,{type:this.getSequelize().QueryTypes.SELECT,nest:!1}),this.getSequelize().query(n,{type:this.getSequelize().QueryTypes.SELECT,nest:!1})).spread((e,t)=>{return{status:!0,data:{products:Utils.objectify(e).map(e=>(e.subCategory=e.subCategory[0],e.subCategory.category=e.subCategory.category[0],e.primaryImage=e.primaryImage[0],e)),totalProducts:t[0].count}}})}getPOProducts({pageSize:e=10,pageIndex:t=0,productId:r=null,categoryId:i=null,subCategoryId:s=null},a){if(null!==r&&!Utils.isNumber(r))return Promise.reject("productId has to be number!");if(null!==i&&!Utils.isNumber(i))return Promise.reject("categoryId has to be number!");if(null!==s&&!Utils.isNumber(s))return Promise.reject("subCategoryId has to be number!");const o=`\n      SELECT\n        poProductsView.id as id,\n        poProductsView.shopId as shopId,\n        poProductsView.name as name,\n        poProductsView.description as description,\n        poProductsView.warranty as warranty,\n        poProductsView.price as price,\n        poProductsView.preOrderDuration as preOrderDuration,\n        poProductsView.updatedAt as updatedAt,\n        primaryImages.imageFilename as \`primaryImage.imageFilename\`,\n        primaryImages.productId as \`primaryImage.productId\`,\n        productImages.imageFilename as \`images.imageFilename\`,\n        # productImages.productId as \`images.productId\`,\n        productImages.primary as \`images.primary\`,\n        subCategories.id as \`subCategory.id\`,\n        subCategories.name as \`subCategory.name\`,\n        subCategories.description as \`subCategory.description\`,\n        subCategories.categoryId as \`subCategory.categoryId\`,\n        subCategories.imageFilename as \`subCategory.imageFilename\`,\n        categories.id as \`subCategory.category.id\`,\n        categories.name as \`subCategory.category.name\`,\n        categories.description as \`subCategory.category.description\`,\n        poVariantsView.id as \`variants.id\`,\n        poVariantsView.shopId as \`variants.shopId\`,\n        poVariantsView.productId as \`variants.productId\`,\n        poVariantsView.name as \`variants.name\`,\n        poVariantsView.supplierCount as \`variants.supplierCount\`\n      FROM (SELECT *\n        FROM poProductsView\n        WHERE poProductsView.shopId = ${a}\n              ${r?"AND poProductsView.id ="+r:""}\n              ${s?"AND poProductsView.subCategoryId ="+s:""}\n              ${i?" AND poProductsView.categoryId = "+i:""}\n        LIMIT ${e*t}, ${e}\n        ) as poProductsView\n      LEFT OUTER JOIN\n        (SELECT * FROM productImages WHERE \`primary\` = TRUE) as primaryImages ON poProductsView.id = primaryImages.productId\n      LEFT OUTER JOIN productImages on poProductsView.id = productImages.productId\n      INNER JOIN subCategories on subCategories.id = poProductsView.subCategoryId\n      INNER JOIN categories on subCategories.categoryId = categories.id\n      LEFT OUTER JOIN poVariantsView ON poVariantsView.productId = poProductsView.id AND poVariantsView.shopId = ${a}\n      ORDER BY poProductsView.id;`,n=`\n      SELECT COUNT(*) AS count FROM\n        (SELECT *\n          FROM poProductsView\n          WHERE poProductsView.shopId = ${a}\n                ${r?"AND poProductsView.id ="+r:""}\n                ${s?"AND poProductsView.subCategoryId ="+s:""}\n                ${i?" AND poProductsView.categoryId = "+i:""}\n          ) as poProductsView`;return Promise.join(this.getSequelize().query(o,{type:this.getSequelize().QueryTypes.SELECT,nest:!1}),this.getSequelize().query(n,{type:this.getSequelize().QueryTypes.SELECT})).spread((e,t)=>{return{status:!0,data:{products:Utils.objectify(e).map(e=>(e.subCategory=e.subCategory[0],e.subCategory.category=e.subCategory.category[0],e.primaryImage=e.primaryImage[0],e)),totalProducts:t[0].count}}})}getShopifiedVariants(e,t){return this.getSequelize().query(`SELECT * FROM shopifiedVariantsView WHERE shopId = ${e} AND productId =${t}`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>e?{status:!0,data:e}:{status:!1})}getShopStock(e,t={}){return this.getModels("ShopStock").findAll({where:Object.assign({},t,{shopId:e}),include:[{model:this.getModels("Variant"),include:[{model:this.getModels("Product")}]}]}).then(e=>({status:!0,data:e}))}getSupplierStock(e){return this.getModels("SupplierStock").findAll({where:{supplierId:e},include:[{model:this.getModels("Variant"),required:!0,include:[{model:this.getModels("Product"),required:!0}]}]}).then(e=>({status:!0,data:e})).catch(this.errHandler)}addSupplierStock({supplierId:e,variantId:t,price:r}){return this.create("SupplierStock",{supplierId:e,variantId:t,price:r})}getPromotion(e){return super.rawReadQuery(`SELECT * FROM shopifiedPromotionsView WHERE shopId = ${e}`)}}exports.default=new ShopService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9zaG9wLXNlcnZpY2UudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJjcnVkX3NlcnZpY2VfMSIsIlV0aWxzIiwiU2hvcFNlcnZpY2UiLCJDUlVEU2VydmljZSIsIltvYmplY3QgT2JqZWN0XSIsInRoaXMiLCJyZWFkIiwidGhlbiIsInJlc3AiLCJzaG9wSWQiLCJwcmltYXJ5SW1hZ2VzT25seSIsInByb2R1Y3RTZWFyY2hDbGF1c2UiLCJjYXRlZ29yeVNlYXJjaENsYXVzZSIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJyZXN1bHQiLCJzdGF0dXMiLCJkYXRhIiwicGFnZVNpemUiLCJwYWdlSW5kZXgiLCJwcm9kdWN0SWQiLCJjYXRlZ29yeUlkIiwic3ViQ2F0ZWdvcnlJZCIsImlzTnVtYmVyIiwicmVqZWN0IiwiZ2V0UXVlcnkiLCJjb3VudFF1ZXJ5Iiwiam9pbiIsIm5lc3QiLCJzcHJlYWQiLCJmbGF0dGVuZWRQcm9kdWN0cyIsImNvdW50RGF0YSIsInByb2R1Y3RzIiwib2JqZWN0aWZ5IiwibWFwIiwicHJvZHVjdCIsInN1YkNhdGVnb3J5IiwiY2F0ZWdvcnkiLCJwcmltYXJ5SW1hZ2UiLCJ0b3RhbFByb2R1Y3RzIiwiY291bnQiLCJzZWFyY2hDbGF1c2UiLCJnZXRNb2RlbHMiLCJmaW5kQWxsIiwid2hlcmUiLCJPYmplY3QiLCJhc3NpZ24iLCJpbmNsdWRlIiwibW9kZWwiLCJzdXBwbGllcklkIiwicmVxdWlyZWQiLCJjYXRjaCIsImVyckhhbmRsZXIiLCJ2YXJpYW50SWQiLCJwcmljZSIsImNyZWF0ZSIsInN1cGVyIiwicmF3UmVhZFF1ZXJ5IiwiZXhwb3J0cyIsImRlZmF1bHQiXSwibWFwcGluZ3MiOiJvRUFHQSxNQUFBQSxRQUFBQyxRQUFBLFlBRUFDLGVBQUFELFFBQUEsa0JBRUFFLE1BQUFGLFFBQUEsdUJBTUFHLG9CQUEwQkYsZUFBQUcsWUFheEJD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cUVuRCxNQUl0Rm9ELFFBQUFDLFFBQWUsSUFBSTVEIiwiZmlsZSI6InNlcnZpY2VzL3Nob3Atc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHV0aWwgZnJvbSAndXRpbCdcblxuaW1wb3J0IHsgTW9kZWwsIEluc3RhbmNlLCBPcCB9IGZyb20gJ3NlcXVlbGl6ZSdcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5cbmltcG9ydCB7IENSVURTZXJ2aWNlIH0gZnJvbSAnLi9jcnVkLXNlcnZpY2UnXG5pbXBvcnQgQXBwQ29uZmlnIGZyb20gJy4uL2FwcC1jb25maWcnXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICcuLi9saWJzL3V0aWxzJ1xuXG4vKlxuICBUaGlzIGlzIHVzZWQgdG8gZG8gc2hvcCBtYW5hZ2VtZW50LlxuICBGb3IgZXhhbXBsZSwgdG8gY3VzdG9taXplIHByaWNlIGZvciBwcm9kdWN0XG4qL1xuY2xhc3MgU2hvcFNlcnZpY2UgZXh0ZW5kcyBDUlVEU2VydmljZSB7XG4gIC8qXG4gICAgUmV0dXJuIHByb2R1Y3Qgam9pbmVkIHdpdGggc2hvcFByb2R1Y3QgbWV0YSBpbmZvcm1hdGlvbi5cbiAgICBJZiBzaG9wUHJvZHVjdCBpcyBub3QgZGVmaW5lZCwgYXBwZW5kIG1ldGEgaW5mb3JtYXRpb246XG4gICAge1xuICAgICAgaWQ6IG51bGwsXG4gICAgICBwcmljZTogcHJvZHVjdC5wcmljZSxcbiAgICAgIHByZU9yZGVyOiB0cnVlLFxuICAgICAgcG9MZW5ndGg6IDMgZGF5cyxcbiAgICAgIGRpc2FibGU6IGZhbHNlXG4gICAgfVxuICAqL1xuXG4gIGdldFNob3BzICgpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkPFNob3A+KCdTaG9wJywge30pLnRoZW4ocmVzcCA9PiB7XG4gICAgICByZXR1cm4gcmVzcFxuICAgIH0pXG4gIH1cblxuICAvLyBUT0RPOiBXZSBzaG91bGQgY3JlYXRlIHRlc3QgY2FzZXMgdG8gZW5zdXJlIHRoaXMgaXMgY29ycmVjdC4uLlxuICAvLyBpLmUuIHdoZW4gdGhlcmUgYXJlIHN1cHBsaWVycywgc3VwcGxpZXIgY291bnQgaXMgY29ycmVjdFxuICAvLyAgICAgIHdoZW4gdGhlcmUgYXJlIHNob3BTdG9ja3MsIHRoZSBjb3VudCBpcyBjb3JyZWN0XG4gIGdldFNob3BpZmllZFByb2R1Y3RzIChzaG9wSWQsIHByaW1hcnlJbWFnZXNPbmx5ID0gZmFsc2UsIHByb2R1Y3RTZWFyY2hDbGF1c2UgPSB7fSwgY2F0ZWdvcnlTZWFyY2hDbGF1c2UgPSB7fSk6IFByb21pc2U8TkNSZXNwb25zZTxTaG9waWZpZWRQcm9kdWN0W10+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFNFTEVDVCAqIEZST00gc2hvcGlmaWVkUHJvZHVjdHNWaWV3IFdIRVJFIHNob3BJZCA9ICR7c2hvcElkfWAsXG4gICAgICB7IHR5cGU6IHRoaXMuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXN1bHQgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UgfVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG5cbiAgLy8gVE9ETzogTGltaXQgc2hvdWxkIGJlIGRvbmUgb24gdGhlIGZpbmFsIHF1ZXJpZXMuIFNvbHV0aW9uIGlzIHRvIGFkZCBjYXRlZ29yeUlkIG9uIFNRTCB2aWV3XG4gIGdldEluU3RvY2tQcm9kdWN0cyAoeyBwYWdlU2l6ZSA9IDEwLCBwYWdlSW5kZXggPSAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZHVjdElkID0gbnVsbCwgY2F0ZWdvcnlJZCA9IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJDYXRlZ29yeUlkID0gbnVsbCB9LCBzaG9wSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8eyBwcm9kdWN0czogSW5TdG9ja1Byb2R1Y3RbXSwgdG90YWxQcm9kdWN0czogbnVtYmVyIH0+PiB7XG4gICAgaWYgKHByb2R1Y3RJZCAhPT0gbnVsbCAmJiAhVXRpbHMuaXNOdW1iZXIocHJvZHVjdElkKSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdwcm9kdWN0SWQgaGFzIHRvIGJlIG51bWJlciEnKVxuICAgIH0gZWxzZSBpZiAoY2F0ZWdvcnlJZCAhPT0gbnVsbCAmJiAhVXRpbHMuaXNOdW1iZXIoY2F0ZWdvcnlJZCkpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnY2F0ZWdvcnlJZCBoYXMgdG8gYmUgbnVtYmVyIScpXG4gICAgfSBlbHNlIGlmIChzdWJDYXRlZ29yeUlkICE9PSBudWxsICYmICFVdGlscy5pc051bWJlcihzdWJDYXRlZ29yeUlkKSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdzdWJDYXRlZ29yeUlkIGhhcyB0byBiZSBudW1iZXIhJylcbiAgICB9XG5cbiAgICBjb25zdCBnZXRRdWVyeSA9IGBcbiAgICAgIFNFTEVDVFxuICAgICAgICBpblN0b2NrUHJvZHVjdHNWaWV3LmlkIGFzIGlkLFxuICAgICAgICBpblN0b2NrUHJvZHVjdHNWaWV3LnNob3BJZCBhcyBzaG9wSWQsXG4gICAgICAgIGluU3RvY2tQcm9kdWN0c1ZpZXcubmFtZSBhcyBuYW1lLFxuICAgICAgICBpblN0b2NrUHJvZHVjdHNWaWV3LmRlc2NyaXB0aW9uIGFzIGRlc2NyaXB0aW9uLFxuICAgICAgICBpblN0b2NrUHJvZHVjdHNWaWV3LndhcnJhbnR5IGFzIHdhcnJhbnR5LFxuICAgICAgICBpblN0b2NrUHJvZHVjdHNWaWV3LnByaWNlIGFzIHByaWNlLFxuICAgICAgICBpblN0b2NrUHJvZHVjdHNWaWV3LnN0b2NrUXVhbnRpdHkgYXMgc3RvY2tRdWFudGl0eSxcbiAgICAgICAgaW5TdG9ja1Byb2R1Y3RzVmlldy51cGRhdGVkQXQgYXMgdXBkYXRlZEF0LFxuICAgICAgICBwcmltYXJ5SW1hZ2VzLmltYWdlRmlsZW5hbWUgYXMgXFxgcHJpbWFyeUltYWdlLmltYWdlRmlsZW5hbWVcXGAsXG4gICAgICAgIHByaW1hcnlJbWFnZXMucHJvZHVjdElkIGFzIFxcYHByaW1hcnlJbWFnZS5wcm9kdWN0SWRcXGAsXG4gICAgICAgIHByb2R1Y3RJbWFnZXMuaW1hZ2VGaWxlbmFtZSBhcyBcXGBpbWFnZXMuaW1hZ2VGaWxlbmFtZVxcYCxcbiAgICAgICAgcHJvZHVjdEltYWdlcy5wcm9kdWN0SWQgYXMgXFxgaW1hZ2VzLnByb2R1Y3RJZFxcYCxcbiAgICAgICAgc3ViQ2F0ZWdvcmllcy5pZCBhcyBcXGBzdWJDYXRlZ29yeS5pZFxcYCxcbiAgICAgICAgc3ViQ2F0ZWdvcmllcy5uYW1lIGFzIFxcYHN1YkNhdGVnb3J5Lm5hbWVcXGAsXG4gICAgICAgIHN1YkNhdGVnb3JpZXMuZGVzY3JpcHRpb24gYXMgXFxgc3ViQ2F0ZWdvcnkuZGVzY3JpcHRpb25cXGAsXG4gICAgICAgIHN1YkNhdGVnb3JpZXMuY2F0ZWdvcnlJZCBhcyBcXGBzdWJDYXRlZ29yeS5jYXRlZ29yeUlkXFxgLFxuICAgICAgICBzdWJDYXRlZ29yaWVzLmltYWdlRmlsZW5hbWUgYXMgXFxgc3ViQ2F0ZWdvcnkuaW1hZ2VGaWxlbmFtZVxcYCxcbiAgICAgICAgY2F0ZWdvcmllcy5pZCBhcyBcXGBzdWJDYXRlZ29yeS5jYXRlZ29yeS5pZFxcYCxcbiAgICAgICAgY2F0ZWdvcmllcy5uYW1lIGFzIFxcYHN1YkNhdGVnb3J5LmNhdGVnb3J5Lm5hbWVcXGAsXG4gICAgICAgIGNhdGVnb3JpZXMuZGVzY3JpcHRpb24gYXMgXFxgc3ViQ2F0ZWdvcnkuY2F0ZWdvcnkuZGVzY3JpcHRpb25cXGAsXG4gICAgICAgIGluU3RvY2tWYXJpYW50c1ZpZXcuaWQgYXMgXFxgdmFyaWFudHMuaWRcXGAsXG4gICAgICAgIGluU3RvY2tWYXJpYW50c1ZpZXcuc2hvcElkIGFzIFxcYHZhcmlhbnRzLnNob3BJZFxcYCxcbiAgICAgICAgaW5TdG9ja1ZhcmlhbnRzVmlldy5wcm9kdWN0SWQgYXMgXFxgdmFyaWFudHMucHJvZHVjdElkXFxgLFxuICAgICAgICBpblN0b2NrVmFyaWFudHNWaWV3Lm5hbWUgYXMgXFxgdmFyaWFudHMubmFtZVxcYCxcbiAgICAgICAgaW5TdG9ja1ZhcmlhbnRzVmlldy5zdG9ja1F1YW50aXR5IGFzIFxcYHZhcmlhbnRzLnN0b2NrUXVhbnRpdHlcXGBcbiAgICBGUk9NIChTRUxFQ1QgKlxuICAgICAgICAgIEZST00gaW5TdG9ja1Byb2R1Y3RzVmlld1xuICAgICAgICAgIFdIRVJFIGluU3RvY2tQcm9kdWN0c1ZpZXcuc2hvcElkID0gJHtzaG9wSWR9XG4gICAgICAgICAgICAgICAgJHtwcm9kdWN0SWQgPyAnQU5EIGluU3RvY2tQcm9kdWN0c1ZpZXcuaWQgPScgKyBwcm9kdWN0SWQgOiAnJ31cbiAgICAgICAgICAgICAgICAke3N1YkNhdGVnb3J5SWQgPyAnIEFORCBpblN0b2NrUHJvZHVjdHNWaWV3LnN1YkNhdGVnb3J5SWQgPScgKyBzdWJDYXRlZ29yeUlkIDogJyd9XG4gICAgICAgICAgICAgICAgJHtjYXRlZ29yeUlkID8gJyBBTkQgaW5TdG9ja1Byb2R1Y3RzVmlldy5jYXRlZ29yeUlkID0gJyArIGNhdGVnb3J5SWQgOiAnJyB9XG4gICAgICAgICAgTElNSVQgJHtwYWdlU2l6ZSAqIHBhZ2VJbmRleH0sICR7cGFnZVNpemV9XG4gICAgICAgICApIGFzIGluU3RvY2tQcm9kdWN0c1ZpZXdcbiAgICBMRUZUIE9VVEVSIEpPSU4gcHJvZHVjdEltYWdlcyBPTiBpblN0b2NrUHJvZHVjdHNWaWV3LmlkID0gcHJvZHVjdEltYWdlcy5wcm9kdWN0SWRcbiAgICBMRUZUIE9VVEVSIEpPSU5cbiAgICAgIChTRUxFQ1QgKiBGUk9NIHByb2R1Y3RJbWFnZXMgV0hFUkUgXFxgcHJpbWFyeVxcYCA9IFRSVUUpIGFzIHByaW1hcnlJbWFnZXMgT04gaW5TdG9ja1Byb2R1Y3RzVmlldy5pZCA9IHByaW1hcnlJbWFnZXMucHJvZHVjdElkXG4gICAgSU5ORVIgSk9JTiBzdWJDYXRlZ29yaWVzIE9OIHN1YkNhdGVnb3JpZXMuaWQgPSBpblN0b2NrUHJvZHVjdHNWaWV3LnN1YkNhdGVnb3J5SWRcbiAgICBJTk5FUiBKT0lOIGNhdGVnb3JpZXMgT04gc3ViQ2F0ZWdvcmllcy5jYXRlZ29yeUlkID0gY2F0ZWdvcmllcy5pZFxuICAgIExFRlQgT1VURVIgSk9JTiBpblN0b2NrVmFyaWFudHNWaWV3IE9OIGluU3RvY2tWYXJpYW50c1ZpZXcucHJvZHVjdElkID0gaW5TdG9ja1Byb2R1Y3RzVmlldy5pZCBBTkQgaW5TdG9ja1ZhcmlhbnRzVmlldy5zaG9wSWQgPSAke3Nob3BJZH1cbiAgICBPUkRFUiBCWSBpblN0b2NrUHJvZHVjdHNWaWV3LmlkO2BcblxuICAgIGNvbnN0IGNvdW50UXVlcnkgPSBgXG4gICAgICBTRUxFQ1QgQ09VTlQoKikgQVMgY291bnRcbiAgICAgICAgRlJPTSAoU0VMRUNUICpcbiAgICAgICAgICAgICAgRlJPTSBpblN0b2NrUHJvZHVjdHNWaWV3XG4gICAgICAgICAgICAgIFdIRVJFIGluU3RvY2tQcm9kdWN0c1ZpZXcuc2hvcElkID0gJHtzaG9wSWR9XG4gICAgICAgICAgICAgICAgICAgICR7cHJvZHVjdElkID8gJ0FORCBpblN0b2NrUHJvZHVjdHNWaWV3LmlkID0nICsgcHJvZHVjdElkIDogJyd9XG4gICAgICAgICAgICAgICAgICAgICR7c3ViQ2F0ZWdvcnlJZCA/ICcgQU5EIGluU3RvY2tQcm9kdWN0c1ZpZXcuc3ViQ2F0ZWdvcnlJZCA9JyArIHN1YkNhdGVnb3J5SWQgOiAnJ31cbiAgICAgICAgICAgICAgICAgICAgJHtjYXRlZ29yeUlkID8gJyBBTkQgaW5TdG9ja1Byb2R1Y3RzVmlldy5jYXRlZ29yeUlkID0gJyArIGNhdGVnb3J5SWQgOiAnJyB9XG4gICAgICAgICAgICAgICkgYXMgaW5TdG9ja1Byb2R1Y3RzVmlldztgXG5cbiAgICByZXR1cm4gUHJvbWlzZS5qb2luKFxuICAgICAgdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShnZXRRdWVyeSwgeyB0eXBlOiB0aGlzLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNULCBuZXN0OiBmYWxzZSB9KSxcbiAgICAgIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoY291bnRRdWVyeSwgeyB0eXBlOiB0aGlzLmdldFNlcXVlbGl6ZSgpLlF1ZXJ5VHlwZXMuU0VMRUNULCBuZXN0OiBmYWxzZSB9KVxuICAgICkuc3ByZWFkKChmbGF0dGVuZWRQcm9kdWN0cywgY291bnREYXRhKSA9PiB7XG4gICAgICBjb25zdCBwcm9kdWN0cyA9IFV0aWxzLm9iamVjdGlmeShmbGF0dGVuZWRQcm9kdWN0cykubWFwKHByb2R1Y3QgPT4ge1xuICAgICAgICBwcm9kdWN0LnN1YkNhdGVnb3J5ID0gcHJvZHVjdC5zdWJDYXRlZ29yeVswXVxuICAgICAgICBwcm9kdWN0LnN1YkNhdGVnb3J5LmNhdGVnb3J5ID0gcHJvZHVjdC5zdWJDYXRlZ29yeS5jYXRlZ29yeVswXVxuICAgICAgICBwcm9kdWN0LnByaW1hcnlJbWFnZSA9IHByb2R1Y3QucHJpbWFyeUltYWdlWzBdXG4gICAgICAgIHJldHVybiBwcm9kdWN0XG4gICAgICB9KVxuICAgICAgY29uc3QgdG90YWxQcm9kdWN0cyA9IGNvdW50RGF0YVswXS5jb3VudFxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHByb2R1Y3RzLCB0b3RhbFByb2R1Y3RzIH0gfVxuICAgIH0pXG4gIH1cblxuICAvLyBUT0RPOiBMaW1pdCBzaG91bGQgYmUgZG9uZSBvbiB0aGUgZmluYWwgcXVlcmllcy4gU29sdXRpb24gaXMgdG8gYWRkIGNhdGVnb3J5SWQgb24gU1FMIHZpZXdcbiAgZ2V0UE9Qcm9kdWN0cyAoeyBwYWdlU2l6ZSA9IDEwLCBwYWdlSW5kZXggPSAwLFxuICAgICAgICAgICAgICAgICAgcHJvZHVjdElkID0gbnVsbCwgY2F0ZWdvcnlJZCA9IG51bGwsXG4gICAgICAgICAgICAgICAgICBzdWJDYXRlZ29yeUlkID0gbnVsbCB9LCBzaG9wSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8eyBwcm9kdWN0czogUE9Qcm9kdWN0W10sIHRvdGFsUHJvZHVjdHM6IG51bWJlciB9Pj4ge1xuICAgIGlmIChwcm9kdWN0SWQgIT09IG51bGwgJiYgIVV0aWxzLmlzTnVtYmVyKHByb2R1Y3RJZCkpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgncHJvZHVjdElkIGhhcyB0byBiZSBudW1iZXIhJylcbiAgICB9IGVsc2UgaWYgKGNhdGVnb3J5SWQgIT09IG51bGwgJiYgIVV0aWxzLmlzTnVtYmVyKGNhdGVnb3J5SWQpKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ2NhdGVnb3J5SWQgaGFzIHRvIGJlIG51bWJlciEnKVxuICAgIH0gZWxzZSBpZiAoc3ViQ2F0ZWdvcnlJZCAhPT0gbnVsbCAmJiAhVXRpbHMuaXNOdW1iZXIoc3ViQ2F0ZWdvcnlJZCkpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnc3ViQ2F0ZWdvcnlJZCBoYXMgdG8gYmUgbnVtYmVyIScpXG4gICAgfVxuXG4gICAgY29uc3QgZ2V0UXVlcnkgPSBgXG4gICAgICBTRUxFQ1RcbiAgICAgICAgcG9Qcm9kdWN0c1ZpZXcuaWQgYXMgaWQsXG4gICAgICAgIHBvUHJvZHVjdHNWaWV3LnNob3BJZCBhcyBzaG9wSWQsXG4gICAgICAgIHBvUHJvZHVjdHNWaWV3Lm5hbWUgYXMgbmFtZSxcbiAgICAgICAgcG9Qcm9kdWN0c1ZpZXcuZGVzY3JpcHRpb24gYXMgZGVzY3JpcHRpb24sXG4gICAgICAgIHBvUHJvZHVjdHNWaWV3LndhcnJhbnR5IGFzIHdhcnJhbnR5LFxuICAgICAgICBwb1Byb2R1Y3RzVmlldy5wcmljZSBhcyBwcmljZSxcbiAgICAgICAgcG9Qcm9kdWN0c1ZpZXcucHJlT3JkZXJEdXJhdGlvbiBhcyBwcmVPcmRlckR1cmF0aW9uLFxuICAgICAgICBwb1Byb2R1Y3RzVmlldy51cGRhdGVkQXQgYXMgdXBkYXRlZEF0LFxuICAgICAgICBwcmltYXJ5SW1hZ2VzLmltYWdlRmlsZW5hbWUgYXMgXFxgcHJpbWFyeUltYWdlLmltYWdlRmlsZW5hbWVcXGAsXG4gICAgICAgIHByaW1hcnlJbWFnZXMucHJvZHVjdElkIGFzIFxcYHByaW1hcnlJbWFnZS5wcm9kdWN0SWRcXGAsXG4gICAgICAgIHByb2R1Y3RJbWFnZXMuaW1hZ2VGaWxlbmFtZSBhcyBcXGBpbWFnZXMuaW1hZ2VGaWxlbmFtZVxcYCxcbiAgICAgICAgIyBwcm9kdWN0SW1hZ2VzLnByb2R1Y3RJZCBhcyBcXGBpbWFnZXMucHJvZHVjdElkXFxgLFxuICAgICAgICBwcm9kdWN0SW1hZ2VzLnByaW1hcnkgYXMgXFxgaW1hZ2VzLnByaW1hcnlcXGAsXG4gICAgICAgIHN1YkNhdGVnb3JpZXMuaWQgYXMgXFxgc3ViQ2F0ZWdvcnkuaWRcXGAsXG4gICAgICAgIHN1YkNhdGVnb3JpZXMubmFtZSBhcyBcXGBzdWJDYXRlZ29yeS5uYW1lXFxgLFxuICAgICAgICBzdWJDYXRlZ29yaWVzLmRlc2NyaXB0aW9uIGFzIFxcYHN1YkNhdGVnb3J5LmRlc2NyaXB0aW9uXFxgLFxuICAgICAgICBzdWJDYXRlZ29yaWVzLmNhdGVnb3J5SWQgYXMgXFxgc3ViQ2F0ZWdvcnkuY2F0ZWdvcnlJZFxcYCxcbiAgICAgICAgc3ViQ2F0ZWdvcmllcy5pbWFnZUZpbGVuYW1lIGFzIFxcYHN1YkNhdGVnb3J5LmltYWdlRmlsZW5hbWVcXGAsXG4gICAgICAgIGNhdGVnb3JpZXMuaWQgYXMgXFxgc3ViQ2F0ZWdvcnkuY2F0ZWdvcnkuaWRcXGAsXG4gICAgICAgIGNhdGVnb3JpZXMubmFtZSBhcyBcXGBzdWJDYXRlZ29yeS5jYXRlZ29yeS5uYW1lXFxgLFxuICAgICAgICBjYXRlZ29yaWVzLmRlc2NyaXB0aW9uIGFzIFxcYHN1YkNhdGVnb3J5LmNhdGVnb3J5LmRlc2NyaXB0aW9uXFxgLFxuICAgICAgICBwb1ZhcmlhbnRzVmlldy5pZCBhcyBcXGB2YXJpYW50cy5pZFxcYCxcbiAgICAgICAgcG9WYXJpYW50c1ZpZXcuc2hvcElkIGFzIFxcYHZhcmlhbnRzLnNob3BJZFxcYCxcbiAgICAgICAgcG9WYXJpYW50c1ZpZXcucHJvZHVjdElkIGFzIFxcYHZhcmlhbnRzLnByb2R1Y3RJZFxcYCxcbiAgICAgICAgcG9WYXJpYW50c1ZpZXcubmFtZSBhcyBcXGB2YXJpYW50cy5uYW1lXFxgLFxuICAgICAgICBwb1ZhcmlhbnRzVmlldy5zdXBwbGllckNvdW50IGFzIFxcYHZhcmlhbnRzLnN1cHBsaWVyQ291bnRcXGBcbiAgICAgIEZST00gKFNFTEVDVCAqXG4gICAgICAgIEZST00gcG9Qcm9kdWN0c1ZpZXdcbiAgICAgICAgV0hFUkUgcG9Qcm9kdWN0c1ZpZXcuc2hvcElkID0gJHtzaG9wSWR9XG4gICAgICAgICAgICAgICR7cHJvZHVjdElkID8gJ0FORCBwb1Byb2R1Y3RzVmlldy5pZCA9JyArIHByb2R1Y3RJZCA6ICcnfVxuICAgICAgICAgICAgICAke3N1YkNhdGVnb3J5SWQgPyAnQU5EIHBvUHJvZHVjdHNWaWV3LnN1YkNhdGVnb3J5SWQgPScgKyBzdWJDYXRlZ29yeUlkIDogJyd9XG4gICAgICAgICAgICAgICR7Y2F0ZWdvcnlJZCA/ICcgQU5EIHBvUHJvZHVjdHNWaWV3LmNhdGVnb3J5SWQgPSAnICsgY2F0ZWdvcnlJZCA6ICcnIH1cbiAgICAgICAgTElNSVQgJHtwYWdlU2l6ZSAqIHBhZ2VJbmRleH0sICR7cGFnZVNpemV9XG4gICAgICAgICkgYXMgcG9Qcm9kdWN0c1ZpZXdcbiAgICAgIExFRlQgT1VURVIgSk9JTlxuICAgICAgICAoU0VMRUNUICogRlJPTSBwcm9kdWN0SW1hZ2VzIFdIRVJFIFxcYHByaW1hcnlcXGAgPSBUUlVFKSBhcyBwcmltYXJ5SW1hZ2VzIE9OIHBvUHJvZHVjdHNWaWV3LmlkID0gcHJpbWFyeUltYWdlcy5wcm9kdWN0SWRcbiAgICAgIExFRlQgT1VURVIgSk9JTiBwcm9kdWN0SW1hZ2VzIG9uIHBvUHJvZHVjdHNWaWV3LmlkID0gcHJvZHVjdEltYWdlcy5wcm9kdWN0SWRcbiAgICAgIElOTkVSIEpPSU4gc3ViQ2F0ZWdvcmllcyBvbiBzdWJDYXRlZ29yaWVzLmlkID0gcG9Qcm9kdWN0c1ZpZXcuc3ViQ2F0ZWdvcnlJZFxuICAgICAgSU5ORVIgSk9JTiBjYXRlZ29yaWVzIG9uIHN1YkNhdGVnb3JpZXMuY2F0ZWdvcnlJZCA9IGNhdGVnb3JpZXMuaWRcbiAgICAgIExFRlQgT1VURVIgSk9JTiBwb1ZhcmlhbnRzVmlldyBPTiBwb1ZhcmlhbnRzVmlldy5wcm9kdWN0SWQgPSBwb1Byb2R1Y3RzVmlldy5pZCBBTkQgcG9WYXJpYW50c1ZpZXcuc2hvcElkID0gJHtzaG9wSWR9XG4gICAgICBPUkRFUiBCWSBwb1Byb2R1Y3RzVmlldy5pZDtgXG5cbiAgICBjb25zdCBjb3VudFF1ZXJ5ID0gYFxuICAgICAgU0VMRUNUIENPVU5UKCopIEFTIGNvdW50IEZST01cbiAgICAgICAgKFNFTEVDVCAqXG4gICAgICAgICAgRlJPTSBwb1Byb2R1Y3RzVmlld1xuICAgICAgICAgIFdIRVJFIHBvUHJvZHVjdHNWaWV3LnNob3BJZCA9ICR7c2hvcElkfVxuICAgICAgICAgICAgICAgICR7cHJvZHVjdElkID8gJ0FORCBwb1Byb2R1Y3RzVmlldy5pZCA9JyArIHByb2R1Y3RJZCA6ICcnfVxuICAgICAgICAgICAgICAgICR7c3ViQ2F0ZWdvcnlJZCA/ICdBTkQgcG9Qcm9kdWN0c1ZpZXcuc3ViQ2F0ZWdvcnlJZCA9JyArIHN1YkNhdGVnb3J5SWQgOiAnJ31cbiAgICAgICAgICAgICAgICAke2NhdGVnb3J5SWQgPyAnIEFORCBwb1Byb2R1Y3RzVmlldy5jYXRlZ29yeUlkID0gJyArIGNhdGVnb3J5SWQgOiAnJyB9XG4gICAgICAgICAgKSBhcyBwb1Byb2R1Y3RzVmlld2BcblxuICAgIHJldHVybiBQcm9taXNlLmpvaW4oXG4gICAgICB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGdldFF1ZXJ5LCB7IHR5cGU6IHRoaXMuZ2V0U2VxdWVsaXplKCkuUXVlcnlUeXBlcy5TRUxFQ1QsIG5lc3Q6IGZhbHNlIH0pLFxuICAgICAgICB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGNvdW50UXVlcnksIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KVxuICAgICkuc3ByZWFkKChmbGF0dGVuZWRQcm9kdWN0cywgY291bnREYXRhKSA9PiB7XG4gICAgICBjb25zdCBwcm9kdWN0cyA9IFV0aWxzLm9iamVjdGlmeShmbGF0dGVuZWRQcm9kdWN0cykubWFwKHByb2R1Y3QgPT4ge1xuICAgICAgICBwcm9kdWN0LnN1YkNhdGVnb3J5ID0gcHJvZHVjdC5zdWJDYXRlZ29yeVswXVxuICAgICAgICBwcm9kdWN0LnN1YkNhdGVnb3J5LmNhdGVnb3J5ID0gcHJvZHVjdC5zdWJDYXRlZ29yeS5jYXRlZ29yeVswXVxuICAgICAgICBwcm9kdWN0LnByaW1hcnlJbWFnZSA9IHByb2R1Y3QucHJpbWFyeUltYWdlWzBdXG4gICAgICAgIHJldHVybiBwcm9kdWN0XG4gICAgICB9KVxuICAgICAgY29uc3QgdG90YWxQcm9kdWN0cyA9IGNvdW50RGF0YVswXS5jb3VudFxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHByb2R1Y3RzLCB0b3RhbFByb2R1Y3RzIH0gfVxuICAgIH0pXG4gIH1cblxuICBnZXRTaG9waWZpZWRWYXJpYW50cyAoc2hvcElkLCBwcm9kdWN0SWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8U2hvcGlmaWVkVmFyaWFudFtdPj4ge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIHNob3BpZmllZFZhcmlhbnRzVmlldyBXSEVSRSBzaG9wSWQgPSAke3Nob3BJZH0gQU5EIHByb2R1Y3RJZCA9JHtwcm9kdWN0SWR9YCxcbiAgICAgIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3VsdCB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gIH1cblxuICBnZXRTaG9wU3RvY2sgKHNob3BJZCwgc2VhcmNoQ2xhdXNlID0ge30pIHtcbiAgICByZXR1cm4gKHRoaXMuZ2V0TW9kZWxzKCdTaG9wU3RvY2snKSBhcyBNb2RlbDxJbnN0YW5jZTxTaG9wU3RvY2s+LCBQYXJ0aWFsPFNob3BTdG9jaz4+KS5maW5kQWxsKHtcbiAgICAgIHdoZXJlOiBPYmplY3QuYXNzaWduKHt9LCBzZWFyY2hDbGF1c2UsIHsgc2hvcElkIH0pLFxuICAgICAgaW5jbHVkZTogW1xuICAgICAgICB7XG4gICAgICAgICAgbW9kZWw6IHRoaXMuZ2V0TW9kZWxzKCdWYXJpYW50JyksXG4gICAgICAgICAgaW5jbHVkZTogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1Byb2R1Y3QnKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGEgfVxuICAgIH0pXG4gIH1cblxuICBnZXRTdXBwbGllclN0b2NrIChzdXBwbGllcklkOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRNb2RlbHMoJ1N1cHBsaWVyU3RvY2snKS5maW5kQWxsKHtcbiAgICAgIHdoZXJlOiB7IHN1cHBsaWVySWQgfSxcbiAgICAgIGluY2x1ZGU6IFtcbiAgICAgICAge1xuICAgICAgICAgIG1vZGVsOiB0aGlzLmdldE1vZGVscygnVmFyaWFudCcpLFxuICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgIGluY2x1ZGU6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbW9kZWw6IHRoaXMuZ2V0TW9kZWxzKCdQcm9kdWN0JyksXG4gICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICB9XG4gICAgICBdXG4gICAgfSkudGhlbihkYXRhID0+IHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YSB9XG4gICAgfSkuY2F0Y2godGhpcy5lcnJIYW5kbGVyKVxuICB9XG5cbiAgYWRkU3VwcGxpZXJTdG9jayAoeyBzdXBwbGllcklkLCB2YXJpYW50SWQsIHByaWNlIH0pIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGU8U3VwcGxpZXJTdG9jaz4oJ1N1cHBsaWVyU3RvY2snLCB7XG4gICAgICBzdXBwbGllcklkLFxuICAgICAgdmFyaWFudElkLFxuICAgICAgcHJpY2VcbiAgICB9KVxuICB9XG5cbiAgLy8gVE9ETzogVGhpcyBzaG91bGQgYmUgb2Ygc2hvcGlmaWVkUHJvZHVjdHNWaWV3IGluc3RlYWQgb2YgcHJvZHVjdCB0YWJsZVxuICBnZXRQcm9tb3Rpb24gKHNob3BJZCk6IFByb21pc2U8TkNSZXNwb25zZTxTaG9waWZpZWRQcm9tb3Rpb25bXT4+IHtcbiAgICByZXR1cm4gc3VwZXIucmF3UmVhZFF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIHNob3BpZmllZFByb21vdGlvbnNWaWV3IFdIRVJFIHNob3BJZCA9ICR7c2hvcElkfWApXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IFNob3BTZXJ2aWNlKClcbiJdfQ==
